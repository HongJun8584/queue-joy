<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>QueueJoy Admin ‚Äî Real-Time Queue Management</title>
    <meta name="description" content="QueueJoy Admin Panel - Manage queues, announcements, and analytics in real-time" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <meta property="og:title" content="QueueJoy Admin ‚Äî Real-Time Queue Management" />
    <meta property="og:description" content="Manage queues, send announcements, and view analytics in real-time" />
    <link rel="canonical" href="/counter.html" />

    <style>
      :root {
        --primary: 264 83% 62%;
        --accent: 197 92% 44%;
        --muted: 220 14% 56%;
      }
      * { scrollbar-width: thin; scrollbar-color: rgba(139,92,246,0.3) transparent; }
      *::-webkit-scrollbar { width: 8px; height: 8px; }
      *::-webkit-scrollbar-track { background: transparent; }
      *::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.3); border-radius: 10px; }
      *::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.5); }
      body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        -webkit-font-smoothing: antialiased;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
      }
      @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
      .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 1px solid rgba(255,255,255,0.3); }
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
      .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease-out; }
      @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      .spinner { border: 2px solid #f3f3f3; border-top: 2px solid hsl(var(--primary)); border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; }
      @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
      .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 260px; background: linear-gradient(180deg, rgba(99,102,241,0.95) 0%, rgba(139,92,246,0.95) 50%, rgba(168,85,247,0.95) 100%); backdrop-filter: blur(20px); z-index: 50; transition: transform .3s cubic-bezier(.4,0,.2,1); box-shadow: 8px 0 40px rgba(139,92,246,.4), 0 0 0 1px rgba(255,255,255,.2) inset; border-right: 1px solid rgba(255,255,255,.2); }
      .sidebar-mobile-closed { transform: translateX(-100%); }
      .sidebar-item { display:flex; align-items:center; gap:14px; padding:16px 24px; margin:6px 12px; color:#fff; cursor:pointer; transition: all .3s cubic-bezier(.4,0,.2,1); font-weight:600; border-radius:12px; position:relative; overflow:hidden; }
      .sidebar-item::before { content:''; position:absolute; inset:0; background: rgba(255,255,255,0); transition: all .3s cubic-bezier(.4,0,.2,1); z-index:-1; }
      .sidebar-item:hover::before { background: rgba(255,255,255,0.15); }
      .sidebar-item.active { background: rgba(255,255,255,0.25); box-shadow:0 8px 20px rgba(0,0,0,0.15); transform: translateX(4px); }
      .sidebar-item.active::before { background: rgba(255,255,255,0.25); }
      .main-content { margin-left:260px; transition: margin-left .3s cubic-bezier(.4,0,.2,1); }
      @media (max-width: 1024px) { .main-content { margin-left:0; } }
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px; }
      .modal-content { background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y:auto; padding:32px; box-shadow: 0 30px 80px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 1px solid rgba(255,255,255,0.3); }
      .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius:16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
      .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
      .stat-card { position:relative; overflow:hidden; }
      .stat-card::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s infinite; }
      @keyframes shimmer { 0%,100%{ transform: translate(0,0);} 50%{ transform: translate(-20%,-20%);} }
      .cropper-container { max-height: 400px; margin: 20px 0; }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar sidebar-mobile-closed lg:transform-none">
      <div class="p-8 border-b border-white/20">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-lg flex items-center justify-center text-white text-lg font-bold shadow-lg">QJ</div>
          <h1 class="text-white text-2xl font-bold tracking-tight">QueueJoy</h1>
        </div>
        <p class="text-white/80 text-sm font-medium ml-13">Admin Panel</p>
      </div>
      <nav class="mt-6">
        <div class="sidebar-item active" data-view="dashboard"><span class="text-2xl">üè†</span><span class="text-base">Dashboard</span></div>
        <div class="sidebar-item" data-view="analytics"><span class="text-2xl">üìä</span><span class="text-base">Analytics</span></div>
      </nav>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-40 p-4 bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-2xl shadow-2xl hover:scale-110 transition-all duration-300">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <div class="max-w-6xl mx-auto p-4 pb-20 fade-in">
        <!-- Dashboard View -->
        <div id="dashboardView">
          <!-- Header -->
          <header class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-8 mt-16 lg:mt-6">
            <div class="flex items-center gap-4">
              <div id="headerLogo" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-600 via-purple-500 to-indigo-500 flex items-center justify-center text-white text-2xl font-bold shadow-2xl ring-4 ring-white/30">QJ</div>
              <div>
                <h2 id="headerName" class="text-3xl font-bold gradient-text">Queue Joy Admin</h2>
                <p class="text-sm text-gray-700 font-medium mt-1">Real-time management dashboard</p>
              </div>
            </div>
            <button id="saveAllBtn" class="px-8 py-4 bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">üíæ Save All Changes</button>
          </header>

          <!-- Analytics Panel -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Total Queues</p>
                  <p id="totalQueues" class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-2xl shadow-xl">üìä</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Waiting</p>
                  <p id="activeQueues" class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-2xl shadow-xl">üé´</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Today's Queues</p>
                  <p id="todayQueues" class="text-4xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white text-2xl shadow-xl">üìà</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Active Counters</p>
                  <p id="activeCounters" class="text-4xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white text-2xl shadow-xl">üè™</div>
              </div>
            </div>
          </div>

          <!-- Main Content Grid -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Business Settings Card -->
            <div class="card p-8 space-y-6">
              <h3 class="text-2xl font-bold gradient-text mb-6">‚öôÔ∏è Business Settings</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
                <input id="businessName" type="text" placeholder="Your Business Name" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Message</label>
                <textarea id="welcomeMessage" rows="3" placeholder="Real-time queueing system. Mobile-friendly. No app needed." class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Logo Image (Square)</label>
                <div class="flex items-center gap-3">
                  <img id="logoPreview" src="" alt="Logo" class="w-16 h-16 rounded-lg object-cover border-2 border-gray-200 hidden" />
                  <div class="flex-1">
                    <input id="logoFile" type="file" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"/>
                    <p class="text-xs text-gray-500 mt-1">Click to crop before saving</p>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Advertisement Banner (Landscape)</label>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div id="adPreviewBox" class="w-32 h-20 rounded-lg overflow-hidden border-2 border-gray-200 hidden"></div>
                    <div class="flex-1">
                      <input id="adFile" type="file" accept="image/*,video/*,.gif" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"/>
                      <p class="text-xs text-gray-500 mt-1">Landscape (16:9). Max 50MB</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Display Settings -->
              <div class="border-t pt-6 mt-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4">üñ•Ô∏è Display Settings</h4>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Small Text on Top</label>
                    <input id="displaySmallText" type="text" placeholder="Digital Queue System" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL (Centered)</label>
                    <input id="displayLogoUrl" type="text" placeholder="https://.../logo.png" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Main Title in Middle</label>
                    <input id="displayMainTitle" type="text" placeholder="Get your queue number" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
                  </div>
                </div>
              </div>
              
              <button id="updateSettingsBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">
                <span id="updateBtnText">‚ú® Update Settings</span>
                <span id="updateBtnSpinner" class="hidden"><span class="spinner"></span> Updating...</span>
              </button>
            </div>

            <!-- Right Column: Announcement + Live Preview -->
            <div class="space-y-6">
              <div class="card p-8">
                <h3 class="text-2xl font-bold gradient-text mb-6">üì¢ Telegram Announcement</h3>
                <div class="space-y-4">
                  <textarea id="announcementMessage" rows="4" placeholder="Type your announcement message here..." class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"></textarea>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Attach Media (Image, Video, or GIF)</label>
                    <input id="announcementMedia" type="file" accept="image/*,video/*,audio/*,.gif" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-50 file:text-green-600 file:font-semibold hover:file:bg-green-100 cursor-pointer" />
                    <div id="announcementPreview" class="mt-3 hidden"></div>
                  </div>
                  <button id="sendAnnouncementBtn" class="w-full py-4 bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-green-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">
                    <span id="sendBtnText">üì± Send to Telegram</span>
                    <span id="sendBtnSpinner" class="hidden"><span class="spinner"></span> Sending...</span>
                  </button>
                  <div id="announcementResult" class="hidden p-3 rounded-lg text-sm"></div>
                </div>
              </div>

              <div class="card p-8">
                <h3 class="text-2xl font-bold gradient-text mb-6">üëÅÔ∏è Live Preview</h3>
                <div class="space-y-4">
                  <div class="flex items-center gap-4">
                    <div id="previewLogo" class="w-14 h-14 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
                    <div class="flex-1">
                      <p id="previewName" class="text-lg font-bold text-gray-800">Your Business</p>
                      <p id="previewIntro" class="text-sm text-gray-600">Real-time queueing system</p>
                    </div>
                  </div>
                  <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 mb-2">Advertisement Preview</p>
                    <div class="flex items-center gap-3">
                      <img id="previewAd" src="" alt="Ad" class="w-24 h-16 rounded-lg object-cover border hidden" />
                    </div>
                  </div>
                  <button class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl opacity-75 cursor-not-allowed">üé´ Get My Number</button>
                  <p class="text-xs text-center text-gray-500">This is how customers see your page</p>
                </div>
              </div>
            </div>
          </div>

          <footer class="text-center text-sm font-medium text-gray-700 mt-12 p-6 card">
            <p>üî• Real-time sync powered by Firebase</p>
          </footer>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" class="hidden">
          <div class="mt-16 lg:mt-6">
            <h2 class="text-3xl font-bold text-white mb-8 bg-gradient-to-r from-purple-600 to-indigo-500 p-6 rounded-2xl shadow-lg">üìä Analytics Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div class="card p-6 bg-gradient-to-br from-purple-600 to-purple-400 text-white">
                <p class="text-sm opacity-90 mb-2">Total Customers Served</p>
                <p id="analyticsServed" class="text-4xl font-bold">0</p>
              </div>
              <div class="card p-6 bg-gradient-to-br from-indigo-600 to-indigo-400 text-white">
                <p class="text-sm opacity-90 mb-2">Average Wait Time</p>
                <p class="text-4xl font-bold"><span id="analyticsAvgWait">0</span><span class="text-lg ml-1">min</span></p>
              </div>
              <div class="card p-6 bg-gradient-to-br from-pink-600 to-pink-400 text-white">
                <p class="text-sm opacity-90 mb-2">Active Counters</p>
                <p id="analyticsActiveCounters" class="text-4xl font-bold">0</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Queue Trend (Last 7 Days)</h3>
                <div id="queueTrendChart" class="h-64"></div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Counter Performance</h3>
                <div id="counterPerfChart"></div>
              </div>
            </div>
            
            <div class="card p-6 mt-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">Queue Status Breakdown</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center"><p class="text-3xl font-bold text-green-600" id="analyticsCompleted">0</p><p class="text-sm text-gray-600 mt-1">Completed</p></div>
                <div class="text-center"><p class="text-3xl font-bold text-blue-600" id="analyticsWaiting">0</p><p class="text-sm text-gray-600 mt-1">Waiting</p></div>
                <div class="text-center"><p class="text-3xl font-bold text-purple-600" id="analyticsServing">0</p><p class="text-sm text-gray-600 mt-1">Serving</p></div>
                <div class="text-center"><p class="text-3xl font-bold text-gray-600" id="analyticsCancelled">0</p><p class="text-sm text-gray-600 mt-1">Cancelled</p></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal hidden">
      <div class="modal-content">
        <h3 class="text-xl font-bold text-gray-800 mb-4" id="cropModalTitle">Crop Image</h3>
        <div class="cropper-container"><img id="cropImage" src="" alt="Crop" style="max-width: 100%;" /></div>
        <div class="flex gap-3 mt-4">
          <button id="cropSaveBtn" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all">‚úÇÔ∏è Crop & Save</button>
          <button id="cropCancelBtn" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
        authDomain: "queue-joy-aa21b.firebaseapp.com",
        databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "queue-joy-aa21b",
        storageBucket: "queue-joy-aa21b.appspot.com",
        messagingSenderId: "950240394209",
        appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Toast
      const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
        toast.textContent = type === 'success' ? `‚úÖ ${message}` : `‚ö†Ô∏è ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      };

      // File -> base64
      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Elements
      const businessName = document.getElementById('businessName');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const logoFile = document.getElementById('logoFile');
      const logoPreview = document.getElementById('logoPreview');
      const adFile = document.getElementById('adFile');
      const adPreviewBox = document.getElementById('adPreviewBox');
      const updateSettingsBtn = document.getElementById('updateSettingsBtn');
      const updateBtnText = document.getElementById('updateBtnText');
      const updateBtnSpinner = document.getElementById('updateBtnSpinner');
      const saveAllBtn = document.getElementById('saveAllBtn');
      
      // Display settings
      const displaySmallText = document.getElementById('displaySmallText');
      const displayLogoUrl = document.getElementById('displayLogoUrl');
      const displayMainTitle = document.getElementById('displayMainTitle');

      const previewName = document.getElementById('previewName');
      const previewIntro = document.getElementById('previewIntro');
      const previewLogo = document.getElementById('previewLogo');
      const previewAd = document.getElementById('previewAd');
      const headerLogo = document.getElementById('headerLogo');
      const headerName = document.getElementById('headerName');

      const announcementMessage = document.getElementById('announcementMessage');
      const announcementMedia = document.getElementById('announcementMedia');
      const announcementPreview = document.getElementById('announcementPreview');
      const sendAnnouncementBtn = document.getElementById('sendAnnouncementBtn');
      const sendBtnText = document.getElementById('sendBtnText');
      const sendBtnSpinner = document.getElementById('sendBtnSpinner');
      const announcementResult = document.getElementById('announcementResult');

      const cropModal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const cropSaveBtn = document.getElementById('cropSaveBtn');
      const cropCancelBtn = document.getElementById('cropCancelBtn');
      const cropModalTitle = document.getElementById('cropModalTitle');

      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const dashboardView = document.getElementById('dashboardView');
      const analyticsView = document.getElementById('analyticsView');
      const sidebarItems = document.querySelectorAll('.sidebar-item[data-view]');

      const totalQueuesEl = document.getElementById('totalQueues');
      const activeQueuesEl = document.getElementById('activeQueues');
      const todayQueuesEl = document.getElementById('todayQueues');
      const activeCountersEl = document.getElementById('activeCounters');

      const analyticsServed = document.getElementById('analyticsServed');
      const analyticsAvgWait = document.getElementById('analyticsAvgWait');
      const analyticsActiveCounters = document.getElementById('analyticsActiveCounters');
      const analyticsCompleted = document.getElementById('analyticsCompleted');
      const analyticsWaiting = document.getElementById('analyticsWaiting');
      const analyticsServing = document.getElementById('analyticsServing');
      const analyticsCancelled = document.getElementById('analyticsCancelled');
      
      const queueTrendChart = document.getElementById('queueTrendChart');
      const counterPerfChart = document.getElementById('counterPerfChart');

      // Mobile Menu
      mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('sidebar-mobile-closed'));

      // Switch views
      sidebarItems.forEach(item => {
        item.addEventListener('click', () => {
          const view = item.dataset.view;
          sidebarItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          if (view === 'dashboard') {
            dashboardView.classList.remove('hidden');
            analyticsView.classList.add('hidden');
          } else {
            dashboardView.classList.add('hidden');
            analyticsView.classList.remove('hidden');
          }
          sidebar.classList.add('sidebar-mobile-closed');
        });
      });

      // Real-time Analytics Updates
      let allQueues = {};
      let allCounters = {};
      
      onValue(ref(db, 'queue'), (snapshot) => {
        if (snapshot.exists()) {
          allQueues = snapshot.val();
          const queues = Object.values(allQueues);
          
          const total = queues.length;
          const waiting = queues.filter(q => q.status === 'waiting').length;
          const serving = queues.filter(q => q.status === 'serving').length;
          const completed = queues.filter(q => q.status === 'done' || q.status === 'served').length;
          const cancelled = queues.filter(q => q.status === 'cancelled' || q.status === 'cancel').length;

          totalQueuesEl.textContent = total;
          activeQueuesEl.textContent = waiting;

          // Today's queues
          const today = new Date().setHours(0,0,0,0);
          const todayCount = queues.filter(q => {
            const qDate = new Date(q.timestamp).setHours(0,0,0,0);
            return qDate === today;
          }).length;
          todayQueuesEl.textContent = todayCount;

          // Analytics view
          analyticsServed.textContent = completed;
          analyticsCompleted.textContent = completed;
          analyticsWaiting.textContent = waiting;
          analyticsServing.textContent = serving;
          analyticsCancelled.textContent = cancelled;

          // Average wait time (for waiting customers only)
          const waitingQueuesWithTime = queues.filter(q => q.status === 'waiting' && q.timestamp);
          if (waitingQueuesWithTime.length > 0) {
            const totalWaitMs = waitingQueuesWithTime.reduce((acc, q) => {
              return acc + (Date.now() - q.timestamp);
            }, 0);
            const avgWaitMin = Math.round(totalWaitMs / waitingQueuesWithTime.length / 60000);
            analyticsAvgWait.textContent = Math.max(0, avgWaitMin);
          } else {
            analyticsAvgWait.textContent = '0';
          }
          
          // Update charts
          updateCharts();
        } else {
          totalQueuesEl.textContent = '0';
          activeQueuesEl.textContent = '0';
          todayQueuesEl.textContent = '0';
          analyticsServed.textContent = '0';
          analyticsCompleted.textContent = '0';
          analyticsWaiting.textContent = '0';
          analyticsServing.textContent = '0';
          analyticsCancelled.textContent = '0';
          analyticsAvgWait.textContent = '0';
          allQueues = {};
        }
      });

      onValue(ref(db, 'counters'), (snapshot) => {
        if (snapshot.exists()) {
          allCounters = snapshot.val();
          const counters = Object.values(allCounters);
          const activeCount = counters.filter(c => c.active === true).length;
          activeCountersEl.textContent = activeCount;
          analyticsActiveCounters.textContent = activeCount;
          updateCharts();
        } else {
          activeCountersEl.textContent = '0';
          analyticsActiveCounters.textContent = '0';
          allCounters = {};
        }
      });

      // Update charts with real data
      function updateCharts() {
        const queues = Object.values(allQueues);
        const counters = Object.values(allCounters);
        
        // Last 7 days trend
        const last7Days = Array.from({ length: 7 }, (_, i) => {
          const date = new Date();
          date.setDate(date.getDate() - (6 - i));
          date.setHours(0, 0, 0, 0);
          return date;
        });
        
        const dayLabels = last7Days.map(d => d.toLocaleDateString('en-US', { weekday: 'short' }));
        const dayCounts = last7Days.map(date => {
          const dayStart = date.getTime();
          const dayEnd = dayStart + 86400000;
          return queues.filter(q => q.timestamp >= dayStart && q.timestamp < dayEnd).length;
        });
        
        // Render trend chart
        const maxCount = Math.max(...dayCounts, 1);
        queueTrendChart.innerHTML = '<div class="h-full flex items-end justify-between gap-2">' +
          dayCounts.map((count, i) => {
            const height = Math.max((count / maxCount * 100), 5);
            return `<div class="flex-1 flex flex-col items-center gap-2">
              <div class="w-full bg-gradient-to-t from-purple-600 to-purple-400 rounded-t-lg transition-all hover:scale-105" style="height: ${height}%">
                <p class="text-xs font-bold text-white text-center mt-2">${count}</p>
              </div>
              <p class="text-xs font-medium text-gray-600">${dayLabels[i]}</p>
            </div>`;
          }).join('') + '</div>';
        
        // Counter performance
        const counterKeys = Object.keys(allCounters);
        const counterPerf = counterKeys.map(key => {
          const counter = allCounters[key];
          const served = queues.filter(q => 
            q.counterId === key && (q.status === 'done' || q.status === 'served')
          ).length;
          return { name: counter.name || counter.prefix, served };
        });
        
        const maxServed = Math.max(...counterPerf.map(c => c.served), 1);
        counterPerfChart.innerHTML = '<div class="space-y-4">' +
          counterPerf.map(counter => {
            const width = Math.max((counter.served / maxServed * 100), 5);
            return `<div>
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-medium text-gray-700">${counter.name}</p>
                <p class="text-sm font-bold text-gray-800">${counter.served} served</p>
              </div>
              <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-purple-600 to-indigo-500 transition-all" style="width: ${width}%"></div>
              </div>
            </div>`;
          }).join('') + '</div>';
      }

      // Settings sync
      onValue(ref(db, 'settings/name'), (snap) => { 
        if (snap.exists()) { 
          const v = snap.val(); 
          businessName.value = v; 
          previewName.textContent = v; 
          headerName.textContent = v; 
        } 
      });
      
      onValue(ref(db, 'settings/introText'), (snap) => { 
        if (snap.exists()) { 
          const v = snap.val(); 
          welcomeMessage.value = v; 
          previewIntro.textContent = v; 
        } 
      });
      
      onValue(ref(db, 'settings/logo'), (snap) => { 
        if (snap.exists()) { 
          const v = snap.val(); 
          logoPreview.src = v; 
          logoPreview.classList.remove('hidden'); 
          previewLogo.innerHTML = `<img src="${v}" class="w-full h-full rounded-xl object-cover" />`; 
          headerLogo.innerHTML = `<img src="${v}" class="w-full h-full rounded-xl object-cover" />`; 
        } 
      });
      
      // Display settings sync
      onValue(ref(db, 'displaySettings'), (snap) => {
        if (snap.exists()) { 
          const v = snap.val(); 
          displaySmallText.value = v.smallText || ''; 
          displayLogoUrl.value = v.logoUrl || ''; 
          displayMainTitle.value = v.mainTitle || ''; 
        }
      });
      
      onValue(ref(db, 'settings/adImage'), (snap) => { 
        if (snap.exists()) { 
          const v = snap.val();
          if (typeof v === 'string' && v.startsWith('data:video/')) {
            adPreviewBox.innerHTML = `<video src="${v}" class="w-full h-full object-cover" controls></video>`;
          } else {
            adPreviewBox.innerHTML = `<img src="${v}" class="w-full h-full object-cover" />`;
          }
          adPreviewBox.classList.remove('hidden');
          previewAd.src = v; 
          previewAd.classList.remove('hidden');
          window.adData = v;
        } else { 
          adPreviewBox.classList.add('hidden'); 
          previewAd.classList.add('hidden'); 
        } 
      });

      // Cropping
      let currentCropper = null; 
      let currentCropType = '';
      window.adData = '';
      
      logoFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; 
        if (!file) return;
        currentCropType = 'logo'; 
        cropModalTitle.textContent = 'Crop Logo (Square)';
        const base64 = await fileToBase64(file); 
        cropImage.src = base64; 
        cropModal.classList.remove('hidden');
        if (currentCropper) currentCropper.destroy();
        currentCropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2, autoCropArea: 1 });
      });
      
      adFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; 
        if (!file) return;
        if (file.size > 50 * 1024 * 1024) { 
          showToast('File too large! Max 50MB', 'error'); 
          return; 
        }
        const base64 = await fileToBase64(file);
        const type = file.type || '';
        
        if (type.startsWith('video/')) {
          window.adData = base64;
          adPreviewBox.innerHTML = `<video src="${base64}" class="w-full h-full object-cover" controls></video>`;
          adPreviewBox.classList.remove('hidden');
          return;
        }
        if (type === 'image/gif') {
          window.adData = base64;
          adPreviewBox.innerHTML = `<img src="${base64}" class="w-full h-full object-cover" />`;
          adPreviewBox.classList.remove('hidden');
          return;
        }
        
        currentCropType = 'ad'; 
        cropModalTitle.textContent = 'Crop Ad Banner (Landscape)';
        cropImage.src = base64; 
        cropModal.classList.remove('hidden');
        if (currentCropper) currentCropper.destroy();
        currentCropper = new Cropper(cropImage, { aspectRatio: 16/9, viewMode: 2, autoCropArea: 1 });
      });
      
      cropSaveBtn.addEventListener('click', () => {
        if (!currentCropper) return; 
        const canvas = currentCropper.getCroppedCanvas(); 
        const cropped = canvas.toDataURL('image/jpeg', 0.9);
        
        if (currentCropType === 'logo') {
          logoPreview.src = cropped; 
          logoPreview.classList.remove('hidden');
          previewLogo.innerHTML = `<img src="${cropped}" class="w-full h-full rounded-xl object-cover" />`;
          headerLogo.innerHTML = `<img src="${cropped}" class="w-full h-full rounded-xl object-cover" />`;
        }
        if (currentCropType === 'ad') {
          window.adData = cropped;
          adPreviewBox.innerHTML = `<img src="${cropped}" class="w-full h-full object-cover" />`;
          adPreviewBox.classList.remove('hidden');
          previewAd.src = cropped; 
          previewAd.classList.remove('hidden');
        }
        
        cropModal.classList.add('hidden'); 
        currentCropper.destroy(); 
        currentCropper = null; 
        showToast('Image cropped successfully');
      });
      
      cropCancelBtn.addEventListener('click', () => { 
        cropModal.classList.add('hidden'); 
        if (currentCropper) { 
          currentCropper.destroy(); 
          currentCropper = null; 
        } 
        if (currentCropType === 'logo') logoFile.value=''; 
        else if (currentCropType === 'ad') adFile.value=''; 
      });

      // Save settings
      const updateSettings = async () => {
        updateBtnText.classList.add('hidden'); 
        updateBtnSpinner.classList.remove('hidden'); 
        updateSettingsBtn.disabled = true;
        
        try {
          const updates = { 
            name: businessName.value, 
            introText: welcomeMessage.value 
          };
          
          if (logoPreview.src && logoPreview.src.startsWith('data:')) {
            updates.logo = logoPreview.src;
          }
          
          if (window.adData && typeof window.adData === 'string' && window.adData.startsWith('data:')) {
            updates.adImage = window.adData;
          }
          
          await set(ref(db, 'settings'), updates);
          
          // Save display settings separately
          await set(ref(db, 'displaySettings'), {
            smallText: displaySmallText.value || 'Digital Queue System',
            logoUrl: displayLogoUrl.value || '',
            mainTitle: displayMainTitle.value || 'Get your queue number'
          });
          
          showToast('Settings updated successfully!');
        } catch (err) { 
          console.error(err); 
          showToast('Failed to update settings', 'error'); 
        } finally { 
          updateBtnText.classList.remove('hidden'); 
          updateBtnSpinner.classList.add('hidden'); 
          updateSettingsBtn.disabled = false; 
        }
      };
      
      updateSettingsBtn.addEventListener('click', updateSettings);
      saveAllBtn.addEventListener('click', updateSettings);

      // Announcement with media support
      let selectedMediaFile = null;
      
      announcementMedia.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; 
        selectedMediaFile = file || null; 
        announcementPreview.innerHTML = ''; 
        announcementPreview.classList.add('hidden');
        
        if (file) {
          if (file.size > 50 * 1024 * 1024) { 
            showToast('File too large! Max 50MB', 'error'); 
            selectedMediaFile = null; 
            return; 
          }
          const url = URL.createObjectURL(file);
          if (file.type.startsWith('video/')) {
            const video = document.createElement('video'); 
            video.src = url; 
            video.controls = true; 
            video.className = 'w-full h-48 rounded-lg object-cover'; 
            announcementPreview.appendChild(video);
          } else if (file.type.startsWith('audio/')) {
            const audio = document.createElement('audio'); 
            audio.src = url; 
            audio.controls = true; 
            audio.className = 'w-full'; 
            announcementPreview.appendChild(audio);
          } else {
            const img = document.createElement('img'); 
            img.src = url; 
            img.className = 'w-full h-48 rounded-lg object-cover'; 
            announcementPreview.appendChild(img);
          }
          announcementPreview.classList.remove('hidden');
        }
      });

      sendAnnouncementBtn.addEventListener('click', async () => {
        const message = announcementMessage.value.trim();
        if (!message && !selectedMediaFile) { 
          showToast('Please enter a message or attach media', 'error'); 
          return; 
        }
        
        sendBtnText.classList.add('hidden'); 
        sendBtnSpinner.classList.remove('hidden'); 
        sendAnnouncementBtn.disabled = true;
        
        try {
          let mediaBase64 = '';
          let mediaType = '';
          if (selectedMediaFile) { 
            mediaBase64 = await fileToBase64(selectedMediaFile); 
            mediaType = selectedMediaFile.type; 
          }
          
          const res = await fetch('/.netlify/functions/announce', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ message, media: mediaBase64, mediaType }) 
          });
          
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to send');
          
          announcementResult.className = 'p-3 rounded-lg text-sm bg-green-50 text-green-700 border border-green-200';
          announcementResult.textContent = '‚úÖ ' + (result.message || 'Announcement sent successfully!');
          announcementMessage.value=''; 
          announcementMedia.value=''; 
          announcementPreview.innerHTML=''; 
          announcementPreview.classList.add('hidden'); 
          selectedMediaFile = null; 
          showToast('Announcement sent!');
        } catch (error) {
          console.error('Announcement error:', error);
          announcementResult.className = 'p-3 rounded-lg text-sm bg-red-50 text-red-700 border border-red-200';
          announcementResult.textContent = '‚ö†Ô∏è ' + (error.message || 'Failed to send announcement');
          showToast('Failed to send announcement', 'error');
        } finally {
          announcementResult.classList.remove('hidden');
          sendBtnText.classList.remove('hidden'); 
          sendBtnSpinner.classList.add('hidden'); 
          sendAnnouncementBtn.disabled = false;
          setTimeout(() => announcementResult.classList.add('hidden'), 5000);
        }
      });
    </script>
  </body>
</html>
