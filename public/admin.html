<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QueueJoy Admin ‚Äî Real-Time Queue Management</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: 264 83% 62%;
      --accent: 197 92% 44%;
      --muted: 220 14% 56%;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      -webkit-font-smoothing: antialiased;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(10, 10, 30, 0.08);
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid hsl(var(--primary));
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4 pb-20">
  
  <div class="max-w-6xl mx-auto space-y-6 fade-in">
    
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div id="headerLogo" class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white text-xl font-bold shadow-lg">
          QJ
        </div>
        <div>
          <h1 id="headerName" class="text-2xl font-bold text-gray-800">Queue Joy Admin</h1>
          <p class="text-sm text-gray-600">Real-time management dashboard</p>
        </div>
      </div>
      <button id="saveAllBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
        üíæ Save All Changes
      </button>
    </header>

    <!-- Analytics Panel -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-2">Total Queues</p>
            <p id="totalQueues" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-xl">
            üìä
          </div>
        </div>
      </div>
      
      <div class="card p-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-2">Active Queues</p>
            <p id="activeQueues" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-xl">
            üé´
          </div>
        </div>
      </div>
      
      <div class="card p-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-2">Today's Queues</p>
            <p id="todayQueues" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white text-xl">
            üìà
          </div>
        </div>
      </div>
      
      <div class="card p-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-600 mb-2">Active Counters</p>
            <p id="activeCounters" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white text-xl">
            üè™
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Business Settings Card -->
      <div class="card p-6 space-y-5">
        <h2 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Business Settings</h2>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
          <input 
            id="businessName" 
            type="text" 
            placeholder="Your Business Name"
            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Message</label>
          <textarea 
            id="welcomeMessage" 
            rows="3"
            placeholder="Real-time queueing system. Mobile-friendly. No app needed."
            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"
          ></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Logo Image</label>
          <div class="flex items-center gap-3">
            <img id="logoPreview" src="" alt="Logo" class="w-16 h-16 rounded-lg object-cover border-2 border-gray-200 hidden" />
            <div class="flex-1">
              <input 
                id="logoFile" 
                type="file" 
                accept="image/*"
                class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"
              />
            </div>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Advertisement Banner</label>
          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <img id="adPreview" src="" alt="Ad" class="w-32 h-20 rounded-lg object-cover border-2 border-gray-200 hidden" />
              <div class="flex-1">
                <input 
                  id="adFile" 
                  type="file" 
                  accept="image/*"
                  class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"
                />
              </div>
            </div>
            <textarea 
              id="adText" 
              rows="2"
              placeholder="Advertisement text (optional)"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"
            ></textarea>
          </div>
        </div>
        
        <button id="updateSettingsBtn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
          <span id="updateBtnText">‚ú® Update Settings</span>
          <span id="updateBtnSpinner" class="hidden">
            <span class="spinner"></span> Updating...
          </span>
        </button>
      </div>

      <!-- Announcement Panel -->
      <div class="space-y-6">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üì¢ Telegram Announcement</h2>
          
          <div class="space-y-4">
            <textarea 
              id="announcementMessage" 
              rows="5"
              placeholder="Type your announcement message here..."
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"
            ></textarea>
            
            <button id="sendAnnouncementBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300">
              <span id="sendBtnText">üì± Send to Telegram</span>
              <span id="sendBtnSpinner" class="hidden">
                <span class="spinner"></span> Sending...
              </span>
            </button>
            
            <div id="announcementResult" class="hidden p-3 rounded-lg text-sm"></div>
          </div>
        </div>

        <!-- Live Preview Card -->
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üëÅÔ∏è Live Preview</h2>
          
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <div id="previewLogo" class="w-14 h-14 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">
                QJ
              </div>
              <div class="flex-1">
                <p id="previewName" class="text-lg font-bold text-gray-800">Your Business</p>
                <p id="previewIntro" class="text-sm text-gray-600">Real-time queueing system</p>
              </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-xs text-gray-500 mb-2">Advertisement Preview</p>
              <div class="flex items-center gap-3">
                <img id="previewAd" src="" alt="Ad" class="w-24 h-16 rounded-lg object-cover border hidden" />
                <p id="previewAdText" class="text-sm text-gray-700">No advertisement</p>
              </div>
            </div>
            
            <button class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl opacity-75 cursor-not-allowed">
              üé´ Get My Number
            </button>
            <p class="text-xs text-center text-gray-500">This is how customers see your page</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-sm text-gray-500 mt-8">
      <p>Real-time sync powered by Firebase ‚Ä¢ <span id="slugDisplay" class="font-mono text-purple-600"></span></p>
    </footer>
  </div>

  <!-- Firebase & App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Auto-detect slug from URL
    const pathname = window.location.pathname;
    const pathParts = pathname.split('/').filter(p => p);
    const slug = pathParts.length > 0 && pathParts[0] !== 'admin.html' ? pathParts[0] : '';
    
    document.getElementById('slugDisplay').textContent = slug ? `businesses/${slug}` : 'global settings';

    // Helper to get Firebase path
    const getPath = (key) => {
      if (slug) return `businesses/${slug}/settings/${key}`;
      return `settings/${key}`;
    };

    // Toast notification
    const showToast = (message, type = 'success') => {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
      toast.textContent = type === 'success' ? `‚úÖ ${message}` : `‚ö†Ô∏è ${message}`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    // File to Base64
    const fileToBase64 = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    // DOM Elements
    const businessName = document.getElementById('businessName');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const logoFile = document.getElementById('logoFile');
    const logoPreview = document.getElementById('logoPreview');
    const adFile = document.getElementById('adFile');
    const adPreview = document.getElementById('adPreview');
    const adText = document.getElementById('adText');
    const updateSettingsBtn = document.getElementById('updateSettingsBtn');
    const updateBtnText = document.getElementById('updateBtnText');
    const updateBtnSpinner = document.getElementById('updateBtnSpinner');
    const saveAllBtn = document.getElementById('saveAllBtn');
    
    const previewName = document.getElementById('previewName');
    const previewIntro = document.getElementById('previewIntro');
    const previewLogo = document.getElementById('previewLogo');
    const previewAd = document.getElementById('previewAd');
    const previewAdText = document.getElementById('previewAdText');
    const headerLogo = document.getElementById('headerLogo');
    const headerName = document.getElementById('headerName');
    
    const announcementMessage = document.getElementById('announcementMessage');
    const sendAnnouncementBtn = document.getElementById('sendAnnouncementBtn');
    const sendBtnText = document.getElementById('sendBtnText');
    const sendBtnSpinner = document.getElementById('sendBtnSpinner');
    const announcementResult = document.getElementById('announcementResult');

    // Real-time Analytics
    const totalQueuesEl = document.getElementById('totalQueues');
    const activeQueuesEl = document.getElementById('activeQueues');
    const todayQueuesEl = document.getElementById('todayQueues');
    const activeCountersEl = document.getElementById('activeCounters');

    onValue(ref(db, 'queue'), (snapshot) => {
      if (snapshot.exists()) {
        const queues = Object.values(snapshot.val());
        totalQueuesEl.textContent = queues.length;
        activeQueuesEl.textContent = queues.filter(q => q.status === 'waiting').length;
        
        const today = new Date().setHours(0, 0, 0, 0);
        const todayCount = queues.filter(q => {
          const queueDate = new Date(q.timestamp).setHours(0, 0, 0, 0);
          return queueDate === today;
        }).length;
        todayQueuesEl.textContent = todayCount;
      } else {
        totalQueuesEl.textContent = '0';
        activeQueuesEl.textContent = '0';
        todayQueuesEl.textContent = '0';
      }
    });

    onValue(ref(db, 'counters'), (snapshot) => {
      if (snapshot.exists()) {
        const counters = Object.values(snapshot.val());
        activeCountersEl.textContent = counters.filter(c => c.active).length;
      } else {
        activeCountersEl.textContent = '0';
      }
    });

    // Real-time Settings Sync
    onValue(ref(db, getPath('name')), (snap) => {
      if (snap.exists()) {
        const val = snap.val();
        businessName.value = val;
        previewName.textContent = val;
        headerName.textContent = val;
      }
    });

    onValue(ref(db, getPath('introText')), (snap) => {
      if (snap.exists()) {
        const val = snap.val();
        welcomeMessage.value = val;
        previewIntro.textContent = val;
      }
    });

    onValue(ref(db, getPath('logo')), (snap) => {
      if (snap.exists()) {
        const val = snap.val();
        logoPreview.src = val;
        logoPreview.classList.remove('hidden');
        previewLogo.innerHTML = `<img src="${val}" class="w-full h-full rounded-xl object-cover" />`;
        headerLogo.innerHTML = `<img src="${val}" class="w-full h-full rounded-xl object-cover" />`;
      }
    });

    onValue(ref(db, getPath('adImage')), (snap) => {
      if (snap.exists()) {
        const val = snap.val();
        adPreview.src = val;
        adPreview.classList.remove('hidden');
        previewAd.src = val;
        previewAd.classList.remove('hidden');
      } else {
        adPreview.classList.add('hidden');
        previewAd.classList.add('hidden');
      }
    });

    onValue(ref(db, getPath('adText')), (snap) => {
      if (snap.exists()) {
        const val = snap.val();
        adText.value = val;
        previewAdText.textContent = val || 'No advertisement';
      }
    });

    // File Upload Handlers
    logoFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (file) {
        try {
          const base64 = await fileToBase64(file);
          logoPreview.src = base64;
          logoPreview.classList.remove('hidden');
          previewLogo.innerHTML = `<img src="${base64}" class="w-full h-full rounded-xl object-cover" />`;
          headerLogo.innerHTML = `<img src="${base64}" class="w-full h-full rounded-xl object-cover" />`;
        } catch (err) {
          showToast('Failed to process logo image', 'error');
        }
      }
    });

    adFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (file) {
        try {
          const base64 = await fileToBase64(file);
          adPreview.src = base64;
          adPreview.classList.remove('hidden');
          previewAd.src = base64;
          previewAd.classList.remove('hidden');
        } catch (err) {
          showToast('Failed to process ad image', 'error');
        }
      }
    });

    // Update Settings
    const updateSettings = async () => {
      updateBtnText.classList.add('hidden');
      updateBtnSpinner.classList.remove('hidden');
      updateSettingsBtn.disabled = true;

      try {
        const updates = [];
        
        if (businessName.value) {
          updates.push(set(ref(db, getPath('name')), businessName.value));
        }
        
        if (welcomeMessage.value) {
          updates.push(set(ref(db, getPath('introText')), welcomeMessage.value));
        }
        
        if (adText.value) {
          updates.push(set(ref(db, getPath('adText')), adText.value));
        }
        
        if (logoPreview.src && logoPreview.src.startsWith('data:')) {
          updates.push(set(ref(db, getPath('logo')), logoPreview.src));
        }
        
        if (adPreview.src && adPreview.src.startsWith('data:')) {
          updates.push(set(ref(db, getPath('adImage')), adPreview.src));
        }

        await Promise.all(updates);
        showToast('Settings updated successfully!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to update settings', 'error');
      } finally {
        updateBtnText.classList.remove('hidden');
        updateBtnSpinner.classList.add('hidden');
        updateSettingsBtn.disabled = false;
      }
    };

    updateSettingsBtn.addEventListener('click', updateSettings);
    saveAllBtn.addEventListener('click', updateSettings);

    // Send Telegram Announcement
    sendAnnouncementBtn.addEventListener('click', async () => {
      const message = announcementMessage.value.trim();
      
      if (!message) {
        announcementResult.textContent = '‚ö†Ô∏è Please enter a message';
        announcementResult.className = 'p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800';
        announcementResult.classList.remove('hidden');
        return;
      }

      sendBtnText.classList.add('hidden');
      sendBtnSpinner.classList.remove('hidden');
      sendAnnouncementBtn.disabled = true;

      try {
        const response = await fetch('/.netlify/functions/announce', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (response.ok) {
          announcementResult.textContent = '‚úÖ Announcement sent successfully!';
          announcementResult.className = 'p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-800';
          announcementMessage.value = '';
          showToast('Announcement sent!', 'success');
        } else {
          throw new Error('Failed to send announcement');
        }
      } catch (err) {
        console.error(err);
        announcementResult.textContent = '‚ö†Ô∏è Failed to send announcement. Please try again.';
        announcementResult.className = 'p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-800';
        showToast('Failed to send announcement', 'error');
      } finally {
        announcementResult.classList.remove('hidden');
        sendBtnText.classList.remove('hidden');
        sendBtnSpinner.classList.add('hidden');
        sendAnnouncementBtn.disabled = false;
        
        setTimeout(() => {
          announcementResult.classList.add('hidden');
        }, 5000);
      }
    });

  </script>
</body>
</html>
