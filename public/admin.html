<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QueueJoy Admin ‚Äî Real-Time Queue Management</title>
  <meta name="description" content="QueueJoy Admin Panel - Manage queues, announcements, and analytics in real-time" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root { --primary: 264 83% 62%; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; background: linear-gradient(135deg,#667eea 0%,#764ba2 25%,#f093fb 50%,#4facfe 75%,#00f2fe 100%); background-size:400% 400%; animation: gradientShift 15s linear infinite; }
    @keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .card{background:rgba(255,255,255,0.95);backdrop-filter:blur(18px);border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.35)}
    .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:12px;color:white;z-index:1000}
    .spinner{border:2px solid rgba(255,255,255,0.3);border-top:2px solid hsl(var(--primary));border-radius:50%;width:18px;height:18px;animation:spin .8s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sidebar{position:fixed;left:0;top:0;height:100vh;width:260px;background:linear-gradient(180deg,rgba(99,102,241,0.95),rgba(139,92,246,0.95));padding:18px;box-shadow:8px 0 40px rgba(0,0,0,0.15)}
    .main-content{margin-left:260px;padding:28px;min-height:100vh}
    @media(max-width:1024px){.main-content{margin-left:0}}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="mb-6">
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-white font-bold">QJ</div>
        <h1 class="text-white text-xl font-bold">QueueJoy</h1>
      </div>
      <p class="text-white/80 text-sm">Admin Panel</p>
    </div>
    <nav class="space-y-2">
      <div class="block p-3 text-white bg-white/10 rounded-md" id="navDashboard">üè† Dashboard</div>
      <div class="block p-3 text-white hover:bg-white/10 rounded-md" id="navAnalyst">üìä Analytics</div>
      <div class="block p-3 text-white hover:bg-white/10 rounded-md" id="navHowTo">‚ùì How to Use</div>
    </nav>
  </aside>

  <!-- Main -->
  <div class="main-content">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <header class="flex items-center justify-between gap-6 mb-8 mt-6">
        <div class="flex items-center gap-4">
          <div id="headerLogo" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white font-bold">QJ</div>
          <div>
            <h2 id="headerName" class="text-2xl font-bold text-gray-900">QueueJoy Admin</h2>
            <p class="text-sm text-gray-600">Real-time management dashboard</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button id="saveAllBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg">üíæ Save All Changes</button>
        </div>
      </header>

      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card">
          <p class="text-sm text-gray-600">Total Queues</p>
          <p id="totalQueues" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="card">
          <p class="text-sm text-gray-600">Active (Waiting)</p>
          <p id="waitingCount" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="card">
          <p class="text-sm text-gray-600">Average Wait Time</p>
          <p id="avgWait" class="text-3xl font-bold mt-2">0 min</p>
        </div>
        <div class="card">
          <p class="text-sm text-gray-600">Active Counters</p>
          <p id="activeCounters" class="text-3xl font-bold mt-2">0</p>
        </div>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Settings -->
        <div class="card space-y-6">
          <h3 class="text-xl font-bold">‚öôÔ∏è Business Settings</h3>

          <div>
            <label class="text-sm text-gray-700">Business Name</label>
            <input id="businessName" class="w-full mt-2 p-3 rounded border" placeholder="Your Business Name" />
          </div>

          <div>
            <label class="text-sm text-gray-700">Welcome Message</label>
            <textarea id="welcomeMessage" rows="3" class="w-full mt-2 p-3 rounded border" placeholder="Real-time queueing system..."></textarea>
          </div>

          <div>
            <label class="text-sm text-gray-700">Logo (crop)</label>
            <div class="flex gap-3 items-center mt-2">
              <img id="logoPreview" src="" class="w-16 h-16 rounded object-cover hidden" alt="logo" />
              <input id="logoFile" type="file" accept="image/*" />
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-700">Ad Banner (crop)</label>
            <div class="mt-2 flex gap-3 items-center">
              <div id="adPreviewBox" class="w-32 h-20 rounded overflow-hidden hidden"></div>
              <input id="adFile" type="file" accept="image/*,video/*" />
            </div>
          </div>

          <div>
            <button id="updateSettingsBtn" class="w-full p-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded">‚ú® Update Settings</button>
          </div>
        </div>

        <!-- Right: Display & Announcement & Preview -->
        <div class="space-y-6">
          <div class="card">
            <h3 class="text-xl font-bold">üñ•Ô∏è Display Settings</h3>
            <div class="mt-3 space-y-3">
              <div>
                <label class="text-sm text-gray-700">Small Text (Subtitle)</label>
                <input id="displaySmallText" class="w-full mt-2 p-2 rounded border" placeholder="Digital Queue System" />
              </div>
              <div>
                <label class="text-sm text-gray-700">Logo URL (Centered)</label>
                <input id="displayLogoUrl" class="w-full mt-2 p-2 rounded border" placeholder="https://.../logo.png" />
              </div>
              <div>
                <label class="text-sm text-gray-700">Main Title</label>
                <input id="displayMainTitle" class="w-full mt-2 p-2 rounded border" placeholder="Get your queue number" />
              </div>
              <p class="text-xs text-gray-500 mt-2">Saves to <code>/displaySettings</code>. Index page reads this for live updates.</p>
            </div>
          </div>

          <div class="card">
            <h3 class="text-xl font-bold">üì¢ Telegram Announcement</h3>
            <textarea id="announcementMessage" class="w-full mt-2 p-3 rounded border" rows="3" placeholder="Announcement..."></textarea>
            <div class="mt-3 flex gap-3 items-start">
              <input id="announcementMedia" type="file" accept="image/*,video/*,.gif" />
              <div id="announcementPreview" class="hidden"></div>
            </div>
            <div class="mt-3">
              <button id="sendAnnouncementBtn" class="p-2 bg-green-600 text-white rounded">üì± Send to Telegram</button>
              <div id="announcementResult" class="mt-2 text-sm hidden"></div>
            </div>
          </div>

          <div class="card">
            <h3 class="text-xl font-bold">üëÅÔ∏è Live Preview</h3>
            <div class="flex items-center gap-3 mt-3">
              <div id="previewLogo" class="w-14 h-14 rounded bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white">QJ</div>
              <div>
                <p id="previewName" class="font-bold">Your Business</p>
                <p id="previewIntro" class="text-sm text-gray-600">Real-time queueing system</p>
              </div>
            </div>
            <div class="mt-3">
              <p class="text-xs text-gray-500 mb-2">Advertisement Preview</p>
              <img id="previewAd" src="" class="w-32 h-20 rounded object-cover hidden" alt="ad" />
            </div>
          </div>
        </div>
      </div>

      <!-- Analyst View (hidden by default) -->
      <div id="analystArea" class="card mt-8 hidden">
        <h3 class="text-xl font-bold mb-4">üìä Analytics Dashboard</h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="font-bold mb-2">Queue Trend (Last 7 Days)</h4>
            <canvas id="queueTrendChart" height="120"></canvas>
          </div>

          <div class="card">
            <h4 class="font-bold mb-2">Counter Performance (served per counter)</h4>
            <canvas id="counterPerfChart" height="120"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-6">
          <div class="card">
            <p class="text-sm text-gray-600">Completed</p>
            <p id="completedCount" class="text-2xl font-bold mt-2">0</p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-600">Waiting</p>
            <p id="waitingCount2" class="text-2xl font-bold mt-2">0</p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-600">Serving</p>
            <p id="servingCount" class="text-2xl font-bold mt-2">0</p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-600">Cancelled</p>
            <p id="cancelledCount" class="text-2xl font-bold mt-2">0</p>
          </div>
        </div>
      </div>

      <footer class="mt-8 text-center text-sm text-gray-600">üî• Live sync with Firebase ‚Äî changes update index.html in real time</footer>
    </div>
  </div>

  <!-- Crop Modal -->
  <div id="cropModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-40">
    <div class="bg-white p-4 rounded-lg max-w-xl w-full">
      <h4 class="font-bold mb-3">Crop Image</h4>
      <div class="mb-3"><img id="cropImage" src="" style="max-width:100%" /></div>
      <div class="flex gap-3 justify-end">
        <button id="cropCancelBtn" class="px-3 py-2 bg-gray-200 rounded">Cancel</button>
        <button id="cropSaveBtn" class="px-3 py-2 bg-purple-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // helpers
    const $ = (id) => document.getElementById(id);
    const showToast = (msg, ok=true) => {
      const t = document.createElement('div');
      t.className = 'toast';
      t.style.background = ok ? 'linear-gradient(90deg,#16a34a,#059669)' : 'linear-gradient(90deg,#dc2626,#ef4444)';
      t.textContent = (ok ? '‚úÖ ' : '‚ö†Ô∏è ') + msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3500);
    };
    const fileToBase64 = (file) => new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });

    // elements
    const businessName = $('businessName');
    const welcomeMessage = $('welcomeMessage');
    const logoFile = $('logoFile');
    const logoPreview = $('logoPreview');
    const adFile = $('adFile');
    const adPreviewBox = $('adPreviewBox');
    const updateSettingsBtn = $('updateSettingsBtn');
    const saveAllBtn = $('saveAllBtn');

    const displaySmallText = $('displaySmallText');
    const displayLogoUrl = $('displayLogoUrl');
    const displayMainTitle = $('displayMainTitle');

    const previewName = $('previewName');
    const previewIntro = $('previewIntro');
    const previewLogo = $('previewLogo');
    const previewAd = $('previewAd');

    const announcementMessage = $('announcementMessage');
    const announcementMedia = $('announcementMedia');
    const announcementPreview = $('announcementPreview');
    const sendAnnouncementBtn = $('sendAnnouncementBtn');

    const totalQueuesEl = $('totalQueues');
    const waitingCountEl = $('waitingCount');
    const activeCountersEl = $('activeCounters');
    const avgWaitEl = $('avgWait');

    // analyst
    const analystArea = $('analystArea');
    const navAnalyst = document.getElementById('navAnalyst');
    const navDashboard = document.getElementById('navDashboard');
    const navHowTo = document.getElementById('navHowTo');

    const completedCountEl = $('completedCount');
    const waitingCount2El = $('waitingCount2');
    const servingCountEl = $('servingCount');
    const cancelledCountEl = $('cancelledCount');

    // charts
    let queueTrendChart = null;
    let counterPerfChart = null;

    function initCharts() {
      if (!queueTrendChart) {
        const ctx = document.getElementById('queueTrendChart').getContext('2d');
        queueTrendChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [{ label: 'Queues', data: [], tension: 0.35, fill: true, backgroundColor: 'rgba(99,102,241,0.12)', borderColor: 'rgb(99,102,241)' }] },
          options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      }
      if (!counterPerfChart) {
        const ctx2 = document.getElementById('counterPerfChart').getContext('2d');
        counterPerfChart = new Chart(ctx2, {
          type: 'bar',
          data: { labels: [], datasets: [{ label: 'Served', data: [], backgroundColor: [] }] },
          options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      }
    }

    // Utility: format minutes nicely
    function humanizeMinutes(mins) {
      if (!isFinite(mins) || mins <= 0) return '0 min';
      if (mins < 60) return `${Math.round(mins)} min`;
      const hours = mins / 60;
      if (hours < 24) return `${(hours).toFixed(1)} hr`;
      const days = hours / 24;
      return `${days.toFixed(1)} day`;
    }

    // Apply display settings to preview
    function applyDisplaySettings(obj={}) {
      const smallText = obj.smallText ?? obj.displaySmallText ?? obj.name ?? '';
      const logoUrl = obj.logoUrl ?? obj.displayLogoUrl ?? obj.logo ?? '';
      const mainTitle = obj.mainTitle ?? obj.displayMainTitle ?? obj.introText ?? '';

      if (smallText) { displaySmallText.value = smallText; previewName.textContent = smallText; }
      if (mainTitle) { displayMainTitle.value = mainTitle; previewIntro.textContent = mainTitle; }
      if (logoUrl) { displayLogoUrl.value = logoUrl; previewLogo.innerHTML = `<img src="${logoUrl}" class="w-full h-full object-cover rounded" />`; previewLogo.classList.remove('hidden'); }
    }

    // Read existing settings (live)
    onValue(ref(db, 'settings/name'), snap => {
      if (!snap.exists()) return;
      businessName.value = snap.val();
      previewName.textContent = snap.val();
      $('headerName')?.textContent = snap.val();
    });
    onValue(ref(db, 'settings/introText'), snap => {
      if (!snap.exists()) return;
      welcomeMessage.value = snap.val();
      previewIntro.textContent = snap.val();
    });
    onValue(ref(db, 'settings/logo'), snap => {
      if (!snap.exists()) return;
      const v = snap.val();
      logoPreview.src = v; logoPreview.classList.remove('hidden');
      previewLogo.innerHTML = `<img src="${v}" class="w-full h-full object-cover rounded" />`;
      headerLogo.innerHTML = `<img src="${v}" class="w-full h-full object-cover rounded" />`;
    });

    // displaySettings (primary for display)
    onValue(ref(db, 'displaySettings'), snap => {
      if (!snap.exists()) return;
      applyDisplaySettings(snap.val());
    });

    // ad image
    onValue(ref(db, 'settings/adImage'), snap => {
      if (!snap.exists()) { adPreviewBox.classList.add('hidden'); previewAd.classList.add('hidden'); return; }
      const v = snap.val();
      if (typeof v === 'string' && v.startsWith('data:video/')) {
        adPreviewBox.innerHTML = `<video src="${v}" class="w-full h-full object-cover" controls></video>`;
      } else {
        adPreviewBox.innerHTML = `<img src="${v}" class="w-full h-full object-cover" />`;
      }
      adPreviewBox.classList.remove('hidden');
      previewAd.src = v; previewAd.classList.remove('hidden');
    });

    // Queue analytics listener (robust)
    onValue(ref(db, 'queue'), snap => {
      const raw = snap.exists() ? snap.val() : {};
      // raw is object keyed by push-id => { queueId, timestamp, status, counterId, ... }
      const items = Object.keys(raw).map(k => ({ id:k, ...(raw[k]||{}) }));

      // counts
      const counts = { waiting:0, serving:0, completed:0, cancelled:0 };
      const waitingTimestamps = [];
      const completedPerCounter = {}; // served by counterId
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      let todayCount = 0;

      // Build last7 days buckets (YYYY-MM-DD)
      const buckets = {};
      for (let i=6;i>=0;i--) {
        const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        buckets[key] = 0;
      }

      items.forEach(item => {
        const status = String(item.status || '').toLowerCase();
        const ts = Number(item.timestamp || item.time || 0) || (item.timestamp && Date.parse(item.timestamp) ? Date.parse(item.timestamp) : 0);
        // status mapping
        if (status === 'waiting' || status === 'pending') { counts.waiting++; if (ts) waitingTimestamps.push(ts); }
        else if (status === 'serving' || status === 'called' || status === 'in-service') { counts.serving++; if (ts) waitingTimestamps.push(ts); }
        else if (status === 'done' || status === 'served' || status === 'completed') { counts.completed++; if (item.counterId) completedPerCounter[item.counterId] = (completedPerCounter[item.counterId]||0) + 1; }
        else if (status === 'cancelled' || status === 'canceled') { counts.cancelled++; }

        if (ts) {
          const key = new Date(ts).toISOString().slice(0,10);
          if (key in buckets) buckets[key] += 1;
          if (new Date(ts).setHours(0,0,0,0) === todayStart.getTime()) todayCount++;
        }
      });

      // totals
      totalQueuesEl.textContent = String(items.length || 0);
      waitingCountEl.textContent = String(counts.waiting || 0);
      $('waitingCount2').textContent = String(counts.waiting || 0);
      servingCountEl.textContent = String(counts.serving || 0);
      completedCountEl.textContent = String(counts.completed || 0);
      cancelledCountEl.textContent = String(counts.cancelled || 0);

      // average wait in minutes from waiting items
      const now = Date.now();
      const minsArray = waitingTimestamps.map(t => (now - Number(t)) / 60000).filter(n => isFinite(n) && n >= 0);
      const avg = minsArray.length ? (minsArray.reduce((a,b)=>a+b,0)/minsArray.length) : 0;
      avgWaitEl.textContent = humanizeMinutes(avg);

      // Build last7 arrays for chart
      const labels = Object.keys(buckets).map(k => k.slice(5)); // MM-DD
      const data = Object.keys(buckets).map(k => buckets[k]);

      initCharts();
      if (queueTrendChart) {
        queueTrendChart.data.labels = labels;
        queueTrendChart.data.datasets[0].data = data;
        queueTrendChart.update();
      }

      // Counter performance: if counters node exists, we'll use served counts derived from queue + fallback to lastIssued
      // We'll fetch counters once and merge served counts with lastIssued if available
      get(ref(db, 'counters')).then(countersSnap => {
        const cdata = countersSnap.exists() ? countersSnap.val() : {};
        const keys = Object.keys(cdata || {});
        const labelsC = [];
        const dataC = [];
        const colors = [];
        keys.forEach((k, idx) => {
          const c = cdata[k] || {};
          labelsC.push(c.name || (c.prefix ? `Counter ${c.prefix}` : `Counter ${idx+1}`));
          // prefer computed served count if present otherwise fallback to lastIssued or 0
          const served = completedPerCounter[k] || c.servedCount || c.lastIssued || 0;
          dataC.push(served);
          const palette = ['rgba(99,102,241,0.85)','rgba(168,85,247,0.85)','rgba(236,72,153,0.85)','rgba(59,130,246,0.85)','rgba(16,185,129,0.85)'];
          colors.push(palette[idx % palette.length]);
        });
        if (counterPerfChart) {
          counterPerfChart.data.labels = labelsC;
          counterPerfChart.data.datasets[0].data = dataC;
          counterPerfChart.data.datasets[0].backgroundColor = colors;
          counterPerfChart.update();
        }
        activeCountersEl.textContent = String(keys.filter(k=>cdata[k] && cdata[k].active).length || 0);
      }).catch(err=>{
        console.error('counters read error', err);
        activeCountersEl.textContent = '0';
      });
    }, err => {
      console.error('queue listener error', err);
    });

    // Counters listener for active counters in header (fallback)
    onValue(ref(db, 'counters'), snap => {
      if (!snap.exists()) { activeCountersEl.textContent = '0'; return; }
      const obj = snap.val();
      const arr = Object.values(obj || {});
      activeCountersEl.textContent = String(arr.filter(x => x && x.active).length || 0);
    });

    // Image cropping (Cropper)
    let currentCropper = null;
    let currentCropType = ''; // 'logo' or 'ad'
    const cropModal = document.getElementById('cropModal');
    const cropImage = document.getElementById('cropImage');
    const cropSaveBtn = document.getElementById('cropSaveBtn');
    const cropCancelBtn = document.getElementById('cropCancelBtn');
    let adData = '';

    logoFile.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      currentCropType = 'logo';
      const b64 = await fileToBase64(f);
      cropImage.src = b64;
      cropModal.classList.remove('hidden');
      if (currentCropper) currentCropper.destroy();
      currentCropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2, autoCropArea: 1 });
    });

    adFile.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      if (f.size > 50*1024*1024) { showToast('File too large (50MB max)', false); return; }
      const b64 = await fileToBase64(f);
      const t = f.type || '';
      if (t.startsWith('video/')) {
        adData = b64;
        adPreviewBox.innerHTML = `<video src="${b64}" controls class="w-full h-full object-cover"></video>`;
        adPreviewBox.classList.remove('hidden');
        previewAd.src = b64; previewAd.classList.remove('hidden');
        return;
      }
      if (t === 'image/gif') {
        adData = b64;
        adPreviewBox.innerHTML = `<img src="${b64}" class="w-full h-full object-cover" />`;
        adPreviewBox.classList.remove('hidden');
        previewAd.src = b64; previewAd.classList.remove('hidden');
        return;
      }
      // else crop image
      currentCropType = 'ad';
      cropImage.src = b64;
      cropModal.classList.remove('hidden');
      if (currentCropper) currentCropper.destroy();
      currentCropper = new Cropper(cropImage, { aspectRatio: 16/9, viewMode: 2, autoCropArea: 1 });
    });

    cropSaveBtn.addEventListener('click', () => {
      if (!currentCropper) return;
      const canvas = currentCropper.getCroppedCanvas();
      const out = canvas.toDataURL('image/jpeg', 0.9);
      if (currentCropType === 'logo') {
        logoPreview.src = out; logoPreview.classList.remove('hidden');
        previewLogo.innerHTML = `<img src="${out}" class="w-full h-full object-cover rounded" />`;
        headerLogo.innerHTML = `<img src="${out}" class="w-full h-full object-cover rounded" />`;
      } else if (currentCropType === 'ad') {
        adData = out;
        adPreviewBox.innerHTML = `<img src="${out}" class="w-full h-full object-cover" />`;
        adPreviewBox.classList.remove('hidden');
        previewAd.src = out; previewAd.classList.remove('hidden');
      }
      cropModal.classList.add('hidden');
      currentCropper.destroy(); currentCropper = null;
      showToast('Image cropped');
    });

    cropCancelBtn.addEventListener('click', () => {
      cropModal.classList.add('hidden');
      if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
    });

    // Save settings (atomic update)
    updateSettingsBtn.addEventListener('click', async () => {
      const updates = {};
      updates['/settings/name'] = businessName.value || '';
      updates['/settings/introText'] = welcomeMessage.value || '';
      if (logoPreview.src && logoPreview.src.startsWith('data:')) updates['/settings/logo'] = logoPreview.src;
      if (adData) updates['/settings/adImage'] = adData;

      // display settings
      updates['/displaySettings/smallText'] = displaySmallText.value || (businessName.value || 'Digital Queue System');
      updates['/displaySettings/logoUrl'] = displayLogoUrl.value || (logoPreview.src && logoPreview.src.startsWith('http') ? logoPreview.src : '');
      updates['/displaySettings/mainTitle'] = displayMainTitle.value || (welcomeMessage.value || 'Get your queue number');

      try {
        update(ref(db, '/'), updates);
        showToast('Settings saved');
      } catch (err) {
        console.error('update error', err);
        showToast('Failed to save settings: ' + (err.message || err), false);
      }
    });

    saveAllBtn.addEventListener('click', () => updateSettingsBtn.click());

    // Announcement
    let selectedMedia = null;
    announcementMedia.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; selectedMedia = f || null;
      announcementPreview.innerHTML = ''; announcementPreview.classList.add('hidden');
      if (!f) return;
      if (f.size > 50*1024*1024) { showToast('Media too large (50MB max)', false); selectedMedia = null; return; }
      const url = URL.createObjectURL(f);
      if (f.type.startsWith('video/')) {
        announcementPreview.innerHTML = `<video src="${url}" controls class="w-48 h-32 object-cover"></video>`;
      } else {
        announcementPreview.innerHTML = `<img src="${url}" class="w-48 h-32 object-cover" />`;
      }
      announcementPreview.classList.remove('hidden');
    });

    sendAnnouncementBtn.addEventListener('click', async () => {
      const msg = announcementMessage.value.trim();
      if (!msg && !selectedMedia) { showToast('Please supply message or media', false); return; }
      sendAnnouncementBtn.disabled = true;
      try {
        let mediaBase64 = '';
        let mediaType = '';
        if (selectedMedia) { mediaBase64 = await fileToBase64(selectedMedia); mediaType = selectedMedia.type; }
        const res = await fetch('/.netlify/functions/announce', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: msg, media: mediaBase64, mediaType }) });
        const body = await res.json();
        if (!res.ok) throw new Error(body.error || 'Failed to send');
        showToast(body.message || 'Announcement sent');
        announcementMessage.value = ''; announcementMedia.value = ''; announcementPreview.innerHTML = ''; announcementPreview.classList.add('hidden'); selectedMedia = null;
      } catch (err) {
        console.error(err);
        showToast('Announcement failed: ' + (err.message || err), false);
      } finally { sendAnnouncementBtn.disabled = false; }
    });

    // Navigation toggles
    navAnalyst.addEventListener('click', () => {
      analystArea.classList.remove('hidden');
      window.scrollTo({ top: analystArea.offsetTop - 100, behavior: 'smooth' });
      initCharts();
    });
    navDashboard.addEventListener('click', () => {
      analystArea.classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    navHowTo.addEventListener('click', () => {
      alert('How to use: Upload/crop images, update display settings, send announcements. Index.html reads /displaySettings and /settings/* live.');
    });

    // Initialize charts area on load if needed
    function initCharts() {
      if (!queueTrendChart || !counterPerfChart) initChartsOnce();
    }
    function initChartsOnce() {
      if (!queueTrendChart) {
        const ctx = document.getElementById('queueTrendChart').getContext('2d');
        queueTrendChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{ label:'Queues', data:[], tension:0.35, backgroundColor:'rgba(99,102,241,0.12)', borderColor:'rgb(99,102,241)' }] }, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } } });
      }
      if (!counterPerfChart) {
        const ctx2 = document.getElementById('counterPerfChart').getContext('2d');
        counterPerfChart = new Chart(ctx2, { type:'bar', data:{ labels:[], datasets:[{ label:'Served', data:[], backgroundColor:[] }] }, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } } });
      }
    }

    // small safety: initialize charts now
    initChartsOnce();

    // humanize minutes used earlier
    function humanizeMinutes(mins) {
      if (!isFinite(mins) || mins <= 0) return '0 min';
      if (mins < 60) return `${Math.round(mins)} min`;
      const hrs = mins / 60;
      if (hrs < 24) return `${hrs.toFixed(1)} hr`;
      const days = hrs / 24;
      return `${days.toFixed(1)} day`;
    }
  </script>
</body>
</html>
