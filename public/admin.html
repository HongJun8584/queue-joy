<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueJoy - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .accent-blue { color: #0099ff; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 p-4 md:p-8">
    <!-- Header Bar -->
    <header class="flex items-center justify-between bg-white rounded-lg shadow p-4 mb-8">
        <div class="text-xl font-bold accent-blue">QueueJoy</div>
        <h1 class="text-xl font-semibold text-gray-800">Admin Panel</h1>
        <div id="storeIdDisplay" class="text-gray-600">Store ID: Loading...</div>
    </header>

    <div id="noStoreWarning" class="hidden bg-yellow-100 border-yellow-400 text-yellow-700 p-4 rounded-lg mb-8">
        ⚠️ No store ID found. Please access through your assigned QueueJoy link.
    </div>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-7xl mx-auto">
        <!-- Left Column: Form & Preview -->
        <div class="space-y-8">
            <!-- Customization Form -->
            <div class="bg-white rounded-2xl shadow p-6">
                <form id="customForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">System Name</label>
                        <input id="systemName" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="Padini Express">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Welcome Message</label>
                        <textarea id="introText" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="Welcome to our queue system!"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Logo</label>
                        <input id="logoUrl" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 mb-2" placeholder="https://example.com/logo.png">
                        <input id="logoUpload" type="file" accept="image/*" class="w-full text-sm text-gray-600 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700">
                        <div id="logoPreview" class="mt-4 hidden">
                            <img id="logoImg" src="" alt="Logo Preview" class="max-h-32 rounded-lg shadow">
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl shadow hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span>✅ Save Changes</span>
                    </button>
                </form>
                <p class="text-sm text-gray-500 mt-4">Your changes apply instantly to your queue system.</p>
            </div>

            <!-- Live Preview -->
            <div class="bg-white rounded-2xl shadow p-6">
                <h2 class="text-lg font-medium text-gray-800 mb-4">Live Preview</h2>
                <div id="previewBox" class="border border-gray-200 rounded-lg p-4 space-y-4">
                    <div class="flex items-center gap-4">
                        <img id="previewLogo" src="" alt="Logo" class="h-16 hidden">
                        <h3 id="previewName" class="text-xl font-bold accent-blue">System Name</h3>
                    </div>
                    <p id="previewIntro" class="text-gray-600">Welcome message here.</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Ads -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-lg font-medium text-gray-800 mb-4">QueueJoy Updates & Upgrades</h2>
            <div id="adsList" class="space-y-6"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-8 text-center text-sm text-gray-500">
        Powered by QueueJoy • v1.0.0 • <a href="mailto:support@queuejoy.io" class="accent-blue hover:underline">Support</a>
    </footer>

    <div id="saveToast" class="hidden fixed bottom-8 right-8 bg-green-500 text-white p-4 rounded-lg shadow-lg">✅ Settings saved successfully.</div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
            authDomain: "queue-joy-aa21b.firebaseapp.com",
            databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "queue-joy-aa21b",
            storageBucket: "queue-joy-aa21b.appspot.com",
            messagingSenderId: "950240394209",
            appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const urlParams = new URLSearchParams(window.location.search);
        const storeId = urlParams.get('store');

        if (!storeId) {
            document.getElementById('noStoreWarning').classList.remove('hidden');
            return;
        }

        document.getElementById('storeIdDisplay').textContent = `Store ID: ${storeId}`;

        const settingsRef = ref(db, `stores/${storeId}/settings`);
        const adsRef = ref(db, 'ads/active');

        // Load settings
        get(settingsRef).then(snap => {
            if (snap.exists()) {
                const data = snap.val();
                document.getElementById('systemName').value = data.systemName || '';
                document.getElementById('introText').value = data.introText || '';
                document.getElementById('logoUrl').value = data.logoUrl || '';
                updatePreview(data);
            }
        });

        // Load ads
        get(adsRef).then(snap => {
            if (snap.exists()) {
                const ads = snap.val();
                const adsList = document.getElementById('adsList');
                ads.forEach(ad => {
                    const adDiv = document.createElement('div');
                    adDiv.className = 'space-y-2 border-b pb-4 last:border-0';
                    adDiv.innerHTML = `
                        <img src="${ad.image}" alt="${ad.title}" class="w-full rounded-lg">
                        <h3 class="font-semibold">${ad.title}</h3>
                        <p class="text-sm text-gray-600">${ad.message}</p>
                        <a href="${ad.link}" class="inline-block py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Upgrade Now</a>
                    `;
                    adsList.appendChild(adDiv);
                });
            }
        });

        // Form submit
        document.getElementById('customForm').addEventListener('submit', async e => {
            e.preventDefault();
            const systemName = document.getElementById('systemName').value.trim();
            const introText = document.getElementById('introText').value.trim();
            let logoUrl = document.getElementById('logoUrl').value.trim();

            if (!systemName || !introText) return alert('Please fill required fields.');

            if (document.getElementById('logoUpload').files[0]) {
                const file = document.getElementById('logoUpload').files[0];
                const logoRef = sRef(storage, `stores/${storeId}/logo_${Date.now()}`);
                await uploadBytes(logoRef, file);
                logoUrl = await getDownloadURL(logoRef);
            }

            const updates = { systemName, introText, logoUrl, updatedAt: Date.now() };
            await update(settingsRef, updates);
            updatePreview(updates);
            showToast();
        });

        function updatePreview(data) {
            document.getElementById('previewName').textContent = data.systemName || 'System Name';
            document.getElementById('previewIntro').textContent = data.introText || 'Welcome message here.';
            const previewLogo = document.getElementById('previewLogo');
            if (data.logoUrl) {
                previewLogo.src = data.logoUrl;
                previewLogo.classList.remove('hidden');
            } else {
                previewLogo.classList.add('hidden');
            }
            const logoImg = document.getElementById('logoImg');
            if (data.logoUrl) {
                logoImg.src = data.logoUrl;
                document.getElementById('logoPreview').classList.remove('hidden');
            }
        }

        function showToast() {
            const toast = document.getElementById('saveToast');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
