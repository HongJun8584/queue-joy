<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QueueJoy Admin ‚Äî Real-Time Queue Management</title>
  <meta name="description" content="QueueJoy Admin Panel - Manage queues, announcements, and analytics in real-time" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root { --primary: 264 83% 62%; }
    * { scrollbar-width: thin; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; background: linear-gradient(135deg,#667eea 0%,#764ba2 25%,#f093fb 50%,#4facfe 75%,#00f2fe 100%); background-size:400% 400%; animation: gradientShift 15s ease infinite; }
    @keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .card{background:rgba(255,255,255,0.95);backdrop-filter:blur(16px);border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.35)}
    .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;z-index:1200}
    .spinner{border:2px solid rgba(255,255,255,0.35);border-top:2px solid hsl(var(--primary));border-radius:50%;width:16px;height:16px;animation:spin .8s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sidebar{position:fixed;left:0;top:0;height:100vh;width:260px;background:linear-gradient(180deg,rgba(99,102,241,0.95),rgba(139,92,246,0.95));padding:18px;color:#fff;box-shadow:8px 0 40px rgba(0,0,0,0.15)}
    .main-content{margin-left:260px;padding:28px;min-height:100vh}
    @media(max-width:1024px){.main-content{margin-left:0}}
    .hidden{display:none!important}
    .small-muted{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="mb-6">
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center font-bold">QJ</div>
        <h1 class="text-lg font-bold">QueueJoy</h1>
      </div>
      <p class="small-muted">Admin Panel ‚Äî no auth</p>
    </div>

    <nav class="space-y-2">
      <button id="navDashboard" class="w-full text-left p-3 rounded bg-white/10">üè† Dashboard</button>
      <button id="navAnalyst" class="w-full text-left p-3 rounded hover:bg-white/10">üìä Analytics</button>
      <button id="navHowTo" class="w-full text-left p-3 rounded hover:bg-white/10">‚ùì How to Use</button>
    </nav>
  </aside>

  <!-- Main -->
  <div class="main-content">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <header class="flex items-center justify-between gap-6 mb-6 mt-6">
        <div class="flex items-center gap-4">
          <div id="headerLogo" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white font-bold">QJ</div>
          <div>
            <h2 id="headerName" class="text-2xl font-bold">QueueJoy Admin</h2>
            <p class="small-muted">Live management for index.html</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="saveAllBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg">üíæ Save All Changes</button>
        </div>
      </header>

      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="card">
          <p class="small-muted">Total Queues</p>
          <p id="totalQueues" class="text-2xl font-bold mt-2">0</p>
        </div>
        <div class="card">
          <p class="small-muted">Active (Waiting)</p>
          <p id="activeQueues" class="text-2xl font-bold mt-2">0</p>
        </div>
        <div class="card">
          <p class="small-muted">Average Wait</p>
          <p id="avgWait" class="text-2xl font-bold mt-2">0 min</p>
        </div>
        <div class="card">
          <p class="small-muted">Active Counters</p>
          <p id="activeCounters" class="text-2xl font-bold mt-2">0</p>
        </div>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Settings -->
        <div class="card space-y-4">
          <h3 class="font-bold text-lg">‚öôÔ∏è Business Settings</h3>

          <div>
            <label class="small-muted block mb-1">Business Name</label>
            <input id="businessName" class="w-full p-3 rounded border" placeholder="Your Business Name" />
          </div>

          <div>
            <label class="small-muted block mb-1">Welcome Message</label>
            <textarea id="welcomeMessage" rows="3" class="w-full p-3 rounded border" placeholder="Real-time queueing system..."></textarea>
          </div>

          <div>
            <label class="small-muted block mb-1">Logo Image (square)</label>
            <div class="flex items-center gap-3">
              <img id="logoPreview" src="" class="w-16 h-16 rounded object-cover hidden" alt="logo" />
              <input id="logoFile" type="file" accept="image/*" />
            </div>
            <p class="small-muted mt-1">Click to crop and save. This writes to <code>/settings/logo</code>.</p>
          </div>

          <div>
            <label class="small-muted block mb-1">Advertisement (landscape)</label>
            <div class="flex items-center gap-3">
              <div id="adPreviewBox" class="w-32 h-20 rounded overflow-hidden hidden"></div>
              <input id="adFile" type="file" accept="image/*,video/*" />
            </div>
            <p class="small-muted mt-1">Images can be cropped (16:9). Videos/GIFs bypass cropping.</p>
          </div>

          <div>
            <button id="updateSettingsBtn" class="w-full p-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded">‚ú® Update Settings</button>
          </div>
        </div>

        <!-- Display + Announce + Preview -->
        <div class="space-y-4">
          <div class="card">
            <h3 class="font-bold text-lg">üñ•Ô∏è Display Settings</h3>
            <div class="mt-3">
              <label class="small-muted block mb-1">Small Text (subtitle)</label>
              <input id="displaySmallText" class="w-full p-2 rounded border" placeholder="Digital Queue System" />
            </div>
            <div class="mt-3">
              <label class="small-muted block mb-1">Centered Logo URL</label>
              <input id="displayLogoUrl" class="w-full p-2 rounded border" placeholder="https://.../logo.png" />
            </div>
            <div class="mt-3">
              <label class="small-muted block mb-1">Main Title</label>
              <input id="displayMainTitle" class="w-full p-2 rounded border" placeholder="Get your queue number" />
            </div>
            <p class="small-muted mt-2">Saved to <code>/displaySettings</code> ‚Äî index.html reads these live.</p>
            <div class="mt-3">
              <button id="saveDisplayBtn" class="w-full p-2 bg-indigo-600 text-white rounded">Save Display Settings</button>
            </div>
          </div>

          <div class="card">
            <h3 class="font-bold text-lg">üì¢ Telegram Announcement</h3>
            <textarea id="announcementMessage" class="w-full p-3 rounded border" rows="3" placeholder="Announcement..."></textarea>
            <div class="mt-2 flex gap-3 items-start">
              <input id="announcementMedia" type="file" accept="image/*,video/*,.gif" />
              <div id="announcementPreview" class="hidden"></div>
            </div>
            <div class="mt-3">
              <button id="sendAnnouncementBtn" class="w-full p-2 bg-green-600 text-white rounded">üì± Send to Telegram</button>
              <div id="announcementResult" class="mt-2 hidden"></div>
            </div>
          </div>

          <div class="card">
            <h3 class="font-bold text-lg">üëÅÔ∏è Live Preview</h3>
            <div class="flex items-center gap-3 mt-3">
              <div id="previewLogo" class="w-14 h-14 rounded bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white">QJ</div>
              <div>
                <p id="previewName" class="font-bold">Your Business</p>
                <p id="previewIntro" class="small-muted">Real-time queueing system</p>
              </div>
            </div>
            <div class="mt-3">
              <p class="small-muted mb-1">Advertisement preview</p>
              <img id="previewAd" src="" class="w-32 h-20 rounded object-cover hidden" alt="ad">
            </div>
            <div class="mt-3">
              <button class="w-full p-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded opacity-80 cursor-not-allowed">üé´ Get My Number (preview)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analyst area -->
      <div id="analystArea" class="card mt-6 hidden">
        <h3 class="font-bold text-lg mb-3">üìä Analytics</h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card">
            <h4 class="font-semibold mb-2">Queue Trend (last 7 days)</h4>
            <canvas id="queueTrendChart" height="120"></canvas>
          </div>
          <div class="card">
            <h4 class="font-semibold mb-2">Counter Performance (served)</h4>
            <canvas id="counterPerfChart" height="120"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
          <div class="card">
            <p class="small-muted">Completed</p>
            <p id="analystCompleted" class="text-2xl font-bold">0</p>
          </div>
          <div class="card">
            <p class="small-muted">Waiting</p>
            <p id="analystWaiting" class="text-2xl font-bold">0</p>
          </div>
          <div class="card">
            <p class="small-muted">Serving</p>
            <p id="analystServing" class="text-2xl font-bold">0</p>
          </div>
          <div class="card">
            <p class="small-muted">Cancelled</p>
            <p id="analystCancelled" class="text-2xl font-bold">0</p>
          </div>
        </div>
      </div>

      <footer class="text-center small-muted mt-6">Live sync with Firebase ‚Äî edits update index.html</footer>
    </div>
  </div>

  <!-- Crop modal -->
  <div id="cropModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded max-w-lg w-full">
      <h4 class="font-bold mb-2" id="cropModalTitle">Crop Image</h4>
      <div class="mb-3"><img id="cropImage" src="" style="max-width:100%" /></div>
      <div class="flex justify-end gap-2">
        <button id="cropCancelBtn" class="px-3 py-2 bg-gray-200 rounded">Cancel</button>
        <button id="cropSaveBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Save Crop</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const toast = (msg, ok=true) => {
      const d = document.createElement('div');
      d.className = 'toast';
      d.style.background = ok ? 'linear-gradient(90deg,#16a34a,#059669)' : 'linear-gradient(90deg,#dc2626,#ef4444)';
      d.textContent = (ok ? '‚úÖ ' : '‚ö†Ô∏è ') + msg;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(),3500);
    };
    const fileToBase64 = (file)=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

    // Elements
    const businessName = $('businessName');
    const welcomeMessage = $('welcomeMessage');
    const logoFile = $('logoFile');
    const logoPreview = $('logoPreview');
    const adFile = $('adFile');
    const adPreviewBox = $('adPreviewBox');
    const updateSettingsBtn = $('updateSettingsBtn');
    const saveAllBtn = $('saveAllBtn');

    const displaySmallText = $('displaySmallText');
    const displayLogoUrl = $('displayLogoUrl');
    const displayMainTitle = $('displayMainTitle');
    const saveDisplayBtn = $('saveDisplayBtn');

    const previewName = $('previewName');
    const previewIntro = $('previewIntro');
    const previewLogo = $('previewLogo');
    const previewAd = $('previewAd');

    const announcementMessage = $('announcementMessage');
    const announcementMedia = $('announcementMedia');
    const announcementPreview = $('announcementPreview');
    const sendAnnouncementBtn = $('sendAnnouncementBtn');
    const announcementResult = $('announcementResult');

    const totalQueuesEl = $('totalQueues');
    const activeQueuesEl = $('activeQueues');
    const avgWaitEl = $('avgWait');
    const activeCountersEl = $('activeCounters');

    const analystArea = $('analystArea');
    const navAnalyst = $('navAnalyst');
    const navDashboard = $('navDashboard');
    const navHowTo = $('navHowTo');

    const analystCompleted = $('analystCompleted');
    const analystWaiting = $('analystWaiting');
    const analystServing = $('analystServing');
    const analystCancelled = $('analystCancelled');

    // crop modal refs
    const cropModal = $('cropModal');
    const cropImage = $('cropImage');
    const cropSaveBtn = $('cropSaveBtn');
    const cropCancelBtn = $('cropCancelBtn');
    const cropModalTitle = $('cropModalTitle');

    // charts
    let queueTrendChart = null;
    let counterPerfChart = null;

    function initCharts() {
      if (!queueTrendChart) {
        const ctx = $('queueTrendChart')?.getContext?.('2d');
        if (ctx) queueTrendChart = new Chart(ctx, {
          type:'line',
          data:{ labels:[], datasets:[{ label:'Queues', data:[], tension:0.35, backgroundColor:'rgba(99,102,241,0.12)', borderColor:'rgb(99,102,241)' }] },
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
        });
      }
      if (!counterPerfChart) {
        const ctx2 = $('counterPerfChart')?.getContext?.('2d');
        if (ctx2) counterPerfChart = new Chart(ctx2, {
          type:'bar',
          data:{ labels:[], datasets:[{ label:'Served', data:[], backgroundColor:[] }] },
          options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
        });
      }
    }

    // Robust timestamp parser
    function parseTs(ts) {
      if (!ts && ts !== 0) return 0;
      // numeric string?
      if (typeof ts === 'string' && /^\d+$/.test(ts)) ts = Number(ts);
      if (typeof ts === 'number') {
        // if seconds (10-digit) convert
        if (ts < 1e11) return ts * 1000; // likely seconds
        if (ts < 1e15) return ts; // likely ms
        // outlier ‚Äî fallback
        return ts;
      }
      // ISO-like string
      const parsed = Date.parse(String(ts));
      return isNaN(parsed) ? 0 : parsed;
    }

    function humanizeMinutes(mins) {
      if (!isFinite(mins) || mins <= 0) return '0 min';
      if (mins < 60) return `${Math.round(mins)} min`;
      const hrs = mins / 60;
      if (hrs < 24) return `${hrs.toFixed(1)} hr`;
      return `${(hrs/24).toFixed(1)} day`;
    }

    // Read settings -> UI
    onValue(ref(db, 'settings/name'), snap => {
      if (!snap.exists()) return;
      businessName.value = snap.val();
      previewName.textContent = snap.val();
      $('headerName').textContent = snap.val();
    });
    onValue(ref(db, 'settings/introText'), snap => {
      if (!snap.exists()) return;
      welcomeMessage.value = snap.val();
      previewIntro.textContent = snap.val();
    });
    onValue(ref(db, 'settings/logo'), snap => {
      if (!snap.exists()) return;
      const v = snap.val();
      logoPreview.src = v; logoPreview.classList.remove('hidden');
      previewLogo.innerHTML = `<img src="${v}" class="w-full h-full rounded object-cover">`;
      $('headerLogo').innerHTML = `<img src="${v}" class="w-full h-full rounded object-cover">`;
    });

    // displaySettings binding
    onValue(ref(db, 'displaySettings'), snap => {
      if (!snap.exists()) return;
      const v = snap.val();
      displaySmallText.value = v.smallText || '';
      displayLogoUrl.value = v.logoUrl || '';
      displayMainTitle.value = v.mainTitle || '';
      if (v.logoUrl) previewLogo.innerHTML = `<img src="${v.logoUrl}" class="w-full h-full rounded object-cover">`;
      if (v.smallText) previewName.textContent = v.smallText;
      if (v.mainTitle) previewIntro.textContent = v.mainTitle;
    });

    // ad image
    onValue(ref(db, 'settings/adImage'), snap => {
      if (!snap.exists()) { adPreviewBox.classList.add('hidden'); previewAd.classList.add('hidden'); return; }
      const v = snap.val();
      if (typeof v === 'string' && v.startsWith('data:video/')) {
        adPreviewBox.innerHTML = `<video src="${v}" controls class="w-full h-full object-cover"></video>`;
      } else {
        adPreviewBox.innerHTML = `<img src="${v}" class="w-full h-full object-cover">`;
      }
      adPreviewBox.classList.remove('hidden');
      previewAd.src = v; previewAd.classList.remove('hidden');
    });

    // Queue analytics ‚Äî primary source
    onValue(ref(db, 'queue'), async snap => {
      const raw = snap.exists() ? snap.val() : {};
      const items = Object.keys(raw).map(k => ({ id:k, ...(raw[k]||{}) }));

      // counters aggregation for "served per counter"
      const completedStatuses = new Set(['done','served','completed']);
      const waitingStatuses = new Set(['waiting','pending']);
      const servingStatuses = new Set(['serving','called','in-service']);
      let total = items.length;
      let waiting = 0, serving = 0, completed = 0, cancelled = 0;
      const waitingTimestamps = [];
      const completedPerCounter = {}; // { counterId: number }
      const recentDates = {}; // YYYY-MM-DD -> count

      // prepare last 7 day buckets
      const buckets = {};
      const today = new Date(); today.setHours(0,0,0,0);
      for (let i=6;i>=0;i--) {
        const d = new Date(today.getTime() - i*24*60*60*1000);
        buckets[d.toISOString().slice(0,10)] = 0;
      }

      items.forEach(it => {
        const status = (it.status || '').toString().toLowerCase();
        const tsRaw = it.timestamp ?? it.time ?? it.ts ?? 0;
        const ts = parseTs(tsRaw);
        if (waitingStatuses.has(status)) {
          waiting++;
          if (ts) waitingTimestamps.push(ts);
        } else if (servingStatuses.has(status)) {
          serving++;
          if (ts) waitingTimestamps.push(ts);
        } else if (completedStatuses.has(status)) {
          completed++;
          if (it.counterId) completedPerCounter[it.counterId] = (completedPerCounter[it.counterId]||0) + 1;
        } else if (status === 'cancelled' || status === 'canceled') {
          cancelled++;
        }
        if (ts) {
          const key = new Date(ts).toISOString().slice(0,10);
          if (key in buckets) buckets[key] += 1;
          recentDates[key] = (recentDates[key]||0) + 1;
        }
      });

      // totals
      totalQueuesEl.textContent = String(total);
      activeQueuesEl.textContent = String(waiting);
      analystWaiting.textContent = String(waiting);
      analystServing.textContent = String(serving);
      analystCompleted.textContent = String(completed);
      analystCancelled.textContent = String(cancelled);

      // average wait (minutes) for waiting items
      const now = Date.now();
      const minsArr = waitingTimestamps.map(t => Math.max(0, (now - t) / 60000)).filter(n => isFinite(n));
      const avg = minsArr.length ? minsArr.reduce((a,b)=>a+b,0)/minsArr.length : 0;
      avgWaitEl.textContent = humanizeMinutes(avg);
      // also set in small statistic if present
      $('avgWait') && ($('avgWait').textContent = humanizeMinutes(avg));

      // charts: build last7 arrays
      initCharts();
      if (queueTrendChart) {
        const labels = Object.keys(buckets).map(k => k.slice(5));
        const data = Object.keys(buckets).map(k => buckets[k]);
        queueTrendChart.data.labels = labels;
        queueTrendChart.data.datasets[0].data = data;
        queueTrendChart.update();
      }

      // build counter performance: prefer counting completions by counterId. If counters node exists with lastIssued, we'll merge later.
      // first, fetch counters to get names and active counts
      try {
        const cSnap = await get(ref(db, 'counters'));
        const countersObj = cSnap.exists() ? cSnap.val() : {};
        const keys = Object.keys(countersObj || {});
        // label array and data array
        const labels = [];
        const dataArr = [];
        const colors = [];
        keys.forEach((k, idx) => {
          const c = countersObj[k] || {};
          const name = c.name || c.label || (c.prefix ? `Counter ${c.prefix}` : k);
          labels.push(name);
          const servedCount = completedPerCounter[k] || 0;
          dataArr.push(servedCount);
          const palette = ['rgba(99,102,241,0.85)','rgba(168,85,247,0.85)','rgba(236,72,153,0.85)','rgba(59,130,246,0.85)','rgba(16,185,129,0.85)'];
          colors.push(palette[idx % palette.length]);
        });
        if (counterPerfChart) {
          counterPerfChart.data.labels = labels;
          counterPerfChart.data.datasets[0].data = dataArr;
          counterPerfChart.data.datasets[0].backgroundColor = colors;
          counterPerfChart.update();
        }
        activeCountersEl.textContent = String(keys.filter(k=>countersObj[k] && countersObj[k].active).length || 0);
        $('activeCounters') && ($('activeCounters').textContent = String(keys.filter(k=>countersObj[k] && countersObj[k].active).length || 0));
        $('analystActiveCounters') && ($('analystActiveCounters').textContent = String(keys.filter(k=>countersObj[k] && countersObj[k].active).length || 0));
      } catch (err) {
        console.error('Failed reading counters for performance chart', err);
      }
    }, err => console.error('queue listener error', err));

    // counters node listens to update activeCounters early
    onValue(ref(db, 'counters'), snap => {
      if (!snap.exists()) { activeCountersEl.textContent = '0'; return; }
      const obj = snap.val();
      const arr = Object.values(obj || {});
      activeCountersEl.textContent = String(arr.filter(x=>x && x.active).length || 0);
    });

    // Image cropping logic (Cropper.js)
    let currentCropper = null, currentCropType = '';
    let adData = '';
    logoFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      currentCropType = 'logo';
      cropModalTitle.textContent = 'Crop Logo (1:1)';
      const b64 = await fileToBase64(file);
      cropImage.src = b64; cropModal.classList.remove('hidden');
      if (currentCropper) currentCropper.destroy();
      currentCropper = new Cropper(cropImage, { aspectRatio: 1, viewMode:2, autoCropArea:1 });
    });
    adFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      if (file.size > 50*1024*1024) { toast('File too large (50MB)', false); return; }
      const b64 = await fileToBase64(file);
      const t = file.type || '';
      if (t.startsWith('video/')) {
        adData = b64; adPreviewBox.innerHTML = `<video src="${b64}" controls class="w-full h-full object-cover"></video>`; adPreviewBox.classList.remove('hidden'); previewAd.src = b64; previewAd.classList.remove('hidden'); return;
      }
      if (t === 'image/gif') {
        adData = b64; adPreviewBox.innerHTML = `<img src="${b64}" class="w-full h-full object-cover">`; adPreviewBox.classList.remove('hidden'); previewAd.src = b64; previewAd.classList.remove('hidden'); return;
      }
      currentCropType = 'ad';
      cropModalTitle.textContent = 'Crop Ad Banner (16:9)';
      cropImage.src = b64; cropModal.classList.remove('hidden');
      if (currentCropper) currentCropper.destroy();
      currentCropper = new Cropper(cropImage, { aspectRatio: 16/9, viewMode:2, autoCropArea:1 });
    });

    cropSaveBtn.addEventListener('click', () => {
      if (!currentCropper) return;
      const canvas = currentCropper.getCroppedCanvas();
      const out = canvas.toDataURL('image/jpeg', 0.9);
      if (currentCropType === 'logo') {
        logoPreview.src = out; logoPreview.classList.remove('hidden');
        previewLogo.innerHTML = `<img src="${out}" class="w-full h-full rounded object-cover">`;
        $('headerLogo').innerHTML = `<img src="${out}" class="w-full h-full rounded object-cover">`;
      } else if (currentCropType === 'ad') {
        adData = out;
        adPreviewBox.innerHTML = `<img src="${out}" class="w-full h-full object-cover">`;
        adPreviewBox.classList.remove('hidden');
        previewAd.src = out; previewAd.classList.remove('hidden');
      }
      cropModal.classList.add('hidden');
      currentCropper.destroy(); currentCropper = null;
      toast('Image cropped');
    });

    cropCancelBtn.addEventListener('click', () => {
      cropModal.classList.add('hidden'); if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
    });

    // Save settings (writes to /settings and /displaySettings); no auth required
    updateSettingsBtn.addEventListener('click', async () => {
      updateSettingsBtn.disabled = true;
      try {
        const updates = {};
        updates['/settings/name'] = businessName.value || '';
        updates['/settings/introText'] = welcomeMessage.value || '';
        if (logoPreview.src && logoPreview.src.startsWith('data:')) updates['/settings/logo'] = logoPreview.src;
        if (adData) updates['/settings/adImage'] = adData;

        updates['/displaySettings/smallText'] = displaySmallText.value || '';
        updates['/displaySettings/logoUrl'] = displayLogoUrl.value || '';
        updates['/displaySettings/mainTitle'] = displayMainTitle.value || '';

        await update(ref(db, '/'), updates);
        toast('Settings saved');
      } catch (err) {
        console.error('Update failed', err);
        toast('Failed to update settings: ' + (err.message || err), false);
      } finally { updateSettingsBtn.disabled = false; }
    });

    saveDisplayBtn.addEventListener('click', async () => {
      try {
        await update(ref(db, '/displaySettings'), {
          smallText: displaySmallText.value || '',
          logoUrl: displayLogoUrl.value || '',
          mainTitle: displayMainTitle.value || ''
        });
        toast('Display settings saved');
      } catch (err) {
        toast('Failed to save display settings', false);
      }
    });

    saveAllBtn.addEventListener('click', () => updateSettingsBtn.click());

    // Announcement functionality (calls serverless announce function)
    let selectedMediaFile = null;
    announcementMedia.addEventListener('change', (e) => {
      selectedMediaFile = e.target.files?.[0] || null;
      announcementPreview.innerHTML = ''; announcementPreview.classList.add('hidden');
      if (!selectedMediaFile) return;
      if (selectedMediaFile.size > 50*1024*1024) { toast('Media too large (50MB)', false); selectedMediaFile = null; return; }
      const url = URL.createObjectURL(selectedMediaFile);
      if (selectedMediaFile.type.startsWith('video/')) announcementPreview.innerHTML = `<video src="${url}" controls class="w-48 h-32 object-cover"></video>`;
      else announcementPreview.innerHTML = `<img src="${url}" class="w-48 h-32 object-cover">`;
      announcementPreview.classList.remove('hidden');
    });

    sendAnnouncementBtn.addEventListener('click', async () => {
      const msg = announcementMessage.value.trim();
      if (!msg && !selectedMediaFile) { toast('Enter message or attach media', false); return; }
      sendAnnouncementBtn.disabled = true;
      try {
        let mediaBase64 = '';
        let mediaType = '';
        if (selectedMediaFile) { mediaBase64 = await fileToBase64(selectedMediaFile); mediaType = selectedMediaFile.type; }
        const res = await fetch('/.netlify/functions/announce', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: msg, media: mediaBase64, mediaType })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.error || 'Failed');
        announcementResult.className = 'p-3 bg-green-50 text-green-700 rounded';
        announcementResult.textContent = '‚úÖ ' + (body.message || 'Sent');
        announcementResult.classList.remove('hidden');
        announcementMessage.value = ''; announcementMedia.value = ''; announcementPreview.innerHTML = ''; announcementPreview.classList.add('hidden'); selectedMediaFile = null;
        toast('Announcement sent');
      } catch (err) {
        console.error('Announcement error', err);
        announcementResult.className = 'p-3 bg-red-50 text-red-700 rounded';
        announcementResult.textContent = '‚ö†Ô∏è ' + (err.message || 'Failed');
        announcementResult.classList.remove('hidden');
        toast('Failed sending announcement', false);
      } finally { sendAnnouncementBtn.disabled = false; setTimeout(()=>announcementResult.classList.add('hidden'),4000); }
    });

    // Charts initialization (if analyst nav clicked)
    function ensureCharts() {
      if (!queueTrendChart) {
        const el = $('queueTrendChart');
        if (el) {
          const ctx = el.getContext('2d');
          queueTrendChart = new Chart(ctx, {
            type:'line',
            data:{ labels:[], datasets:[{ label:'Queues', data:[], tension:0.35, backgroundColor:'rgba(99,102,241,0.12)', borderColor:'rgb(99,102,241)'}] },
            options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }}}
          });
        }
      }
      if (!counterPerfChart) {
        const el2 = $('counterPerfChart');
        if (el2) {
          const ctx2 = el2.getContext('2d');
          counterPerfChart = new Chart(ctx2, {
            type:'bar',
            data:{ labels:[], datasets:[{ label:'Served', data:[], backgroundColor:[]}] },
            options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }}}
          });
        }
      }
    }

    navAnalyst.addEventListener('click', () => { analystArea.classList.remove('hidden'); ensureCharts(); window.scrollTo({top: analystArea.offsetTop-50, behavior:'smooth'}); });
    navDashboard.addEventListener('click', () => { analystArea.classList.add('hidden'); window.scrollTo({top:0, behavior:'smooth'}); });
    navHowTo.addEventListener('click', ()=> alert('Upload/crop images, edit displaySettings, and send announcements. index.html reads /displaySettings and /settings/* live.'));

    // initial charts setup
    ensureCharts();
  </script>
</body>
</html>
