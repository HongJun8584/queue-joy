<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QueueJoy Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 280px;
      background: linear-gradient(180deg, rgba(102, 126, 234, 0.98) 0%, rgba(118, 75, 162, 0.98) 100%);
      backdrop-filter: blur(20px);
      box-shadow: 4px 0 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      z-index: 100;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 24px;
      margin: 8px 16px;
      color: white;
      cursor: pointer;
      border-radius: 16px;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .sidebar-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(4px);
    }

    .sidebar-item.active {
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .main-content {
      margin-left: 280px;
      padding: 32px;
      transition: margin-left 0.3s ease;
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }

    .stat-card {
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      background: #10b981;
      color: white;
    }

    .toast.error {
      background: #ef4444;
      color: white;
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.6s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .preview-image, .preview-video, .preview-gif {
      max-width: 120px;
      max-height: 120px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      margin-top: 8px;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-label {
      padding: 10px 20px;
      background: #f3f4f6;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .file-input-label:hover {
      background: #e5e7eb;
    }

    input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    .metric-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      margin: 4px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div style="padding: 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        <div style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üé´</div>
        <h1 style="color: white; font-size: 24px; font-weight: 700;">QueueJoy</h1>
      </div>
      <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-left: 60px;">Admin Panel</p>
    </div>

    <nav style="margin-top: 24px;">
      <div class="sidebar-item active" data-view="dashboard">
        <span style="font-size: 24px;">üè†</span>
        <span>Dashboard</span>
      </div>
      <div class="sidebar-item" data-view="analytics">
        <span style="font-size: 24px;">üìä</span>
        <span>Analytics</span>
      </div>
      <div class="sidebar-item" data-view="settings">
        <span style="font-size: 24px;">‚öôÔ∏è</span>
        <span>Business Settings</span>
      </div>
      <div class="sidebar-item" id="howToUseBtn">
        <span style="font-size: 24px;">‚ùì</span>
        <span>How to Use</span>
      </div>
    </nav>
  </aside>

  <!-- Mobile Menu Button -->
  <button id="mobileMenuBtn" style="display: none; position: fixed; top: 20px; left: 20px; z-index: 99; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
  </button>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Dashboard View -->
    <div id="dashboardView">
      <div style="max-width: 1400px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px;">
          <h2 style="font-size: 32px; font-weight: 700; color: white;">Dashboard</h2>
          <button class="btn-primary" id="saveAllBtn">üíæ Save All Changes</button>
        </div>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
          <div class="glass-card stat-card" style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Total Queues</p>
                <p id="totalQueues" style="font-size: 36px; font-weight: 700; color: #667eea;">0</p>
              </div>
              <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">üìä</div>
            </div>
          </div>

          <div class="glass-card stat-card" style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Active Queues</p>
                <p id="activeQueues" style="font-size: 36px; font-weight: 700; color: #8b5cf6;">0</p>
              </div>
              <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">üé´</div>
            </div>
          </div>

          <div class="glass-card stat-card" style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Today's Queues</p>
                <p id="todayQueues" style="font-size: 36px; font-weight: 700; color: #10b981;">0</p>
              </div>
              <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">üìà</div>
            </div>
          </div>

          <div class="glass-card stat-card" style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Active Counters</p>
                <p id="activeCounters" style="font-size: 36px; font-weight: 700; color: #f59e0b;">0</p>
              </div>
              <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">üè™</div>
            </div>
          </div>
        </div>

        <!-- Announcement Card -->
        <div class="glass-card" style="padding: 32px; margin-bottom: 32px;">
          <h3 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 24px;">üì¢ Send Announcement</h3>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Message</label>
            <textarea id="announcementMessage" class="input-field" rows="4" placeholder="Type your announcement message here..."></textarea>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Attach Media (Optional)</label>
            <div class="file-input-wrapper">
              <label class="file-input-label">
                üìé Choose File
                <input type="file" id="announcementMedia" accept="image/*,video/*,audio/*">
              </label>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">Supports images, videos, GIFs, and audio (max 5MB) due to telegram restrictions</p>
            <div id="announcementPreview" style="margin-top: 16px;"></div>
          </div>

          <button class="btn-primary" id="sendAnnouncementBtn" style="width: 100%;">
            <span id="sendBtnText">üì± Send to All Subscribers</span>
            <span id="sendBtnSpinner" style="display: none;"><span class="spinner"></span> Sending...</span>
          </button>

          <div id="announcementResult" style="margin-top: 16px; display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Analytics View -->
    <div id="analyticsView" style="display: none;">
      <div style="max-width: 1400px; margin: 0 auto;">
        <h2 style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 32px;">üìä Analytics Dashboard</h2>

        <!-- Analytics Summary -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
          <div class="glass-card" style="padding: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(139, 92, 246, 0.8));">
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">Total Served</p>
            <p id="analystTotalServed" style="font-size: 36px; font-weight: 700; color: white;">0</p>
          </div>

          <div class="glass-card" style="padding: 24px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(102, 126, 234, 0.8));">
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">Avg Wait Time</p>
            <p style="font-size: 36px; font-weight: 700; color: white;"><span id="analystAvgWait">0</span><span style="font-size: 18px;"> min</span></p>
          </div>

          <div class="glass-card" style="padding: 24px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.95), rgba(236, 72, 153, 0.8));">
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">Active Counters</p>
            <p id="analystActiveCounters" style="font-size: 36px; font-weight: 700; color: white;">0</p>
          </div>

          <div class="glass-card" style="padding: 24px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(16, 185, 129, 0.8));">
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600; margin-bottom: 8px;">Median Wait</p>
            <p style="font-size: 36px; font-weight: 700; color: white;"><span id="analystMedianWait">0</span><span style="font-size: 18px;"> min</span></p>
          </div>
        </div>

        <!-- Queue Status Breakdown -->
        <div class="glass-card" style="padding: 32px; margin-bottom: 32px;">
          <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 24px;">Queue Status Breakdown</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 24px;">
            <div style="text-align: center;">
              <p id="analystCompleted" style="font-size: 40px; font-weight: 700; color: #10b981;">0</p>
              <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-top: 8px;">Completed</p>
            </div>
            <div style="text-align: center;">
              <p id="analystWaiting" style="font-size: 40px; font-weight: 700; color: #3b82f6;">0</p>
              <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-top: 8px;">Waiting</p>
            </div>
            <div style="text-align: center;">
              <p id="analystServing" style="font-size: 40px; font-weight: 700; color: #8b5cf6;">0</p>
              <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-top: 8px;">Serving</p>
            </div>
            <div style="text-align: center;">
              <p id="analystCancelled" style="font-size: 40px; font-weight: 700; color: #6b7280;">0</p>
              <p style="color: #6b7280; font-size: 14px; font-weight: 600; margin-top: 8px;">Cancelled</p>
            </div>
          </div>
        </div>

        <!-- Wait Time Analytics -->
        <div class="glass-card" style="padding: 32px; margin-bottom: 32px;">
          <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 24px;">‚è±Ô∏è Wait Time Analytics</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
              <p style="color: #6b7280; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Average</p>
              <p style="font-size: 28px; font-weight: 700; color: #667eea;"><span id="waitAverage">0</span><span style="font-size: 16px;"> min</span></p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Median</p>
              <p style="font-size: 28px; font-weight: 700; color: #8b5cf6;"><span id="waitMedian">0</span><span style="font-size: 16px;"> min</span></p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 13px; font-weight: 600; margin-bottom: 4px;">90th Percentile</p>
              <p style="font-size: 28px; font-weight: 700; color: #ec4899;"><span id="wait90th">0</span><span style="font-size: 16px;"> min</span></p>
            </div>
            <div>
              <p style="color: #6b7280; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Longest Wait</p>
              <p style="font-size: 28px; font-weight: 700; color: #f59e0b;"><span id="waitLongest">0</span><span style="font-size: 16px;"> min</span></p>
            </div>
          </div>
        </div>

        <!-- Busiest Hours -->
        <div class="glass-card" style="padding: 32px; margin-bottom: 32px;">
          <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 24px;">üïê Busiest Hours (Last 7 Days)</h3>
          <div id="busiestHoursContainer" style="display: flex; flex-wrap: wrap; gap: 12px;"></div>
        </div>

        <!-- Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
          <div class="glass-card" style="padding: 32px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 20px;">Queue Trend (Last 7 Days)</h3>
            <div class="chart-container">
              <canvas id="queueTrendChart"></canvas>
            </div>
          </div>

          <div class="glass-card" style="padding: 32px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 20px;">Counter Performance</h3>
            <div class="chart-container">
              <canvas id="counterPerfChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Business Settings View -->
    <div id="settingsView" style="display: none;">
      <div style="max-width: 900px; margin: 0 auto;">
        <h2 style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 32px;">‚öôÔ∏è Business Settings</h2>

        <div class="glass-card" style="padding: 40px;">
          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Main Title</label>
            <input type="text" id="mainTitle" class="input-field" placeholder="e.g., ICE CREAM">
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/mainTitle</p>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Welcome Message</label>
            <textarea id="introText" class="input-field" rows="3" placeholder="e.g., Buy one free one. NEW FLAVOR AVAILABLE"></textarea>
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/introText</p>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Small Text on Top</label>
            <input type="text" id="smallTextOnTop" class="input-field" placeholder="e.g., Digital Queue System">
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/smallTextOnTop</p>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Title in Middle</label>
            <input type="text" id="titleinmiddle" class="input-field" placeholder="e.g., BUY ONE FREE ONE!">
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/titleinmiddle</p>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px;">Logo (Image/GIF/Video)</label>
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
              <div id="logoPreviewContainer"></div>
              <div class="file-input-wrapper">
                <label class="file-input-label">
                  üñºÔ∏è Upload Logo
                  <input type="file" id="logoFile" accept="image/*,video/*">
                </label>
              </div>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/logo | Supports images, GIFs, and videos (videos will loop)</p>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px;">Logo URL (Image/GIF/Video)</label>
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
              <div id="logoUrlPreviewContainer"></div>
              <div class="file-input-wrapper">
                <label class="file-input-label">
                  üñºÔ∏è Upload Logo URL
                  <input type="file" id="logoUrlFile" accept="image/*,video/*">
                </label>
              </div>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/logoUrl | Supports images, GIFs, and videos (videos will loop)</p>
          </div>

          <div style="margin-bottom: 32px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px;">Advertisement Banner (Image/GIF/Video)</label>
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
              <div id="adImagePreviewContainer"></div>
              <div class="file-input-wrapper">
                <label class="file-input-label">
                  üñºÔ∏è Upload Ad Banner
                  <input type="file" id="adImageFile" accept="image/*,video/*">
                </label>
              </div>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Firebase: settings/adImage | Supports images, GIFs, and videos (videos will loop)</p>
          </div>

          <button class="btn-primary" id="updateSettingsBtn" style="width: 100%;">
            <span id="updateBtnText">‚ú® Update Business Settings</span>
            <span id="updateBtnSpinner" style="display: none;"><span class="spinner"></span> Updating...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- How to Use Modal -->
  <div id="howToUseModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 24px; font-weight: 700; color: #1f2937;">‚ùì How to Use QueueJoy Admin</h3>
        <button id="closeHowToUse" style="background: none; border: none; font-size: 32px; color: #6b7280; cursor: pointer; line-height: 1;">&times;</button>
      </div>

      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div style="padding: 20px; background: #ede9fe; border-radius: 16px;">
          <h4 style="font-weight: 700; color: #7c3aed; margin-bottom: 12px;">üè† Dashboard</h4>
          <ul style="list-style: disc; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.8;">
            <li>View real-time statistics of your queue system</li>
            <li>Send announcements to all Telegram subscribers</li>
            <li>Attach images, videos, GIFs, or audio to announcements</li>
            <li>Monitor total queues, active queues, and counter status</li>
          </ul>
        </div>

        <div style="padding: 20px; background: #dbeafe; border-radius: 16px;">
          <h4 style="font-weight: 700; color: #2563eb; margin-bottom: 12px;">üìä Analytics</h4>
          <ul style="list-style: disc; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.8;">
            <li>Track total customers served and average wait times</li>
            <li>View queue status breakdown (completed, waiting, serving, cancelled)</li>
            <li>Analyze wait time metrics (median, 90th percentile)</li>
            <li>See busiest hours and queue trends over 7 days</li>
            <li>Monitor counter performance with detailed charts</li>
          </ul>
        </div>

        <div style="padding: 20px; background: #dcfce7; border-radius: 16px;">
          <h4 style="font-weight: 700; color: #16a34a; margin-bottom: 12px;">‚öôÔ∏è Business Settings</h4>
          <ul style="list-style: disc; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.8;">
            <li>Configure business settings and branding</li>
            <li>Upload logos, banners (images, GIFs, or videos)</li>
            <li>Videos automatically loop for continuous display</li>
            <li>All changes sync to Firebase in real-time</li>
            <li>Click "Update Business Settings" to save changes</li>
          </ul>
        </div>
      </div>

      <button class="btn-primary" id="closeHowToUseBtn" style="width: 100%; margin-top: 24px;">Got it!</button>
    </div>
  </div>

  <!-- Firebase & Application Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const dashboardView = document.getElementById('dashboardView');
    const analyticsView = document.getElementById('analyticsView');
    const settingsView = document.getElementById('settingsView');
    const sidebarItems = document.querySelectorAll('.sidebar-item[data-view]');
    const howToUseBtn = document.getElementById('howToUseBtn');
    const howToUseModal = document.getElementById('howToUseModal');
    const closeHowToUse = document.getElementById('closeHowToUse');
    const closeHowToUseBtn = document.getElementById('closeHowToUseBtn');

    if (window.innerWidth <= 1024) {
      mobileMenuBtn.style.display = 'block';
    }

    window.addEventListener('resize', () => {
      if (window.innerWidth <= 1024) {
        mobileMenuBtn.style.display = 'block';
      } else {
        mobileMenuBtn.style.display = 'none';
        sidebar.classList.remove('open');
      }
    });

    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    sidebarItems.forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;

        sidebarItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        dashboardView.style.display = 'none';
        analyticsView.style.display = 'none';
        settingsView.style.display = 'none';

        if (view === 'dashboard') {
          dashboardView.style.display = 'block';
        } else if (view === 'analytics') {
          analyticsView.style.display = 'block';
          initializeCharts();
        } else if (view === 'settings') {
          settingsView.style.display = 'block';
        }

        if (window.innerWidth <= 1024) {
          sidebar.classList.remove('open');
        }
      });
    });

    howToUseBtn.addEventListener('click', () => {
      howToUseModal.classList.add('active');
      if (window.innerWidth <= 1024) {
        sidebar.classList.remove('open');
      }
    });

    closeHowToUse.addEventListener('click', () => {
      howToUseModal.classList.remove('active');
    });

    closeHowToUseBtn.addEventListener('click', () => {
      howToUseModal.classList.remove('active');
    });

    function parseTimestamp(ts) {
      if (!ts) return null;

      let timestamp;
      if (typeof ts === 'string') {
        timestamp = parseInt(ts, 10);
        if (isNaN(timestamp)) {
          const parsed = new Date(ts).getTime();
          if (isNaN(parsed)) return null;
          timestamp = parsed;
        }
      } else if (typeof ts === 'number') {
        timestamp = ts;
      } else {
        return null;
      }

      const now = Date.now();
      const oneYearAgo = now - (365 * 24 * 60 * 60 * 1000);
      const oneYearFuture = now + (365 * 24 * 60 * 60 * 1000);

      if (timestamp < oneYearAgo || timestamp > oneYearFuture) {
        return null;
      }

      return timestamp;
    }

    function isToday(timestamp) {
      if (!timestamp) return false;
      const ts = parseTimestamp(timestamp);
      if (!ts) return false;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tsDate = new Date(ts);
      tsDate.setHours(0, 0, 0, 0);

      return today.getTime() === tsDate.getTime();
    }

    function safeDate(timestamp) {
      const ts = parseTimestamp(timestamp);
      return ts ? new Date(ts) : null;
    }

    function calculateWaitTimes(queues) {
      const waitTimes = [];

      queues.forEach(q => {
        if (q.status === 'waiting' && q.timestamp) {
          const ts = parseTimestamp(q.timestamp);
          if (ts) {
            const waitMinutes = Math.floor((Date.now() - ts) / 60000);
            if (waitMinutes >= 0 && waitMinutes <= 1440) {
              waitTimes.push(waitMinutes);
            }
          }
        }
      });

      if (waitTimes.length === 0) {
        return {
          average: 0,
          median: 0,
          p90: 0,
          longest: 0
        };
      }

      const sorted = [...waitTimes].sort((a, b) => a - b);
      const sum = sorted.reduce((acc, val) => acc + val, 0);
      const average = Math.round(sum / sorted.length);
      const median = sorted.length % 2 === 0
        ? Math.round((sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2)
        : sorted[Math.floor(sorted.length / 2)];
      const p90Index = Math.floor(sorted.length * 0.9);
      const p90 = sorted[p90Index] || 0;
      const longest = sorted[sorted.length - 1];

      return { average, median, p90, longest };
    }

    function calculateSevenDaySummary(queues) {
      const days = [];
      const today = new Date();

      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0);
        const dayStart = date.getTime();
        const dayEnd = dayStart + (24 * 60 * 60 * 1000);

        const dayQueues = queues.filter(q => {
          const ts = parseTimestamp(q.timestamp);
          return ts && ts >= dayStart && ts < dayEnd;
        });

        const total = dayQueues.length;
        const completed = dayQueues.filter(q => q.status === 'done' || q.status === 'served').length;
        const cancelled = dayQueues.filter(q => q.status === 'cancelled').length;

        const waitTimes = [];
        dayQueues.forEach(q => {
          if (q.timestamp) {
            const ts = parseTimestamp(q.timestamp);
            if (ts) {
              const waitMinutes = Math.floor((Date.now() - ts) / 60000);
              if (waitMinutes >= 0 && waitMinutes <= 1440) {
                waitTimes.push(waitMinutes);
              }
            }
          }
        });

        const avgWait = waitTimes.length > 0
          ? Math.round(waitTimes.reduce((acc, val) => acc + val, 0) / waitTimes.length)
          : 0;

        const hourCounts = new Array(24).fill(0);
        dayQueues.forEach(q => {
          const ts = parseTimestamp(q.timestamp);
          if (ts) {
            const hour = new Date(ts).getHours();
            hourCounts[hour]++;
          }
        });

        const maxCount = Math.max(...hourCounts);
        const busiestHour = maxCount > 0 ? hourCounts.indexOf(maxCount) : 0;

        days.push({
          date: date.toISOString().split('T')[0],
          total,
          completed,
          cancelled,
          avgWait,
          busiestHour
        });
      }

      return { days };
    }

    function calculateBusiestHours(queues) {
      const hourCounts = new Array(24).fill(0);

      queues.forEach(q => {
        const ts = parseTimestamp(q.timestamp);
        if (ts) {
          const date = safeDate(q.timestamp);
          if (date) {
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));

            if (date >= sevenDaysAgo) {
              const hour = date.getHours();
              hourCounts[hour]++;
            }
          }
        }
      });

      const hoursWithCounts = hourCounts.map((count, hour) => ({ hour, count }))
        .filter(h => h.count > 0)
        .sort((a, b) => b.count - a.count);

      return hoursWithCounts.slice(0, 5);
    }

    function updateUI(queues) {
      const total = queues.length;
      const waiting = queues.filter(q => q.status === 'waiting').length;
      const completed = queues.filter(q => q.status === 'done' || q.status === 'served').length;
      const serving = queues.filter(q => q.status === 'serving').length;
      const cancelled = queues.filter(q => q.status === 'cancelled').length;

      document.getElementById('totalQueues').textContent = total;
      document.getElementById('activeQueues').textContent = waiting;

      const todayCount = queues.filter(q => isToday(q.timestamp)).length;
      document.getElementById('todayQueues').textContent = todayCount;

      document.getElementById('analystTotalServed').textContent = completed;
      document.getElementById('analystCompleted').textContent = completed;
      document.getElementById('analystWaiting').textContent = waiting;
      document.getElementById('analystServing').textContent = serving;
      document.getElementById('analystCancelled').textContent = cancelled;

      const waitStats = calculateWaitTimes(queues);
      document.getElementById('analystAvgWait').textContent = waitStats.average;
      document.getElementById('analystMedianWait').textContent = waitStats.median;
      document.getElementById('waitAverage').textContent = waitStats.average;
      document.getElementById('waitMedian').textContent = waitStats.median;
      document.getElementById('wait90th').textContent = waitStats.p90;
      document.getElementById('waitLongest').textContent = waitStats.longest;

      const busiestHours = calculateBusiestHours(queues);
      const busiestContainer = document.getElementById('busiestHoursContainer');
      busiestContainer.innerHTML = '';

      if (busiestHours.length === 0) {
        busiestContainer.innerHTML = '<p style="color: #6b7280; font-size: 14px;">No data available</p>';
      } else {
        busiestHours.forEach((item, index) => {
          const badge = document.createElement('div');
          badge.className = 'metric-badge';
          const colors = ['#667eea', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
          badge.style.backgroundColor = colors[index % colors.length];
          badge.style.color = 'white';

          const hourLabel = item.hour === 0 ? '12 AM'
            : item.hour < 12 ? `${item.hour} AM`
            : item.hour === 12 ? '12 PM'
            : `${item.hour - 12} PM`;

          badge.textContent = `${hourLabel}: ${item.count} queues`;
          busiestContainer.appendChild(badge);
        });
      }

      updateCharts(queues);
    }

// REPLACE the old onValue(ref(db, 'queue'), ...) block with this entire block
// ‚Äî this preserves your analytics logic and also detects status changes (-> calls notifyCounter)
window._prevQueueState = window._prevQueueState || {};
window._lastNotify = window._lastNotify || {};
window._countersMap = window._countersMap || null;

onValue(ref(db, 'queue'), async (snapshot) => {
  // Handle empty DB
  if (!snapshot.exists()) {
    [
      'totalQueues','activeQueues','todayQueues',
      'analystTotalServed','analystCompleted','analystWaiting',
      'analystServing','analystCancelled','analystAvgWait',
      'analystMedianWait','analyst90pWait','analystMaxWait'
    ].forEach(id => document.getElementById(id).textContent = '0');

    updateCharts([]);
    // reset cache
    window._prevQueueState = {};
    return;
  }

  const raw = snapshot.val(); // object keyed by firebase key
  const rawQueues = Object.entries(raw).map(([k,v]) => ({ __key: k, ...v }));
  const now = Date.now();

  // -------------------------------
  // 1Ô∏è‚É£ SANITIZE TIMESTAMPS
  // -------------------------------
  const queues = rawQueues
    .map(q => {
      const ts = Number(q.timestamp);
      if (!ts || isNaN(ts)) return null;
      if (ts > now + 86400000) return null; // reject >24h future
      if (ts < 1000000000000) return null;  // reject unrealistic timestamps (ms expected)
      return { ...q, timestamp: ts };
    })
    .filter(Boolean);

  // -------------------------------
  // 2Ô∏è‚É£ TODAY COUNT (SAFE)
  // -------------------------------
  const todayStart = new Date().setHours(0,0,0,0);
  const todayEnd = new Date().setHours(24,0,0,0);

  const todayCount = queues.filter(q => 
    q.timestamp >= todayStart && q.timestamp < todayEnd
  ).length;
  document.getElementById('todayQueues').textContent = todayCount;

  // -------------------------------
  // 3Ô∏è‚É£ BASIC COUNTS
  // -------------------------------
  const waiting = queues.filter(q => q.status === 'waiting');
  const serving = queues.filter(q => q.status === 'serving');
  const cancelled = queues.filter(q => q.status === 'cancelled');

  document.getElementById('totalQueues').textContent = queues.length;
  document.getElementById('activeQueues').textContent = waiting.length;
  document.getElementById('analystWaiting').textContent = waiting.length;
  document.getElementById('analystServing').textContent = serving.length;
  document.getElementById('analystCancelled').textContent = cancelled.length;

  // -------------------------------
  // 4Ô∏è‚É£ TOTAL SERVED
  // -------------------------------
  try {
    const servedSnap = await get(ref(db, 'analytics/servedCount'));
    const served = servedSnap.val() || 0;
    document.getElementById('analystTotalServed').textContent = served;
    document.getElementById('analystCompleted').textContent = served;
  } catch (e) {
    console.warn('failed to read analytics/servedCount', e);
    document.getElementById('analystTotalServed').textContent = '0';
    document.getElementById('analystCompleted').textContent = '0';
  }

  // -------------------------------
  // 5Ô∏è‚É£ WAIT TIME ANALYTICS (SAFE)
  // -------------------------------
  const waits = waiting.map(q => (now - q.timestamp) / 60000); // minutes

  if (waits.length === 0) {
    document.getElementById('analystAvgWait').textContent = 0;
    document.getElementById('analystMedianWait').textContent = 0;
    document.getElementById('analyst90pWait').textContent = 0;
    document.getElementById('analystMaxWait').textContent = 0;
  } else {
    waits.sort((a, b) => a - b);

    const avg = Math.round(waits.reduce((a, b) => a + b, 0) / waits.length);
    const median = Math.round(
      waits.length % 2 === 0
      ? (waits[waits.length/2 - 1] + waits[waits.length/2]) / 2
      : waits[(waits.length - 1) / 2]
    );
    const p90 = Math.round(waits[Math.floor(waits.length * 0.9)]);
    const max = Math.round(waits[waits.length - 1]);

    document.getElementById('analystAvgWait').textContent = Math.max(0, avg);
    document.getElementById('analystMedianWait').textContent = Math.max(0, median);
    document.getElementById('analyst90pWait').textContent = Math.max(0, p90);
    document.getElementById('analystMaxWait').textContent = Math.max(0, max);
  }

  // -------------------------------
  // 6Ô∏è‚É£ BUSIEST HOURS (LAST 7 DAYS)
  // -------------------------------
  const last7 = now - 7*24*60*60*1000;
  const recent = queues.filter(q => q.timestamp >= last7);

  const hourCount = {};
  recent.forEach(q => {
    const h = new Date(q.timestamp).getHours();
    hourCount[h] = (hourCount[h] || 0) + 1;
  });

  // Render busiest hours
  const busiestDiv = document.getElementById('busiestHours');
  busiestDiv.innerHTML = Object.entries(hourCount)
    .sort((a,b) => b[1] - a[1])
    .map(([h,c]) => `${h}:00 ‚Äî ${c} queues`)
    .join('<br>');

  // -------------------------------
  // 7Ô∏è‚É£ CONNECT TO notifyCounter.js (auto-notify on status change)
  //    - detects transitions (prev status -> new status)
  //    - triggers notifyCounter Netlify function when a queue item's status changes to "serving"
  // -------------------------------
  try {
    const prevState = window._prevQueueState || {};
    // lazy-load counters map to resolve counterId -> friendly name (caching helps)
    if (!window._countersMap) {
      try {
        const countersSnap = await get(ref(db, 'counters'));
        window._countersMap = countersSnap.exists() ? countersSnap.val() : {};
      } catch (e) {
        console.warn('failed to fetch counters map', e);
        window._countersMap = {};
      }
    }

    for (const q of queues) {
      const key = q.__key;
      const old = prevState[key];
      const oldStatus = old ? old.status : null;
      const newStatus = q.status;

      // status transition detection
      if (oldStatus !== newStatus) {
        // trigger notify when a ticket becomes "serving" (you can add other statuses if needed)
        if (newStatus === 'serving') {
          const calledFull = q.queueId || q.queueId || q.ticket || q.number || null;
          // determine counter name from counters map if possible
          let counterName = q.counterName || '';
          if (!counterName && q.counterId && window._countersMap && window._countersMap[q.counterId]) {
            counterName = window._countersMap[q.counterId].name || q.counterId;
          } else if (!counterName) {
            counterName = q.counterId || '';
          }

          if (calledFull) {
            const notifyKey = `${key}|${calledFull}|serving`;
            const last = window._lastNotify[notifyKey] || 0;
            const DEBOUNCE_MS = 3000; // avoid duplicates in short window
            if (Date.now() - last > DEBOUNCE_MS) {
              window._lastNotify[notifyKey] = Date.now();
              // call Netlify function (it will read /queue itself if payload.recipients absent)
              fetch('/.netlify/functions/notifyCounter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calledFull, counterName })
              })
                .then(res => res.json().catch(()=>null))
                .then(json => {
                  console.log('notifyCounter result', calledFull, counterName, json);
                })
                .catch(err => {
                  console.warn('notifyCounter failed', err);
                });
            }
          }
        }

        // optionally: handle when an item becomes "served" ‚Äî push a simple analytics refresh or other action
        // if (newStatus === 'served') { /* optional extra logic */ }
      }
    }
  } catch (e) {
    console.warn('notifyCounter integration error', e);
  }

  // update previous snapshot for next diff
  const newPrev = {};
  Object.entries(raw).forEach(([k,v]) => { newPrev[k] = v; });
  window._prevQueueState = newPrev;

  // -------------------------------
  // 8Ô∏è‚É£ UPDATE CHARTS/UI
  // -------------------------------
  updateCharts(queues);
});

    onValue(ref(db, 'counters'), (snapshot) => {
      if (snapshot.exists()) {
        const counters = Object.values(snapshot.val());
        const activeCount = counters.filter(c => c.active === true).length;
        document.getElementById('activeCounters').textContent = activeCount;
        document.getElementById('analystActiveCounters').textContent = activeCount;
      } else {
        document.getElementById('activeCounters').textContent = '0';
        document.getElementById('analystActiveCounters').textContent = '0';
      }
    });

    onValue(ref(db, 'settings/mainTitle'), (snap) => {
      if (snap.exists()) {
        document.getElementById('mainTitle').value = snap.val();
      }
    });

    onValue(ref(db, 'settings/introText'), (snap) => {
      if (snap.exists()) {
        document.getElementById('introText').value = snap.val();
      }
    });

    onValue(ref(db, 'settings/smallTextOnTop'), (snap) => {
      if (snap.exists()) {
        document.getElementById('smallTextOnTop').value = snap.val();
      }
    });

    onValue(ref(db, 'settings/titleinmiddle'), (snap) => {
      if (snap.exists()) {
        document.getElementById('titleinmiddle').value = snap.val();
      }
    });

    function createMediaPreview(src, container, type = 'image') {
      container.innerHTML = '';

      if (type === 'video' || src.startsWith('data:video')) {
        const video = document.createElement('video');
        video.src = src;
        video.className = 'preview-video';
        video.loop = true;
        video.autoplay = true;
        video.muted = true;
        video.style.maxWidth = '120px';
        video.style.maxHeight = '120px';
        container.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'preview-image';
        container.appendChild(img);
      }
    }

    onValue(ref(db, 'settings/logo'), (snap) => {
      if (snap.exists()) {
        const container = document.getElementById('logoPreviewContainer');
        createMediaPreview(snap.val(), container);
      }
    });

    onValue(ref(db, 'settings/logoUrl'), (snap) => {
      if (snap.exists()) {
        const container = document.getElementById('logoUrlPreviewContainer');
        createMediaPreview(snap.val(), container);
      }
    });

    onValue(ref(db, 'settings/adImage'), (snap) => {
      if (snap.exists()) {
        const container = document.getElementById('adImagePreviewContainer');
        createMediaPreview(snap.val(), container);
      }
    });

    let uploadedMedia = {
      logo: null,
      logoUrl: null,
      adImage: null
    };

    document.getElementById('logoFile').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const base64 = await fileToBase64(file);
      uploadedMedia.logo = base64;

      const container = document.getElementById('logoPreviewContainer');
      createMediaPreview(base64, container, file.type.startsWith('video') ? 'video' : 'image');

      showToast('Logo uploaded! Click "Update Business Settings" to save.');
    });

    document.getElementById('logoUrlFile').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const base64 = await fileToBase64(file);
      uploadedMedia.logoUrl = base64;

      const container = document.getElementById('logoUrlPreviewContainer');
      createMediaPreview(base64, container, file.type.startsWith('video') ? 'video' : 'image');

      showToast('Logo URL uploaded! Click "Update Business Settings" to save.');
    });

    document.getElementById('adImageFile').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const base64 = await fileToBase64(file);
      uploadedMedia.adImage = base64;

      const container = document.getElementById('adImagePreviewContainer');
      createMediaPreview(base64, container, file.type.startsWith('video') ? 'video' : 'image');

      showToast('Ad banner uploaded! Click "Update Business Settings" to save.');
    });

    const updateSettings = async () => {
      const updateBtn = document.getElementById('updateSettingsBtn');
      const updateBtnText = document.getElementById('updateBtnText');
      const updateBtnSpinner = document.getElementById('updateBtnSpinner');

      updateBtnText.style.display = 'none';
      updateBtnSpinner.style.display = 'inline';
      updateBtn.disabled = true;

      try {
        const currentSettingsSnap = await get(ref(db, 'settings'));
        const currentSettings = currentSettingsSnap.exists() ? currentSettingsSnap.val() : {};

        const updates = {
          ...currentSettings,
          mainTitle: document.getElementById('mainTitle').value || currentSettings.mainTitle || '',
          introText: document.getElementById('introText').value || currentSettings.introText || '',
          smallTextOnTop: document.getElementById('smallTextOnTop').value || currentSettings.smallTextOnTop || '',
          titleinmiddle: document.getElementById('titleinmiddle').value || currentSettings.titleinmiddle || ''
        };

        if (uploadedMedia.logo) {
          updates.logo = uploadedMedia.logo;
        }
        if (uploadedMedia.logoUrl) {
          updates.logoUrl = uploadedMedia.logoUrl;
        }
        if (uploadedMedia.adImage) {
          updates.adImage = uploadedMedia.adImage;
        }

        await set(ref(db, 'settings'), updates);

        uploadedMedia = { logo: null, logoUrl: null, adImage: null };

        showToast('Settings updated successfully!');
      } catch (error) {
        console.error('Update error:', error);
        showToast('Failed to update settings', 'error');
      } finally {
        updateBtnText.style.display = 'inline';
        updateBtnSpinner.style.display = 'none';
        updateBtn.disabled = false;
      }
    };

    document.getElementById('updateSettingsBtn').addEventListener('click', updateSettings);
    document.getElementById('saveAllBtn').addEventListener('click', updateSettings);

    let selectedMediaFile = null;
    const announcementMedia = document.getElementById('announcementMedia');
    const announcementPreview = document.getElementById('announcementPreview');

    announcementMedia.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      selectedMediaFile = file || null;
      announcementPreview.innerHTML = '';

      if (file) {
        if (file.size > 50 * 1024 * 1024) {
          showToast('File too large! Max 50MB', 'error');
          selectedMediaFile = null;
          return;
        }

        const url = URL.createObjectURL(file);

        if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          video.style.cssText = 'width: 100%; max-width: 300px; border-radius: 12px; margin-top: 8px;';
          announcementPreview.appendChild(video);
        } else if (file.type.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.src = url;
          audio.controls = true;
          audio.style.cssText = 'width: 100%; margin-top: 8px;';
          announcementPreview.appendChild(audio);
        } else {
          const img = document.createElement('img');
          img.src = url;
          img.style.cssText = 'width: 100%; max-width: 300px; border-radius: 12px; margin-top: 8px;';
          announcementPreview.appendChild(img);
        }
      }
    });

    document.getElementById('sendAnnouncementBtn').addEventListener('click', async () => {
      const message = document.getElementById('announcementMessage').value.trim();

      if (!message && !selectedMediaFile) {
        showToast('Please enter a message or attach media', 'error');
        return;
      }

      const sendBtn = document.getElementById('sendAnnouncementBtn');
      const sendBtnText = document.getElementById('sendBtnText');
      const sendBtnSpinner = document.getElementById('sendBtnSpinner');
      const announcementResult = document.getElementById('announcementResult');

      sendBtnText.style.display = 'none';
      sendBtnSpinner.style.display = 'inline';
      sendBtn.disabled = true;

      try {
        const chatIdsSnap = await get(ref(db, 'announcement/chatIds'));
        const botTokenSnap = await get(ref(db, 'announcement/botToken'));

        if (!chatIdsSnap.exists() || !botTokenSnap.exists()) {
          throw new Error('Missing chatIds or botToken in Firebase');
        }

        const chatIdsObj = chatIdsSnap.val();
        const chatIds = chatIdsObj ? Object.keys(chatIdsObj) : [];
        const telegramBotToken = botTokenSnap.val();

        let mediaBase64 = '';
        let mediaType = '';

        if (selectedMediaFile) {
          mediaBase64 = await fileToBase64(selectedMediaFile);
          mediaType = selectedMediaFile.type;
        }

        const payload = {
          message,
          media: mediaBase64,
          mediaType,
          chatIds: Array.isArray(chatIds) ? chatIds : [chatIds],
          telegramBotToken
        };

        const response = await fetch('/.netlify/functions/announce', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to send announcement');
        }

        announcementResult.style.display = 'block';
        announcementResult.style.padding = '16px';
        announcementResult.style.borderRadius = '12px';
        announcementResult.style.marginTop = '16px';

        if (result.success > 0) {
          announcementResult.style.background = '#dcfce7';
          announcementResult.style.color = '#166534';
          announcementResult.innerHTML = `‚úÖ Successfully sent to ${result.success} recipient(s)`;

          if (result.failed > 0) {
            announcementResult.innerHTML += `<br>‚ö†Ô∏è Failed to send to ${result.failed} recipient(s)`;
          }

          document.getElementById('announcementMessage').value = '';
          announcementMedia.value = '';
          announcementPreview.innerHTML = '';
          selectedMediaFile = null;

          showToast('Announcement sent successfully!');
        } else {
          announcementResult.style.background = '#fee2e2';
          announcementResult.style.color = '#991b1b';
          announcementResult.innerHTML = `‚ö†Ô∏è Failed to send announcement`;
          showToast('Failed to send announcement', 'error');
        }

        setTimeout(() => {
          announcementResult.style.display = 'none';
        }, 5000);
      } catch (error) {
        console.error('Announcement error:', error);
        announcementResult.style.display = 'block';
        announcementResult.style.padding = '16px';
        announcementResult.style.borderRadius = '12px';
        announcementResult.style.background = '#fee2e2';
        announcementResult.style.color = '#991b1b';
        announcementResult.innerHTML = `‚ö†Ô∏è ${error.message}`;
        showToast(error.message, 'error');

        setTimeout(() => {
          announcementResult.style.display = 'none';
        }, 5000);
      } finally {
        sendBtnText.style.display = 'inline';
        sendBtnSpinner.style.display = 'none';
        sendBtn.disabled = false;
      }
    });

    let queueTrendChart = null;
    let counterPerfChart = null;

    function initializeCharts() {
      if (!queueTrendChart) {
        const ctx = document.getElementById('queueTrendChart');
        if (ctx) {
          queueTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Queues',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }

      if (!counterPerfChart) {
        const ctx = document.getElementById('counterPerfChart');
        if (ctx) {
          counterPerfChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: [],
              datasets: [{
                label: 'Served',
                data: [],
                backgroundColor: ['#667eea', '#8b5cf6', '#ec4899', '#f59e0b']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }
    }

    function updateCharts(queues) {
      if (queueTrendChart) {
        const summary = calculateSevenDaySummary(queues);
        const labels = summary.days.map(d => {
          const date = new Date(d.date);
          return date.toLocaleDateString('en-US', { weekday: 'short' });
        });
        const data = summary.days.map(d => d.total);

        queueTrendChart.data.labels = labels;
        queueTrendChart.data.datasets[0].data = data;
        queueTrendChart.update();
      }

      if (counterPerfChart) {
        const counterStats = {};
        queues.forEach(q => {
          if (q.counterId) {
            counterStats[q.counterId] = (counterStats[q.counterId] || 0) + 1;
          }
        });

        const labels = Object.keys(counterStats);
        const data = Object.values(counterStats);

        counterPerfChart.data.labels = labels;
        counterPerfChart.data.datasets[0].data = data;
        counterPerfChart.update();
      }
    }

    initializeCharts();
  </script>
</body>
</html>
