<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QueueJoy â€” Admin</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --muted: #6b7280;
      --accent-from: #7c3aed;
      --accent-to: #06b6d4;
    }
    html,body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f0f9ff 0,#f5f3ff 100%); -webkit-font-smoothing:antialiased; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 10px 30px rgba(10,10,30,0.06); }
    .small { font-size:13px; color:var(--muted); }
    .hidden { display:none; }
    .safe-pad { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    input[type=file] { display:block; }
    .btn-primary { background: linear-gradient(90deg,var(--accent-from),var(--accent-to)); color:#fff; }
  </style>
</head>
<body class="safe-pad p-4">
  <div class="max-w-3xl mx-auto space-y-4">

    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
        <div>
          <div class="text-lg font-semibold text-slate-900">QueueJoy â€” Admin</div>
          <div class="small">Store settings Â· Live preview Â· Announce to customers</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a id="openPublic" href="#" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg btn-primary shadow-sm text-sm">
          Open public
        </a>
      </div>
    </header>

    <!-- Main -->
    <main class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Controls (left) -->
      <section class="card p-4 space-y-4">

        <!-- Slug -->
        <div>
          <label class="text-xs text-slate-600">Store slug (public URL)</label>
          <div class="mt-2 flex gap-2">
            <input id="slugInput" class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="your-store" />
            <button id="applySlugBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm">Apply</button>
          </div>
          <p class="small mt-1">Public: <span id="publicUrl" class="font-medium text-indigo-600">â€”</span></p>
        </div>

        <!-- Name -->
        <div>
          <label class="text-xs text-slate-600">Business name</label>
          <input id="businessName" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Coffee Lab" />
        </div>

        <!-- Welcome text -->
        <div>
          <label class="text-xs text-slate-600">Welcome / intro text</label>
          <input id="introText" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Welcomeâ€¦ (appears on public page)" />
        </div>

        <!-- Logo -->
        <div>
          <label class="text-xs text-slate-600">Logo</label>
          <div class="mt-2 flex items-center gap-3">
            <img id="logoPreview" class="w-16 h-16 rounded-md object-cover border hidden" src="" alt="logo preview" />
            <div class="flex-1">
              <input id="logoUpload" type="file" accept="image/*" class="text-sm text-slate-600" />
              <p class="small mt-1">PNG/JPG recommended. Saved as base64 to DB for instant preview compatibility.</p>
            </div>
          </div>
        </div>

        <!-- Advertisement -->
        <div>
          <label class="text-xs text-slate-600">Advertisement image</label>
          <div class="mt-2 flex items-start gap-3">
            <img id="adPreview" class="w-28 h-16 rounded-md object-cover border hidden" src="" alt="ad preview" />
            <div class="flex-1">
              <input id="adUpload" type="file" accept="image/*" class="text-sm text-slate-600" />
              <textarea id="adText" rows="2" class="mt-2 w-full px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Ad copy (optional)"></textarea>
              <p class="small mt-1">Shown in ad panel on public page. Leave blank to hide.</p>
            </div>
          </div>
        </div>

        <!-- Save controls -->
        <div class="flex gap-2">
          <button id="saveBtn" class="flex-1 px-4 py-3 rounded-lg bg-emerald-600 text-white font-semibold">Save Settings</button>
          <button id="resetBtn" class="px-4 py-3 rounded-lg border border-gray-200">Reset</button>
        </div>

        <div id="toast" class="hidden rounded-lg p-3 text-sm"></div>

        <hr />

        <!-- Registered customers count -->
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-medium text-slate-800">Registered customers</div>
            <div class="small">Customers who connected via Telegram for this store</div>
          </div>
          <div class="text-right">
            <div id="customersCount" class="text-lg font-semibold text-indigo-700">0</div>
            <div class="small text-gray-500">live</div>
          </div>
        </div>

        <!-- Announcement -->
        <div>
          <label class="text-sm font-medium text-slate-800">Send Telegram announcement</label>
          <textarea id="announceMessage" rows="4" class="mt-2 w-full px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Type message to customers..."></textarea>

          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="radio" name="announceTarget" id="modeChannel" checked />
              <span class="small">Post to store channel/group</span>
            </label>
            <label class="inline-flex items-center gap-2 text-sm ml-4">
              <input type="radio" name="announceTarget" id="modeRegistered" />
              <span class="small">Send to registered customers</span>
            </label>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="sendAnnounceBtn" class="flex-1 px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold">Send Announcement</button>
            <button id="previewBtn" class="px-4 py-3 rounded-lg border border-gray-200">Preview</button>
          </div>

          <p id="announceStatus" class="small mt-2"></p>
        </div>

      </section>

      <!-- Preview (right) -->
      <aside class="card p-4">
        <div class="flex items-center gap-4">
          <div id="pvLogoWrap" class="w-14 h-14 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
          <div class="flex-1">
            <div id="pvName" class="text-lg font-semibold text-slate-900">Your store</div>
            <div id="pvIntro" class="small">Real-time queueing system. Mobile-friendly. No app needed.</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="bg-white rounded-xl p-3 text-center">
            <button class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold">ðŸŽ« Get My Number</button>
            <p class="small mt-2 text-slate-600">This is a preview of the public page button.</p>
          </div>

          <div class="mt-3 bg-white rounded-xl p-3">
            <div class="flex items-center gap-3">
              <img id="pvAdImg" class="w-24 h-12 object-cover rounded-md border hidden" src="" alt="ad" />
              <div>
                <div id="pvAdText" class="font-medium text-slate-800">No ad</div>
                <div class="small mt-1 text-slate-500">Shown on public page</div>
              </div>
            </div>
          </div>

          <div class="mt-4 small text-slate-500">Open public page to test: <button id="openPublicBtn" class="text-indigo-600 underline">Open</button></div>
        </div>
      </aside>

    </main>

    <footer class="text-center small text-slate-500 mt-2">
      Note: announcements call your centralized server function. Registered customer chat IDs are stored server-side under <code>businesses/&lt;slug&gt;/customers</code>.
    </footer>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref as dbRef, set, get, onValue, child, remove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // your firebase config (same as index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // server endpoint (centralized) - your Netlify function
    const SEND_ENDPOINT = '/.netlify/functions/sendTelegram';

    // DOM refs
    const slugInput = document.getElementById('slugInput');
    const applySlugBtn = document.getElementById('applySlugBtn');
    const publicUrlEl = document.getElementById('publicUrl');
    const openPublic = document.getElementById('openPublic');
    const openPublicBtn = document.getElementById('openPublicBtn');

    const businessNameEl = document.getElementById('businessName');
    const introTextEl = document.getElementById('introText');

    const logoUploadEl = document.getElementById('logoUpload');
    const logoPreviewEl = document.getElementById('logoPreview');

    const adUploadEl = document.getElementById('adUpload');
    const adPreviewEl = document.getElementById('adPreview');
    const adTextEl = document.getElementById('adText');

    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const toast = document.getElementById('toast');

    const pvName = document.getElementById('pvName');
    const pvIntro = document.getElementById('pvIntro');
    const pvLogoWrap = document.getElementById('pvLogoWrap');
    const pvAdImg = document.getElementById('pvAdImg');
    const pvAdText = document.getElementById('pvAdText');

    const customersCountEl = document.getElementById('customersCount');

    const announceMessageEl = document.getElementById('announceMessage');
    const sendAnnounceBtn = document.getElementById('sendAnnounceBtn');
    const previewBtnEl = document.getElementById('previewBtn');
    const announceStatusEl = document.getElementById('announceStatus');

    // helpers
    function showToast(msg, type='success') {
      toast.classList.remove('hidden');
      toast.textContent = msg;
      toast.style.background = type === 'error' ? '#fee2e2' : '#ecfdf5';
      toast.style.color = type === 'error' ? '#991b1b' : '#065f46';
      setTimeout(() => toast.classList.add('hidden'), 3500);
    }

    function pathFor(key) {
      if (!slug) return `settings/${key}`;
      return `businesses/${slug}/settings/${key}`;
    }
    function customersPath() {
      if (!slug) return `customers`; // fallback global customers
      return `businesses/${slug}/customers`;
    }

    // read slug from querystring
    const params = new URLSearchParams(window.location.search);
    let slug = (params.get('business') || '').trim().toLowerCase();
    slugInput.value = slug || '';

    // set public url and open links
    function updatePublicLinks() {
      const url = slug ? `${location.origin}/${slug}` : `${location.origin}/`;
      publicUrlEl.textContent = slug ? url : 'Not set â€” choose a slug';
      openPublic.href = slug ? url : '#';
      openPublicBtn.onclick = () => { if (slug) window.open(url, '_blank'); else showToast('Set slug first', 'error'); };
    }
    updatePublicLinks();

    // realtime listeners for settings & customers
    let settingsListenersAttached = false;
    function attachListeners() {
      if (!slug) return;
      // name
      onValue(dbRef(db, pathFor('name')), snap => {
        const v = snap.exists() ? snap.val() : '';
        businessNameEl.value = v;
        pvName.textContent = v || 'Your store';
      });
      // intro
      onValue(dbRef(db, pathFor('introText')), snap => {
        const v = snap.exists() ? snap.val() : '';
        introTextEl.value = v;
        pvIntro.textContent = v || 'Real-time queueing system. Mobile-friendly. No app needed.';
      });
      // logo
      onValue(dbRef(db, pathFor('logo')), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (v) {
          logoPreviewEl.src = v; logoPreviewEl.classList.remove('hidden');
          pvLogoWrap.innerHTML = `<img src="${v}" class="w-full h-full object-cover rounded-lg" alt="logo">`;
        } else {
          logoPreviewEl.classList.add('hidden');
          pvLogoWrap.style.background = 'linear-gradient(90deg,#7c3aed,#06b6d4)';
          pvLogoWrap.textContent = 'QJ';
        }
      });
      // ad image
      onValue(dbRef(db, pathFor('adImage')), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (v) {
          adPreviewEl.src = v; adPreviewEl.classList.remove('hidden');
          pvAdImg.src = v; pvAdImg.classList.remove('hidden');
        } else {
          adPreviewEl.classList.add('hidden');
          pvAdImg.classList.add('hidden');
        }
      });
      // ad text
      onValue(dbRef(db, pathFor('adText')), snap => {
        const v = snap.exists() ? snap.val() : '';
        adTextEl.value = v;
        pvAdText.textContent = v || 'No ad';
      });

      // customers count
      onValue(dbRef(db, customersPath()), snap => {
        if (!snap.exists()) {
          customersCountEl.textContent = '0';
          return;
        }
        const count = Object.keys(snap.val() || {}).length;
        customersCountEl.textContent = String(count);
      });

      settingsListenersAttached = true;
    }

    // apply slug button
    applySlugBtn.addEventListener('click', () => {
      const raw = (slugInput.value || '').trim().toLowerCase();
      if (!raw) return showToast('Enter a slug (letters/numbers/hyphen)', 'error');
      slug = raw.replace(/[^a-z0-9\-]/g, '-');
      slugInput.value = slug;
      updatePublicLinks();
      attachListeners();
      showToast('Slug applied â€” press Save to persist settings', 'success');
    });

    // file -> base64 util
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onerror = () => reject(new Error('File read failed'));
        r.onload = () => resolve(r.result);
        r.readAsDataURL(file);
      });
    }

    // local previews on file select
    logoUploadEl.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        const data = await fileToDataUrl(f);
        logoPreviewEl.src = data; logoPreviewEl.classList.remove('hidden');
        pvLogoWrap.innerHTML = `<img src="${data}" class="w-full h-full object-cover rounded-lg" alt="logo">`;
      } catch (err) {
        console.error(err);
        showToast('Logo load failed', 'error');
      }
    });
    adUploadEl.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        const data = await fileToDataUrl(f);
        adPreviewEl.src = data; adPreviewEl.classList.remove('hidden');
        pvAdImg.src = data; pvAdImg.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        showToast('Ad load failed', 'error');
      }
    });

    // Save settings (writes to Realtime DB)
    saveBtn.addEventListener('click', async () => {
      if (!slug) return showToast('Set slug first', 'error');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Savingâ€¦';
      try {
        await set(dbRef(db, pathFor('name')), businessNameEl.value || '');
        await set(dbRef(db, pathFor('introText')), introTextEl.value || '');
        await set(dbRef(db, pathFor('adText')), adTextEl.value || '');

        // upload base64 images if present in preview and data URL (not an external URL)
        if (logoPreviewEl.src && logoPreviewEl.src.startsWith('data:')) {
          await set(dbRef(db, pathFor('logo')), logoPreviewEl.src);
        }
        if (adPreviewEl.src && adPreviewEl.src.startsWith('data:')) {
          await set(dbRef(db, pathFor('adImage')), adPreviewEl.src);
        }

        showToast('Settings saved', 'success');
        updatePublicLinks();
      } catch (err) {
        console.error(err);
        showToast('Save failed', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Settings';
      }
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
      if (!confirm('Reload saved settings? Unsaved changes will be lost.')) return;
      location.reload();
    });

    // Announcement preview
    previewBtnEl.addEventListener('click', () => {
      const txt = (announceMessageEl.value || '').trim();
      if (!txt) return showToast('Type message to preview', 'error');
      alert('Preview:\n\n' + txt);
    });

    // Send announcement
    sendAnnounceBtn.addEventListener('click', async () => {
      const message = (announceMessageEl.value || '').trim();
      if (!message) return showToast('Type announcement', 'error');
      if (!slug) return showToast('Set slug first', 'error');

      // confirm when sending to registered customers (dangerous)
      const targetMode = document.getElementById('modeRegistered').checked ? 'registered' : 'channel';
      if (targetMode === 'registered') {
        const cnt = Number(customersCountEl.textContent || 0);
        if (cnt === 0) {
          announceStatusEl.textContent = 'No registered customers to send to.';
          announceStatusEl.style.color = '#b91c1c';
          return;
        }
        if (!confirm(`Send message to ${cnt} registered customers of "${slug}"?`)) return;
      }

      sendAnnounceBtn.disabled = true;
      sendAnnounceBtn.textContent = 'Sendingâ€¦';
      announceStatusEl.textContent = '';

      try {
        const payload = { business: slug, message, mode: targetMode };
        const res = await fetch(SEND_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ ok:false }));

        if (res.ok) {
          announceStatusEl.textContent = j.message || 'Announcement sent/queued';
          announceStatusEl.style.color = '#065f46';
          showToast('Announcement sent', 'success');
        } else {
          announceStatusEl.textContent = (j && j.error) ? j.error : `Failed (${res.status})`;
          announceStatusEl.style.color = '#b91c1c';
          showToast('Announcement failed', 'error');
        }
      } catch (err) {
        console.error(err);
        announceStatusEl.textContent = 'Network error';
        announceStatusEl.style.color = '#b91c1c';
        showToast('Network error', 'error');
      } finally {
        sendAnnounceBtn.disabled = false;
        sendAnnounceBtn.textContent = 'Send Announcement';
      }
    });

    // initialize listeners if slug present from query param
    if (slug) {
      updatePublicLinks();
      attachListeners();
      showToast('Editing store: ' + slug, 'success');
    } else {
      // allow user to type slug and apply
      showToast('No slug selected â€” enter slug and press Apply', 'error');
    }

    // small UX: open public
    openPublic.addEventListener('click', (e) => {
      if (!slug) { e.preventDefault(); showToast('Set slug first','error'); }
    });

  </script>
</body>
</html>
