<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>QueueJoy Admin ‚Äî Real-Time Queue Management</title>
    <meta name="description" content="QueueJoy Admin Panel - Manage queues, announcements, and analytics in real-time" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <meta property="og:title" content="QueueJoy Admin ‚Äî Real-Time Queue Management" />
    <meta property="og:description" content="Manage queues, send announcements, and view analytics in real-time" />
    <link rel="canonical" href="/admin.html" />
    <style>
      :root { --primary: 264 83% 62%; --accent: 197 92% 44%; --muted: 220 14% 56%; }
      * { scrollbar-width: thin; scrollbar-color: rgba(139,92,246,0.3) transparent; }
      *::-webkit-scrollbar { width: 8px; height: 8px; }
      *::-webkit-scrollbar-track { background: transparent; }
      *::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.3); border-radius: 10px; }
      *::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.5); }
      body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        -webkit-font-smoothing: antialiased;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
      }
      @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
      .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 1px solid rgba(255,255,255,0.3); }
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
      .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease-out; }
      @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      .spinner { border: 2px solid #f3f3f3; border-top: 2px solid hsl(var(--primary)); border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; }
      @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
      .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 260px; background: linear-gradient(180deg, rgba(99,102,241,0.95) 0%, rgba(139,92,246,0.95) 50%, rgba(168,85,247,0.95) 100%); backdrop-filter: blur(20px); z-index: 50; transition: transform .3s cubic-bezier(.4,0,.2,1); box-shadow: 8px 0 40px rgba(139,92,246,.4), 0 0 0 1px rgba(255,255,255,.2) inset; border-right: 1px solid rgba(255,255,255,.2); }
      .sidebar-mobile-closed { transform: translateX(-100%); }
      .sidebar-item { display:flex; align-items:center; gap:14px; padding:16px 24px; margin:6px 12px; color:#fff; cursor:pointer; transition: all .3s cubic-bezier(.4,0,.2,1); font-weight:600; border-radius:12px; position:relative; overflow:hidden; }
      .sidebar-item::before { content:''; position:absolute; inset:0; background: rgba(255,255,255,0); transition: all .3s cubic-bezier(.4,0,.2,1); z-index:-1; }
      .sidebar-item:hover::before { background: rgba(255,255,255,0.15); }
      .sidebar-item.active { background: rgba(255,255,255,0.25); box-shadow:0 8px 20px rgba(0,0,0,0.15); transform: translateX(4px); }
      .sidebar-item.active::before { background: rgba(255,255,255,0.25); }
      .main-content { margin-left:260px; transition: margin-left .3s cubic-bezier(.4,0,.2,1); }
      @media (max-width: 1024px) { .main-content { margin-left:0; } }
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px; }
      .modal-content { background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y:auto; padding:32px; box-shadow: 0 30px 80px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 1px solid rgba(255,255,255,0.3); }
      .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius:16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
      .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
      .stat-card { position:relative; overflow:hidden; transition: all 0.3s ease; }
      .stat-card::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s infinite; }
      @keyframes shimmer { 0%,100%{ transform: translate(0,0);} 50%{ transform: translate(-20%,-20%);} }
      .cropper-container { max-height: 400px; margin: 20px 0; }
      .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
      @keyframes pulseGlow { 0%, 100% { box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset; } 50% { box-shadow: 0 25px 70px rgba(139,92,246,0.3), 0 0 0 1px rgba(255,255,255,0.7) inset; } }
      .stat-icon { width: 64px; height: 64px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
      .chart-container { position: relative; height: 300px; }
    </style>
  </head>
  <body class="min-h-screen">
    <aside id="sidebar" class="sidebar sidebar-mobile-closed lg:transform-none">
      <div class="p-8 border-b border-white/20">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-lg flex items-center justify-center text-white text-lg font-bold shadow-lg">QJ</div>
          <h1 class="text-white text-2xl font-bold tracking-tight">QueueJoy</h1>
        </div>
        <p class="text-white/80 text-sm font-medium ml-13">Admin Panel</p>
      </div>
      <nav class="mt-6">
        <div class="sidebar-item active" data-view="dashboard"><span class="text-2xl">üè†</span><span class="text-base">Dashboard</span></div>
        <div class="sidebar-item" data-view="analyst"><span class="text-2xl">üìä</span><span class="text-base">Analytics</span></div>
        <div class="sidebar-item" id="howToUseBtn"><span class="text-2xl">‚ùì</span><span class="text-base">How to Use</span></div>
      </nav>
    </aside>

    <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-40 p-4 bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-2xl shadow-2xl hover:scale-110 transition-all duration-300">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <div class="main-content">
      <div class="max-w-7xl mx-auto p-4 pb-20 fade-in">
        <div id="dashboardView">
          <header class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-8 mt-16 lg:mt-6">
            <div class="flex items-center gap-4">
              <div id="headerLogo" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-600 via-purple-500 to-indigo-500 flex items-center justify-center text-white text-2xl font-bold shadow-2xl ring-4 ring-white/30">QJ</div>
              <div>
                <h2 id="headerName" class="text-3xl font-bold gradient-text">Queue Joy Admin</h2>
                <p class="text-sm text-gray-700 font-medium mt-1">Real-time management dashboard</p>
              </div>
            </div>
            <button id="saveAllBtn" class="px-8 py-4 bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">üíæ Save All Changes</button>
          </header>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Total Queues</p>
                  <p id="totalQueues" class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="stat-icon bg-gradient-to-br from-blue-500 to-cyan-500 text-white">üìä</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Waiting Now</p>
                  <p id="activeQueues" class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="stat-icon bg-gradient-to-br from-purple-500 to-pink-500 text-white">‚è≥</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Served Today</p>
                  <p id="todayQueues" class="text-4xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="stat-icon bg-gradient-to-br from-green-500 to-emerald-500 text-white">‚úÖ</div>
              </div>
            </div>
            <div class="card p-8 stat-card hover:scale-105 transition-all duration-300 cursor-pointer">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-600 mb-3">Active Counters</p>
                  <p id="activeCounters" class="text-4xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">0</p>
                </div>
                <div class="stat-icon bg-gradient-to-br from-orange-500 to-red-500 text-white">üè™</div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-8 space-y-6">
              <h3 class="text-2xl font-bold gradient-text mb-6">‚öôÔ∏è Business Settings</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
                <input id="businessName" type="text" placeholder="Your Business Name" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Welcome Message</label>
                <textarea id="welcomeMessage" rows="3" placeholder="Real-time queueing system. Mobile-friendly. No app needed." class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Logo Image (Square)</label>
                <div class="flex items-center gap-3">
                  <img id="logoPreview" src="" alt="Logo" class="w-16 h-16 rounded-lg object-cover border-2 border-gray-200 hidden" />
                  <div class="flex-1">
                    <input id="logoFile" type="file" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"/>
                    <p class="text-xs text-gray-500 mt-1">Click to crop before saving</p>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Advertisement Banner (Landscape)</label>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div id="adPreviewBox" class="w-32 h-20 rounded-lg overflow-hidden border-2 border-gray-200 hidden"></div>
                    <div class="flex-1">
                      <input id="adFile" type="file" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-600 file:font-semibold hover:file:bg-purple-100 cursor-pointer"/>
                      <p class="text-xs text-gray-500 mt-1">Click to crop before saving</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card p-8 space-y-6">
              <h3 class="text-2xl font-bold gradient-text mb-6">üñ•Ô∏è Display Settings</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Small Text (Subtitle)</label>
                <input id="displaySmallText" type="text" placeholder="Digital Queue System" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL (Centered)</label>
                <div class="space-y-2">
                  <input id="displayLogoUrl" type="text" placeholder="https://.../logo.png" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
                  <input id="displayLogoFile" type="file" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-600 file:font-semibold hover:file:bg-indigo-100 cursor-pointer"/>
                  <p class="text-xs text-gray-500">Choose file to upload, or paste URL above</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Main Title</label>
                <input id="displayMainTitle" type="text" placeholder="Get your queue number" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"/>
              </div>
              <p class="text-xs text-gray-500">These values are saved to <code class="bg-gray-100 px-2 py-1 rounded">/displaySettings</code> without touching your queue schema.</p>
            </div>

            <div class="space-y-6">
              <div class="card p-8">
                <h3 class="text-2xl font-bold gradient-text mb-6">üì¢ Telegram Announcement</h3>
                <div class="space-y-4">
                  <textarea id="announcementMessage" rows="4" placeholder="Type your announcement message here..." class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"></textarea>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Attach Media (Image, Video, or GIF)</label>
                    <input id="announcementMedia" type="file" accept="image/*,video/*,audio/*,.gif" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-50 file:text-green-600 file:font-semibold hover:file:bg-green-100 cursor-pointer" />
                    <div id="announcementPreview" class="mt-3 hidden"></div>
                  </div>
                  <button id="sendAnnouncementBtn" class="w-full py-4 bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-green-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">
                    <span id="sendBtnText">üì± Send to Telegram</span>
                    <span id="sendBtnSpinner" class="hidden"><span class="spinner"></span> Sending...</span>
                  </button>
                  <div id="announcementResult" class="hidden p-3 rounded-lg text-sm"></div>
                </div>
              </div>

              <div class="card p-8">
                <h3 class="text-2xl font-bold gradient-text mb-6">üëÅÔ∏è Live Preview (Demo)</h3>
                <div class="space-y-4">
                  <div class="flex items-center gap-4">
                    <div id="previewLogo" class="w-14 h-14 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
                    <div class="flex-1">
                      <p id="previewName" class="text-lg font-bold text-gray-800">Your Business</p>
                      <p id="previewIntro" class="text-sm text-gray-600">Real-time queueing system</p>
                    </div>
                  </div>
                  <div class="bg-gray-50 rounded-xl p-4">
                    <p class="text-xs text-gray-500 mb-2">Advertisement Preview</p>
                    <div class="flex items-center gap-3">
                      <img id="previewAd" src="" alt="Ad" class="w-24 h-16 rounded-lg object-cover border hidden" />
                    </div>
                  </div>
                  <button class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl opacity-75 cursor-not-allowed">üé´ Get My Number</button>
                  <p class="text-xs text-center text-gray-500">This is how customers see your page</p>
                </div>
              </div>
            </div>

            <div class="card p-8">
              <button id="updateSettingsBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-500 text-white font-bold rounded-2xl shadow-2xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 ring-2 ring-white/50">
                <span id="updateBtnText">‚ú® Update Settings</span>
                <span id="updateBtnSpinner" class="hidden"><span class="spinner"></span> Updating...</span>
              </button>
            </div>
          </div>

          <footer class="text-center text-sm font-medium text-gray-700 mt-12 p-6 card">
            <p>üî• Real-time sync powered by Firebase</p>
          </footer>
        </div>

        <div id="analystView" class="hidden">
          <div class="mt-16 lg:mt-6">
            <h2 class="text-3xl font-bold text-white mb-8 bg-gradient-to-r from-purple-600 to-indigo-500 p-6 rounded-2xl shadow-lg">üìä Analytics Dashboard</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div class="card p-6 bg-gradient-to-br from-purple-600 to-purple-400 text-white pulse-glow">
                <p class="text-sm opacity-90 mb-2 font-semibold">Total Served</p>
                <p id="analystTotalServed" class="text-5xl font-extrabold">0</p>
                <p class="text-xs opacity-75 mt-2">All completed queues</p>
              </div>
              <div class="card p-6 bg-gradient-to-br from-indigo-600 to-indigo-400 text-white pulse-glow">
                <p class="text-sm opacity-90 mb-2 font-semibold">Waiting Now</p>
                <p id="analystWaiting" class="text-5xl font-extrabold">0</p>
                <p class="text-xs opacity-75 mt-2">Currently in queue</p>
              </div>
              <div class="card p-6 bg-gradient-to-br from-pink-600 to-pink-400 text-white pulse-glow">
                <p class="text-sm opacity-90 mb-2 font-semibold">Being Served</p>
                <p id="analystServing" class="text-5xl font-extrabold">0</p>
                <p class="text-xs opacity-75 mt-2">At counters now</p>
              </div>
              <div class="card p-6 bg-gradient-to-br from-teal-600 to-teal-400 text-white pulse-glow">
                <p class="text-sm opacity-90 mb-2 font-semibold">Active Counters</p>
                <p id="analystActiveCounters" class="text-5xl font-extrabold">0</p>
                <p class="text-xs opacity-75 mt-2">Currently open</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="text-2xl">üìà</span> Queue Trend (Last 7 Days)</h3>
                <div class="chart-container"><canvas id="queueTrendChart"></canvas></div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="text-2xl">üèÜ</span> Counter Performance</h3>
                <div class="chart-container"><canvas id="counterPerfChart"></canvas></div>
              </div>
            </div>

            <div class="card p-8">
              <h3 class="text-2xl font-bold gradient-text mb-6 flex items-center gap-2"><span class="text-2xl">üìä</span> Queue Status Breakdown</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 hover:scale-105 transition-all cursor-pointer">
                  <div class="text-5xl mb-2">‚úÖ</div>
                  <p class="text-4xl font-extrabold text-green-600" id="analystCompleted">0</p>
                  <p class="text-sm text-gray-600 mt-2 font-semibold">Completed</p>
                </div>
                <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 hover:scale-105 transition-all cursor-pointer">
                  <div class="text-5xl mb-2">‚è≥</div>
                  <p class="text-4xl font-extrabold text-blue-600" id="analystWaitingDetail">0</p>
                  <p class="text-sm text-gray-600 mt-2 font-semibold">Waiting</p>
                </div>
                <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200 hover:scale-105 transition-all cursor-pointer">
                  <div class="text-5xl mb-2">üîÑ</div>
                  <p class="text-4xl font-extrabold text-purple-600" id="analystServingDetail">0</p>
                  <p class="text-sm text-gray-600 mt-2 font-semibold">Serving</p>
                </div>
                <div class="text-center p-6 bg-gradient-to-br from-gray-50 to-slate-50 rounded-xl border-2 border-gray-200 hover:scale-105 transition-all cursor-pointer">
                  <div class="text-5xl mb-2">‚ùå</div>
                  <p class="text-4xl font-extrabold text-gray-600" id="analystCancelled">0</p>
                  <p class="text-sm text-gray-600 mt-2 font-semibold">Cancelled</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="cropModal" class="modal hidden">
      <div class="modal-content">
        <h3 class="text-xl font-bold text-gray-800 mb-4" id="cropModalTitle">Crop Image</h3>
        <div class="cropper-container"><img id="cropImage" src="" alt="Crop" style="max-width: 100%;" /></div>
        <div class="flex gap-3 mt-4">
          <button id="cropSaveBtn" class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all">‚úÇÔ∏è Crop & Save</button>
          <button id="cropCancelBtn" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all">Cancel</button>
        </div>
      </div>
    </div>

    <div id="howToUseModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-gray-800">‚ùì How to Use QueueJoy Admin</h3>
          <button id="closeHowToUse" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="space-y-4 text-gray-700">
          <div class="p-4 bg-purple-50 rounded-lg">
            <h4 class="font-bold text-purple-700 mb-2">üè† Dashboard</h4>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>Edit your business name and welcome message</li>
              <li>Upload and crop logo (square) and ad banner (landscape)</li>
              <li>Logo URL accepts file upload or direct URL input</li>
              <li>Send Telegram announcements with optional media</li>
              <li>View live preview of how customers see your page</li>
            </ul>
          </div>
          <div class="p-4 bg-indigo-50 rounded-lg">
            <h4 class="font-bold text-indigo-700 mb-2">‚úÇÔ∏è Image Cropping</h4>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>Upload an image using the file input</li>
              <li>Cropping tool will appear automatically</li>
              <li>Logo: Square crop (1:1 ratio)</li>
              <li>Ad Banner: Landscape crop (16:9 ratio)</li>
              <li>Click "Crop & Save" to finalize</li>
            </ul>
          </div>
          <div class="p-4 bg-pink-50 rounded-lg">
            <h4 class="font-bold text-pink-700 mb-2">üìä Analytics View</h4>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>View real-time queue statistics from Firebase</li>
              <li>Monitor completed, waiting, serving, and cancelled queues</li>
              <li>Track counter performance with live charts</li>
              <li>All data synced directly from your Firebase database</li>
            </ul>
          </div>
          <div class="p-4 bg-green-50 rounded-lg">
            <h4 class="font-bold text-green-700 mb-2">üíæ Saving Changes</h4>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>All changes auto-sync to Firebase in real-time</li>
              <li>Click "Update Settings" or "Save All Changes"</li>
              <li>Green toast notification confirms successful save</li>
              <li>Changes appear instantly on your public queue page</li>
            </ul>
          </div>
        </div>
        <button id="closeHowToUseBtn" class="w-full mt-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all">Got it!</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
        authDomain: "queue-joy-aa21b.firebaseapp.com",
        databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "queue-joy-aa21b",
        storageBucket: "queue-joy-aa21b.appspot.com",
        messagingSenderId: "950240394209",
        appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
        toast.textContent = type === 'success' ? `‚úÖ ${message}` : `‚ö†Ô∏è ${message}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      };

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const businessName = document.getElementById('businessName');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const logoFile = document.getElementById('logoFile');
      const logoPreview = document.getElementById('logoPreview');
      const adFile = document.getElementById('adFile');
      const adPreviewBox = document.getElementById('adPreviewBox');
      const updateSettingsBtn = document.getElementById('updateSettingsBtn');
      const updateBtnText = document.getElementById('updateBtnText');
      const updateBtnSpinner = document.getElementById('updateBtnSpinner');
      const saveAllBtn = document.getElementById('saveAllBtn');
      const displaySmallText = document.getElementById('displaySmallText');
      const displayLogoUrl = document.getElementById('displayLogoUrl');
      const displayLogoFile = document.getElementById('displayLogoFile');
      const displayMainTitle = document.getElementById('displayMainTitle');

      const previewName = document.getElementById('previewName');
      const previewIntro = document.getElementById('previewIntro');
      const previewLogo = document.getElementById('previewLogo');
      const previewAd = document.getElementById('previewAd');
      const headerLogo = document.getElementById('headerLogo');
      const headerName = document.getElementById('headerName');

      const announcementMessage = document.getElementById('announcementMessage');
      const announcementMedia = document.getElementById('announcementMedia');
      const announcementPreview = document.getElementById('announcementPreview');
      const sendAnnouncementBtn = document.getElementById('sendAnnouncementBtn');
      const sendBtnText = document.getElementById('sendBtnText');
      const sendBtnSpinner = document.getElementById('sendBtnSpinner');
      const announcementResult = document.getElementById('announcementResult');

      const cropModal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const cropSaveBtn = document.getElementById('cropSaveBtn');
      const cropCancelBtn = document.getElementById('cropCancelBtn');
      const cropModalTitle = document.getElementById('cropModalTitle');

      const howToUseModal = document.getElementById('howToUseModal');
      const howToUseBtn = document.getElementById('howToUseBtn');
      const closeHowToUse = document.getElementById('closeHowToUse');
      const closeHowToUseBtn = document.getElementById('closeHowToUseBtn');

      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const dashboardView = document.getElementById('dashboardView');
      const analystView = document.getElementById('analystView');
      const sidebarItems = document.querySelectorAll('.sidebar-item[data-view]');

      const totalQueuesEl = document.getElementById('totalQueues');
      const activeQueuesEl = document.getElementById('activeQueues');
      const todayQueuesEl = document.getElementById('todayQueues');
      const activeCountersEl = document.getElementById('activeCounters');

      const analystTotalServed = document.getElementById('analystTotalServed');
      const analystWaiting = document.getElementById('analystWaiting');
      const analystServing = document.getElementById('analystServing');
      const analystActiveCounters = document.getElementById('analystActiveCounters');
      const analystCompleted = document.getElementById('analystCompleted');
      const analystWaitingDetail = document.getElementById('analystWaitingDetail');
      const analystServingDetail = document.getElementById('analystServingDetail');
      const analystCancelled = document.getElementById('analystCancelled');

      mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('sidebar-mobile-closed'));

      sidebarItems.forEach(item => {
        item.addEventListener('click', () => {
          const view = item.dataset.view;
          sidebarItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          if (view === 'dashboard') {
            dashboardView.classList.remove('hidden');
            analystView.classList.add('hidden');
          } else {
            dashboardView.classList.add('hidden');
            analystView.classList.remove('hidden');
            initializeCharts();
          }
          sidebar.classList.add('sidebar-mobile-closed');
        });
      });

      howToUseBtn.addEventListener('click', () => { howToUseModal.classList.remove('hidden'); sidebar.classList.add('sidebar-mobile-closed'); });
      closeHowToUse.addEventListener('click', () => howToUseModal.classList.add('hidden'));
      closeHowToUseBtn.addEventListener('click', () => howToUseModal.classList.add('hidden'));

      // Real-time Queue Analytics
      let queueData = {};
      onValue(ref(db, 'queue'), (snapshot) => {
        if (snapshot.exists()) {
          queueData = snapshot.val();
          const queues = Object.values(queueData);
          const total = queues.length;
          const waiting = queues.filter(q => q.status === 'waiting').length;
          const serving = queues.filter(q => q.status === 'serving').length;
          const completed = queues.filter(q => q.status === 'done' || q.status === 'served').length;
          const cancelled = queues.filter(q => q.status === 'cancelled').length;

          totalQueuesEl.textContent = total;
          activeQueuesEl.textContent = waiting;

          const today = new Date().setHours(0,0,0,0);
          const todayCount = queues.filter(q => {
            const ts = q.timestamp;
            if (!ts) return false;
            return new Date(ts).setHours(0,0,0,0) === today && (q.status === 'done' || q.status === 'served');
          }).length;
          todayQueuesEl.textContent = todayCount;

          analystTotalServed.textContent = completed;
          analystCompleted.textContent = completed;
          analystWaiting.textContent = waiting;
          analystWaitingDetail.textContent = waiting;
          analystServing.textContent = serving;
          analystServingDetail.textContent = serving;
          analystCancelled.textContent = cancelled;

          updateCharts();
        } else {
          [totalQueuesEl, activeQueuesEl, todayQueuesEl, analystTotalServed, analystCompleted, analystWaiting, analystWaitingDetail, analystServing, analystServingDetail, analystCancelled].forEach(el => el.textContent = '0');
        }
      });

      onValue(ref(db, 'counters'), (snapshot) => {
        if (snapshot.exists()) {
          const counters = Object.values(snapshot.val());
          const activeCount = counters.filter(c => !!c.active).length;
          activeCountersEl.textContent = activeCount;
          analystActiveCounters.textContent = activeCount;
        } else {
          activeCountersEl.textContent = '0';
          analystActiveCounters.textContent = '0';
        }
      });

      onValue(ref(db, 'settings/name'), (snap) => { if (snap.exists()) { const v = snap.val(); businessName.value = v; previewName.textContent = v; headerName.textContent = v; } });
      onValue(ref(db, 'settings/introText'), (snap) => { if (snap.exists()) { const v = snap.val(); welcomeMessage.value = v; previewIntro.textContent = v; } });
      onValue(ref(db, 'settings/logo'), (snap) => { if (snap.exists()) { const v = snap.val(); logoPreview.src = v; logoPreview.classList.remove('hidden'); previewLogo.innerHTML = `<img src="${v}" class="w-full h-full rounded-xl object-cover" />`; headerLogo.innerHTML = `<img src="${v}" class="w-full h-full rounded-xl object-cover" />`; } });
      onValue(ref(db, 'displaySettings'), (snap) => {
        if (snap.exists()) { const v = snap.val(); displaySmallText.value = v.smallText || ''; displayLogoUrl.value = v.logoUrl || ''; displayMainTitle.value = v.mainTitle || ''; }
      });
      onValue(ref(db, 'settings/adImage'), (snap) => { 
        if (snap.exists()) { 
          const v = snap.val();
          if (typeof v === 'string' && v.startsWith('data:video/')) {
            adPreviewBox.innerHTML = `<video src="${v}" class="w-full h-full object-cover" controls></video>`;
          } else {
            adPreviewBox.innerHTML = `<img src="${v}" class="w-full h-full object-cover" />`;
          }
          adPreviewBox.classList.remove('hidden');
          previewAd.src = v; previewAd.classList.remove('hidden');
          adData = v;
        } else { 
          adPreviewBox.classList.add('hidden'); previewAd.classList.add('hidden'); 
        } 
      });

      // Display Logo File Upload
      displayLogoFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const base64 = await fileToBase64(file);
        displayLogoUrl.value = base64;
        showToast('Logo file loaded! Click Save to update.');
      });

      let currentCropper = null; let currentCropType = '';
      let adData = '';
      logoFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        currentCropType = 'logo'; cropModalTitle.textContent = 'Crop Logo (Square)';
        const base64 = await fileToBase64(file); cropImage.src = base64; cropModal.classList.remove('hidden');
        if (currentCropper) currentCropper.destroy();
        currentCropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2, autoCropArea: 1 });
      });
      adFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        if (file.size > 50 * 1024 * 1024) { showToast('File too large! Max 50MB', 'error'); return; }
        const base64 = await fileToBase64(file);
        const type = file.type || '';
        if (type.startsWith('video/')) {
          adData = base64;
          adPreviewBox.innerHTML = `<video src="${base64}" class="w-full h-full object-cover" controls></video>`;
          adPreviewBox.classList.remove('hidden');
          return;
        }
        if (type === 'image/gif') {
          adData = base64;
          adPreviewBox.innerHTML = `<img src="${base64}" class="w-full h-full object-cover" />`;
          adPreviewBox.classList.remove('hidden');
          return;
        }
        currentCropType = 'ad'; cropModalTitle.textContent = 'Crop Ad Banner (Landscape)';
        cropImage.src = base64; cropModal.classList.remove('hidden');
        if (currentCropper) currentCropper.destroy();
        currentCropper = new Cropper(cropImage, { aspectRatio: 16/9, viewMode: 2, autoCropArea: 1 });
      });
      cropSaveBtn.addEventListener('click', () => {
        if (!currentCropper) return; const canvas = currentCropper.getCroppedCanvas(); const cropped = canvas.toDataURL('image/jpeg', 0.9);
        if (currentCropType === 'logo') {
          logoPreview.src = cropped; logoPreview.classList.remove('hidden');
          previewLogo.innerHTML = `<img src="${cropped}" class="w-full h-full rounded-xl object-cover" />`;
          headerLogo.innerHTML = `<img src="${cropped}" class="w-full h-full rounded-xl object-cover" />`;
        }
        if (currentCropType === 'ad') {
          adData = cropped;
          adPreviewBox.innerHTML = `<img src="${cropped}" class="w-full h-full object-cover" />`;
          adPreviewBox.classList.remove('hidden');
          previewAd.src = cropped; previewAd.classList.remove('hidden');
        }
        cropModal.classList.add('hidden'); currentCropper.destroy(); currentCropper = null; showToast('Image cropped successfully');
      });
      cropCancelBtn.addEventListener('click', () => { cropModal.classList.add('hidden'); if (currentCropper) { currentCropper.destroy(); currentCropper = null; } if (currentCropType === 'logo') logoFile.value=''; else if (currentCropType === 'ad') adFile.value=''; });

      const updateSettings = async () => {
        updateBtnText.classList.add('hidden'); updateBtnSpinner.classList.remove('hidden'); updateSettingsBtn.disabled = true;
        try {
          const updates = { name: businessName.value, introText: welcomeMessage.value };
          if (logoPreview.src && logoPreview.src.startsWith('data:')) updates.logo = logoPreview.src;
          if (adData && typeof adData === 'string' && adData.startsWith('data:')) updates.adImage = adData;
          await set(ref(db, 'settings'), updates);
          await set(ref(db, 'displaySettings'), {
            smallText: displaySmallText.value || 'Digital Queue System',
            logoUrl: displayLogoUrl.value || '',
            mainTitle: displayMainTitle.value || 'Get your queue number'
          });
          showToast('Settings updated successfully!');
        } catch (err) { console.error(err); showToast('Failed to update settings', 'error'); }
        finally { updateBtnText.classList.remove('hidden'); updateBtnSpinner.classList.add('hidden'); updateSettingsBtn.disabled = false; }
      };
      updateSettingsBtn.addEventListener('click', updateSettings);
      saveAllBtn.addEventListener('click', updateSettings);

      let selectedMediaFile = null;
      announcementMedia.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; selectedMediaFile = file || null; announcementPreview.innerHTML = ''; announcementPreview.classList.add('hidden');
        if (file) {
          if (file.size > 50 * 1024 * 1024) { showToast('File too large! Max 50MB', 'error'); selectedMediaFile = null; return; }
          const url = URL.createObjectURL(file);
          if (file.type.startsWith('video/')) {
            const video = document.createElement('video'); video.src = url; video.controls = true; video.className = 'w-full h-48 rounded-lg object-cover'; announcementPreview.appendChild(video);
          } else if (file.type.startsWith('audio/')) {
            const audio = document.createElement('audio'); audio.src = url; audio.controls = true; audio.className = 'w-full'; announcementPreview.appendChild(audio);
          } else {
            const img = document.createElement('img'); img.src = url; img.className = 'w-full h-48 rounded-lg object-cover'; announcementPreview.appendChild(img);
          }
          announcementPreview.classList.remove('hidden');
        }
      });

      sendAnnouncementBtn.addEventListener('click', async () => {
        const message = announcementMessage.value.trim();
        if (!message && !selectedMediaFile) { showToast('Please enter a message or attach media', 'error'); return; }
        sendBtnText.classList.add('hidden'); sendBtnSpinner.classList.remove('hidden'); sendAnnouncementBtn.disabled = true;
        try {
          let mediaBase64 = '';
          let mediaType = '';
          if (selectedMediaFile) { mediaBase64 = await fileToBase64(selectedMediaFile); mediaType = selectedMediaFile.type; }
          const res = await fetch('/.netlify/functions/announce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message, media: mediaBase64, mediaType }) });
          const result = await res.json();
          if (!res.ok) throw new Error(result.error || 'Failed to send');
          announcementResult.className = 'p-3 rounded-lg text-sm bg-green-50 text-green-700 border border-green-200';
          announcementResult.textContent = '‚úÖ ' + (result.message || 'Announcement sent successfully!');
          announcementMessage.value=''; announcementMedia.value=''; announcementPreview.innerHTML=''; announcementPreview.classList.add('hidden'); selectedMediaFile = null; showToast('Announcement sent!');
        } catch (error) {
          console.error('Announcement error:', error);
          announcementResult.className = 'p-3 rounded-lg text-sm bg-red-50 text-red-700 border border-red-200';
          announcementResult.textContent = '‚ö†Ô∏è ' + (error.message || 'Failed to send announcement');
          showToast('Failed to send announcement', 'error');
        } finally {
          announcementResult.classList.remove('hidden');
          sendBtnText.classList.remove('hidden'); sendBtnSpinner.classList.add('hidden'); sendAnnouncementBtn.disabled = false;
          setTimeout(() => announcementResult.classList.add('hidden'), 5000);
        }
      });

      // Charts
      let queueTrendChart = null; let counterPerfChart = null;

      function getLast7DaysData() {
        const days = [];
        const counts = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          date.setHours(0, 0, 0, 0);
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);
          
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          days.push(dayName);
          
          const queues = Object.values(queueData);
          const dayCount = queues.filter(q => {
            const ts = q.timestamp;
            if (!ts) return false;
            const qDate = new Date(ts);
            return qDate >= date && qDate < nextDay && (q.status === 'done' || q.status === 'served');
          }).length;
          counts.push(dayCount);
        }
        return { days, counts };
      }

      async function getCounterPerformance() {
        const countersSnapshot = await get(ref(db, 'counters'));
        if (!countersSnapshot.exists()) return { names: [], counts: [] };
        
        const counters = countersSnapshot.val();
        const counterIds = Object.keys(counters);
        const names = [];
        const counts = [];
        
        counterIds.forEach(counterId => {
          const counter = counters[counterId];
          names.push(counter.name || counterId);
          
          const queues = Object.values(queueData);
          const servedCount = queues.filter(q => 
            q.counterId === counterId && (q.status === 'done' || q.status === 'served')
          ).length;
          counts.push(servedCount);
        });
        
        return { names, counts };
      }

      function updateCharts() {
        if (queueTrendChart) {
          const { days, counts } = getLast7DaysData();
          queueTrendChart.data.labels = days;
          queueTrendChart.data.datasets[0].data = counts;
          queueTrendChart.update();
        }
        
        if (counterPerfChart) {
          getCounterPerformance().then(({ names, counts }) => {
            counterPerfChart.data.labels = names;
            counterPerfChart.data.datasets[0].data = counts;
            counterPerfChart.update();
          });
        }
      }

      function initializeCharts() {
        const queueCtx = document.getElementById('queueTrendChart');
        if (queueCtx && !queueTrendChart) {
          const { days, counts } = getLast7DaysData();
          queueTrendChart = new Chart(queueCtx, {
            type: 'line',
            data: { 
              labels: days, 
              datasets: [{ 
                label: 'Customers Served', 
                data: counts, 
                borderColor: 'rgb(168,85,247)', 
                backgroundColor: 'rgba(168,85,247,0.1)', 
                tension: 0.4, 
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
              }] 
            },
            options: { 
              responsive: true, 
              maintainAspectRatio: false, 
              plugins: { legend: { display: true, labels: { font: { size: 14, weight: 'bold' } } } }, 
              scales: { y: { beginAtZero: true, ticks: { font: { size: 12 } } }, x: { ticks: { font: { size: 12 } } } } 
            }
          });
        }
        
        const counterCtx = document.getElementById('counterPerfChart');
        if (counterCtx && !counterPerfChart) {
          getCounterPerformance().then(({ names, counts }) => {
            counterPerfChart = new Chart(counterCtx, {
              type: 'bar',
              data: { 
                labels: names, 
                datasets: [{ 
                  label: 'Customers Served', 
                  data: counts, 
                  backgroundColor: ['rgba(99,102,241,0.8)','rgba(168,85,247,0.8)','rgba(236,72,153,0.8)','rgba(59,130,246,0.8)'] 
                }] 
              },
              options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { y: { beginAtZero: true, ticks: { font: { size: 12 } } }, x: { ticks: { font: { size: 11 } } } } 
              }
            });
          });
        }
      }
    </script>
  </body>
</html>
