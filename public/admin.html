<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QueueJoy â€” Admin (Live Sync)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --muted:#6b7280; --accent-from:#7c3aed; --accent-to:#06b6d4; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#f0f9ff 0,#f5f3ff 100%); -webkit-font-smoothing:antialiased; }
    .card { background:#fff; border-radius:12px; box-shadow: 0 10px 30px rgba(10,10,30,0.06); }
    .small { font-size:13px; color:var(--muted); }
    .hidden { display:none; }
    .safe-pad { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    input[type=file] { display:block; }
  </style>
</head>
<body class="safe-pad p-4">
  <div class="max-w-3xl mx-auto space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
        <div>
          <div class="text-lg font-semibold text-slate-900">QueueJoy â€” Admin</div>
          <div class="small">Live edit â€” changes immediately appear on the public page</div>
        </div>
      </div>
      <div>
        <a id="openPublic" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg text-white" style="background:linear-gradient(90deg,var(--accent-from),var(--accent-to))" target="_blank">Open Public</a>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- controls -->
      <section class="card p-4 space-y-4">
        <div>
          <label class="block text-xs text-slate-600">Public URL slug (optional)</label>
          <input id="slug" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="(optional) e.g. mycafe" />
          <p class="small mt-1">If you use per-store slugs, admin will write to <code>businesses/&lt;slug&gt;/settings/*</code>. Otherwise it writes to global <code>settings/*</code>.</p>
        </div>

        <div>
          <label class="block text-xs text-slate-600">Business name (optional)</label>
          <input id="name" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Coffee Lab" />
        </div>

        <div>
          <label class="block text-xs text-slate-600">Welcome / Intro text</label>
          <input id="intro" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Real-time queueing system. Mobile-friendly. No app needed." />
          <p class="small mt-1">Saved to <code>settings/introText</code> (or <code>businesses/&lt;slug&gt;/settings/introText</code> if slug provided).</p>
        </div>

        <div>
          <label class="block text-xs text-slate-600">Logo (optional)</label>
          <div class="mt-2 flex items-center gap-3">
            <img id="logoPreview" class="w-16 h-16 rounded-md object-cover border hidden" src="" alt="logo preview" />
            <div class="flex-1">
              <input id="logoFile" type="file" accept="image/*" class="text-sm text-slate-600" />
              <p class="small mt-1">Saved as base64 to <code>settings/logo</code> for instant preview compatibility.</p>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-xs text-slate-600">Advertisement image</label>
          <div class="mt-2 flex items-start gap-3">
            <img id="adPreview" class="w-28 h-16 rounded-md object-cover border hidden" src="" alt="ad preview" />
            <div class="flex-1">
              <input id="adFile" type="file" accept="image/*" class="text-sm text-slate-600" />
              <textarea id="adText" rows="2" class="mt-2 w-full px-3 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Ad text (optional)"></textarea>
              <p class="small mt-1">Saved to <code>settings/adImage</code> and <code>settings/adText</code>.</p>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="saveBtn" class="flex-1 px-4 py-3 rounded-lg bg-emerald-600 text-white font-semibold">Save Settings</button>
          <button id="resetBtn" class="px-4 py-3 rounded-lg border border-gray-200">Reset</button>
        </div>

        <div id="msg" class="small text-center text-gray-600"></div>
      </section>

      <!-- preview -->
      <aside class="card p-4">
        <div class="flex items-center gap-4">
          <div id="pvLogo" class="w-14 h-14 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-500 flex items-center justify-center text-white text-lg font-bold">QJ</div>
          <div class="flex-1">
            <div id="pvName" class="text-lg font-semibold text-slate-900">Your store</div>
            <div id="pvIntro" class="small">Real-time queueing system. Mobile-friendly. No app needed.</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="bg-white rounded-xl p-3 text-center">
            <button class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-500 text-white font-semibold">ðŸŽ« Get My Number</button>
            <p class="small mt-2 text-slate-600">This preview reflects the live public page.</p>
          </div>

          <div class="mt-3 bg-white rounded-xl p-3">
            <div class="flex items-center gap-3">
              <img id="pvAd" class="w-24 h-12 object-cover rounded-md border hidden" src="" alt="ad" />
              <div>
                <div id="pvAdText" class="font-medium text-slate-800">No ad</div>
                <div class="small mt-1 text-slate-500">Shown on public page</div>
              </div>
            </div>
          </div>

          <div class="mt-4 small text-slate-500">Open public page: <button id="openPublicBtn" class="text-indigo-600 underline">Open</button></div>
        </div>
      </aside>

    </main>

    <footer class="text-center small text-slate-500 mt-2">
      Note: this admin writes to the same DB keys used by <code>index.html</code> so changes appear immediately.
    </footer>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, onValue, get, child
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Same Firebase config as your index.html
    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM
    const slugInput = document.getElementById('slug');
    const nameInput = document.getElementById('name');
    const introInput = document.getElementById('intro');
    const logoFile = document.getElementById('logoFile');
    const logoPreview = document.getElementById('logoPreview');
    const adFile = document.getElementById('adFile');
    const adPreview = document.getElementById('adPreview');
    const adText = document.getElementById('adText');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const msg = document.getElementById('msg');

    const pvName = document.getElementById('pvName');
    const pvIntro = document.getElementById('pvIntro');
    const pvLogo = document.getElementById('pvLogo');
    const pvAd = document.getElementById('pvAd');
    const pvAdText = document.getElementById('pvAdText');

    const openPublic = document.getElementById('openPublic');
    const openPublicBtn = document.getElementById('openPublicBtn');

    // helpers
    function showMsg(text, success=true) {
      msg.textContent = text;
      msg.style.color = success ? '#065f46' : '#b91c1c';
      setTimeout(()=> msg.textContent = '', 3000);
    }

    function pathFor(key) {
      const slug = (slugInput.value || '').trim();
      if (slug) return `businesses/${slug}/settings/${key}`;
      return `settings/${key}`;
    }

    // read global settings (so preview has initial values even with no slug)
    function attachGlobalListeners() {
      onValue(ref(db, 'settings/introText'), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (!slugInput.value) {
          introInput.value = v;
          pvIntro.textContent = v || 'Real-time queueing system. Mobile-friendly. No app needed.';
        }
      });
      onValue(ref(db, 'settings/adImage'), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (!slugInput.value) {
          adPreview.src = v; adPreview.classList.toggle('hidden', !v);
          pvAd.src = v; pvAd.classList.toggle('hidden', !v);
        }
      });
      onValue(ref(db, 'settings/name'), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (!slugInput.value) {
          nameInput.value = v; pvName.textContent = v || 'Your store';
        }
      });
      onValue(ref(db, 'settings/logo'), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (!slugInput.value) {
          if (v) { logoPreview.src = v; logoPreview.classList.remove('hidden'); pvLogo.innerHTML = `<img src="${v}" class="w-full h-full object-cover rounded-lg" alt="logo">`; }
          else { logoPreview.classList.add('hidden'); pvLogo.innerHTML = 'QJ'; }
        }
      });
      onValue(ref(db, 'settings/adText'), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (!slugInput.value) { adText.value = v; pvAdText.textContent = v || 'No ad'; }
      });
    }
    attachGlobalListeners();

    // attach slug-specific listeners
    let listenersAttached = false;
    function attachSlugListeners() {
      const slug = (slugInput.value || '').trim();
      if (!slug) return;
      // name
      onValue(ref(db, pathFor('name')), snap => {
        const v = snap.exists() ? snap.val() : '';
        nameInput.value = v; pvName.textContent = v || 'Your store';
      });
      // intro
      onValue(ref(db, pathFor('introText')), snap => {
        const v = snap.exists() ? snap.val() : '';
        introInput.value = v; pvIntro.textContent = v || 'Real-time queueing system. Mobile-friendly. No app needed.';
      });
      // logo
      onValue(ref(db, pathFor('logo')), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (v) { logoPreview.src = v; logoPreview.classList.remove('hidden'); pvLogo.innerHTML = `<img src="${v}" class="w-full h-full object-cover rounded-lg" alt="logo">`; }
        else { logoPreview.classList.add('hidden'); pvLogo.innerHTML = 'QJ'; }
      });
      // adImage
      onValue(ref(db, pathFor('adImage')), snap => {
        const v = snap.exists() ? snap.val() : '';
        adPreview.src = v; adPreview.classList.toggle('hidden', !v);
        pvAd.src = v; pvAd.classList.toggle('hidden', !v);
      });
      // adText
      onValue(ref(db, pathFor('adText')), snap => {
        const v = snap.exists() ? snap.val() : '';
        adText.value = v; pvAdText.textContent = v || 'No ad';
      });
      listenersAttached = true;
    }

    // helpers for files to base64
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onerror = () => reject(new Error('File read failed'));
        r.onload = () => resolve(r.result);
        r.readAsDataURL(file);
      });
    }

    // file preview handlers
    logoFile.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0]; if (!f) return;
      try { const d = await fileToDataUrl(f); logoPreview.src = d; logoPreview.classList.remove('hidden'); pvLogo.innerHTML = `<img src="${d}" class="w-full h-full object-cover rounded-lg" alt="logo">`; } catch(e){ console.error(e); }
    });
    adFile.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0]; if (!f) return;
      try { const d = await fileToDataUrl(f); adPreview.src = d; adPreview.classList.remove('hidden'); pvAd.src = d; pvAd.classList.remove('hidden'); } catch(e){ console.error(e); }
    });

    // Save button
    saveBtn.addEventListener('click', async () => {
      const slug = (slugInput.value || '').trim();
      saveBtn.disabled = true;
      saveBtn.textContent = 'Savingâ€¦';
      try {
        await set(ref(db, pathFor('name')), nameInput.value || '');
        await set(ref(db, pathFor('introText')), introInput.value || '');
        await set(ref(db, pathFor('adText')), adText.value || '');

        if (logoPreview.src && logoPreview.src.startsWith('data:')) {
          await set(ref(db, pathFor('logo')), logoPreview.src);
        }
        if (adPreview.src && adPreview.src.startsWith('data:')) {
          await set(ref(db, pathFor('adImage')), adPreview.src);
        }

        showMsg('Saved', true);
      } catch (err) {
        console.error(err);
        showMsg('Save failed', false);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Settings';
      }
    });

    // Reset button reloads
    resetBtn.addEventListener('click', () => {
      if (!confirm('Reload saved settings? Unsaved changes will be lost.')) return;
      location.reload();
    });

    // save intro on blur for fast edits (also writes to chosen path)
    intro.addEventListener('blur', async () => {
      try {
        await set(ref(db, pathFor('introText')), introInput.value || '');
        showMsg('Intro saved', true);
      } catch (e) { console.error(e); showMsg('Save failed', false); }
    });

    // save name on blur
    name.addEventListener('blur', async () => {
      try { await set(ref(db, pathFor('name')), nameInput.value || ''); showMsg('Name saved', true); } catch(e){ showMsg('Save failed', false); }
    });

    // slug apply: attach slug listeners and update Open Public link
    const params = new URLSearchParams(window.location.search);
    const qSlug = (params.get('business') || '').trim();
    if (qSlug && !slugInput.value) slugInput.value = qSlug;

    const applySlug = () => {
      const s = (slugInput.value || '').trim();
      if (s) {
        // update open public link
        const url = `${location.origin}/${s}`;
        openPublic.href = url; openPublic.textContent = `Open ${url}`;
        openPublicBtn.onclick = () => window.open(url, '_blank');
        attachSlugListeners();
        showMsg('Slug applied; now editing ' + s, true);
      } else {
        openPublic.href = location.origin;
        openPublic.textContent = 'Open Public';
      }
    };
    // apply on load if present
    applySlug();

    // also attach global listeners so preview shows global values when no slug
    updateGlobalOpenLink = () => {
      const s = (slugInput.value || '').trim();
      const url = s ? `${location.origin}/${s}` : location.origin;
      openPublic.href = url;
    };
    updateGlobalOpenLink();

    // small UX: when user types slug and stops, re-apply after short delay
    let slugTimer = null;
    slugInput.addEventListener('input', () => {
      updateGlobalOpenLink();
      clearTimeout(slugTimer);
      slugTimer = setTimeout(() => { applySlug(); }, 900);
    });

  </script>
</body>
</html>
