<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy — Admin</title>

  <!-- NOTE: For development we use Tailwind CDN for quick styling. In production install Tailwind as PostCSS or use the CLI. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small utility overrides */
    .fade-up { transform: translateY(8px); opacity: 0; transition: all .36s ease; }
    .fade-up.show { transform: translateY(0); opacity: 1; }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    input[type=file] { display:block }
    .small { font-size: 0.85rem }
    .pill { padding: .25rem .5rem; border-radius: 999px; background: rgba(0,0,0,0.06); }
    /* crop canvas preview styling */
    .crop-wrap { position: relative; width: 100%; max-width: 420px; }
    .crop-canvas { width: 100%; border-radius: 8px; background: #f6f6f6; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Queue Joy — Admin</h1>
        <p class="text-sm text-slate-500">Manage settings, media, announcements and analytics.</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnRefresh" class="btn bg-white px-3 py-2 card small">Refresh</button>
        <div id="statusDot" class="pill small">Disconnected</div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- left: Settings & Media -->
      <section class="col-span-1 card p-4 fade-up show">
        <h2 class="font-medium">Settings & Images</h2>
        <p class="text-sm text-slate-500 mb-3">Edit values stored in Firebase under <code>/settings</code>. Images can be cropped client-side before saving.</p>

        <div class="space-y-3">
          <label class="block small">Main title
            <input id="mainTitle" class="mt-1 w-full p-2 border rounded" />
          </label>

          <label class="block small">Small text on top
            <input id="smallTextOnTop" class="mt-1 w-full p-2 border rounded" />
          </label>

          <label class="block small">Intro text
            <textarea id="introText" rows="3" class="mt-1 w-full p-2 border rounded"></textarea>
          </label>

          <label class="block small">adImage (croppable)
            <input id="adImageFile" type="file" accept="image/*" />
          </label>
          <div id="adImageCrop" class="crop-wrap hidden">
            <canvas id="adCanvas" class="crop-canvas"></canvas>
            <div class="flex gap-2 mt-2">
              <button id="adCropSave" class="px-3 py-2 card">Save Cropped</button>
              <button id="adReset" class="px-3 py-2 card">Reset</button>
            </div>
          </div>

          <label class="block small">Logo image (croppable)
            <input id="logoFile" type="file" accept="image/*" />
          </label>
          <div id="logoCrop" class="crop-wrap hidden">
            <canvas id="logoCanvas" class="crop-canvas"></canvas>
            <div class="flex gap-2 mt-2">
              <button id="logoCropSave" class="px-3 py-2 card">Save Cropped</button>
              <button id="logoReset" class="px-3 py-2 card">Reset</button>
            </div>
          </div>

          <div class="flex gap-2 mt-2">
            <button id="saveSettings" class="px-4 py-2 bg-sky-600 text-white rounded">Save Settings</button>
            <button id="loadSettings" class="px-4 py-2 card">Load From Firebase</button>
          </div>
        </div>
      </section>

      <!-- middle: Announcement composer -->
      <section class="col-span-1 lg:col-span-2 card p-4">
        <h2 class="font-medium">Announcement Composer</h2>
        <p class="text-sm text-slate-500">Send text, image, gif, audio or video to all or filtered by queue.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
          <div class="md:col-span-2">
            <label class="block small">Message</label>
            <textarea id="announceMessage" rows="4" class="mt-1 w-full p-2 border rounded"></textarea>

            <div class="flex items-center gap-3 mt-2">
              <label class="small">Target queue (optional)</label>
              <select id="queueFilter" class="p-2 border rounded">
                <option value="">All queues</option>
              </select>

              <label class="small">Or paste Chat IDs (comma)</label>
              <input id="overrideChatIds" class="p-2 border rounded" placeholder="123,456" />
            </div>

            <div class="mt-3">
              <label class="small">Attach media (image, gif, video, audio)</label>
              <input id="announceFile" type="file" accept="image/*,video/*,audio/*" />
              <div id="mediaPreview" class="mt-2"></div>
            </div>

            <div class="mt-4 flex gap-2">
              <button id="sendAnnouncement" class="px-4 py-2 bg-emerald-600 text-white rounded">Send Announcement</button>
              <button id="previewAnnouncement" class="px-4 py-2 card">Preview</button>
            </div>

            <div id="announceLog" class="mt-3 small text-sm text-slate-600"></div>
          </div>

          <div class="md:col-span-1 border-l pl-4">
            <h3 class="font-medium">Recipients</h3>
            <div class="mt-2 small text-slate-600">Select from stored telegramUsers or let the function pick all.</div>
            <div id="recipientsList" class="mt-2 max-h-64 overflow-auto"></div>
            <div class="mt-2">
              <button id="selectAllRecipients" class="px-2 py-1 card small">Select All</button>
              <button id="deselectAllRecipients" class="px-2 py-1 card small">Deselect All</button>
            </div>
          </div>
        </div>
      </section>

      <!-- right: Analytics -->
      <section class="col-span-1 card p-4 fade-up show">
        <h2 class="font-medium">Analytics</h2>
        <p class="text-sm text-slate-500">Quick insights computed from <code>/queue</code> and <code>/telegramUsers</code>.</p>

        <div class="mt-3 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-semibold" id="totalWaiting">—</div>
              <div class="small text-slate-500">Waiting</div>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="totalServed">—</div>
              <div class="small text-slate-500">Served</div>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="avgService">—</div>
              <div class="small text-slate-500">Avg serve (s)</div>
            </div>
          </div>

          <div>
            <h4 class="small font-medium">Recent queues</h4>
            <div id="recentQueueList" class="mt-2 max-h-48 overflow-auto small"></div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-500">Queue Joy Admin • edit settings in Firebase & use announce function. Use Tailwind via proper build in production.</footer>
  </div>

  <!-- Scripts: Firebase v9 modular (CDN module imports) -->
  <script type="module">
    // ----------------- CONFIG -------------------
    // Replace this config or set window.RTDB_ROOT to point to your Firebase Realtime DB root (https://.../)
    // If you prefer env injection, admin.html can read a small /settings-based public endpoint.
    const RTDB_ROOT = window.__RTDB_ROOT__ || null; // leave null to use explicit input below

    // Helper: UI
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // Firebase modular imports (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, get, set, update, onValue } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    // A small helper to prompt for RTDB root if not present
    async function getRtDbRoot() {
      if (RTDB_ROOT) return RTDB_ROOT.replace(/\/$/, '');
      const root = localStorage.getItem('rtdb_root') || prompt('Enter your Firebase Realtime Database root URL (e.g. https://your-db.firebaseio.com):');
      if (!root) throw new Error('RTDB root required');
      localStorage.setItem('rtdb_root', root.replace(/\/$/, ''));
      return root.replace(/\/$/, '');
    }

    // init state
    let FIREBASE_DB_ROOT = null;
    (async () => {
      try {
        FIREBASE_DB_ROOT = await getRtDbRoot();
        $('#statusDot').textContent = 'Connected';
        $('#statusDot').classList.add('text-emerald-600');
      } catch (e) {
        console.error('No RTDB root', e);
        $('#statusDot').textContent = 'No DB';
      }
    })();

    // ----------------- tiny helpers ------------------
    const jsonFetch = async (path, opts = {}) => {
      if (!FIREBASE_DB_ROOT) throw new Error('RTDB root not set');
      const url = `${FIREBASE_DB_ROOT}/${path.replace(/^\//, '')}.json`;
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
      return await res.json();
    };
    const jsonPatch = async (path, body) => {
      if (!FIREBASE_DB_ROOT) throw new Error('RTDB root not set');
      const url = `${FIREBASE_DB_ROOT}/${path.replace(/^\//, '')}.json`;
      const res = await fetch(url, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!res.ok) { const t = await res.text().catch(()=>null); throw new Error(`Patch ${res.status} ${t}`); }
      return await res.json();
    };
    const jsonPut = async (path, body) => {
      if (!FIREBASE_DB_ROOT) throw new Error('RTDB root not set');
      const url = `${FIREBASE_DB_ROOT}/${path.replace(/^\//, '')}.json`;
      const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!res.ok) { const t = await res.text().catch(()=>null); throw new Error(`Put ${res.status} ${t}`); }
      return await res.json();
    };

    // ----------------- Settings load/save ------------------
    async function loadSettings() {
      try {
        const settings = await jsonFetch('settings');
        if (!settings) return;
        $('#mainTitle').value = settings.mainTitle || '';
        $('#smallTextOnTop').value = settings.smallTextOnTop || '';
        $('#introText').value = settings.introText || '';
        // preview images
        if (settings.adImage) previewImageFromData(settings.adImage, '#adImageCrop');
        if (settings.logo) previewImageFromData(settings.logo, '#logoCrop');
        // populate queues list
        await loadQueuesList();
      } catch (e) {
        console.error('loadSettings failed', e);
        alert('Failed to load settings: ' + e.message);
      }
    }

    async function saveSettings() {
      try {
        const payload = {
          mainTitle: $('#mainTitle').value.trim() || null,
          smallTextOnTop: $('#smallTextOnTop').value.trim() || null,
          introText: $('#introText').value.trim() || null,
        };
        await jsonPatch('settings', payload);
        toast('Settings saved');
      } catch (e) {
        console.error('saveSettings', e);
        alert('Save failed: ' + e.message);
      }
    }

    $('#loadSettings').addEventListener('click', loadSettings);
    $('#saveSettings').addEventListener('click', saveSettings);

    // ----------------- crop helpers ------------------
    // lightweight crop: user drags a rectangle on canvas, we crop to that box
    function createCropUI(fileInput, canvasEl, containerSelector) {
      const container = document.querySelector(containerSelector);
      let img = new Image();
      let scale = 1; let startX=0,startY=0,drag=false, sx=0,sy=0,sw=0,sh=0;
      const ctx = canvasEl.getContext('2d');

      function draw() {
        // clear
        canvasEl.width = Math.min(1024, img.width); // limit size for performance
        scale = canvasEl.width / img.width;
        canvasEl.height = Math.round(img.height * scale);
        ctx.clearRect(0,0,canvasEl.width, canvasEl.height);
        ctx.drawImage(img, 0, 0, canvasEl.width, canvasEl.height);
        if (sw && sh) {
          ctx.strokeStyle = 'cyan'; ctx.lineWidth = 2; ctx.strokeRect(sx, sy, sw, sh);
        }
      }

      fileInput.addEventListener('change', async (e) => {
        const f = fileInput.files[0];
        if (!f) return;
        const dataUrl = await readFileAsDataURL(f);
        img = new Image();
        img.onload = () => { container.classList.remove('hidden'); sx=sy=sw=sh=0; draw(); };
        img.src = dataUrl;
      });

      // simple drag to set crop rect
      canvasEl.addEventListener('mousedown', (ev) => {
        const r = canvasEl.getBoundingClientRect(); startX = ev.clientX - r.left; startY = ev.clientY - r.top; drag=true; sx = startX; sy = startY; sw = 0; sh = 0;
      });
      canvasEl.addEventListener('mousemove', (ev) => {
        if (!drag) return; const r = canvasEl.getBoundingClientRect(); const x = ev.clientX - r.left; const y = ev.clientY - r.top; sw = x - sx; sh = y - sy; draw();
      });
      window.addEventListener('mouseup', () => { if (drag) drag=false; });

      const getCroppedData = () => {
        if (!img.src) return null;
        // if no rectangle selected, return full image
        if (!sw || !sh) return img.src;
        const cropCanvas = document.createElement('canvas');
        // compute real pixel crop
        const realSx = Math.round(sx / scale); const realSy = Math.round(sy / scale); const realSw = Math.round(Math.abs(sw) / scale); const realSh = Math.round(Math.abs(sh) / scale);
        cropCanvas.width = realSw; cropCanvas.height = realSh;
        const cctx = cropCanvas.getContext('2d');
        cctx.drawImage(img, realSx, realSy, realSw, realSh, 0,0, realSw, realSh);
        return cropCanvas.toDataURL('image/jpeg', 0.86);
      };

      return { getCroppedData, container, canvasEl };
    }

    function readFileAsDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file);
      });
    }

    // instantiate crop UIs
    const adCrop = createCropUI($('#adImageFile'), $('#adCanvas'), '#adImageCrop');
    const logoCrop = createCropUI($('#logoFile'), $('#logoCanvas'), '#logoCrop');

    $('#adCropSave').addEventListener('click', async () => {
      const data = adCrop.getCroppedData(); if (!data) return alert('No image');
      try { await jsonPatch('settings', { adImage: data }); toast('adImage saved'); } catch (e) { alert('Save failed: '+e.message); }
    });
    $('#logoCropSave').addEventListener('click', async () => {
      const data = logoCrop.getCroppedData(); if (!data) return alert('No image');
      try { await jsonPatch('settings', { logo: data }); toast('logo saved'); } catch (e) { alert('Save failed: '+e.message); }
    });

    $('#adReset').addEventListener('click', () => { $('#adImageFile').value = ''; $('#adImageCrop').classList.add('hidden'); });
    $('#logoReset').addEventListener('click', () => { $('#logoFile').value = ''; $('#logoCrop').classList.add('hidden'); });

    function previewImageFromData(dataUrl, selector) {
      const container = document.querySelector(selector);
      if (!container) return; container.classList.remove('hidden');
      const canvas = container.querySelector('canvas'); const ctx = canvas.getContext('2d');
      const img = new Image(); img.onload = () => {
        canvas.width = Math.min(900, img.width); const scale = canvas.width / img.width; canvas.height = Math.round(img.height * scale);
        ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
      }; img.src = dataUrl;
    }

    // ----------------- queues & recipients ------------------
    async function loadQueuesList() {
      try {
        const queues = await jsonFetch('queue') || {};
        const sel = $('#queueFilter'); sel.innerHTML = '<option value="">All queues</option>';
        for (const k of Object.keys(queues)) {
          const q = queues[k]; const label = (q.queueId || q.ticket || q.number || k) + (q.counterId ? ' • '+q.counterId : '');
          const opt = document.createElement('option'); opt.value = k; opt.textContent = label; sel.appendChild(opt);
        }
        await loadRecipients();
      } catch (e) { console.error('loadQueuesList', e); }
    }

    async function loadRecipients() {
      try {
        const users = await jsonFetch('telegramUsers') || {};
        const wrap = $('#recipientsList'); wrap.innerHTML = '';
        for (const k of Object.keys(users)) {
          const v = users[k]; const row = document.createElement('div'); row.className = 'flex items-center gap-2 py-1';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.dataset.chatId = k; cb.className = 'recipientCB';
          const label = document.createElement('div'); label.className = 'small'; label.textContent = `${k} ${v.queueKey ? '• '+v.queueKey : ''} ${v.connectedAt ? '• '+new Date(v.connectedAt).toLocaleString() : ''}`;
          row.appendChild(cb); row.appendChild(label); wrap.appendChild(row);
        }
        $('#selectAllRecipients').addEventListener('click', ()=> $$('.recipientCB').forEach(x=>x.checked=true));
        $('#deselectAllRecipients').addEventListener('click', ()=> $$('.recipientCB').forEach(x=>x.checked=false));
      } catch (e) { console.error('loadRecipients', e); }
    }

    // ----------------- Announcement sending (calls netlify function) ------------------
    async function buildMediaPayload(file) {
      if (!file) return { media: '', mediaType: '' };
      const dt = file.type || '';
      const dataUrl = await readFileAsDataURL(file);
      const payloadB64 = dataUrl.includes(',') ? dataUrl.split(',')[1] : dataUrl;
      return { media: payloadB64, mediaType: dt };
    }

    async function sendAnnouncement() {
      try {
        const message = $('#announceMessage').value.trim();
        const override = $('#overrideChatIds').value.trim();
        const fileEl = $('#announceFile');
        const file = fileEl.files && fileEl.files[0];
        const selectedCBs = $$('.recipientCB').filter(c=>c.checked).map(c=>c.dataset.chatId);
        const queueKey = $('#queueFilter').value || null;

        let payload = { message };
        if (override) payload.chatIds = override.split(/\s*,\s*/).filter(Boolean).map(s=>s);
        else if (selectedCBs.length) payload.chatIds = selectedCBs;
        else if (queueKey) payload.queueKey = queueKey;

        if (file) {
          const { media, mediaType } = await buildMediaPayload(file);
          payload.media = media; payload.mediaType = mediaType;
        }

        $('#sendAnnouncement').disabled = true; $('#announceLog').textContent = 'Sending...';
        const res = await fetch('/.netlify/functions/announce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || JSON.stringify(j));
        $('#announceLog').textContent = `Sent ${j.sent}/${j.totalRecipients} — failed ${j.failed}`;
        toast('Announcement sent');
      } catch (e) {
        console.error('Announcement error', e); $('#announceLog').textContent = 'Error: '+e.message; alert('Send failed: '+e.message);
      } finally { $('#sendAnnouncement').disabled = false; }
    }

    $('#sendAnnouncement').addEventListener('click', sendAnnouncement);
    $('#previewAnnouncement').addEventListener('click', () => {
      const txt = $('#announceMessage').value || '[No message]';
      alert('Preview:\n\n' + txt);
    });

    // preview attached media
    $('#announceFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; const wrap = $('#mediaPreview'); wrap.innerHTML = '';
      if (!f) return;
      if (f.type.startsWith('image/')) {
        const d = await readFileAsDataURL(f); const img = document.createElement('img'); img.src = d; img.style.maxWidth='220px'; wrap.appendChild(img);
      } else if (f.type.startsWith('video/')) {
        const d = URL.createObjectURL(f); const v = document.createElement('video'); v.src = d; v.controls = true; v.style.maxWidth='240px'; wrap.appendChild(v);
      } else if (f.type.startsWith('audio/')) {
        const d = URL.createObjectURL(f); const a = document.createElement('audio'); a.src = d; a.controls = true; wrap.appendChild(a);
      } else {
        wrap.textContent = 'Attached file: ' + f.name;
      }
    });

    // ----------------- Analytics ------------------
    async function loadAnalytics() {
      try {
        const queues = await jsonFetch('queue') || {};
        const users = await jsonFetch('telegramUsers') || {};
        const totalWaiting = Object.values(queues).filter(q=>q.status !== 'served' && q.status !== 'completed' && !q.servedAt).length || 0;
        const totalServed = Object.values(queues).filter(q=>q.servedAt).length || 0;
        // compute avg service time for entries that have timestamp & servedAt
        const diffs = Object.values(queues).map(q=>{ if (q.timestamp && q.servedAt) return (Date.parse(q.servedAt) - Number(q.timestamp))/1000; return null }).filter(x=>x!==null);
        const avg = diffs.length ? Math.round(diffs.reduce((a,b)=>a+b,0)/diffs.length) : null;
        $('#totalWaiting').textContent = totalWaiting;
        $('#totalServed').textContent = totalServed;
        $('#avgService').textContent = avg === null ? '—' : String(avg);

        const recent = Object.entries(queues).slice(-20).reverse().map(([k,v])=>`<div class="py-1 border-b">${(v.queueId||k)} • ${v.counterId||'—'} • ${v.status||'—'}</div>`).join('');
        $('#recentQueueList').innerHTML = recent || '<div class="small text-slate-500">No recent</div>';
      } catch (e) { console.error('loadAnalytics', e); }
    }

    // ----------------- small UX helpers ------------------
    function toast(msg) {
      const t = document.createElement('div'); t.className = 'fixed bottom-6 right-6 px-4 py-2 card small'; t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3000);
    }

    // ----------------- boot ------------------
    $('#btnRefresh').addEventListener('click', async ()=>{ await loadSettings(); await loadRecipients(); await loadAnalytics(); toast('Refreshed'); });
    // initial load when DB root set
    (async ()=>{
      try { await loadSettings(); await loadRecipients(); await loadAnalytics(); } catch(e){ console.warn('initial load issue', e); }
    })();

  </script>
</body>
</html>
