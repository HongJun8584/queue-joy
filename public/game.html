<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queue Joy - Snake Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    canvas { border: 1px solid #4B5EAA; touch-action: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col items-center justify-center p-4 pb-32">
  <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-4 fade-in">
    <!-- Header -->
    <div class="text-center space-y-2">
      <div class="w-12 h-12 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M15 14h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h1 class="text-xl font-bold text-indigo-800">Snake Game</h1>
      <p class="text-xs text-gray-500 italic">No worries, the system will call you even if you are playing!</p>
    </div>
    <!-- Game Stats -->
    <div class="grid grid-cols-2 gap-2 text-center">
      <div class="bg-gray-50 rounded-lg p-2">
        <p class="text-xs text-gray-600">Score</p>
        <p id="score" class="text-sm font-bold text-gray-800">0</p>
      </div>
      <div class="bg-gray-50 rounded-lg p-2">
        <p class="text-xs text-gray-600">High Score</p>
        <p id="highScore" class="text-sm font-bold text-gray-800">0</p>
      </div>
    </div>
    <!-- Game Board -->
    <div id="gameBoard" class="relative aspect-square">
      <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full" width="320" height="320"></canvas>
    </div>
    <!-- Game Complete -->
    <div id="gameOver" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-3 text-center">
      <div class="text-2xl mb-1">üò¢</div>
      <p class="text-red-800 font-bold">Game Over!</p>
      <div id="finalStats" class="text-red-700 text-xs"></div>
    </div>
    <!-- Actions -->
    <div class="space-y-2">
      <button id="newGameBtn" class="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-500 text-white font-semibold rounded-xl shadow hover:scale-105 transition-all duration-300">
        üéÆ New Game
      </button>
      <button id="backBtn" class="w-full py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
        ‚Üê Back to Status
      </button>
      <div id="inlineError" class="hidden text-red-600 text-sm text-center bg-red-50 border border-red-200 rounded-lg p-2"></div>
    </div>
  </div>
  <!-- Ad Panel -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-sm px-4">
    <div class="bg-white rounded-xl shadow-lg p-3">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement" class="w-full rounded-lg shadow-md hidden max-h-24 object-cover">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>
  <!-- Firebase and Game Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    let app, database;
    try {
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);
    } catch (e) {
      console.error('Firebase initialization failed:', e);
    }

    // --- UI refs ---
    const queueInfoEl = document.getElementById('queueInfo');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('highScore');
    const gameOverEl = document.getElementById('gameOver');
    const finalStatsEl = document.getElementById('finalStats');
    const newGameBtn = document.getElementById('newGameBtn');
    const backBtn = document.getElementById('backBtn');
    const adPanel = document.getElementById('adPanel');
    const noAd = document.getElementById('noAd');
    const inlineError = document.getElementById('inlineError');

    const gameCanvas = document.getElementById('gameCanvas');
    const ctx = gameCanvas.getContext('2d');
    const grid = 16;
    const tileCount = 20; // 320 / 16 = 20
    let count = 0;
    let score = 0;
    let highScore = 0;
    let gameLoop = null;
    let hasNavigated = false;
    let adRef = null;
    let queueRef = null;
    let counterRef = null;

    let snake = {
      x: 160,
      y: 160,
      dx: grid,
      dy: 0,
      cells: [],
      maxCells: 4
    };
    let apple = {
      x: 256,
      y: 256
    };

    function showError(msg) {
      inlineError.textContent = msg;
      inlineError.classList.remove('hidden');
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }

    function loop() {
      gameLoop = requestAnimationFrame(loop);
      if (++count < 4) return;
      count = 0;
      ctx.fillStyle = '#F3F4F6';
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

      snake.x += snake.dx;
      snake.y += snake.dy;

      if (snake.x < 0 || snake.x >= gameCanvas.width || snake.y < 0 || snake.y >= gameCanvas.height) {
        endGame();
        return;
      }

      snake.cells.unshift({x: snake.x, y: snake.y});
      if (snake.cells.length > snake.maxCells) {
        snake.cells.pop();
      }

      ctx.fillStyle = 'red';
      ctx.fillRect(apple.x, apple.y, grid-1, grid-1);

      ctx.fillStyle = 'green';
      snake.cells.forEach(function(cell, index) {
        ctx.fillRect(cell.x, cell.y, grid-1, grid-1);
        if (cell.x === apple.x && cell.y === apple.y) {
          score += 10;
          snake.maxCells++;
          scoreEl.textContent = score;
          if (score > highScore) {
            highScore = score;
            highScoreEl.textContent = highScore;
          }
          apple.x = getRandomInt(0, tileCount) * grid;
          apple.y = getRandomInt(0, tileCount) * grid;
        }
        for (var i = index + 1; i < snake.cells.length; i++) {
          if (cell.x === snake.cells[i].x && cell.y === snake.cells[i].y) {
            endGame();
            return;
          }
        }
      });
    }

    function endGame() {
      if (gameLoop) cancelAnimationFrame(gameLoop);
      gameLoop = null;
      finalStatsEl.innerHTML = `Final Score: ${score}`;
      gameOverEl.classList.remove('hidden');
    }

    function initializeGame() {
      snake = {
        x: 160,
        y: 160,
        dx: grid,
        dy: 0,
        cells: [],
        maxCells: 4
      };
      apple = {
        x: 256,
        y: 256
      };
      score = 0;
      scoreEl.textContent = score;
      count = 0;
      gameOverEl.classList.add('hidden');
      if (gameLoop) cancelAnimationFrame(gameLoop);
      gameLoop = requestAnimationFrame(loop);
    }

    // --- Tap / Click Controls ---
    gameCanvas.addEventListener('click', (e) => {
      if (!gameLoop) return;
      const rect = gameCanvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      const headX = snake.x + grid / 2;
      const headY = snake.y + grid / 2;
      const diffX = clickX - headX;
      const diffY = clickY - headY;
      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (diffX > 0 && snake.dx === 0) { snake.dx = grid; snake.dy = 0; }
        else if (diffX < 0 && snake.dx === 0) { snake.dx = -grid; snake.dy = 0; }
      } else {
        if (diffY > 0 && snake.dy === 0) { snake.dx = 0; snake.dy = grid; }
        else if (diffY < 0 && snake.dy === 0) { snake.dx = 0; snake.dy = -grid; }
      }
    });

    // --- Firebase Listeners ---
    function initAdListener() {
      if (!database) return;
      adRef = ref(database, 'settings/adImage');
      onValue(adRef, (snap) => {
        try {
          const val = snap.exists() ? snap.val() : '';
          if (val) {
            adPanel.src = val;
            adPanel.classList.remove('hidden');
            noAd.classList.add('hidden');
          } else {
            adPanel.classList.add('hidden');
            noAd.classList.remove('hidden');
          }
        } catch (e) {
          console.error('Ad listener error:', e);
        }
      });
    }

    function initQueueListener(queueId) {
  if (!database || !queueId) return;
  queueRef = ref(database, `queues/${queueId}/status`);
  onValue(queueRef, (snap) => {
    if (!snap.exists()) return;
    const status = snap.val();
    if (status === 'called' && !hasNavigated) {
      hasNavigated = true;
      // Redirect to your_turn.html
      window.location.href = `public/your_turn.html?queueId=${encodeURIComponent(queueId)}`;
    }
  });
}

    document.addEventListener('DOMContentLoaded', () => {
      initializeGame();
      initAdListener();
      const params = new URLSearchParams(window.location.search);
      const queueId = params.get('queueId');
      backBtn.onclick = () => {
        if (gameLoop) cancelAnimationFrame(gameLoop);
        window.location.href = queueId ? `status.html?queueId=${encodeURIComponent(queueId)}` : 'index.html';
      };
      initQueueListener(queueId);
    });

    window.addEventListener('beforeunload', () => {
      try {
        if (adRef) off(adRef);
        if (queueRef) off(queueRef);
        if (counterRef) off(counterRef);
        if (gameLoop) cancelAnimationFrame(gameLoop);
      } catch (_) {}
    });

    newGameBtn.addEventListener('click', initializeGame);
  </script>
</body>
</html>
