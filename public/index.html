<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy â€” Get a Number</title>

  <!-- Tailwind CDN ok for development; compile for production later -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root { --card-radius: 1rem; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .fade-in { animation: fadeIn .45s cubic-bezier(.2,.9,.2,1); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px) } to { opacity:1; transform:translateY(0) } }
    .db-image { max-height:180px; object-fit:cover; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-purple-50 to-rose-50 flex flex-col items-center p-6 pb-20">

  <!-- Header -->
  <header class="w-full max-w-3xl mb-6">
    <div class="bg-white rounded-2xl shadow-md p-4 flex items-center gap-4">
      <img id="siteLogo" src="" alt="Site logo" class="w-12 h-12 rounded-full hidden object-cover border" />
      <div class="flex-1 text-left">
        <h1 id="siteTitle" class="text-lg font-bold text-gray-800">Queue Joy</h1>
        <p id="smallTopText" class="text-xs text-gray-500">Digital Queue System</p>
      </div>
      <div class="text-right text-xs text-gray-400">Powered by Queue Joy</div>
    </div>
  </header>

  <!-- Main -->
  <main class="w-full max-w-3xl flex flex-col items-center gap-8">
    <section class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 space-y-6 text-center fade-in relative">
      <div class="mx-auto">
        <img id="centerLogo" class="w-20 h-20 rounded-full object-cover hidden mx-auto shadow-sm border" alt="center logo"/>
        <div id="centerIcon" class="w-20 h-20 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
          <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
          </svg>
        </div>
      </div>

      <div class="space-y-2">
        <h2 id="mainHeading" class="text-2xl font-bold text-gray-800">Get your queue number</h2>
        <p id="introText" class="text-gray-600">Real-time queueing system. Mobile-friendly. No app needed.</p>
      </div>

      <button id="getNumberBtn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-purple-400 text-white font-semibold rounded-2xl shadow-lg hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
        <span id="btnText">ðŸŽ« Get your queue number</span>
        <span id="btnSpinner" class="hidden inline-flex items-center ml-2">
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Getting your number...
        </span>
      </button>

      <div id="errorMessage" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-600 text-sm"></p></div>
      <div id="successMessage" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg"><p class="text-green-600 text-sm"></p></div>
    </section>

    <!-- Advertisement -->
    <aside class="w-full max-w-md bg-white rounded-xl shadow-lg p-3">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <a id="adLink" href="#" class="block relative" rel="noopener noreferrer">
        <div id="adContainer" class="w-full rounded-lg shadow-md overflow-hidden"></div>
      </a>
      <div id="noAd" class="text-center text-gray-400 text-sm py-6">No advertisement available</div>
      <div id="adText" class="text-xs text-gray-600 text-center mt-2 hidden"></div>
    </aside>
  </main>

<script type="module">
/*
  Requirements (must be provided by createSite / Netlify env injection):
    window.__ENV__.FIREBASE_CONFIG  (object or JSON string)
    AND one of:
      window.__ENV__.FIREBASE_PATH  (recommended â€” e.g. "tenants/demo-cafe")
      window.__ENV__.TENANT_ID      (then base path will be "tenants/<TENANT_ID>")
    Optional:
      window.__ENV__.SITE_BASE
  If missing â†’ the page shows clear error and stops. This file never attempts fallback/demo env.
*/

function fatal(msg){
  document.body.innerHTML = `<div style="padding:24px;max-width:720px;margin:40px auto;font-family:Inter,system-ui;"><h2>Error</h2><p>${msg}</p></div>`;
  console.error(msg);
  throw new Error(msg);
}

// read injected env
const env = (typeof window !== 'undefined' && window.__ENV) ? window.__ENV : null;
if (!env) fatal('Missing runtime environment. This site expects window.__ENV to be injected by the provisioning process.');

// parse firebase config
let firebaseConfig = null;
if (env.FIREBASE_CONFIG) {
  firebaseConfig = (typeof env.FIREBASE_CONFIG === 'string') ? (function(){ try { return JSON.parse(env.FIREBASE_CONFIG); } catch(e){ return null; }})() : env.FIREBASE_CONFIG;
}
if (!firebaseConfig) fatal('Missing or invalid FIREBASE_CONFIG in window.__ENV.');

// resolve base path (must be explicit)
let basePath = '';
if (env.FIREBASE_PATH && typeof env.FIREBASE_PATH === 'string' && env.FIREBASE_PATH.trim()) {
  basePath = env.FIREBASE_PATH.replace(/^\/+|\/+$/g,'');
} else if (env.TENANT_ID && typeof env.TENANT_ID === 'string' && env.TENANT_ID.trim()) {
  basePath = `tenants/${String(env.TENANT_ID).trim()}`;
} else {
  fatal('Provisioning error: set FIREBASE_PATH or TENANT_ID in window.__ENV for this site.');
}

const siteBase = env.SITE_BASE || location.origin;

// dynamic import firebase
import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js').then(mod => {
  const initializeApp = mod.initializeApp;
  return import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js').then(dbMod => {
    const { getDatabase, ref, push, set, get, onValue, runTransaction } = dbMod;
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window._db = db; // debug hook

    // helper: tenant-scoped ref
    function tenantRef(rel=''){ rel = String(rel||'').replace(/^\/+|\/+$/g,''); return ref(db, rel ? `${basePath}/${rel}` : `${basePath}`); }

    // simple helpers
    const $ = id => document.getElementById(id);
    function showError(msg){ console.warn(msg); const el = $('errorMessage'); if (el){ el.querySelector('p').textContent = msg; el.classList.remove('hidden'); $('successMessage') && $('successMessage').classList.add('hidden'); setTimeout(()=>el.classList.add('hidden'),6000);} else console.warn(msg); }
    function showSuccess(msg){ const el = $('successMessage'); if (el){ el.querySelector('p').textContent = msg; el.classList.remove('hidden'); $('errorMessage') && $('errorMessage').classList.add('hidden'); setTimeout(()=>el.classList.add('hidden'),6000);} else console.log(msg); }
    function setLoading(flag){ const btn = $('getNumberBtn'); if (!btn) return; btn.disabled = flag; $('btnText') && $('btnText').classList.toggle('hidden', flag); $('btnSpinner') && $('btnSpinner').classList.toggle('hidden', !flag); btn.setAttribute('aria-busy', String(flag)); }

    // transaction with retries
    async function runTxWithRetries(pathRef, updater, maxRetries = 6) {
      let lastErr = null;
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const result = await runTransaction(pathRef, updater, { applyLocally: false });
          if (result && result.committed) return result;
          lastErr = new Error('Transaction not committed');
        } catch (e) {
          lastErr = e;
          console.warn('[tx] attempt', attempt, 'failed', e);
        }
        await new Promise(r => setTimeout(r, 100 * Math.pow(2, attempt - 1) + Math.floor(Math.random() * 120)));
      }
      throw lastErr || new Error('Transaction failed after retries');
    }

    // sanitize link candidate: only allow same-origin or relative
    function isSafeLinkCandidate(raw){
      if (!raw || typeof raw !== 'string') return false;
      const t = raw.trim();
      if (/^(javascript|data|vbscript):/i.test(t)) return false;
      try {
        const u = new URL(t, location.href);
        return u.origin === location.origin;
      } catch (e) { return false; }
    }

    // ---- settings listener ----
    try {
      onValue(tenantRef('settings'), snap => {
        const s = snap.exists() ? snap.val() : {};
        const pick = v => (typeof v === 'string' && v.trim()) ? v.trim() : (typeof v === 'number' || typeof v === 'boolean') ? v : null;

        // header logo
        if (s.logo){ $('siteLogo').src = s.logo; $('siteLogo').classList.remove('hidden'); } else { $('siteLogo').src=''; $('siteLogo').classList.add('hidden'); }

        const topTitle = pick(s.mainTitle) || pick(s.name) || 'Queue Joy';
        $('siteTitle').textContent = topTitle;
        document.title = topTitle + ' - Digital Queue System';

        if (s.logoUrl){ $('centerLogo').src = s.logoUrl; $('centerLogo').classList.remove('hidden'); $('centerIcon').classList.add('hidden'); }
        else if (s.logo){ $('centerLogo').src = s.logo; $('centerLogo').classList.remove('hidden'); $('centerIcon').classList.add('hidden'); }
        else { $('centerLogo').src=''; $('centerLogo').classList.add('hidden'); $('centerIcon').classList.remove('hidden'); }

        $('mainHeading').textContent = pick(s.titleinmiddle) || pick(s.ctaTitle) || 'Get your queue number';
        $('introText').textContent = pick(s.introText) || pick(s.smallTextOnTop) || 'Real-time queueing system. Mobile-friendly. No app needed.';
        $('btnText').textContent = 'ðŸŽ« ' + (pick(s.ctaText) || 'Get your queue number');

        // ad
        const adContainer = $('adContainer'); adContainer.innerHTML = '';
        if (s.adImage){
          const url = String(s.adImage).trim();
          const isVideo = /\.(mp4|webm|ogg)(\?.*)?$/i.test(url) || url.startsWith('data:video/');
          if (isVideo){
            const v = document.createElement('video'); v.src = url; v.autoplay = true; v.loop = true; v.muted = true; v.playsInline = true; v.className='w-full db-image'; adContainer.appendChild(v); v.play().catch(()=>{});
          } else {
            const i = document.createElement('img'); i.src = url; i.className='w-full db-image'; adContainer.appendChild(i);
          }
          adContainer.classList.remove('hidden'); $('noAd') && $('noAd').classList.add('hidden');
        } else { adContainer.innerHTML=''; adContainer.classList.add('hidden'); $('noAd') && $('noAd').classList.remove('hidden'); }

        $('adText').textContent = pick(s.adText) || ''; $('adText').classList.toggle('hidden', !$('adText').textContent);

        const rawAdLink = (s.adLink || '').toString();
        if (isSafeLinkCandidate(rawAdLink)){
          $('adLink').href = new URL(rawAdLink, location.href).href;
          $('adLink').removeAttribute('target');
        } else {
          $('adLink').href = '#';
          $('adLink').removeAttribute('target');
          if (rawAdLink) console.warn('Blocked unsafe adLink:', rawAdLink);
        }
      });
    } catch (e) {
      console.warn('settings listener setup failed', e);
    }

    // --- auto-redirect (only to local status.html) ---
    (async function(){
      try {
        const last = sessionStorage.getItem('lastQueueId');
        if (!last) return;
        const snap = await get(tenantRef(`queue/${last}`));
        if (snap.exists() && snap.val().status === 'waiting'){
          location.href = `status.html?queueId=${encodeURIComponent(last)}`;
        }
      } catch(e){ console.warn('autoRedirect check failed', e); }
    })();

    // --- fetch active counters ---
    async function fetchActiveCounters(){
      try {
        const snap = await get(tenantRef('counters'));
        if (!snap.exists()) return [];
        const list = [];
        snap.forEach(s => {
          const v = s.val() || {};
          const activeRaw = v.active;
          const active = activeRaw === undefined || activeRaw === null || activeRaw === true || String(activeRaw).toLowerCase() === 'true' || activeRaw === 1 || String(activeRaw) === '1';
          list.push({ id: s.key, ...v, _active: !!active });
        });
        list.sort((a,b) => {
          const ao = (a.order !== undefined && a.order !== '') ? Number(a.order) : Number.POSITIVE_INFINITY;
          const bo = (b.order !== undefined && b.order !== '') ? Number(b.order) : Number.POSITIVE_INFINITY;
          if (ao !== bo) return ao - bo;
          if (!isNaN(Number(a.id)) && !isNaN(Number(b.id))) return Number(a.id) - Number(b.id);
          return String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
        });
        return list.filter(x => x._active);
      } catch (e) {
        console.warn('fetchActiveCounters failed', e);
        return [];
      }
    }

    // --- main: getQueueNumber ---
    async function getQueueNumber(){
      setLoading(true);
      try {
        const counters = await fetchActiveCounters();
        if (!counters || counters.length === 0) { showError('No active counters available right now.'); return; }

        const rrTx = await runTxWithRetries(tenantRef('system/lastCounterIndex'), cur => { const n = Number(cur) || 0; return n + 1; }, 8);
        if (!rrTx || rrTx.committed !== true) throw new Error('Round-robin transaction failed');

        const globalCounter = Number(rrTx.snapshot && rrTx.snapshot.val());
        if (!Number.isFinite(globalCounter)) throw new Error('Invalid round-robin counter');

        const n = counters.length;
        const index = ((globalCounter - 1) % n + n) % n;
        let chosen = counters[index] || counters[0];

        const liTx = await runTxWithRetries(tenantRef(`counters/${chosen.id}/lastIssued`), cur => (Number(cur) || 0) + 1, 8);
        if (!liTx || liTx.committed !== true) throw new Error('Failed to increment counter lastIssued');

        const nextNumber = Number(liTx.snapshot && liTx.snapshot.val());
        if (!Number.isFinite(nextNumber)) throw new Error('Invalid next number');

        const prefix = (chosen.prefix && String(chosen.prefix)) || 'Q';
        const digits = (chosen.digits && Number(chosen.digits)) || 3;
        const queueId = `${prefix}${String(nextNumber).padStart(digits, '0')}`;

        const newNode = push(tenantRef('queue'));
        await set(newNode, { counterId: chosen.id, queueId, timestamp: Date.now(), status: 'waiting' });

        try { sessionStorage.setItem('lastQueueId', newNode.key); } catch(e){}

        showSuccess(`You're number ${queueId}`);
        setTimeout(()=> location.href = `status.html?queueId=${encodeURIComponent(newNode.key)}`, 700);

      } catch (err) {
        console.error('getQueueNumber error', err);
        showError(err && err.message ? err.message : 'Failed to get queue number.');
      } finally {
        setLoading(false);
      }
    }

    // safety: block external ad navigation
    const adLink = $('adLink');
    adLink && adLink.addEventListener('click', (ev) => {
      const href = adLink.getAttribute('href') || '';
      if (!href || href === '#' ) { ev.preventDefault(); return; }
      try {
        const u = new URL(href, location.href);
        if (u.origin !== location.origin) { ev.preventDefault(); console.warn('Blocked external ad navigation to', href); }
      } catch { ev.preventDefault(); }
    });

    // wire button
    $('getNumberBtn') && $('getNumberBtn').addEventListener('click', (e) => { e.preventDefault(); getQueueNumber(); });

  }); // end import db
}).catch(e => {
  console.error('Failed to init Firebase modules', e);
  fatal('Initialization error: see console.');
});
</script>

</body>
</html>
