<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy</title>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      push,
      onValue,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener('DOMContentLoaded', () => {
      const siteLogo = document.getElementById('siteLogo');
      const topTitle = document.getElementById('topTitle');
      const topSmallText = document.getElementById('topSmallText');
      const midLogo = document.getElementById('midLogo');
      const midIcon = document.getElementById('midIcon');
      const midTitle = document.getElementById('midTitle');
      const introText = document.getElementById('introText');
      const adPanel = document.getElementById('adPanel');
      const adText = document.getElementById('adText');
      const noAd = document.getElementById('noAd');
      const adLink = document.getElementById('adLink');

      const getBtn = document.getElementById('getBtn');
      const btnText = document.getElementById('btnText');
      const btnSpin = document.getElementById('btnSpin');
      const errBox = document.getElementById('errBox');

      function showError(t) {
        errBox.textContent = t;
        errBox.classList.remove('hidden');
        setTimeout(() => errBox.classList.add('hidden'), 5000);
      }

      function loading(flag) {
        getBtn.disabled = flag;
        btnText.classList.toggle('hidden', flag);
        btnSpin.classList.toggle('hidden', !flag);
      }

      // SETTINGS LISTENER
      onValue(ref(db, 'settings'), snap => {
        const s = snap.exists() ? snap.val() : {};

        // title
        const mainTitle = s.mainTitle?.trim() || 'Queue Joy';
        document.title = mainTitle;
        topTitle.textContent = mainTitle;

        // smallTextOnTop
        topSmallText.textContent = s.smallTextOnTop?.trim() || '';

        // header logo
        if (s.logo) {
          siteLogo.src = s.logo;
          siteLogo.classList.remove('hidden');
        } else siteLogo.classList.add('hidden');

        // mid logo
        if (s.logoUrl) {
          midLogo.src = s.logoUrl;
          midLogo.classList.remove('hidden');
          midIcon.classList.add('hidden');
        } else {
          midLogo.classList.add('hidden');
          midIcon.classList.remove('hidden');
        }

        // middle title
        midTitle.textContent = s.titleinmiddle?.trim() || 'Get your queue number';

        // intro text
        introText.textContent = s.introText?.trim() || '';

        // ad
        if (s.adImage) {
          adPanel.src = s.adImage;
          adPanel.classList.remove('hidden');
          noAd.classList.add('hidden');
        } else {
          adPanel.classList.add('hidden');
          noAd.classList.remove('hidden');
        }
        adText.textContent = s.adText?.trim() || '';

        if (s.adLink) {
          adLink.href = s.adLink;
          adLink.target = '_blank';
        } else {
          adLink.href = '#';
          adLink.removeAttribute('target');
        }
      });

      async function fetchActiveCounters() {
        const snap = await get(ref(db, 'counters'));
        if (!snap.exists()) return [];
        const arr = [];
        snap.forEach(s => arr.push({ id: s.key, ...s.val() }));
        return arr.filter(x => x.active);
      }

      function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

      async function tx(path, fn, tries = 6) {
        const rp = ref(db, path);
        let last;
        for (let i = 1; i <= tries; i++) {
          try {
            const r = await runTransaction(rp, fn, { applyLocally: false });
            if (r.committed) return r;
            last = new Error('not committed');
          } catch (e) { last = e; }
          await sleep(80 * i);
        }
        throw last;
      }

      async function getQueue() {
        loading(true);
        try {
          const counters = await fetchActiveCounters();
          if (!counters.length) throw new Error('No active counters');

          const rr = await tx('settings/lastCounterIndex', c => (c || 0) + 1);
          const idx = (rr.snapshot.val() - 1) % counters.length;
          const c = counters[idx];
          if (!c) throw new Error('Counter error');

          const li = await tx(`counters/${c.id}/lastIssued`, x => (x || 0) + 1);
          const num = li.snapshot.val();

          const prefix = c.prefix || 'Q';
          const qid = `${prefix}${String(num).padStart(3, '0')}`;

          const nref = push(ref(db, 'queue'));
          await set(nref, {
            counterId: c.id,
            queueId: qid,
            timestamp: Date.now(),
            status: 'waiting'
          });

          sessionStorage.setItem('lastQueueId', nref.key);
          setTimeout(() => window.location.href = `status.html?queueId=${nref.key}`, 600);

        } catch (err) {
          showError(err.message || 'Failed');
        }
        loading(false);
      }

      getBtn.addEventListener('click', e => {
        e.preventDefault();
        getQueue();
      });
    });
  </script>

  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="min-h-screen bg-gray-100 p-4 flex flex-col items-center">

<header class="w-full max-w-2xl mb-4">
  <div class="bg-white rounded-xl shadow p-4 flex items-center gap-4">
    <img id="siteLogo" class="w-12 h-12 rounded-full hidden object-cover border" />
    <div>
      <h1 id="topTitle" class="text-lg font-bold"></h1>
      <p id="topSmallText" class="text-xs text-gray-500"></p>
    </div>
    <span class="text-xs text-gray-400 ml-auto">Powered by Queue Joy</span>
  </div>
</header>

<main class="w-full max-w-md bg-white rounded-2xl shadow p-6 space-y-6 text-center">

  <img id="midLogo" class="w-20 h-20 rounded-full object-cover hidden mx-auto border shadow" />
  <div id="midIcon" class="w-20 h-20 bg-purple-600 rounded-full mx-auto flex items-center justify-center">
    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h14v14H5z"/></svg>
  </div>

  <h2 id="midTitle" class="text-2xl font-bold"></h2>
  <p id="introText" class="text-gray-600 text-sm"></p>

  <button id="getBtn" class="w-full py-4 bg-purple-600 text-white rounded-xl font-semibold shadow">
    <span id="btnText">Get queue</span>
    <span id="btnSpin" class="hidden text-sm">Loading...</span>
  </button>

  <div id="errBox" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 p-2 rounded"></div>

</main>

<div class="w-full max-w-md bg-white rounded-xl shadow p-3 mt-6 text-center">
  <p class="text-xs text-gray-500">Advertisement</p>
  <a id="adLink" href="#" class="block mt-2">
    <img id="adPanel" class="w-full rounded hidden" />
  </a>
  <div id="noAd" class="text-gray-400 text-sm py-4">No advertisement</div>
  <div id="adText" class="text-xs text-gray-600 mt-2"></div>
</div>

</body>
</html><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy - Digital Queue System</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      push,
      onValue,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.appspot.com",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener('DOMContentLoaded', () => {

      const getNumberBtn = document.getElementById('getNumberBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');

      const siteLogoEl = document.getElementById('siteLogo');
      const siteTitleEl = document.getElementById('siteTitle');
      const siteSmallText = document.getElementById('siteSmallText');

      const centerLogoImg = document.getElementById('centerLogo');
      const centerIcon = document.getElementById('centerIcon');

      const middleTitle = document.getElementById('middleTitle');
      const introText = document.getElementById('introText');

      const adPanel = document.getElementById('adPanel');
      const noAd = document.getElementById('noAd');

      // SETTINGS LISTENER
      const settingsRef = ref(db, 'settings');
      onValue(settingsRef, snap => {
        const s = snap.exists() ? snap.val() : {};

        const clean = v => (typeof v === 'string' && v.trim() ? v.trim() : null);

        // header logo
        if (s.logo) {
          siteLogoEl.src = s.logo;
          siteLogoEl.classList.remove('hidden');
        } else {
          siteLogoEl.classList.add('hidden');
        }

        // top block title
        const topTitle = clean(s.mainTitle) || 'Queue Joy';
        siteTitleEl.textContent = topTitle;
        document.title = topTitle;

        // top block small text
        siteSmallText.textContent = clean(s.smallTextOnTop) || 'Digital Queue System';

        // center logo
        if (s.logoUrl) {
          centerLogoImg.src = s.logoUrl;
          centerLogoImg.classList.remove('hidden');
          centerIcon.classList.add('hidden');
        } else {
          centerLogoImg.classList.add('hidden');
          centerIcon.classList.remove('hidden');
        }

        // middle title
        middleTitle.textContent = clean(s.titleinmiddle) || 'Get your queue number';

        // intro
        introText.textContent = clean(s.introText) || 'Real-time queueing system. Mobile-friendly. No app needed.';

        // advertisement
        if (s.adImage) {
          adPanel.src = s.adImage;
          adPanel.classList.remove('hidden');
          noAd.classList.add('hidden');
        } else {
          adPanel.classList.add('hidden');
          noAd.classList.remove('hidden');
        }
      });

      function setLoading(f) {
        getNumberBtn.disabled = f;
        btnText.classList.toggle('hidden', f);
        btnSpinner.classList.toggle('hidden', !f);
      }

      async function fetchActiveCounters() {
        const snap = await get(ref(db, 'counters'));
        if (!snap.exists()) return [];
        const list = [];
        snap.forEach(s => list.push({ id: s.key, ...s.val() }));
        return list.filter(c => c.active);
      }

      function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

      async function runTx(path, fn) {
        const r = ref(db, path);
        for (let i=0;i<6;i++){
          try {
            const out = await runTransaction(r, fn, {applyLocally:false});
            if (out.committed) return out;
          } catch {}
          await sleep(80 + Math.random()*50);
        }
        throw new Error('Transaction failed: '+path);
      }

      async function getQueueNumber(){
        setLoading(true);
        try {
          const counters = await fetchActiveCounters();
          if (!counters.length) throw new Error('No active counters available.');

          // global round robin
          const r = await runTx('settings/lastCounterIndex', cur => (cur||0)+1);
          const g = r.snapshot.val();
          const idx = (g-1) % counters.length;
          const chosen = counters[idx];

          // increment local
          const r2 = await runTx(`counters/${chosen.id}/lastIssued`, cur => (cur||0)+1);
          const num = r2.snapshot.val();
          const queueId = (chosen.prefix||'Q') + String(num).padStart(3,'0');

          const newRef = push(ref(db,'queue'));
          await set(newRef,{
            counterId: chosen.id,
            queueId,
            timestamp: Date.now(),
            status:'waiting'
          });

          sessionStorage.setItem('lastQueueId',newRef.key);
          window.location.href = `status.html?queueId=${newRef.key}`;

        } catch(err){
          alert(err.message||'Error');
        }
        setLoading(false);
      }

      getNumberBtn.onclick = e => {
        e.preventDefault();
        getQueueNumber();
      };

    });
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col items-center p-6">

  <header class="w-full max-w-2xl mb-6">
    <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
      <img id="siteLogo" class="w-12 h-12 rounded-full hidden object-cover border" />
      <div>
        <h1 id="siteTitle" class="text-lg font-bold text-gray-800">Queue Joy</h1>
        <p id="siteSmallText" class="text-xs text-gray-500">Digital Queue System</p>
      </div>
      <div class="ml-auto text-xs text-gray-400">Powered by Queue Joy</div>
    </div>
  </header>

  <main class="w-full max-w-2xl flex flex-col items-center gap-8">
    <div class="w-full max-w-md bg-white rounded-2xl shadow p-6 text-center space-y-4">
      <div>
        <img id="centerLogo" class="w-16 h-16 rounded-full object-cover hidden mx-auto" />
        <div id="centerIcon" class="w-16 h-16 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h14v14H5z"/></svg>
        </div>
      </div>

      <h2 id="middleTitle" class="text-2xl font-bold text-gray-800">Get your queue number</h2>
      <p id="introText" class="text-gray-600 text-sm">Real-time queueing system. Mobile-friendly. No app needed.</p>

      <button id="getNumberBtn" class="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold shadow hover:opacity-90 transition">
        <span id="btnText">ðŸŽ« Get your queue number</span>
        <span id="btnSpinner" class="hidden">Loading...</span>
      </button>
    </div>

    <div class="w-full max-w-md bg-white rounded-xl shadow p-4">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" class="w-full rounded hidden" />
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </main>

</body>
</html>
