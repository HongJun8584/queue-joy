<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy - Your Queue Status</title>
  <meta name="description" content="Real-time queue status with Telegram notifications" />

  <!-- Tailwind CDN (keeps your original look) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-from: #f3f0ff;
      --bg-via:  #eef2ff;
      --bg-to:   #ecfeff;
    }

    html,body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      background: linear-gradient(135deg, var(--bg-from), var(--bg-to));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Small, consistent animations */
    .fade-in { animation: fadeIn .36s cubic-bezier(.2,.9,.2,1) both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

    /* Spinner */
    .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.25); border-top-color: white; border-radius: 50%; display: inline-block; animation: spin .8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal base - responsive & scroll-safe */
    .modal { display: none; position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,.55); align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 14px;
      max-width: 540px;
      width: 100%;
      box-shadow: 0 30px 80px rgba(2,6,23,.35);
      overflow: hidden;
      max-height: calc(100vh - 48px); /* never overflow viewport */
      display: flex;
      flex-direction: column;
    }
    .modal-header { padding: 18px; background: linear-gradient(90deg,#2563eb,#8b5cf6); color: white; text-align: center; }
    .modal-body { padding: 18px; overflow: auto; }
    .modal-footer { padding: 14px 18px 20px; background: #fff; display: flex; flex-direction: column; gap: 10px; }

    /* Steps UI (cards) */
    .cj-steps { display: flex; gap: 14px; align-items: stretch; justify-content: center; margin: 0 auto; }
    .cj-step {
      flex: 0 0 260px;
      padding: 18px;
      border-radius: 12px;
      background: linear-gradient(180deg,#fff,#fbfdff);
      box-shadow: 0 12px 30px rgba(12,20,50,0.06);
      transform: translateY(6px);
      transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .26s ease;
      opacity: 0.6;
      display:flex;
      flex-direction: column;
      align-items: center;
      text-align:center;
    }
    .cj-step.active { transform: translateY(0); opacity: 1; }
    .cj-illustration { width: 84px; height: 84px; border-radius: 14px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; background: linear-gradient(180deg,#fff,#f7fbff); box-shadow: 0 6px 18px rgba(10,20,60,0.06); }
    .cj-step-number { width:48px; height:48px; border-radius:999px; background:white; border:2px solid #F3E6FB; display:flex; align-items:center; justify-content:center; font-weight:800; color:#6b21a8; margin-bottom:10px; }
    .cj-title { font-size: 16px; font-weight: 700; margin-bottom:6px; color: #0f172a; }
    .cj-desc { font-size: 13px; color:#475569; line-height:1.45; max-width: 260px; margin: 0; }
    .cj-dots { display:flex; gap:8px; justify-content:center; margin-top:12px; }
    .cj-dot { width:10px; height:10px; border-radius:999px; background:#E6E7EE; transition: all .18s ease; }
    .cj-dot.active { width:18px; background: linear-gradient(90deg,#ff77c3,#6c63ff); }

    .cj-controls { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:14px; }
    .cj-skip { background:transparent; border:none; color:#475569; font-weight:700; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .cj-next { padding:10px 18px; border-radius:12px; background: linear-gradient(90deg,#6c63ff,#ff77c3); color:white; font-weight:700; border:none; box-shadow: 0 8px 24px rgba(108,99,255,.14); cursor:pointer; }

    /* Responsive tweaks */
    @media (max-width: 740px) {
      .cj-steps { gap: 12px; overflow: hidden; }
      .cj-step { flex: 0 0 80%; min-width: 80%; }
      .modal-content { max-width: 520px; }
    }

    @media (prefers-reduced-motion: reduce) {
      .fade-in, .spinner { animation: none; }
    }

    /* make primary button look nice on mobile */
    .primary-cta { display:block; width:100%; padding:14px; border-radius:12px; text-align:center; font-weight:700; cursor:pointer; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Main UI (kept as you had it) -->
  <main class="min-h-screen flex items-center justify-center p-4 pb-28">
    <section class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-gray-100 p-6 space-y-6 relative fade-in" aria-labelledby="pageTitle">

      <!-- Top Controls -->
      <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button id="gameBtn" title="Play Game" class="w-11 h-11 rounded-full bg-white shadow flex items-center justify-center text-2xl hover:scale-105 transition">üéÆ</button>
        <button id="connectTopBtn" title="Connect Telegram" class="w-11 h-11 rounded-full bg-white shadow flex items-center justify-center text-2xl hover:scale-105 transition">‚úâÔ∏è</button>
      </div>

      <!-- Header -->
      <div class="space-y-3 text-center pt-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-blue-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Queue Status</h1>
        <p id="counterName" class="text-sm text-gray-600">--</p>
      </div>

      <!-- Connection Banner -->
      <div id="connectionBanner" class="rounded-2xl p-4 border-2 bg-yellow-50 border-yellow-200">
        <p id="connectionBannerText" class="text-sm text-center text-yellow-700">‚ö†Ô∏è Not connected. Tap Connect to receive notifications.</p>
      </div>

      <!-- Your Number -->
      <div class="bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl p-6 border-2 border-purple-200">
        <p class="text-sm font-medium text-purple-700 mb-2">Your Number</p>
        <p id="yourNumber" class="text-5xl font-bold text-purple-800">--</p>
      </div>

      <!-- Status Grid -->
      <div class="space-y-4">
        <div class="bg-gray-50 rounded-2xl p-5">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Now Serving</span>
            <div id="statusIndicator" class="w-3 h-3 rounded-full bg-blue-500"></div>
          </div>
          <p id="nowServing" class="text-3xl font-bold text-gray-900">--</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
              <p class="text-sm text-gray-600">People Ahead</p>
            </div>
            <p id="peopleAhead" class="text-2xl font-bold text-gray-900">--</p>
          </div>
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <p class="text-sm text-gray-600">Est. Wait</p>
            </div>
            <p id="estimatedWait" class="text-2xl font-bold text-gray-900">--</p>
          </div>
        </div>
      </div>

      <!-- Telegram Status (Desktop) -->
      <div class="hidden sm:block bg-gray-50 rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Notifications</p>
            <p id="telegramStatus" class="text-base font-semibold">Checking...</p>
          </div>
          <div id="telegramIcon" class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100"><span class="text-2xl">‚úâÔ∏è</span></div>
        </div>
      </div>

    </section>
  </main>

  <!-- Advertisement -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-md px-4 z-40">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-4">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement" class="w-full rounded-lg max-h-24 object-cover hidden">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>

  <!-- Connect Telegram Modal -->
  <div id="connectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="connectTitle">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:8px">
          <div style="width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
          </div>
        </div>
        <h2 id="connectTitle" class="text-2xl font-bold">Connect to QueueJoyBot</h2>
        <p class="text-blue-100 text-sm mt-1">Tap the button and follow these 3 quick steps</p>
      </div>

      <div class="modal-body">
        <div id="cjStepsWrap" class="cj-steps" role="list" aria-label="Connection steps">
          <div class="cj-step active" data-step="0" role="listitem" aria-hidden="false">
            <div class="cj-step-number">1</div>
            <div class="cj-illustration" aria-hidden="true">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#6c63ff" stroke-width="1.6"><rect x="6" y="2" width="12" height="20" rx="2"/><circle cx="12" cy="17" r="1"/></svg>
            </div>
            <div class="cj-title">Install Telegram App</div>
            <p class="cj-desc">Install Telegram from App Store / Play Store ‚Äî only the app supports background notifications reliably.</p>
          </div>

          <div class="cj-step" data-step="1" role="listitem" aria-hidden="true">
            <div class="cj-step-number">2</div>
            <div class="cj-illustration" aria-hidden="true">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ff77c3" stroke-width="1.6"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
            </div>
            <div class="cj-title">Tap "Connect Telegram"</div>
            <p class="cj-desc">Press the button below. A Telegram chat will open to QueueJoyBot with a secure token. Tap "Start" in Telegram.</p>
          </div>

          <div class="cj-step" data-step="2" role="listitem" aria-hidden="true">
            <div class="cj-step-number">3</div>
            <div class="cj-illustration" aria-hidden="true">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="1.6"><path d="M3 7h18v13H3z"/><path d="M12 7v10"/><path d="M3 7l4-4h10l4 4"/></svg>
            </div>
            <div class="cj-title">You're All Set</div>
            <p class="cj-desc">QueueJoyBot will message you automatically when your number is called ‚Äî you can then close this page.</p>
          </div>
        </div>

        <!-- dots -->
        <div class="cj-dots mt-5" aria-hidden="true">
          <span class="cj-dot active" data-dot="0"></span>
          <span class="cj-dot" data-dot="1"></span>
          <span class="cj-dot" data-dot="2"></span>
        </div>

        <!-- controls -->
        <div class="cj-controls mt-6">
          <button id="cjPrev" class="cj-skip" aria-label="Previous step">Back</button>
          <button id="cjNext" class="cj-next" aria-label="Next step">Next</button>
        </div>

        <!-- loading -->
        <div id="loadingIndicator" class="hidden text-center py-3">
          <span class="spinner" aria-hidden="true"></span>
          <span class="ml-2 text-gray-600 text-sm">Preparing secure link...</span>
        </div>

        <!-- fallback -->
        <div id="fallbackArea" class="hidden mt-4 text-center">
          <p class="text-sm text-gray-600 mb-2">If Telegram didn't open automatically, tap below:</p>
          <a id="manualLink" class="inline-block px-4 py-3 bg-white border rounded-xl text-sm font-medium" target="_blank" rel="noopener noreferrer">Open QueueJoyBot</a>
        </div>
      </div>

      <div class="modal-footer">
        <button id="connectBtn" class="primary-cta bg-gradient-to-r from-pink-500 to-purple-600 text-white">Connect Telegram</button>
        <button id="closeModalBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 rounded-xl">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal (unchanged) -->
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content max-w-sm">
      <div class="text-center py-6 px-4">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
        <h3 id="confirmTitle" class="text-xl font-bold text-gray-900 mb-2">Connected Successfully!</h3>
        <p class="text-gray-600 mb-3">Hey üëã</p>
        <div class="text-sm bg-gray-50 rounded-lg p-4 mb-4 space-y-1">
          <p class="text-gray-700">üßæ Number: <strong id="confirmNumber">--</strong></p>
          <p class="text-gray-700">ü™ë Counter: <strong id="confirmCounter">--</strong></p>
        </div>
        <p class="text-sm text-gray-600">You can close this page now. We'll message you on Telegram when it's your turn.</p>
      </div>
    </div>
  </div>

  <!-- Firebase + Client JS (single module ‚Äî consolidated & robust) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Endpoints (unchanged)
    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const SEND_TELEGRAM_ENDPOINT = '/.netlify/functions/sendTelegram';

    // Force target bot
    const PREFERRED_BOT_USERNAME = 'QueueJoyBot';

    // DOM refs
    const yourNumber = document.getElementById('yourNumber');
    const counterNameEl = document.getElementById('counterName');
    const nowServingEl = document.getElementById('nowServing');
    const peopleAheadEl = document.getElementById('peopleAhead');
    const estimatedWaitEl = document.getElementById('estimatedWait');
    const statusIndicator = document.getElementById('statusIndicator');
    const telegramStatus = document.getElementById('telegramStatus');
    const telegramIcon = document.getElementById('telegramIcon');
    const connectionBanner = document.getElementById('connectionBanner');
    const connectionBannerText = document.getElementById('connectionBannerText');
    const adPanel = document.getElementById('adPanel');
    const noAd = document.getElementById('noAd');

    const connectModal = document.getElementById('connectModal');
    const confirmModal = document.getElementById('confirmModal');
    const connectTopBtn = document.getElementById('connectTopBtn');
    const connectBtn = document.getElementById('connectBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const gameBtn = document.getElementById('gameBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const confirmNumber = document.getElementById('confirmNumber');
    const confirmCounter = document.getElementById('confirmCounter');
    const fallbackArea = document.getElementById('fallbackArea');
    const manualLink = document.getElementById('manualLink');

    // Carousel elements
    const cjStepsWrap = document.getElementById('cjStepsWrap');
    const cjSteps = Array.from(document.querySelectorAll('.cj-step'));
    const cjDots = Array.from(document.querySelectorAll('.cj-dot'));
    const cjPrev = document.getElementById('cjPrev');
    const cjNext = document.getElementById('cjNext');

    // Firebase config (same as yours)
    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // State
    let queueData = null;
    let avgServiceTime = 2;
    let isGeneratingLink = false;
    let prevTelegramConnected = false;
    window.lastTokenGenerated = null; // exposed for debugging/fallback

    // Read queueId from URL
    const params = new URLSearchParams(window.location.search);
    const queueKey = params.get('queueId');
    if (!queueKey) {
      alert('Queue ID missing. Please scan the QR code again.');
      window.location.href = '/';
    }

    // UI helpers
    function updateConnectionUI(connected) {
      if (connected) {
        telegramStatus.textContent = 'Connected to Telegram';
        telegramStatus.className = 'text-base font-semibold text-green-700';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-green-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-green-50 border-green-200';
        connectionBannerText.textContent = '‚úÖ Connected! You can leave this page. We\'ll notify you on Telegram when it\'s your turn.';
        connectionBannerText.className = 'text-sm text-center text-green-700';
      } else {
        telegramStatus.textContent = 'Not connected';
        telegramStatus.className = 'text-base font-semibold text-gray-800';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-gray-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-yellow-50 border-yellow-200';
        connectionBannerText.textContent = '‚ö†Ô∏è Not connected. Tap Connect to receive notifications.';
        connectionBannerText.className = 'text-sm text-center text-yellow-700';
      }
    }

    // generate token via server
    async function createTokenFromServer() {
      if (!queueKey) throw new Error('Missing queueKey');
      const queueNumber = yourNumber.textContent && yourNumber.textContent !== '--' ? yourNumber.textContent : null;
      const payload = { queueKey: queueKey || null, queueNumber: queueNumber || null, counterId: queueData?.counterId || null };
      const res = await fetch(CREATE_LINK_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>null);
        throw new Error('createTelegramLink failed: ' + (t || res.status));
      }
      const json = await res.json();
      // token field preferred
      const token = json?.token || null;
      if (token) return { token, rawServerLink: json?.link || null };
      // fallback: parse start= from server link
      if (json?.link) {
        try {
          const u = new URL(json.link);
          const s = u.searchParams.get('start');
          if (s) return { token: s, rawServerLink: json.link };
        } catch (e){}
      }
      throw new Error('No token returned by createTelegramLink');
    }

    function buildPreferredLink(token) {
      return `https://t.me/${PREFERRED_BOT_USERNAME}?start=${encodeURIComponent(token)}`;
    }

    // Fallback link UI
    function showFallback(link) {
      manualLink.href = link;
      manualLink.textContent = `Open ${PREFERRED_BOT_USERNAME} in Telegram`;
      fallbackArea.classList.remove('hidden');
    }
    function hideFallback() {
      fallbackArea.classList.add('hidden');
      manualLink.href = '#';
      manualLink.textContent = 'Open Telegram';
    }

    /**
     * Robust connect flow:
     * 1) Immediately open a blank tab/window (user gesture) -> win
     * 2) Call server to create token
     * 3) When token ready, navigate win.location to preferred bot link
     * 4) If anything fails, show fallback manual link and close the blank tab if possible
     */
    async function handleConnectClick() {
      if (isGeneratingLink) return;
      isGeneratingLink = true;
      hideFallback();
      connectBtn.disabled = true;
      loadingIndicator.classList.remove('hidden');

      // open an about:blank tab immediately on user gesture -> avoids popup blocking
      let win = null;
      try {
        win = window.open('about:blank', '_blank', 'noopener,noreferrer');
      } catch (e) {
        win = null;
      }

      try {
        const { token, rawServerLink } = await createTokenFromServer();
        window.lastTokenGenerated = token;
        const link = buildPreferredLink(token);

        // if we have a window handle, navigate it; otherwise fall back to window.open (may be blocked)
        if (win) {
          try { win.location.href = link; win.focus(); }
          catch (e) { /* in some browsers setting location on about:blank may be restricted */ 
            try { win.close(); } catch(e) {}
            win = window.open(link, '_blank', 'noopener,noreferrer');
            if (win) try { win.focus(); } catch(e) {}
          }
        } else {
          // Attempt to open directly (may be blocked on some browsers if not considered user gesture)
          win = window.open(link, '_blank', 'noopener,noreferrer');
          if (!win) {
            // popup blocked ‚Äî show fallback and do not leave user hanging
            showFallback(link);
            console.warn('Popup blocked when opening preferred link; fallback shown', { link, rawServerLink });
          } else {
            try { win.focus(); } catch(e) {}
          }
        }

      } catch (err) {
        console.error('connect flow error', err);
        alert('Could not create the Telegram connection link. Use the manual link shown below or try again.');
        // show manual fallback if token exists
        if (window.lastTokenGenerated) {
          showFallback(buildPreferredLink(window.lastTokenGenerated));
        } else {
          // if server returned raw link earlier, optionally show that (we didn't capture here)
        }
        // close blank window if it exists to avoid orphan about:blank
        try { if (win && !win.closed) win.close(); } catch (e) {}
      } finally {
        isGeneratingLink = false;
        connectBtn.disabled = false;
        loadingIndicator.classList.add('hidden');
      }
    }

    // Expose for debugging (optional)
    window.handleConnectClick = handleConnectClick;

    // Carousel logic - compact and robust
    (function initCarousel(){
      const steps = cjSteps;
      const dots = cjDots;
      let idx = 0;
      function show(i) {
        steps.forEach((s,j) => { s.classList.toggle('active', j===i); s.setAttribute('aria-hidden', j===i? 'false':'true'); });
        dots.forEach((d,j) => d.classList.toggle('active', j===i));
        cjNext.textContent = i === steps.length -1 ? 'Connect & Open' : 'Next';
      }
      show(idx);
      cjPrev?.addEventListener('click', ()=> { idx = Math.max(0, idx-1); show(idx); });
      cjNext?.addEventListener('click', ()=> {
        if (idx < steps.length -1) { idx += 1; show(idx); }
        else { connectBtn.focus(); }
      });
      dots.forEach((d,j)=> d.addEventListener('click', ()=> { idx = j; show(idx); }));
      // pointer swipe
      let sx = null;
      cjStepsWrap?.addEventListener('pointerdown', e => sx = e.clientX);
      cjStepsWrap?.addEventListener('pointerup', e => { if (sx === null) return; const dx = e.clientX - sx; if (dx < -40) idx = Math.min(steps.length-1, idx+1); if (dx > 40) idx = Math.max(0, idx-1); show(idx); sx = null; });
    })();

    // UI event bindings
    connectTopBtn.addEventListener('click', ()=> { connectModal.classList.add('show'); setTimeout(()=> connectBtn.focus(), 220); });
    closeModalBtn.addEventListener('click', ()=> connectModal.classList.remove('show'));
    connectModal.addEventListener('click', e => { if (e.target === connectModal) connectModal.classList.remove('show'); });
    connectBtn.addEventListener('click', (e) => { /* user gesture */ handleConnectClick(); });
    gameBtn.addEventListener('click', ()=> { window.location.href = 'https://queuejoy.netlify.app/game.html'; });

    // show connect modal on load (only UI, does not auto-open Telegram)
    setTimeout(()=> connectModal.classList.add('show'), 450);

    // FIREBASE: listen to queue data and counters (kept as your existing logic)
    const queueRef = ref(db, `queue/${queueKey}`);
    onValue(queueRef, async (snap) => {
      if (!snap.exists()) {
        alert('Queue entry not found.');
        return;
      }

      const data = snap.val();
      const wasConnected = prevTelegramConnected;
      prevTelegramConnected = !!data.telegramConnected;

      queueData = data;
      yourNumber.textContent = data.queueId || '--';

      updateConnectionUI(!!data.telegramConnected);

      // Show confirmation when newly connected
      if (data.telegramConnected && !wasConnected) {
        const prefix = String(data.queueId || '').match(/^[A-Za-z]*/)?.[0] || '';
        const numberOnly = String(data.queueId || '').replace(prefix, '') || '';
        confirmNumber.textContent = `${prefix}${numberOnly}`;
        confirmCounter.textContent = data.counterId || 'TBD';
        connectModal.classList.remove('show');
        confirmModal.classList.add('show');
        setTimeout(()=> confirmModal.classList.remove('show'), 3000);
      }

      // Listen to counter
      if (data.counterId) {
        const counterRef = ref(db, `counters/${data.counterId}`);
        onValue(counterRef, async (counterSnap) => {
          if (!counterSnap.exists()) return;
          const counterData = counterSnap.val();
          counterNameEl.textContent = counterData.name || data.counterId;

          // avg service time
          let avgTime = Number(counterData.avgServiceTime) || null;
          if (!avgTime) {
            try {
              const settingsSnap = await get(ref(db, 'settings/avgServiceTime'));
              avgTime = settingsSnap.exists() ? Number(settingsSnap.val()) || 2 : 2;
            } catch (e) { avgTime = 2; }
          }
          avgServiceTime = avgTime;

          // Listen to nowServing
          const servingRef = ref(db, `counters/${data.counterId}/nowServing`);
          onValue(servingRef, (nowSnap) => {
            const currentServing = Number(nowSnap.val() || 0);
            const prefix = counterData.prefix || String(data.queueId || '').match(/^[A-Za-z]+/)?.[0] || "";
            nowServingEl.textContent = `${prefix}${String(currentServing).padStart(3,'0')}`;

            const yourNumericValue = data.queueId ? parseInt(String(data.queueId).replace(prefix,''), 10) : NaN;
            const ahead = Number.isFinite(yourNumericValue) ? Math.max(0, yourNumericValue - currentServing) : 0;
            peopleAheadEl.textContent = String(ahead);

            if (ahead === 0) {
              estimatedWaitEl.textContent = "Your turn!";
              statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse';

              // Notify via server/sendTelegram endpoint (best-effort)
              try {
                const notifyBody = data.chatId ? { chatId: data.chatId, message: `üéü It's now your turn!\nQueue: ${queueKey}` } : { message: `üéü It's now the customer's turn!\nQueue: ${queueKey}` };
                fetch(SEND_TELEGRAM_ENDPOINT, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(notifyBody)
                }).catch(()=>{});
              } catch(e) {}

              // redirect to your_turn page
              setTimeout(()=> { try { window.location.href = `/your_turn.html?queueId=${encodeURIComponent(queueKey)}` } catch(e) {} }, 1200);
            } else {
              statusIndicator.className = 'w-3 h-3 bg-blue-500 rounded-full';
              const estimatedMinutes = Math.round(ahead * avgServiceTime);
              estimatedWaitEl.textContent = `~${estimatedMinutes} min`;
            }
          });
        });
      }
    });

    // ad listener
    const adRef = ref(db, "settings/adImage");
    onValue(adRef, (snap) => {
      const adUrl = snap.val();
      if (adUrl) { adPanel.src = adUrl; adPanel.classList.remove('hidden'); noAd.classList.add('hidden'); }
      else { adPanel.classList.add('hidden'); noAd.classList.remove('hidden'); }
    });

    // cleanup
    window.addEventListener('beforeunload', ()=> { off(queueRef); off(adRef); });

  </script>
</body>
</html>
