<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy - Your Status</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.45s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px);} to { opacity: 1; transform: translateY(0); } }
    .circle-control { width:46px;height:46px;border-radius:9999px;background:white;display:inline-flex;align-items:center;justify-content:center;box-shadow: 0 8px 30px rgba(15,23,42,0.08);cursor:pointer;border:none }
    .top-controls { z-index:80; position:absolute; right:.75rem; top:.75rem; display:flex; gap:.5rem; }
    #adPanelContainer { z-index:40; }
    #adContainer video, #adContainer img { max-height: 96px; width: 100%; object-fit: cover; border-radius: 0.5rem; display: block; }
    @media (max-width:420px){ .top-controls{ right:.5rem; top:.5rem } }
    .spinner-inline { width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;margin-right:8px }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4 pb-32">

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display:flex">
    <div class="bg-white rounded-2xl max-w-md w-full p-6">
      <h2 class="text-2xl font-bold text-indigo-700 mb-2">Connect Telegram</h2>
      <p class="text-gray-600 mb-4">Get notified instantly when it's your turn. Tap the button below to connect this queue to Telegram.</p>
      <div id="connectArea" class="space-y-3">
        <button id="finalConnectButton" class="w-full py-3 rounded-xl text-white font-semibold" style="background:linear-gradient(135deg,#ec4899,#8b5cf6)">Connect via Telegram</button>
        <p id="connectStatusText" class="text-sm text-gray-500">Preparing connection...</p>
      </div>
      <div class="text-right mt-3">
        <button id="closeOnboarding" class="text-sm text-gray-500">Close</button>
      </div>
    </div>
  </div>

  <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-6 text-center fade-in relative">
    <div class="top-controls">
      <button id="gameBtn" title="Game" class="circle-control" type="button">üéÆ</button>
      <button id="connectTopBtn" title="Connect Telegram" class="circle-control" type="button">‚úâÔ∏è</button>
    </div>

    <div class="space-y-2">
      <div class="w-16 h-16 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-indigo-800">Queue Status</h1>
      <p id="counterName" class="text-sm text-gray-600">--</p>
    </div>

    <div id="connectionBanner" class="rounded-xl p-3 bg-yellow-50 border border-yellow-100 text-left text-sm">
      <span id="connectionBannerText">Checking notification status...</span>
    </div>

    <div class="bg-gradient-to-r from-purple-100 to-indigo-100 rounded-xl p-4 border-2 border-purple-200">
      <p class="text-sm text-purple-600 font-medium">Your Number</p>
      <p id="yourNumber" class="text-4xl font-bold text-purple-800">--</p>
    </div>

    <div class="space-y-4">
      <div class="bg-gray-50 rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm text-gray-600">Now Serving</span>
          <div id="statusIndicator" class="w-3 h-3 bg-green-400 rounded-full"></div>
        </div>
        <p id="nowServing" class="text-2xl font-bold text-indigo-600">--</p>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-xl p-4">
          <p class="text-sm text-gray-600">People Ahead</p>
          <p id="peopleAhead" class="text-xl font-bold text-gray-800">--</p>
        </div>
        <div class="bg-gray-50 rounded-xl p-4">
          <p class="text-sm text-gray-600">Est. Wait</p>
          <p id="estimatedWait" class="text-xl font-bold text-gray-800">--</p>
        </div>
      </div>
    </div>

    <div id="telegramStatusBox" class="hidden sm:block bg-gray-50 rounded-xl p-4 text-left">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">Notifications</p>
          <p id="telegramStatus" class="text-base font-semibold text-gray-800">Checking...</p>
        </div>
        <div id="telegramIcon" class="w-10 h-10 rounded-full flex items-center justify-center bg-indigo-100">
          <span>‚úâÔ∏è</span>
        </div>
      </div>
    </div>

    <div id="errorMessage" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-600 text-sm text-center"></p>
    </div>

    <!-- Admin small card showing the computed avg (optional - only visible for admins if included on page) -->
    <div id="analystCard" class="mt-2 hidden">
      <div style="padding:18px;background:linear-gradient(135deg,rgba(102,126,234,0.95),rgba(102,126,234,0.8));color:white;border-radius:12px">
        <p style="opacity:.9;margin:0">Avg Wait Time</p>
        <h3 style="font-size:20px;font-weight:700;margin:6px 0"><span id="analystAvgWait">0</span> min</h3>
      </div>
    </div>

  </div>

  <div id="adPanelContainer" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-sm px-4">
    <div class="bg-white rounded-xl shadow-lg p-3">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <div id="adContainer" class="w-full rounded-lg shadow-md overflow-hidden"></div>
      <div id="noAd" class="text-center text-gray-400 text-sm py-4 hidden">No advertisement available</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const SEND_TELEGRAM_ENDPOINT = '/.netlify/functions/sendTelegram';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM refs
    const yourNumber = document.getElementById('yourNumber');
    const counterNameEl = document.getElementById('counterName');
    const nowServingEl = document.getElementById('nowServing');
    const peopleAheadEl = document.getElementById('peopleAhead');
    const estimatedWaitEl = document.getElementById('estimatedWait');
    const indicator = document.getElementById('statusIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const adContainer = document.getElementById('adContainer');
    const noAd = document.getElementById('noAd');
    const telegramStatus = document.getElementById('telegramStatus');
    const telegramIcon = document.getElementById('telegramIcon');
    const connectionBannerText = document.getElementById('connectionBannerText');
    const connectTopBtn = document.getElementById('connectTopBtn');
    const gameBtn = document.getElementById('gameBtn');
    const onboardingModal = document.getElementById('onboardingModal');
    const connectStatusText = document.getElementById('connectStatusText');
    const finalConnectButton = document.getElementById('finalConnectButton');
    const closeOnboarding = document.getElementById('closeOnboarding');
    const analystCard = document.getElementById('analystCard');
    const analystAvgWait = document.getElementById('analystAvgWait');

    // state
    let queueRef = null, counterRef = null, servingRef = null, adRef = null;
    let currentQueueKey = null;
    let currentQueueData = null;
    let currentCounterId = null;
    let latestConnectLink = null;
    let linkGenerating = false;
    let avgServiceTimeForCounter = 3; // minutes
    let redirectTimeoutId = null;

    // UI helpers
    function showError(msg) {
      errorMessage.querySelector('p').textContent = msg;
      errorMessage.classList.remove('hidden');
      setTimeout(()=> errorMessage.classList.add('hidden'), 6000);
    }

    function setTelegramUIConnected(connected) {
      if (connected) {
        telegramStatus.textContent = "Connected ‚Äî you'll get Telegram notifications";
        telegramStatus.classList.remove('text-gray-600');
        telegramStatus.classList.add('text-green-700','font-semibold');
        telegramIcon.classList.add('bg-green-100');
        connectionBannerText.textContent = "Connected ‚úÖ You can close both your browser and Telegram. You‚Äôll get notified when it‚Äôs your turn.";
      } else {
        telegramStatus.textContent = 'Not connected ‚Äî get notified by Telegram';
        telegramStatus.classList.remove('text-green-700','font-semibold');
        telegramStatus.classList.add('text-gray-800');
        telegramIcon.classList.remove('bg-green-100');
        connectionBannerText.textContent = 'Not connected ‚Äî you must keep this page open to get live updates and automatic redirect.';
      }
    }

    function formatMinutesToReadable(mins) {
      const m = Math.max(0, Math.round(mins));
      if (m === 0) return 'Less than a minute';
      if (m < 60) return `${m} min`;
      const hrs = Math.floor(m / 60);
      const rem = m % 60;
      return rem === 0 ? `${hrs} hr${hrs > 1 ? 's' : ''}` : `${hrs} hr ${rem} min`;
    }

    function computeEstimatedWaitText(ahead, avgMins) {
      let avg = Number(avgMins);
      if (!Number.isFinite(avg) || avg <= 0) avg = 3;
      if (!Number.isFinite(ahead) || ahead <= 0) return 'Now';
      const estMinutes = Math.round(ahead * avg);
      return `${ahead} person${ahead > 1 ? 's' : ''} ‚Äî approx ${formatMinutesToReadable(estMinutes)}`;
    }

    // Connect button logic
    async function generateConnectLink() {
      if (!currentQueueKey) throw new Error('Missing queueKey');
      const res = await fetch(CREATE_LINK_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ queueKey: currentQueueKey })
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>'');
        throw new Error(`Server error ${res.status} ${txt}`);
      }
      const j = await res.json();
      if (!j.link) throw new Error('No link returned');
      return j.link;
    }

    async function openConnect() {
      if (linkGenerating) return;
      linkGenerating = true;
      connectStatusText.textContent = 'Generating secure link...';
      finalConnectButton.disabled = true;
      try {
        latestConnectLink = await generateConnectLink();
      } catch (e) {
        latestConnectLink = `https://t.me/QueueJoyBot`;
      } finally {
        linkGenerating = false;
      }
      connectStatusText.textContent = 'Opening Telegram...';
      window.open(latestConnectLink, '_blank', 'noopener');
      finalConnectButton.disabled = false;
      setTimeout(()=> { onboardingModal.style.display = 'none'; }, 500);
    }

    finalConnectButton.addEventListener('click', openConnect);
    connectTopBtn.addEventListener('click', () => { onboardingModal.style.display = 'flex'; });
    closeOnboarding.addEventListener('click', () => { onboardingModal.style.display = 'none'; });
    gameBtn.addEventListener('click', () => { window.location.href = 'https://queuejoy.netlify.app/game.html'; });

    // AD handling (light)
    function clearAdContainerPause() {
      const prev = adContainer.querySelector('video');
      if (prev) {
        try { prev.pause(); } catch(e){}
        try { prev.removeAttribute('src'); } catch(e){}
      }
      adContainer.innerHTML = '';
    }
    function showAdFromUrl(adUrl) {
      clearAdContainerPause();
      if (!adUrl) {
        noAd.classList.remove('hidden');
        return;
      }
      const url = String(adUrl).trim();
      const isVideo = /\.(mp4|webm|ogg)(\?.*)?$/i.test(url) || url.startsWith('data:video/');
      noAd.classList.add('hidden');
      if (isVideo) {
        const videoEl = document.createElement('video');
        videoEl.setAttribute('playsinline',''); videoEl.setAttribute('autoplay',''); videoEl.setAttribute('loop',''); videoEl.setAttribute('muted',''); videoEl.setAttribute('preload','metadata');
        videoEl.className = 'w-full object-cover';
        videoEl.src = url;
        adContainer.appendChild(videoEl);
        videoEl.play().catch(()=>{ videoEl.setAttribute('controls',''); });
      } else {
        const img = document.createElement('img'); img.src = url; img.alt='Ad'; img.className='w-full object-cover';
        img.onerror = () => { clearAdContainerPause(); noAd.classList.remove('hidden'); };
        adContainer.appendChild(img);
      }
    }
    adRef = ref(db, 'settings/adImage');
    onValue(adRef, snap => {
      const val = snap.val();
      if (!val) { clearAdContainerPause(); noAd.classList.remove('hidden'); }
      else showAdFromUrl(val);
    });

    // Average computation ‚Äî returns minutes (float)
    async function computeAvgServiceMinutes(counterId, counterData) {
      // 1) counter.avgServiceTime
      let avg = Number(counterData && counterData.avgServiceTime);
      if (Number.isFinite(avg) && avg > 0) return avg;

      // 2) search likely paths for sample serviceMs
      const candidatePaths = ['tickets','servedTickets','served','history'];
      const samples = [];
      const MAX_SAMPLES = 80;

      for (const p of candidatePaths) {
        try {
          const snap = await get(ref(db, p));
          if (!snap.exists()) continue;
          const all = snap.val();
          for (const k in all) {
            if (!Object.prototype.hasOwnProperty.call(all,k)) continue;
            const t = all[k];
            if (!t) continue;
            const serviceMs = Number(t.serviceMs || t.service_ms || t.servedMs || t.service_time_ms || 0);
            if (!Number.isFinite(serviceMs) || serviceMs <= 0) continue;
            // match by counterId OR counter name OR counter field
            const counterMatches =
              (t.counterId && String(t.counterId) === String(counterId))
              || (t.counter && String(t.counter) === String(counterId))
              || (t.counter && String(t.counter) === String(counterData?.name))
              || false;
            if (counterMatches) {
              samples.push(serviceMs);
              if (samples.length >= MAX_SAMPLES) break;
            }
          }
        } catch (e) {
          // ignore read errors and continue
        }
        if (samples.length >= MAX_SAMPLES) break;
      }

      if (samples.length > 0) {
        // mean of samples
        const sum = samples.reduce((a,b)=>a+b,0);
        const meanMs = sum / samples.length;
        return meanMs / 60000; // minutes
      }

      // 3) try global settings
      try {
        const sSnap = await get(ref(db, 'settings/avgServiceTime'));
        if (sSnap.exists()) {
          const sVal = Number(sSnap.val());
          if (Number.isFinite(sVal) && sVal > 0) return sVal;
        }
      } catch (e) { /* ignore */ }

      // 4) fallback
      return 3;
    }

    // main flow
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const queueKey = params.get('queueId');
      if (!queueKey) {
        showError('Queue ID missing. Returning to home...');
        setTimeout(()=> window.location.href = 'index.html', 1500);
        return;
      }
      currentQueueKey = queueKey;
      queueRef = ref(db, `queue/${queueKey}`);

      onValue(queueRef, async (snap) => {
        if (!snap.exists()) {
          showError('Queue entry not found. Returning...');
          setTimeout(()=> window.location.href = 'index.html', 1800);
          return;
        }

        const prevTelegram = currentQueueData && currentQueueData.telegramConnected;
        currentQueueData = snap.val();
        const qid = currentQueueData.queueId || currentQueueData.number || currentQueueData.ticket || 'Unknown';
        yourNumber.textContent = qid;
        setTelegramUIConnected(!!currentQueueData.telegramConnected);

        if (currentQueueData.telegramConnected && !prevTelegram) {
          onboardingModal.style.display = 'none';
        }

        const counterId = currentQueueData.counterId || null;
        if (!counterId) {
          counterNameEl.textContent = 'Unassigned';
          // detach any existing counter listeners
          if (counterRef) { off(counterRef); counterRef = null; }
          if (servingRef) { off(servingRef); servingRef = null; }
          peopleAheadEl.textContent = '--';
          estimatedWaitEl.textContent = '--';
          return;
        }

        // if counter changed, rebind
        if (!counterRef || currentCounterId !== counterId) {
          currentCounterId = counterId;
          if (counterRef) off(counterRef);
          counterRef = ref(db, `counters/${counterId}`);

          onValue(counterRef, async (counterSnap) => {
            if (!counterSnap.exists()) return;
            const counterData = counterSnap.val();
            counterNameEl.textContent = counterData.name || counterId;

            // compute avg service minutes (tries counter.avgServiceTime -> samples -> settings -> 3)
            avgServiceTimeForCounter = await computeAvgServiceMinutes(counterId, counterData);

            // update admin display if present
            if (analystAvgWait) {
              analystAvgWait.textContent = String(Math.round(Math.max(0, avgServiceTimeForCounter)));
              analystCard.classList.remove('hidden');
            }

            // attach nowServing
            if (servingRef) off(servingRef);
            servingRef = ref(db, `counters/${counterId}/nowServing`);
            onValue(servingRef, nowSnap => {
              const currentServing = Number(nowSnap.val() || 0);
              const prefix = (counterData && counterData.prefix) || (qid && (qid.match(/^[A-Za-z]+/)||[])[0]) || '';
              if (Number.isFinite(currentServing) && currentServing > 0) {
                nowServingEl.textContent = `${prefix}${String(currentServing).padStart(3,'0')}`;
              } else {
                nowServingEl.textContent = '--';
              }

              // compute numeric part of user's number
              const yourNumberNum = (() => {
                if (!qid) return NaN;
                const trimmed = prefix ? String(qid).replace(prefix, '') : String(qid).replace(/^[A-Za-z]+/,'');
                const n = parseInt(trimmed.replace(/^0+/, '') || trimmed, 10);
                return Number.isFinite(n) ? n : NaN;
              })();

              const ahead = (Number.isFinite(yourNumberNum) && Number.isFinite(currentServing)) ? Math.max(0, yourNumberNum - currentServing) : 0;
              peopleAheadEl.textContent = Number.isFinite(ahead) ? String(ahead) : '--';
              estimatedWaitEl.textContent = Number.isFinite(ahead) ? computeEstimatedWaitText(ahead, avgServiceTimeForCounter) : '--';

              // if it's the user's turn
              if (ahead === 0) {
                indicator.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';

                // best-effort notify via server function
                if (currentQueueData && currentQueueData.chatId) {
                  fetch(SEND_TELEGRAM_ENDPOINT, {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify({ chatId: currentQueueData.chatId, message: `üéü It's now your turn!\nQueue: ${currentQueueKey}` })
                  }).catch(()=>{});
                }

                // redirect to your_turn page after short pause (prevent multiple timeouts)
                if (redirectTimeoutId) clearTimeout(redirectTimeoutId);
                redirectTimeoutId = setTimeout(()=> {
                  try { window.location.href = `/your_turn.html?queueId=${encodeURIComponent(currentQueueKey)}`; } catch(e){}
                }, 1200);
              } else {
                indicator.className = 'w-3 h-3 bg-blue-400 rounded-full';
                if (redirectTimeoutId) { clearTimeout(redirectTimeoutId); redirectTimeoutId = null; }
              }
            });
          }); // end onValue counterRef
        } // end if counter change
      }); // end onValue queueRef
    }); // DOMContentLoaded

    window.addEventListener('beforeunload', () => {
      try {
        if (queueRef) off(queueRef);
        if (counterRef) off(counterRef);
        if (servingRef) off(servingRef);
        if (adRef) off(adRef);
      } catch (e) {}
    });

  </script>
</body>
</html>
