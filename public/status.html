<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queue Joy - Your Queue Status</title>
  <meta name="description" content="Real-time queue status with Telegram notifications" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-from:#f3f0ff;--bg-via:#eef2ff;--bg-to:#ecfeff}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    .fade-in{animation:fadeIn .45s cubic-bezier(.2,.9,.2,1)}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.25);border-top-color:white;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal{display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,.45);align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:white;border-radius:14px;max-width:520px;width:94%;box-shadow:0 20px 60px rgba(2,6,23,.25);overflow:hidden}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (prefers-reduced-motion:reduce){.fade-in,.spinner{animation:none}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#f3f0ff] via-[#eef2ff] to-[#ecfeff]">

  <main class="min-h-screen flex items-center justify-center p-4 pb-28">
    <section class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-gray-100 p-6 space-y-6 relative fade-in" aria-labelledby="pageTitle">

      <!-- Top Controls -->
      <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button id="gameBtn" title="Play Game" class="w-11 h-11 rounded-full bg-white shadow flex items-center justify-center text-2xl hover:scale-105 transition">üéÆ</button>
        <button id="connectTopBtn" title="Connect Telegram" class="w-11 h-11 rounded-full bg-white shadow flex items-center justify-center text-2xl hover:scale-105 transition">‚úâÔ∏è</button>
      </div>

      <!-- Header -->
      <div class="space-y-3 text-center pt-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-blue-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Queue Status</h1>
        <p id="counterName" class="text-sm text-gray-600">--</p>
      </div>

      <!-- Connection Banner -->
      <div id="connectionBanner" class="rounded-2xl p-4 border-2 bg-yellow-50 border-yellow-200">
        <p id="connectionBannerText" class="text-sm text-center text-yellow-700">‚ö†Ô∏è Not connected. Keep this page open for updates.</p>
      </div>

      <!-- Your Number -->
      <div class="bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl p-6 border-2 border-purple-200">
        <p class="text-sm font-medium text-purple-700 mb-2">Your Number</p>
        <p id="yourNumber" class="text-5xl font-bold text-purple-800">--</p>
      </div>

      <!-- Status Grid -->
      <div class="space-y-4">
        <div class="bg-gray-50 rounded-2xl p-5">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Now Serving</span>
            <div id="statusIndicator" class="w-3 h-3 rounded-full bg-blue-500"></div>
          </div>
          <p id="nowServing" class="text-3xl font-bold text-gray-900">--</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2"><svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><p class="text-sm text-gray-600">People Ahead</p></div>
            <p id="peopleAhead" class="text-2xl font-bold text-gray-900">--</p>
          </div>
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2"><svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="text-sm text-gray-600">Est. Wait</p></div>
            <p id="estimatedWait" class="text-2xl font-bold text-gray-900">--</p>
          </div>
        </div>
      </div>

      <!-- Telegram Status (Desktop) -->
      <div class="hidden sm:block bg-gray-50 rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Notifications</p>
            <p id="telegramStatus" class="text-base font-semibold">Checking...</p>
          </div>
          <div id="telegramIcon" class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100"><span class="text-2xl">‚úâÔ∏è</span></div>
        </div>
      </div>

    </section>
  </main>

  <!-- Advertisement -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-md px-4 z-40">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-4">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement" class="w-full rounded-lg max-h-24 object-cover hidden">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>

  <!-- Connect Telegram Modal -->
<!-- Connect Telegram Modal (REPLACE the old modal with this block) -->
<div id="connectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="connectTitle">
  <div class="modal-content">
    <style>
      /* Local modal-only styles for the 3-step carousel */
      .cj-steps { display:flex; gap:18px; align-items:center; justify-content:center; }
      .cj-step { min-width:260px; max-width:420px; padding:26px; border-radius:16px; background:white; box-shadow:0 10px 30px rgba(12,20,50,0.08); transform:translateY(6px); transition:transform .32s cubic-bezier(.2,.9,.2,1),opacity .28s ease; opacity:0.0; }
      .cj-step.active { transform:translateY(0); opacity:1; }
      .cj-illustration { width:84px; height:84px; border-radius:18px; display:flex; align-items:center; justify-content:center; margin:0 auto 12px; background:linear-gradient(180deg,#fff,#f7fbff); box-shadow:0 6px 18px rgba(10,20,60,0.06); }
      .cj-dot { width:10px;height:10px;border-radius:999px;background:#E6E7EE;margin:6px;display:inline-block;transition:all .18s ease; }
      .cj-dot.active { width:18px;background:linear-gradient(90deg,#ff77c3,#6c63ff); }
      .cj-step-number { width:46px;height:46px;border-radius:999px;background:#fff;border:2px solid #F3E6FB;display:flex;align-items:center;justify-content:center;font-weight:700;color:#6b21a8;margin:0 auto 10px;box-shadow:0 6px 18px rgba(99,102,241,0.08); }
      .cj-title { font-size:18px;font-weight:700;color:#0f172a;margin-bottom:6px;text-align:center; }
      .cj-desc { font-size:13px;color:#475569;text-align:center;line-height:1.45;max-width:320px;margin:0 auto; }
      .cj-controls { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; }
      .cj-skip { background:transparent;border:none;color:#475569;font-weight:600;padding:8px 12px;border-radius:10px; }
      .cj-next { padding:10px 18px;border-radius:12px;background:linear-gradient(90deg,#6c63ff,#ff77c3);color:white;font-weight:700;border:none;box-shadow:0 8px 24px rgba(108,99,255,0.14); }
      @media (max-width:520px){ .cj-step{ min-width:86%; } .cj-step-number{width:40px;height:40px} }
    </style>

    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-lg">
      <div class="flex items-center justify-center mb-3">
        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
        </div>
      </div>
      <h2 id="connectTitle" class="text-2xl font-bold text-center">Connect to QueueJoyBot</h2>
      <p class="text-center text-blue-100 text-sm mt-2">Tap the button and follow these 3 quick steps</p>
    </div>

    <!-- Carousel / Steps -->
    <div class="p-6">
      <div id="cjStepsWrap" class="cj-steps" role="list" aria-label="Connection steps">
        <!-- STEP 1 -->
        <div class="cj-step active" role="listitem" data-step="0" aria-hidden="false">
          <div class="cj-step-number">1</div>
          <div class="cj-illustration" aria-hidden="true">
            <!-- simple SVG phone + hand -->
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#6c63ff" stroke-width="1.6"><rect x="6" y="2" width="12" height="20" rx="2"/><circle cx="12" cy="17" r="1"/></svg>
          </div>
          <div class="cj-title">Install Telegram App</div>
          <div class="cj-desc">If you don‚Äôt have Telegram, install it from your app store ‚Äî only the app receives background notifications reliably.</div>
        </div>

        <!-- STEP 2 -->
        <div class="cj-step" role="listitem" data-step="1" aria-hidden="true">
          <div class="cj-step-number">2</div>
          <div class="cj-illustration" aria-hidden="true">
            <!-- SVG showing tap/connect -->
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ff77c3" stroke-width="1.6"><path d="M3 12h18"/><path d="M12 3v18"/></svg>
          </div>
          <div class="cj-title">Tap ‚ÄúConnect Telegram‚Äù</div>
          <div class="cj-desc">Press the Connect button below. Your device will open QueueJoyBot with a secure token ‚Äî press <strong>Start</strong> inside the bot to finish.</div>
        </div>

        <!-- STEP 3 -->
        <div class="cj-step" role="listitem" data-step="2" aria-hidden="true">
          <div class="cj-step-number">3</div>
          <div class="cj-illustration" aria-hidden="true">
            <!-- gift/check svg -->
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="1.6"><path d="M3 7h18v13H3z"/><path d="M12 7v10"/><path d="M3 7l4-4h10l4 4"/></svg>
          </div>
          <div class="cj-title">You're All Set</div>
          <div class="cj-desc">QueueJoyBot will message you automatically when your number is called ‚Äî you can close this page and go about your day.</div>
        </div>
      </div>

      <!-- Progress dots -->
      <div class="mt-5 flex items-center justify-center" aria-hidden="true">
        <span class="cj-dot active" data-dot="0"></span>
        <span class="cj-dot" data-dot="1"></span>
        <span class="cj-dot" data-dot="2"></span>
      </div>

      <!-- Controls -->
      <div class="cj-controls mt-6">
        <button id="cjPrev" class="cj-skip" aria-label="Previous step">Back</button>
        <button id="cjNext" class="cj-next" aria-label="Next step">Next</button>
      </div>

      <!-- Connect button & fallback (final action area) -->
      <div class="mt-4 space-y-3">
        <!-- Keep id connectBtn so your existing JS handles the action -->
        <button id="connectBtn" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg">Connect Telegram</button>
        <div id="fallbackArea" class="hidden mt-2 text-center">
          <p class="text-sm text-gray-600 mb-2">If Telegram didn't open automatically, tap below:</p>
          <a id="manualLink" class="inline-block px-4 py-3 bg-white border rounded-xl text-sm font-medium" target="_blank" rel="noopener noreferrer">Open QueueJoyBot</a>
        </div>
        <button id="closeModalBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- small script to drive carousel (place with other scripts; this block depends only on element IDs above) -->
<script>
  (function(){
    const steps = Array.from(document.querySelectorAll('.cj-step'));
    const dots = Array.from(document.querySelectorAll('.cj-dot'));
    const prev = document.getElementById('cjPrev');
    const next = document.getElementById('cjNext');
    const fallbackArea = document.getElementById('fallbackArea');
    const manualLink = document.getElementById('manualLink');

    let idx = 0;
    function show(i){
      steps.forEach((s, j)=> {
        s.classList.toggle('active', j === i);
        s.setAttribute('aria-hidden', j===i? 'false':'true');
      });
      dots.forEach((d,j)=> d.classList.toggle('active', j===i));
      // update Next button text on last step
      next.textContent = i === steps.length -1 ? 'Connect & Open' : 'Next';
    }
    show(idx);

    prev.addEventListener('click', ()=> { idx = Math.max(0, idx-1); show(idx); });
    next.addEventListener('click', ()=> {
      if (idx < steps.length -1) { idx++; show(idx); }
      else {
        // final step: focus primary connect button so user can tap (or auto-scroll)
        document.getElementById('connectBtn').focus();
      }
    });

    // support dots click
    dots.forEach((d, j)=> d.addEventListener('click', ()=> { idx = j; show(idx); }));

    // swipe support (pointer)
    let startX = null;
    const wrap = document.getElementById('cjStepsWrap');
    wrap.addEventListener('pointerdown', (e)=> { startX = e.clientX; });
    wrap.addEventListener('pointerup', (e)=> {
      if (startX === null) return;
      const dx = e.clientX - startX;
      if (dx < -40) { idx = Math.min(steps.length-1, idx+1); show(idx); }
      if (dx > 40) { idx = Math.max(0, idx-1); show(idx); }
      startX = null;
    });

    // When connectBtn is clicked, build preferred link if lastTokenGenerated exists (your existing logic sets lastTokenGenerated)
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.addEventListener('click', ()=> {
      // hide fallback by default, will be shown by existing popup-block logic
      if (typeof handleConnectClick === 'function') {
        handleConnectClick();
      } else {
        // fallback if your script isn't loaded yet
        alert('Connecting... (handler missing)');
      }
      // set manualLink href if token exists (lastTokenGenerated is set by your existing code)
      try {
        if (window.lastTokenGenerated) {
          const link = `https://t.me/QueueJoyBot?start=${encodeURIComponent(window.lastTokenGenerated)}`;
          manualLink.href = link;
        }
      } catch(e){}
    });

    // Keep fallbackArea hidden initially; your existing popup-block detection will reveal it if needed.
    fallbackArea.classList.add('hidden');
  })();
</script>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content max-w-sm">
      <div class="text-center py-6 px-4">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
        <h3 id="confirmTitle" class="text-xl font-bold text-gray-900 mb-2">Connected Successfully!</h3>
        <p class="text-gray-600 mb-3">Hey üëã</p>
        <div class="text-sm bg-gray-50 rounded-lg p-4 mb-4 space-y-1">
          <p class="text-gray-700">üßæ Number: <strong id="confirmNumber">--</strong></p>
          <p class="text-gray-700">ü™ë Counter: <strong id="confirmCounter">--</strong></p>
        </div>
        <p class="text-sm text-gray-600">You can close this page now. We'll message you on Telegram when it's your turn.</p>
      </div>
    </div>
  </div>

  <!-- Firebase + Client JS -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ENDPOINTS (Netlify functions - do NOT change these functions)
    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const SEND_TELEGRAM_ENDPOINT = '/.netlify/functions/sendTelegram';

    // Force connect to this bot username (overrides server-provided link)
    const PREFERRED_BOT_USERNAME = 'QueueJoyBot'; // <- hard-coded to ensure correct bot

    // DOM references
    const yourNumber = document.getElementById('yourNumber');
    const counterNameEl = document.getElementById('counterName');
    const nowServingEl = document.getElementById('nowServing');
    const peopleAheadEl = document.getElementById('peopleAhead');
    const estimatedWaitEl = document.getElementById('estimatedWait');
    const statusIndicator = document.getElementById('statusIndicator');
    const telegramStatus = document.getElementById('telegramStatus');
    const telegramIcon = document.getElementById('telegramIcon');
    const connectionBanner = document.getElementById('connectionBanner');
    const connectionBannerText = document.getElementById('connectionBannerText');
    const adPanel = document.getElementById('adPanel');
    const noAd = document.getElementById('noAd');
    const connectModal = document.getElementById('connectModal');
    const confirmModal = document.getElementById('confirmModal');
    const connectTopBtn = document.getElementById('connectTopBtn');
    const connectBtn = document.getElementById('connectBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const gameBtn = document.getElementById('gameBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const confirmNumber = document.getElementById('confirmNumber');
    const confirmCounter = document.getElementById('confirmCounter');
    const fallbackArea = document.getElementById('fallbackArea');
    const manualLink = document.getElementById('manualLink');

    // Your Firebase config ‚Äî keep as before
    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // State
    let queueData = null;
    let avgServiceTime = 2;
    let isGeneratingLink = false;
    let connectLink = null;
    let prevTelegramConnected = false;
    let lastTokenGenerated = null;

    // Read queueId from URL
    const params = new URLSearchParams(window.location.search);
    const queueKey = params.get('queueId');

    if (!queueKey) {
      alert('Queue ID missing. Please scan the QR code again.');
      window.location.href = '/';
    }

    // Update UI for connection
    function updateConnectionUI(connected) {
      if (connected) {
        telegramStatus.textContent = 'Connected to Telegram';
        telegramStatus.className = 'text-base font-semibold text-green-700';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-green-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-green-50 border-green-200';
        connectionBannerText.textContent = '‚úÖ Connected! You can leave this page. We\'ll notify you on Telegram when it\'s your turn.';
        connectionBannerText.className = 'text-sm text-center text-green-700';
      } else {
        telegramStatus.textContent = 'Not connected';
        telegramStatus.className = 'text-base font-semibold text-gray-800';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-gray-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-yellow-50 border-yellow-200';
        connectionBannerText.textContent = '‚ö†Ô∏è Not connected. Tap Connect to receive notifications.';
        connectionBannerText.className = 'text-sm text-center text-yellow-700';
      }
    }

    // Generate token & link from server, but build final link using preferred bot username
    async function generateConnectToken() {
      if (!queueKey) throw new Error('Missing queueKey');

      // ensure human readable number known when possible
      let queueNumber = yourNumber.textContent && yourNumber.textContent !== '--' ? yourNumber.textContent : null;

      const payload = {
        queueKey: queueKey || null,
        queueNumber: queueNumber || null,
        counterId: queueData?.counterId || null
      };

      const res = await fetch(CREATE_LINK_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text().catch(()=>null);
        throw new Error('Link creation failed: ' + (text || res.status));
      }

      // server should return { link, token, preview } ‚Äî we need token
      const json = await res.json();
      const token = json?.token || null;

      if (!token) {
        // If server didn't return token but returned link, try to parse token from the returned link as fallback.
        if (json?.link) {
          try {
            const u = new URL(json.link);
            const start = u.searchParams.get('start');
            if (start) return { token: start, rawServerLink: json.link };
          } catch(e){}
        }
        throw new Error('No token returned from createTelegramLink');
      }

      return { token, rawServerLink: json.link || null };
    }

    // Build deep link to preferred bot using token
    function buildPreferredBotLink(token) {
      // token should be URL-safe already; ensure encodeURIComponent just in case
      return `https://t.me/${PREFERRED_BOT_USERNAME}?start=${encodeURIComponent(token)}`;
    }

    // Show fallback UI when popup blocked
    function showFallbackLink(link) {
      manualLink.href = link;
      manualLink.textContent = `Open ${PREFERRED_BOT_USERNAME} in Telegram`;
      fallbackArea.classList.remove('hidden');
    }

    // Hide fallback UI
    function hideFallbackLink() {
      fallbackArea.classList.add('hidden');
      manualLink.href = '#';
      manualLink.textContent = 'Open Telegram';
    }

    // Handle connect click (user gesture)
    async function handleConnectClick() {
      if (isGeneratingLink) return;
      isGeneratingLink = true;
      connectBtn.setAttribute('aria-busy', 'true');
      connectBtn.disabled = true;
      loadingIndicator.classList.remove('hidden');
      hideFallbackLink();

      try {
        const { token, rawServerLink } = await generateConnectToken();
        lastTokenGenerated = token;
        const preferredLink = buildPreferredBotLink(token);

        // Try to open preferred bot link (QueueJoyBot)
        const newWin = window.open(preferredLink, '_blank', 'noopener,noreferrer');

        // If blocked OR null returned, show fallback UI with manual link
        if (!newWin) {
          // Popup blocked or failed ‚Äî show clear manual link inside modal (tappable)
          showFallbackLink(preferredLink);
          // Also fallback to server link (if server returned raw link pointing to other bot) only for diagnostics ‚Äî but prefer preferredLink
          console.warn('Popup blocked. Preferred link shown in fallback UI.', { preferredLink, rawServerLink });
        } else {
          try { newWin.focus(); } catch(e){}
        }
      } catch (err) {
        console.error('generateConnectToken error', err);
        // show helpful message to the user
        alert('Failed to create Telegram connection link. Please try again.');
      } finally {
        isGeneratingLink = false;
        connectBtn.removeAttribute('aria-busy');
        connectBtn.disabled = false;
        loadingIndicator.classList.add('hidden');
      }
    }

    // Event listeners
    connectTopBtn.addEventListener('click', () => {
      connectModal.classList.add('show');
      setTimeout(()=>connectBtn.focus(), 200);
    });
    connectBtn.addEventListener('click', handleConnectClick);
    closeModalBtn.addEventListener('click', () => connectModal.classList.remove('show'));
    connectModal.addEventListener('click', (e) => { if (e.target === connectModal) connectModal.classList.remove('show'); });
    gameBtn.addEventListener('click', ()=>{ window.location.href = 'https://queuejoy.netlify.app/game.html'; });

    // Show connect modal on load but DO NOT auto-open Telegram
    setTimeout(()=>{ connectModal.classList.add('show'); }, 450);

    // Listen to queue data
    const queueRef = ref(db, `queue/${queueKey}`);
    onValue(queueRef, async (snap) => {
      if (!snap.exists()) {
        alert('Queue entry not found.');
        return;
      }

      const data = snap.val();
      const wasConnected = prevTelegramConnected;
      prevTelegramConnected = !!data.telegramConnected;

      queueData = data;
      yourNumber.textContent = data.queueId || '--';
      updateConnectionUI(!!data.telegramConnected);

      // Show confirmation when newly connected
      if (data.telegramConnected && !wasConnected) {
        const prefix = String(data.queueId || '').match(/^[A-Za-z]*/)?.[0] || '';
        const numberOnly = String(data.queueId || '').replace(prefix, '') || '';
        confirmNumber.textContent = `${prefix}${numberOnly}`;
        confirmCounter.textContent = data.counterId || 'TBD';
        connectModal.classList.remove('show');
        confirmModal.classList.add('show');
        setTimeout(()=>confirmModal.classList.remove('show'), 3000);
      }

      // Listen to counter
      if (data.counterId) {
        const counterRef = ref(db, `counters/${data.counterId}`);
        onValue(counterRef, async (counterSnap) => {
          if (!counterSnap.exists()) return;

          const counterData = counterSnap.val();
          counterNameEl.textContent = counterData.name || data.counterId;

          // avg service time
          let avgTime = Number(counterData.avgServiceTime) || null;
          if (!avgTime) {
            try {
              const settingsSnap = await get(ref(db, 'settings/avgServiceTime'));
              avgTime = settingsSnap.exists() ? Number(settingsSnap.val()) || 2 : 2;
            } catch (e) {
              avgTime = 2;
            }
          }
          avgServiceTime = avgTime;

          // Listen to now serving
          const servingRef = ref(db, `counters/${data.counterId}/nowServing`);
          onValue(servingRef, (nowSnap) => {
            const currentServing = Number(nowSnap.val() || 0);
            const prefix = counterData.prefix || String(data.queueId || '').match(/^[A-Za-z]+/)?.[0] || "";
            nowServingEl.textContent = `${prefix}${String(currentServing).padStart(3, '0')}`;

            const yourNumericValue = data.queueId ? parseInt(String(data.queueId).replace(prefix, ''), 10) : NaN;
            const ahead = Number.isFinite(yourNumericValue) ? Math.max(0, yourNumericValue - currentServing) : 0;
            peopleAheadEl.textContent = String(ahead);

            if (ahead === 0) {
              estimatedWaitEl.textContent = "Your turn!";
              statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse';

              // Notify via server/sendTelegram endpoint (best-effort)
              try {
                const notifyBody = data.chatId ? { chatId: data.chatId, message: `üéü It's now your turn!\nQueue: ${queueKey}` } : { message: `üéü It's now the customer's turn!\nQueue: ${queueKey}` };
                fetch(SEND_TELEGRAM_ENDPOINT, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(notifyBody)
                }).catch(()=>{});
              } catch(e){}

              // redirect to your_turn page
              setTimeout(()=>{ try { window.location.href = `/your_turn.html?queueId=${encodeURIComponent(queueKey)}` } catch(e){} }, 1200);
            } else {
              statusIndicator.className = 'w-3 h-3 bg-blue-500 rounded-full';
              const estimatedMinutes = Math.round(ahead * avgServiceTime);
              estimatedWaitEl.textContent = `~${estimatedMinutes} min`;
            }
          });
        });
      }
    });

    // Ad listener
    const adRef = ref(db, "settings/adImage");
    onValue(adRef, (snap)=>{
      const adUrl = snap.val();
      if (adUrl) { adPanel.src = adUrl; adPanel.classList.remove('hidden'); noAd.classList.add('hidden'); }
      else { adPanel.classList.add('hidden'); noAd.classList.remove('hidden'); }
    });

    // Cleanup
    window.addEventListener('beforeunload', ()=>{ off(queueRef); off(adRef); });

  </script>
</body>
</html>
