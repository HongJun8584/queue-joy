<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QueueJoy ‚Äî Status</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --p1:#8b5cf6; --p2:#a78bfa; --bg1:#f6f5ff;
    }
    body {
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background: linear-gradient(135deg,var(--bg1),#f3f0ff);
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:20px;
    }
    .card {
      width:100%; max-width:820px; border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,248,255,0.98));
      box-shadow:0 30px 80px rgba(99,102,241,0.09);
      padding:26px; position:relative; overflow:hidden;
    }
    .brand-blob {
      width:88px;height:88px;border-radius:18px;
      background:linear-gradient(135deg,var(--p1),var(--p2));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:800;
      box-shadow:0 18px 50px rgba(139,92,246,0.18);
      transform:translateY(-6px);
      overflow:hidden;
    }
    .brand-blob img {
      width:100%; height:100%; object-fit:cover;
    }
    .muted { color:#6b7280 }
    .progress-track { height:18px;border-radius:999px;background:#f1f1f5;position:relative;overflow:hidden }
    .progress-fill { height:100%; background:linear-gradient(90deg,var(--p1),var(--p2)); display:flex;align-items:center; padding-right:12px; justify-content:flex-end; color:white; font-weight:800; transition:width .6s cubic-bezier(.2,.9,.2,1) }

    .glass { background:rgba(247,245,255,0.7); border-radius:12px;padding:14px;border:1px solid rgba(139,92,246,0.04) }

    .circle-btn { width:44px;height:44px;border-radius:999px;background:white;display:inline-flex;align-items:center;justify-content:center;border:none;box-shadow:0 10px 30px rgba(2,6,23,0.06);cursor:pointer }
    .btn-gradient { background:linear-gradient(135deg,var(--p1),var(--p2)); color:white; padding:.85rem 1.4rem; border-radius:12px; font-weight:700; border:none; box-shadow:0 10px 30px rgba(139,92,246,0.24); cursor:pointer }
    .btn-outline { border:1px solid rgba(99,102,241,0.12); padding:.7rem 1.1rem; border-radius:10px; background:white; font-weight:700; cursor:pointer }

    .onboarding-modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:60; padding:16px; backdrop-filter:blur(4px) }
    .onboarding-card { width:100%; max-width:460px; background:white; border-radius:16px; padding:20px; box-shadow:0 30px 90px rgba(2,6,23,0.4); overflow:hidden }
    .slide { display:none; animation:slideIn .32s ease both; min-height:320px }
    .slide.active { display:flex; flex-direction:column; justify-content:space-between }
    @keyframes slideIn { from { opacity:0; transform:translateY(18px) } to { opacity:1; transform:translateY(0) } }
    .step-dot { width:8px;height:8px;border-radius:50%;background:#e6e7f8; transition:all .25s }
    .step-dot.active { width:28px;border-radius:6px;background:linear-gradient(135deg,var(--p1),var(--p2)); }

    .spinner { width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.3); border-top-color:white; animation:spin .8s linear infinite; display:inline-block; margin-right:8px }
    @keyframes spin { to { transform:rotate(360deg) } }

    .ad-panel { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:100%; max-width:420px; background:white; border-radius:12px; box-shadow:0 22px 60px rgba(2,6,23,0.06); padding:10px; z-index:40 }
    .ad-media { width:100%; height:96px; object-fit:cover; border-radius:8px }

    @media (max-width:640px) {
      .brand-blob { width:68px;height:68px }
      .card { padding:18px }
      body { padding:10px }
      .btn-gradient { padding:.75rem 1rem; font-size:14px }
      .btn-outline { padding:.6rem .9rem; font-size:14px }
      .ad-panel { max-width:calc(100% - 20px); bottom:10px }
    }
  </style>
</head>
<body>

  <div id="onboardingModal" class="onboarding-modal" style="display:none" aria-hidden="false">
    <div class="onboarding-card" role="dialog" aria-modal="true">
      <div class="slide active" data-slide="0">
        <div style="text-align:center">
          <div style="width:120px;height:120px;margin:0 auto;border-radius:18px;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;font-size:36px;color:white;box-shadow:0 12px 40px rgba(139,92,246,0.18)">‚úâÔ∏è</div>
          <h3 style="margin-top:18px;font-size:20px;font-weight:800;color:#111827">Connect Telegram</h3>
          <p style="color:#6b7280;margin-top:8px">Get notified on Telegram ‚Äî you won't need this page open. Use the Telegram app on your phone to receive push notifications.</p>
        </div>

        <div>
          <div style="display:flex;gap:8px;justify-content:center;margin:14px 0">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
          </div>
          <button id="obNext" class="btn-gradient" style="width:100%">Next</button>
          <button id="obSkip" class="btn-outline" style="width:100%;margin-top:10px">Skip</button>
        </div>
      </div>

      <div class="slide" data-slide="1">
        <div style="text-align:center">
          <div style="width:120px;height:120px;margin:0 auto;border-radius:18px;background:linear-gradient(135deg,var(--p2),var(--p1));display:flex;align-items:center;justify-content:center;font-size:36px;color:white;box-shadow:0 12px 40px rgba(139,92,246,0.18)">‚ñ∂Ô∏è</div>
          <h3 style="margin-top:18px;font-size:20px;font-weight:800;color:#111827">Hit "Start"</h3>
          <p style="color:#6b7280;margin-top:8px">Tap Start on the Telegram page to complete setup. We'll then be able to notify you automatically.</p>
        </div>

        <div>
          <div style="display:flex;gap:8px;justify-content:center;margin:14px 0">
            <div class="step-dot"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
          </div>
          <button id="obNext2" class="btn-gradient" style="width:100%">Next</button>
          <button id="obBack1" class="btn-outline" style="width:100%;margin-top:10px">Back</button>
        </div>
      </div>

      <div class="slide" data-slide="2">
        <div style="text-align:center">
          <div style="width:120px;height:120px;margin:0 auto;border-radius:18px;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;font-size:36px;color:white;box-shadow:0 12px 40px rgba(139,92,246,0.18)">‚úÖ</div>
          <h3 style="margin-top:18px;font-size:20px;font-weight:800;color:#111827">All Set</h3>
          <p id="obStatusText" style="color:#6b7280;margin-top:8px">Preparing connection‚Ä¶</p>
        </div>

        <div>
          <div style="display:flex;gap:8px;justify-content:center;margin:14px 0">
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot active"></div>
          </div>
          <button id="obFinish" class="btn-gradient" style="width:100%"><span id="obFinishText">Connect via Telegram</span></button>
          <button id="obBack2" class="btn-outline" style="width:100%;margin-top:10px">Back</button>
        </div>
      </div>
    </div>
  </div>

  <main class="card" role="main" aria-live="polite">
    <div style="position:absolute;right:18px;top:18px;display:flex;gap:8px">
      <button id="miniGame" class="circle-btn" title="Game">üéÆ</button>
      <button id="miniConnect" class="circle-btn" title="Connect">‚úâÔ∏è</button>
    </div>

    <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:center">
      <div class="brand-blob" id="brandLogo">QJ</div>
      <div style="text-align:center">
        <h1 style="font-size:20px;margin:0;font-weight:900;color:#111827">You are now in line</h1>
        <p class="muted" style="margin-top:6px;max-width:640px">We'll keep you updated. Connect Telegram to receive push notifications when it's your turn.</p>
      </div>
    </div>

    <div style="margin-top:20px">
      <div class="progress-track" aria-hidden="true">
        <div id="progressFill" class="progress-fill" style="width:6%">
          <div id="progressLabel" style="font-size:12px;margin-left:auto;margin-right:6px">6%</div>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px">
      <div class="glass">
        <div class="muted">Your Number</div>
        <div id="yourNumber" style="font-weight:900;font-size:34px;color:var(--p1);margin-top:6px">‚Äî</div>
      </div>
      <div class="glass">
        <div class="muted">Now Serving</div>
        <div id="nowServing" style="font-weight:900;font-size:34px;color:#111827;margin-top:6px">‚Äî</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px">
      <div class="glass">
        <div class="muted">People Ahead</div>
        <div id="peopleAhead" style="font-weight:800;font-size:20px;margin-top:8px">‚Äî</div>
      </div>
      <div class="glass">
        <div class="muted">Estimated Wait</div>
        <div id="estimatedWait" style="font-weight:800;font-size:20px;color:var(--p1);margin-top:8px">‚Äî</div>
      </div>
    </div>

    <div id="connectionBanner" class="glass" style="display:flex;align-items:center;gap:12px;margin-top:16px">
      <div style="width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;color:white">üîî</div>
      <div style="flex:1">
        <div id="connectionBannerText" style="font-weight:800">Checking notification status...</div>
        <div id="connectionBannerSub" style="color:#6b7280;font-size:13px">Connect Telegram to receive notifications even with this page closed.</div>
      </div>
      <div style="min-width:140px">
        <button id="connectMain" class="btn-gradient">Connect via Telegram</button>
      </div>
    </div>

    <div id="error" style="display:none;margin-top:12px;padding:10px;border-radius:10px;background:#fff5f5;border:1px solid #fde2e2;color:#b91c1c;font-weight:700;text-align:center"></div>
  </main>

  <div id="adPanel" class="ad-panel" style="display:none">
    <div style="font-size:12px;color:#9ca3af;text-align:center;margin-bottom:6px">Advertisement</div>
    <div id="adContainer"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const MARK_TOKEN_USED = '/.netlify/functions/markTokenUsed';
    const TELEGRAM_BOT_URL = 'https://t.me/QueueJoyBot';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const obModal = document.getElementById('onboardingModal');
    const slides = Array.from(document.querySelectorAll('.slide'));
    const stepDots = Array.from(document.querySelectorAll('.step-dot'));
    const obNext = document.getElementById('obNext');
    const obNext2 = document.getElementById('obNext2');
    const obBack1 = document.getElementById('obBack1');
    const obBack2 = document.getElementById('obBack2');
    const obSkip = document.getElementById('obSkip');
    const obFinish = document.getElementById('obFinish');
    const obFinishText = document.getElementById('obFinishText');
    const obStatusText = document.getElementById('obStatusText');

    const yourNumberEl = document.getElementById('yourNumber');
    const nowServingEl = document.getElementById('nowServing');
    const peopleAheadEl = document.getElementById('peopleAhead');
    const estimatedWaitEl = document.getElementById('estimatedWait');
    const progressFill = document.getElementById('progressFill');
    const progressLabel = document.getElementById('progressLabel');
    const connectMainBtn = document.getElementById('connectMain');
    const connectMiniBtn = document.getElementById('miniConnect');
    const connectionBannerText = document.getElementById('connectionBannerText');
    const connectionBannerSub = document.getElementById('connectionBannerSub');
    const adPanel = document.getElementById('adPanel');
    const adContainer = document.getElementById('adContainer');
    const errorBox = document.getElementById('error');
    const brandLogo = document.getElementById('brandLogo');

    let slideIndex = 0;
    function showSlide(i){
      slides.forEach(s => s.classList.remove('active'));
      stepDots.forEach(d => d.classList.remove('active'));
      slideIndex = i;
      const sl = slides[i];
      if(sl) sl.classList.add('active');
      if(stepDots[i]) stepDots[i].classList.add('active');
      if(i === 2) triggerGenerateLink();
    }

    obNext.addEventListener('click', ()=> showSlide(1));
    obNext2.addEventListener('click', ()=> showSlide(2));
    obBack1.addEventListener('click', ()=> showSlide(0));
    obBack2.addEventListener('click', ()=> showSlide(1));
    obSkip.addEventListener('click', ()=> obModal.style.display = 'none');

    obModal.addEventListener('click', (e)=>{
      if(e.target === obModal) obModal.style.display = 'none';
    });

    let currentQueueKey = null;
    let currentQueueData = null;
    let currentCounterId = null;
    let latestConnectLink = null;
    let linkGenerating = false;
    let redirecting = false;
    let qRef = null, allQueueRef = null, adRef = null, counterRef = null, settingsRef = null;

    function showError(msg){
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
      setTimeout(()=> errorBox.style.display = 'none', 6000);
    }

    function setTelegramConnectedUI(connected){
      if(connected){
        connectionBannerText.textContent = "Connected ‚Äî you'll get Telegram notifications";
        connectionBannerSub.textContent = "You can close this page; Telegram will notify you when it's your turn.";
        connectMainBtn.textContent = "Connected";
        connectMainBtn.disabled = true;
      } else {
        connectionBannerText.textContent = "Not connected ‚Äî get Telegram notifications";
        connectionBannerSub.textContent = "Connect to receive notifications even when this page is closed.";
        connectMainBtn.textContent = "Connect via Telegram";
        connectMainBtn.disabled = false;
      }
    }

    async function generateConnectLink(){
      if(!currentQueueKey) throw new Error('missing queueKey');
      const res = await fetch(CREATE_LINK_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ queueKey: currentQueueKey })
      });
      if(!res.ok) {
        const t = await res.text().catch(()=>'');
        throw new Error('create link failed ' + res.status + ' ' + t);
      }
      const j = await res.json();
      if(!j.link) throw new Error('no link returned');
      return j.link;
    }

    async function triggerGenerateLink(){
      if(linkGenerating) return;
      linkGenerating = true;
      obStatusText.textContent = 'Generating secure link...';
      obFinishText.innerText = 'Connect via Telegram';
      latestConnectLink = null;
      try{
        const link = await generateConnectLink();
        latestConnectLink = link;
        obStatusText.textContent = 'Ready to connect! Tap the button below.';
      }catch(e){
        latestConnectLink = TELEGRAM_BOT_URL;
        obStatusText.textContent = 'Couldn't generate secure link ‚Äî using direct bot link.';
      } finally {
        linkGenerating = false;
      }
    }

    async function openConnectLink(){
      if(!latestConnectLink && !linkGenerating){
        linkGenerating = true;
        try{ latestConnectLink = await generateConnectLink(); } catch(e){ latestConnectLink = TELEGRAM_BOT_URL; } finally { linkGenerating = false; }
      }
      const win = window.open(latestConnectLink || TELEGRAM_BOT_URL, '_blank', 'noopener,noreferrer');
      try{
        const token = (latestConnectLink && latestConnectLink.split('start=')[1]) || null;
        if(token && currentQueueKey){
          await fetch(MARK_TOKEN_USED, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ queueKey: currentQueueKey, token })
          });
        }
      }catch(e){}
    }

    obFinish.addEventListener('click', async () => {
      obFinish.disabled = true;
      obFinishText.innerHTML = '<span class="spinner"></span>Opening‚Ä¶';
      try{
        await openConnectLink();
        obFinishText.innerHTML = 'Opened';
        setTimeout(()=> obModal.style.display = 'none', 650);
      }catch(e){
        obFinishText.innerHTML = 'Connect via Telegram';
        showError('Unable to open Telegram.');
      } finally { obFinish.disabled = false; }
    });

    connectMainBtn.addEventListener('click', ()=> { obModal.style.display = 'flex'; showSlide(0); });
    connectMiniBtn.addEventListener('click', ()=> { obModal.style.display = 'flex'; showSlide(0); });
    document.getElementById('miniGame').addEventListener('click', ()=> window.location.href = 'https://queuejoy.netlify.app/game.html');

    function clearAd(){ adContainer.innerHTML=''; adPanel.style.display='none'; }
    function showAdFromUrl(url){
      clearAd();
      if(!url) return;
      const trimmed = String(url).trim();
      const isVideo = /\.(mp4|webm|ogg)(\?.*)?$/i.test(trimmed) || trimmed.startsWith('data:video/');
      adPanel.style.display = 'block';
      if(isVideo){
        const v = document.createElement('video');
        v.src = trimmed; v.autoplay = true; v.muted = true; v.loop = true; v.playsInline = true;
        v.className = 'ad-media';
        v.setAttribute('playsinline', ''); v.setAttribute('muted','');
        adContainer.appendChild(v);
        v.play().catch(()=> v.setAttribute('controls',''));
      } else {
        const img = document.createElement('img');
        img.src = trimmed; img.className = 'ad-media'; img.alt = 'Ad';
        img.onerror = ()=> clearAd();
        adContainer.appendChild(img);
      }
    }

    function extractNumberFromQueueId(qid){
      if(!qid) return null;
      const m = String(qid).match(/(\d+)$/);
      return m ? parseInt(m[1], 10) : null;
    }

    function updateProgress(ahead, total){
      if(total <= 0 || ahead < 0){
        progressFill.style.width = '100%';
        progressLabel.textContent = 'Almost';
        return;
      }
      const percent = Math.max(4, Math.min(100, Math.round(((total - ahead) / total) * 100)));
      progressFill.style.width = percent + '%';
      progressLabel.textContent = percent >= 95 ? 'Almost' : percent + '%';
    }

    function formatMinutes(m){
      const mm = Math.max(0, Math.round(m));
      if(mm === 0) return 'Less than a minute';
      if(mm < 60) return `${mm} min${mm>1?'s':''}`;
      const hrs = Math.floor(mm/60), rem = mm%60;
      return rem === 0 ? `${hrs} hr${hrs>1?'s':''}` : `${hrs} hr ${rem} min`;
    }

    async function computePeopleAheadAndEstimate(){
      try{
        if(!currentQueueData) return;

        const myNumber = extractNumberFromQueueId(currentQueueData.queueId);
        if(myNumber === null){
          peopleAheadEl.textContent = '0';
          estimatedWaitEl.textContent = 'Less than a minute';
          updateProgress(0, 1);
          return;
        }

        const counterSnap = currentCounterId ? await get(ref(db, `counters/${currentCounterId}`)) : null;
        const counterData = counterSnap && counterSnap.exists() ? counterSnap.val() : null;

        let nowServingNumber = null;
        if(counterData && counterData.nowServing !== undefined && counterData.nowServing !== null){
          nowServingNumber = Number(counterData.nowServing);
        }

        const allSnap = await get(ref(db, 'queue'));
        let totalInQueue = 0;
        let ahead = 0;

        if(allSnap.exists()){
          const all = allSnap.val();
          for(const k in all){
            if(!Object.prototype.hasOwnProperty.call(all,k)) continue;
            const t = all[k];
            if(!t || t.status !== 'waiting') continue;

            if(currentCounterId && String(t.counterId) !== String(currentCounterId)) continue;

            const tNum = extractNumberFromQueueId(t.queueId);
            if(tNum !== null){
              totalInQueue++;
              if(tNum < myNumber) ahead++;
            }
          }
        }

        if(Number.isFinite(nowServingNumber) && nowServingNumber < myNumber){
          const calculatedAhead = myNumber - nowServingNumber - 1;
          ahead = Math.max(0, calculatedAhead);
        }

        peopleAheadEl.textContent = String(ahead);

        const settingsSnap = await get(ref(db, 'settings/avgServiceTime'));
        let avgServiceTime = 3;
        if(settingsSnap && settingsSnap.exists()){
          const val = Number(settingsSnap.val());
          if(Number.isFinite(val) && val > 0) avgServiceTime = val;
        } else if(counterData && Number.isFinite(Number(counterData.avgServiceTime)) && Number(counterData.avgServiceTime) > 0){
          avgServiceTime = Number(counterData.avgServiceTime);
        }

        const estMinutes = Math.round(ahead * avgServiceTime);
        estimatedWaitEl.textContent = (ahead === 0) ? 'Now' : `${formatMinutes(estMinutes)}`;

        updateProgress(ahead, totalInQueue || (ahead + 1));

      }catch(e){
        console.warn('compute estimate err', e);
      }
    }

    function detectAndRedirectIfCalled(counterData){
      if(!currentQueueData || redirecting) return;
      try{
        const myNumber = extractNumberFromQueueId(currentQueueData.queueId);
        if(myNumber === null) return;

        const nowServingNumber = (counterData && (counterData.nowServing !== undefined && counterData.nowServing !== null)) ? Number(counterData.nowServing) : null;

        if(Number.isFinite(nowServingNumber) && nowServingNumber === myNumber){
          redirecting = true;
          connectionBannerText.textContent = "It's your turn ‚Äî redirecting...";
          setTimeout(()=> {
            window.location.href = `your_turn.html?queueId=${encodeURIComponent(currentQueueData.queueId)}`;
          }, 600);
        }

        const status = (currentQueueData && currentQueueData.status) ? String(currentQueueData.status) : '';
        if(status === 'serving' || status === 'called'){
          redirecting = true;
          connectionBannerText.textContent = "It's your turn ‚Äî redirecting...";
          setTimeout(()=> {
            window.location.href = `your_turn.html?queueId=${encodeURIComponent(currentQueueData.queueId)}`;
          }, 600);
        }
      }catch(e){ console.warn('redirect detect error', e); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      obModal.style.display = 'flex';
      showSlide(0);

      settingsRef = ref(db, 'settings');
      onValue(settingsRef, (snap) => {
        if(snap.exists()){
          const settings = snap.val();
          if(settings.logoUrl){
            brandLogo.innerHTML = `<img src="${settings.logoUrl}" alt="Logo" />`;
          }
          if(settings.adImage){
            showAdFromUrl(settings.adImage);
          } else {
            clearAd();
          }
        }
      });

      const params = new URLSearchParams(window.location.search);
      const queueKey = params.get('queueId');
      if(!queueKey){
        showError('Queue ID missing ‚Äî returning...');
        setTimeout(()=> window.location.href = 'index.html', 1100);
        return;
      }
      currentQueueKey = queueKey;
      qRef = ref(db, `queue/${queueKey}`);

      onValue(qRef, async (snap) => {
        if(!snap.exists()){
          showError('Queue entry not found ‚Äî returning');
          setTimeout(()=> window.location.href = 'index.html', 1200);
          return;
        }
        currentQueueData = snap.val();
        yourNumberEl.textContent = currentQueueData.queueId || '--';

        setTelegramConnectedUI(!!currentQueueData.telegramConnected);

        const counterId = currentQueueData.counterId || null;
        if(counterId && counterId !== currentCounterId){
          if(counterRef) try{ off(counterRef); }catch(e){}
          currentCounterId = counterId;
          counterRef = ref(db, `counters/${counterId}`);
          onValue(counterRef, (cSnap) => {
            if(!cSnap.exists()) return;
            const cData = cSnap.val();

            const nowServingNumber = (cData && (cData.nowServing !== undefined && cData.nowServing !== null)) ? Number(cData.nowServing) : null;
            if(Number.isFinite(nowServingNumber)){
              nowServingEl.textContent = String(nowServingNumber);
            } else {
              nowServingEl.textContent = '--';
            }

            detectAndRedirectIfCalled(cData);
            computePeopleAheadAndEstimate();
          });
        } else if(!counterId){
          nowServingEl.textContent = '--';
        }

        computePeopleAheadAndEstimate();
      });

      allQueueRef = ref(db, 'queue');
      onValue(allQueueRef, () => computePeopleAheadAndEstimate());

      window.addEventListener('beforeunload', () => {
        try { if(qRef) off(qRef); if(allQueueRef) off(allQueueRef); if(adRef) off(adRef); if(counterRef) off(counterRef); if(settingsRef) off(settingsRef); } catch(e){}
      });
    });

  </script>
</body>
</html>
