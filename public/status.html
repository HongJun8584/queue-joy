<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QueueJoy ‚Äî Your Status</title>
  <meta name="description" content="Track your queue position in real-time" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary-500:#8b5cf6;
      --primary-600:#7c3aed;
      --primary-700:#6d28d9;
      --bg-gradient-start:#f6f5ff;
      --bg-gradient-end:#f3f0ff;
      --card-shadow:rgba(99,102,241,0.16);
      --progress-shadow:rgba(129,140,248,0.45);
    }
    
    * { box-sizing:border-box; }
    
    body {
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--bg-gradient-start),var(--bg-gradient-end));
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:16px;
      color:#1f2937;
    }
    
    .page-wrapper{
      width:100%;
      max-width:900px;
      display:flex;
      justify-content:center;
    }
    
    .card {
      width:100%;
      max-width:840px;
      border-radius:24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,248,255,0.95));
      box-shadow:0 26px 80px var(--card-shadow);
      padding:28px 24px 24px;
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(20px);
    }
    
    @media (min-width:768px){
      .card{ padding:32px 32px 28px; border-radius:28px; }
    }

    .logo-container {
      width:84px;
      height:84px;
      border-radius:20px;
      background:linear-gradient(135deg,var(--primary-500),var(--primary-600));
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:900;
      box-shadow:0 20px 60px rgba(139,92,246,0.25);
      font-size:28px;
      transition:transform 0.3s ease;
      overflow:hidden;
    }
    
    .logo-container:hover {
      transform:translateY(-4px) scale(1.02);
    }
    
    .logo-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .progress-track {
      height:24px;
      border-radius:999px;
      background:linear-gradient(90deg, #f3f4f6, #e5e7eb);
      position:relative;
      overflow:hidden;
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.06);
    }
    
    .progress-fill {
      height:100%;
      background:linear-gradient(90deg,var(--primary-600),var(--primary-500));
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right:12px;
      color:white;
      font-weight:800;
      font-size:12px;
      letter-spacing:0.04em;
      transition:width 0.7s cubic-bezier(0.22,0.9,0.22,1);
      box-shadow:0 4px 20px var(--progress-shadow);
      position:relative;
    }
    
    .progress-fill::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation:shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform:translateX(-100%); }
      100% { transform:translateX(100%); }
    }

    .glass-card {
      background:linear-gradient(135deg, rgba(255,255,255,0.9), rgba(247,245,255,0.85));
      border-radius:16px;
      padding:16px 16px 14px;
      border:1px solid rgba(139,92,246,0.1);
      backdrop-filter:blur(20px);
      box-shadow:0 4px 16px rgba(0,0,0,0.04);
      transition:all 0.3s ease;
    }
    
    .glass-card:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(139,92,246,0.12);
    }
    
    @media (min-width:768px){
      .glass-card{ padding:18px 20px 16px; border-radius:18px; }
    }

    .circle-btn {
      width:44px;
      height:44px;
      border-radius:999px;
      background:white;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:none;
      box-shadow:0 4px 16px rgba(0,0,0,0.08);
      cursor:pointer;
      font-size:20px;
      transition:all 0.2s ease;
    }
    
    .circle-btn:hover {
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 8px 24px rgba(0,0,0,0.12);
      background:#fafafa;
    }
    
    .circle-btn:active {
      transform:translateY(0) scale(0.98);
    }

    .btn-primary {
      background:linear-gradient(135deg,var(--primary-600),var(--primary-500));
      color:white;
      padding:0.95rem 1.6rem;
      border-radius:14px;
      font-weight:700;
      border:none;
      box-shadow:0 8px 24px rgba(139,92,246,0.3);
      width:100%;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:15px;
      transition:all 0.2s ease;
      position:relative;
      overflow:hidden;
    }
    
    .btn-primary::before {
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s;
    }
    
    .btn-primary:hover::before {
      left:100%;
    }
    
    .btn-primary:hover {
      transform:translateY(-2px);
      box-shadow:0 12px 32px rgba(129,140,248,0.35);
    }
    
    .btn-primary:active {
      transform:translateY(0);
    }
    
    .btn-primary:disabled{
      opacity:0.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .btn-outline {
      border:2px solid rgba(139,92,246,0.25);
      padding:0.8rem 1.3rem;
      border-radius:12px;
      background:white;
      font-weight:600;
      width:100%;
      cursor:pointer;
      font-size:14px;
      color:#374151;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.2s ease;
    }
    
    .btn-outline:hover {
      background:#f9fafb;
      border-color:rgba(139,92,246,0.4);
      box-shadow:0 4px 16px rgba(0,0,0,0.06);
      transform:translateY(-1px);
    }

    .onboarding-modal {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:20px;
      backdrop-filter:blur(12px);
      animation:fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity:0; }
      to { opacity:1; }
    }
    
    .onboarding-card {
      width:100%;
      max-width:480px;
      background:white;
      border-radius:24px;
      padding:28px 24px 24px;
      box-shadow:0 30px 90px rgba(15,23,42,0.5);
      overflow:hidden;
      animation:slideUp 0.4s cubic-bezier(0.22,0.9,0.22,1);
    }
    
    @keyframes slideUp {
      from { opacity:0; transform:translateY(40px) scale(0.95); }
      to { opacity:1; transform:translateY(0) scale(1); }
    }
    
    @media (min-width:480px){
      .onboarding-card{ padding:32px 28px 28px; }
    }

    .slide {
      display:none;
      animation:slideIn 0.35s ease both;
      min-height:360px;
    }
    
    .slide.active {
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    
    @keyframes slideIn {
      from { opacity:0; transform:translateX(20px); }
      to { opacity:1; transform:translateX(0); }
    }

    .step-dots {
      display:flex;
      gap:10px;
      justify-content:center;
      margin:18px 0;
    }
    
    .step-dot {
      width:10px;
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
      transition:all 0.3s ease;
    }
    
    .step-dot.active {
      width:32px;
      background:linear-gradient(135deg,var(--primary-600),var(--primary-500));
      box-shadow:0 4px 12px rgba(129,140,248,0.4);
    }

    .spinner {
      width:16px;
      height:16px;
      border-radius:50%;
      border:3px solid rgba(255,255,255,0.3);
      border-top-color:white;
      animation:spin 0.8s linear infinite;
      display:inline-block;
    }
    
    @keyframes spin { 
      to { transform:rotate(360deg); } 
    }

    .ad-panel {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      width:calc(100% - 32px);
      max-width:440px;
      background:white;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(15,23,42,0.2);
      padding:12px;
      z-index:100;
      animation:slideUpAd 0.5s ease;
    }
    
    @keyframes slideUpAd {
      from { opacity:0; transform:translate(-50%, 20px); }
      to { opacity:1; transform:translate(-50%, 0); }
    }
    
    .ad-media {
      width:100%;
      height:120px;
      object-fit:cover;
      border-radius:12px;
    }

    .pulse {
      animation:pulseAnim 2s ease-in-out infinite;
    }
    
    @keyframes pulseAnim {
      0%, 100% { transform:scale(1); opacity:1; }
      50% { transform:scale(1.05); opacity:0.9; }
    }

    .stat-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.1em;
      color:#6b7280;
      font-weight:600;
    }
    
    .stat-value {
      font-weight:900;
      font-size:36px;
      margin-top:6px;
      line-height:1;
    }
    
    .stat-value-small {
      font-weight:800;
      font-size:24px;
      margin-top:6px;
      line-height:1.2;
    }

    @media (max-width:640px) {
      body { padding:12px; }
      .card { padding:20px 16px 16px; border-radius:20px; }
      .logo-container { width:72px; height:72px; font-size:24px; }
      .stat-value { font-size:32px; }
      .stat-value-small { font-size:20px; }
    }
    
    .error-banner {
      margin-top:16px;
      padding:14px 16px;
      border-radius:12px;
      background:linear-gradient(135deg, #fef2f2, #fee2e2);
      border:2px solid #fecaca;
      color:#991b1b;
      font-weight:600;
      font-size:14px;
      text-align:center;
      animation:shake 0.5s ease;
    }
    
    @keyframes shake {
      0%, 100% { transform:translateX(0); }
      25% { transform:translateX(-8px); }
      75% { transform:translateX(8px); }
    }
    
    .success-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:linear-gradient(135deg, #d1fae5, #a7f3d0);
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      color:#065f46;
      box-shadow:0 4px 12px rgba(16,185,129,0.2);
    }
  </style>
</head>
<body>

<div class="page-wrapper">

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="onboarding-modal" style="display:none;" aria-hidden="true">
    <div class="onboarding-card" role="dialog" aria-modal="true">
      
      <!-- Slide 1: Introduction -->
      <div class="slide active" data-slide="0">
        <div style="text-align:center;">
          <div style="width:130px;height:130px;margin:0 auto;border-radius:26px;background:linear-gradient(135deg,var(--primary-500),var(--primary-600));display:flex;align-items:center;justify-content:center;font-size:48px;color:white;box-shadow:0 20px 60px rgba(139,92,246,0.3);">‚úâÔ∏è</div>
          <h3 style="margin-top:24px;font-size:22px;font-weight:900;color:#111827;">Stay Connected via Telegram</h3>
          <p style="color:#6b7280;margin-top:12px;font-size:15px;line-height:1.6;max-width:360px;margin-left:auto;margin-right:auto;">
            Get instant push notifications on your phone when it's your turn. No need to keep this page open!
          </p>
        </div>

        <div>
          <div class="step-dots">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
          </div>
          <button id="obNext" class="btn-primary">Continue ‚Üí</button>
          <button id="obSkip" class="btn-outline" style="margin-top:12px;">Skip for now</button>
        </div>
      </div>

      <!-- Slide 2: Instructions -->
      <div class="slide" data-slide="1">
        <div style="text-align:center;">
          <div style="width:130px;height:130px;margin:0 auto;border-radius:26px;background:linear-gradient(135deg,var(--primary-600),var(--primary-700));display:flex;align-items:center;justify-content:center;font-size:48px;color:white;box-shadow:0 20px 60px rgba(139,92,246,0.3);">‚ñ∂Ô∏è</div>
          <h3 style="margin-top:24px;font-size:22px;font-weight:900;color:#111827;">Tap "Start" in Telegram</h3>
          <p style="color:#6b7280;margin-top:12px;font-size:15px;line-height:1.6;max-width:360px;margin-left:auto;margin-right:auto;">
            We'll open our bot in Telegram. Just tap <strong>Start</strong> to activate notifications for your ticket.
          </p>
        </div>

        <div>
          <div class="step-dots">
            <div class="step-dot"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
          </div>
          <button id="obNext2" class="btn-primary">Next ‚Üí</button>
          <button id="obBack1" class="btn-outline" style="margin-top:12px;">‚Üê Back</button>
        </div>
      </div>

      <!-- Slide 3: Connect -->
      <div class="slide" data-slide="2">
        <div style="text-align:center;">
          <div style="width:130px;height:130px;margin:0 auto;border-radius:26px;background:linear-gradient(135deg,var(--primary-500),var(--primary-600));display:flex;align-items:center;justify-content:center;font-size:48px;color:white;box-shadow:0 20px 60px rgba(139,92,246,0.3);">‚úÖ</div>
          <h3 style="margin-top:24px;font-size:22px;font-weight:900;color:#111827;">Ready to Connect</h3>
          <p id="obStatusText" style="color:#6b7280;margin-top:12px;font-size:15px;line-height:1.6;max-width:360px;margin-left:auto;margin-right:auto;">
            Generating your secure connection link...
          </p>
        </div>

        <div>
          <div class="step-dots">
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot active"></div>
          </div>
          <button id="obFinish" class="btn-primary">
            <span id="obFinishIcon">üöÄ</span>
            <span id="obFinishText">Open Telegram</span>
          </button>
          <button id="obBack2" class="btn-outline" style="margin-top:12px;">‚Üê Back</button>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Main Status Card -->
  <main class="card" role="main" aria-live="polite">
    
    <!-- Top Action Buttons -->
    <div style="position:absolute;right:20px;top:18px;display:flex;gap:10px;z-index:10;">
      <button id="miniGame" class="circle-btn" title="Play a quick game" aria-label="Play game">üéÆ</button>
      <button id="miniConnect" class="circle-btn pulse" title="Connect Telegram" aria-label="Connect Telegram">‚úâÔ∏è</button>
    </div>

    <!-- Header Section -->
    <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:8px;margin-bottom:24px;">
      <div class="logo-container" id="logoContainer">
        <span id="logoText">QJ</span>
        <img id="logoImg" class="logo-img" style="display:none;" alt="Logo" />
      </div>
      <div style="text-align:center;max-width:640px;">
        <h1 style="font-size:24px;margin:0;font-weight:900;color:#111827;line-height:1.3;">
          You're in the queue ‚Äî we're tracking your spot
        </h1>
        <p style="color:#6b7280;margin-top:10px;font-size:15px;line-height:1.6;">
          Stay on this page or connect Telegram for instant notifications when it's your turn.
        </p>
      </div>
    </div>

    <!-- Progress Section -->
    <section style="margin-bottom:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span class="stat-label" style="text-transform:none;font-size:13px;">Queue Progress</span>
        <span id="progressCaption" style="font-size:13px;font-weight:700;color:#6b7280;">Loading...</span>
      </div>
      <div class="progress-track" role="progressbar" aria-label="Queue progress">
        <div id="progressFill" class="progress-fill" style="width:8%;">
          <span id="progressLabel">8%</span>
        </div>
      </div>
    </section>

    <!-- Main Stats Grid -->
    <section style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
      <div class="glass-card">
        <div class="stat-label">Your Ticket</div>
        <div id="yourNumber" class="stat-value" style="color:var(--primary-600);word-break:break-word;">‚Äî</div>
      </div>
      <div class="glass-card">
        <div class="stat-label">Now Serving</div>
        <div id="nowServing" class="stat-value" style="color:#111827;word-break:break-word;">‚Äî</div>
      </div>
    </section>

    <!-- Secondary Stats Grid -->
    <section style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;">
      <div class="glass-card">
        <div class="stat-label">People Ahead</div>
        <div id="peopleAhead" class="stat-value-small" style="color:#374151;">‚Äî</div>
      </div>
      <div class="glass-card">
        <div class="stat-label">Estimated Wait</div>
        <div id="estimatedWait" class="stat-value-small" style="color:var(--primary-600);">‚Äî</div>
      </div>
    </section>

    <!-- Connection Banner -->
    <section id="connectionBanner" class="glass-card" style="display:flex;align-items:center;gap:14px;">
      <div style="width:54px;height:54px;border-radius:14px;background:linear-gradient(135deg,var(--primary-600),var(--primary-500));display:flex;align-items:center;justify-content:center;color:white;font-size:26px;flex-shrink:0;box-shadow:0 8px 20px rgba(139,92,246,0.25);">üîî</div>
      <div style="flex:1;min-width:0;">
        <div id="connectionBannerText" style="font-weight:800;font-size:15px;color:#111827;line-height:1.3;">
          Checking notification status...
        </div>
        <div id="connectionBannerSub" style="color:#6b7280;font-size:13px;margin-top:4px;line-height:1.4;">
          Connect Telegram for alerts even when this page is closed.
        </div>
      </div>
      <div style="min-width:150px;">
        <button id="connectMain" class="btn-primary" style="padding:0.8rem 1.2rem;font-size:14px;white-space:nowrap;">
          Connect Telegram
        </button>
      </div>
    </section>

    <!-- Error Display -->
    <div id="error" class="error-banner" style="display:none;"></div>
    
  </main>

</div>

<!-- Ad Panel -->
<div id="adPanel" class="ad-panel" style="display:none;">
  <div style="font-size:10px;color:#9ca3af;text-align:center;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Advertisement</div>
  <div id="adContainer"></div>
</div>

<script type="module">
  // ==================== FIREBASE IMPORTS ====================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ==================== CONFIGURATION ====================
  const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
  const MARK_TOKEN_USED = '/.netlify/functions/markTokenUsed';
  const TELEGRAM_BOT_URL = 'https://t.me/QueueJoyBot';
  const MAX_AHEAD_ESTIMATE = 20; // For progress calculation

  const firebaseConfig = {
    apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
    authDomain: "queue-joy-aa21b.firebaseapp.com",
    databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "queue-joy-aa21b",
    storageBucket: "queue-joy-aa21b.firebasestorage.app",
    messagingSenderId: "950240394209",
    appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ==================== DOM ELEMENTS ====================
  const obModal = document.getElementById('onboardingModal');
  const slides = Array.from(document.querySelectorAll('.slide'));
  const stepDots = Array.from(document.querySelectorAll('.step-dot'));
  const obNext = document.getElementById('obNext');
  const obNext2 = document.getElementById('obNext2');
  const obBack1 = document.getElementById('obBack1');
  const obBack2 = document.getElementById('obBack2');
  const obSkip = document.getElementById('obSkip');
  const obFinish = document.getElementById('obFinish');
  const obFinishText = document.getElementById('obFinishText');
  const obFinishIcon = document.getElementById('obFinishIcon');
  const obStatusText = document.getElementById('obStatusText');

  const logoContainer = document.getElementById('logoContainer');
  const logoText = document.getElementById('logoText');
  const logoImg = document.getElementById('logoImg');
  const yourNumberEl = document.getElementById('yourNumber');
  const nowServingEl = document.getElementById('nowServing');
  const peopleAheadEl = document.getElementById('peopleAhead');
  const estimatedWaitEl = document.getElementById('estimatedWait');
  const progressFill = document.getElementById('progressFill');
  const progressLabel = document.getElementById('progressLabel');
  const progressCaption = document.getElementById('progressCaption');
  const connectMainBtn = document.getElementById('connectMain');
  const connectMiniBtn = document.getElementById('miniConnect');
  const connectionBannerText = document.getElementById('connectionBannerText');
  const connectionBannerSub = document.getElementById('connectionBannerSub');
  const adPanel = document.getElementById('adPanel');
  const adContainer = document.getElementById('adContainer');
  const errorBox = document.getElementById('error');

  // ==================== STATE ====================
  let slideIndex = 0;
  let onboardingDismissed = localStorage.getItem('qj_onboarding_dismissed') === 'true';
  let currentQueueKey = null;
  let currentQueueData = null;
  let currentCounterId = null;
  let latestConnectLink = null;
  let linkGenerating = false;
  let redirecting = false;
  let avgServiceTimeMinutes = 3; // Default fallback
  let qRef = null, allQueueRef = null, adRef = null, counterRef = null, settingsRef = null, analyticsRef = null;

  // ==================== UTILITY FUNCTIONS ====================
  
  function showError(msg) {
    if (!errorBox) return;
    errorBox.style.display = 'block';
    errorBox.textContent = msg;
    setTimeout(() => { 
      if (errorBox) errorBox.style.display = 'none'; 
    }, 7000);
  }

  function extractNumericPart(ticketStr) {
    if (!ticketStr) return null;
    const match = String(ticketStr).match(/(\d+)$/);
    return match ? parseInt(match[1], 10) : null;
  }

  function zeroPad(num, len) {
    return String(num).padStart(len, '0');
  }

  function formatMinutes(m) {
    const mm = Math.max(0, Math.round(m));
    if (mm === 0) return 'Less than a minute';
    if (mm < 60) return `${mm} min${mm > 1 ? 's' : ''}`;
    const hrs = Math.floor(mm / 60);
    const rem = mm % 60;
    return rem === 0 ? `${hrs} hr${hrs > 1 ? 's' : ''}` : `${hrs}h ${rem}m`;
  }

  // ==================== ONBOARDING FUNCTIONS ====================
  
  function showSlide(i) {
    slides.forEach(s => s.classList.remove('active'));
    stepDots.forEach(d => d.classList.remove('active'));
    slideIndex = i;
    const sl = slides[i];
    if (sl) sl.classList.add('active');
    const dot = stepDots[i];
    if (dot) dot.classList.add('active');
    if (i === 2) triggerGenerateLink();
  }

  function openOnboarding() {
    obModal.style.display = 'flex';
    if (onboardingDismissed) {
      showSlide(2);
      triggerGenerateLink();
    } else {
      showSlide(0);
    }
  }

  function closeOnboarding() {
    onboardingDismissed = true;
    localStorage.setItem('qj_onboarding_dismissed', 'true');
    obModal.style.display = 'none';
  }

  obNext.addEventListener('click', () => showSlide(1));
  obNext2.addEventListener('click', () => showSlide(2));
  obBack1.addEventListener('click', () => showSlide(0));
  obBack2.addEventListener('click', () => showSlide(1));
  obSkip.addEventListener('click', closeOnboarding);
  obModal.addEventListener('click', (e) => {
    if (e.target === obModal) closeOnboarding();
  });

  // ==================== TELEGRAM CONNECTION ====================
  
  async function generateConnectLink() {
    if (!currentQueueKey) throw new Error('Missing queueId');
    const res = await fetch(CREATE_LINK_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ queueKey: currentQueueKey })
    });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      throw new Error(`Create link failed: ${res.status} ${txt}`);
    }
    const json = await res.json();
    if (json.link) return json.link;
    if (json.token) {
      const url = new URL(TELEGRAM_BOT_URL);
      url.searchParams.set('start', json.token);
      return url.toString();
    }
    throw new Error('No link returned');
  }

  async function triggerGenerateLink() {
    if (linkGenerating) return;
    linkGenerating = true;
    obStatusText.textContent = 'Generating your secure connection link...';
    obFinishText.textContent = 'Open Telegram';
    latestConnectLink = null;

    try {
      let link = await generateConnectLink();
      
      // Ensure the link has the start parameter for /start command
      if (link && !link.includes('start=')) {
        const url = new URL(TELEGRAM_BOT_URL);
        const token = currentQueueData?.telegramToken || currentQueueData?.tgToken || currentQueueData?.token || null;
        if (token) url.searchParams.set('start', token);
        link = url.toString();
      }
      
      latestConnectLink = link || TELEGRAM_BOT_URL;
      obStatusText.innerHTML = '‚úÖ Ready! Tap below to open Telegram and start the bot.';
    } catch (e) {
      console.error('Link generation failed:', e);
      latestConnectLink = TELEGRAM_BOT_URL;
      obStatusText.textContent = 'Using fallback link. Tap below to connect.';
    } finally {
      linkGenerating = false;
    }
  }

  async function openConnectLink() {
    if (!latestConnectLink && !linkGenerating) {
      try {
        linkGenerating = true;
        latestConnectLink = await generateConnectLink();
      } catch (e) {
        console.warn('Failed to generate link:', e);
        latestConnectLink = TELEGRAM_BOT_URL;
      } finally {
        linkGenerating = false;
      }
    }

    const finalUrl = latestConnectLink || TELEGRAM_BOT_URL;

    // CRITICAL FIX: Open in NEW window/tab instead of replacing current page
    const newWindow = window.open(finalUrl, '_blank', 'noopener,noreferrer');
    
    if (!newWindow) {
      // Fallback if popup blocked
      showError('Please allow popups to open Telegram. Trying alternative method...');
      setTimeout(() => {
        window.location.href = finalUrl;
      }, 1500);
    }

    // Mark token as used
    try {
      const token = finalUrl.split('start=')[1] || null;
      if (token && currentQueueKey) {
        await fetch(MARK_TOKEN_USED, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ queueKey: currentQueueKey, token })
        });
      }
    } catch (e) {
      console.warn('Failed to mark token used:', e);
    }
  }

  obFinish.addEventListener('click', async () => {
    obFinish.disabled = true;
    obFinishIcon.innerHTML = '<span class="spinner"></span>';
    obFinishText.textContent = 'Opening...';
    
    try {
      await openConnectLink();
      obFinishIcon.textContent = '‚úÖ';
      obFinishText.textContent = 'Opened in Telegram';
      setTimeout(() => {
        closeOnboarding();
      }, 1000);
    } catch (e) {
      console.error('Failed to open Telegram:', e);
      obFinishIcon.textContent = 'üöÄ';
      obFinishText.textContent = 'Open Telegram';
      showError('Unable to open Telegram. Please try again.');
    } finally {
      obFinish.disabled = false;
    }
  });

  connectMainBtn.addEventListener('click', openOnboarding);
  connectMiniBtn.addEventListener('click', openOnboarding);
  document.getElementById('miniGame').addEventListener('click', () => {
    window.open('https://queuejoy.netlify.app/game.html', '_blank');
  });

  // ==================== UI UPDATE FUNCTIONS ====================
  
  function setTelegramConnectedUI(connected) {
    if (connected) {
      connectionBannerText.innerHTML = '‚úÖ Connected ‚Äî you\'ll get Telegram notifications';
      connectionBannerSub.textContent = 'You can safely close this page. We\'ll notify you when it\'s your turn.';
      connectMainBtn.innerHTML = '<span style="font-size:18px;">‚úÖ</span> Connected';
      connectMainBtn.disabled = true;
      connectMainBtn.style.opacity = '0.8';
      connectMiniBtn.classList.remove('pulse');
    } else {
      connectionBannerText.textContent = 'Get instant notifications via Telegram';
      connectionBannerSub.textContent = 'Connect to receive alerts even when this page is closed.';
      connectMainBtn.innerHTML = '<span style="font-size:18px;">‚úâÔ∏è</span> Connect Telegram';
      connectMainBtn.disabled = false;
      connectMainBtn.style.opacity = '1';
      connectMiniBtn.classList.add('pulse');
    }
  }

  function updateProgress(percent, ahead = null, status = '') {
    const pct = Math.max(4, Math.min(100, Math.round(percent)));
    progressFill.style.width = pct + '%';
    progressLabel.textContent = pct + '%';

    const st = String(status || '').toLowerCase();
    if (st === 'called' || st === 'serving' || st === 'your_turn') {
      progressCaption.textContent = "üéâ It's your turn ‚Äî go to the counter!";
      progressCaption.style.color = 'var(--primary-600)';
    } else if (ahead === 0) {
      progressCaption.textContent = "‚è∞ You're next ‚Äî stay ready!";
      progressCaption.style.color = 'var(--primary-600)';
    } else if (ahead !== null && ahead > 0) {
      progressCaption.textContent = `${ahead} ${ahead === 1 ? 'person' : 'people'} ahead`;
      progressCaption.style.color = '#6b7280';
    } else {
      progressCaption.textContent = "Tracking your position...";
      progressCaption.style.color = '#6b7280';
    }
  }

  // ==================== ANALYTICS & AVG SERVICE TIME ====================
  
  async function calculateAvgServiceTime() {
    try {
      const snap = await get(ref(db, 'analytics/serviceEvents'));
      if (!snap.exists()) return 3;

      const events = snap.val();
      const serviceTimes = [];

      for (const key in events) {
        if (events.hasOwnProperty(key)) {
          const event = events[key];
          if (event.serviceMs && Number.isFinite(event.serviceMs) && event.serviceMs > 0) {
            // Convert milliseconds to minutes
            const minutes = event.serviceMs / 60000;
            // Filter out unreasonably long times (over 2 hours)
            if (minutes <= 120) {
              serviceTimes.push(minutes);
            }
          }
        }
      }

      if (serviceTimes.length === 0) return 3;

      // Calculate average
      const sum = serviceTimes.reduce((acc, val) => acc + val, 0);
      const avg = sum / serviceTimes.length;

      // Round to 1 decimal place and ensure minimum of 1 minute
      return Math.max(1, Math.round(avg * 10) / 10);
    } catch (e) {
      console.warn('Failed to calculate avg service time:', e);
      return 3;
    }
  }

  // ==================== LOGO LOADING ====================
  
  async function loadLogo() {
    try {
      const snap = await get(ref(db, 'settings/logoUrl'));
      if (snap.exists() && snap.val()) {
        const logoUrl = String(snap.val()).trim();
        if (logoUrl) {
          logoImg.src = logoUrl;
          logoImg.onload = () => {
            logoText.style.display = 'none';
            logoImg.style.display = 'block';
          };
          logoImg.onerror = () => {
            logoText.style.display = 'flex';
            logoImg.style.display = 'none';
          };
        }
      }
    } catch (e) {
      console.warn('Failed to load logo:', e);
    }
  }

  // ==================== AD FUNCTIONS ====================
  
  function clearAd() {
    adContainer.innerHTML = '';
    adPanel.style.display = 'none';
  }

  function showAdFromUrl(url) {
    clearAd();
    if (!url) return;
    const trimmed = String(url).trim();
    if (!trimmed) return;

    const isVideo = /\.(mp4|webm|ogg)(\?.*)?$/i.test(trimmed) || trimmed.startsWith('data:video/');
    adPanel.style.display = 'block';

    if (isVideo) {
      const v = document.createElement('video');
      v.src = trimmed;
      v.autoplay = true;
      v.muted = true;
      v.loop = true;
      v.playsInline = true;
      v.className = 'ad-media';
      v.setAttribute('playsinline', '');
      v.setAttribute('muted', '');
      adContainer.appendChild(v);
      v.play().catch(() => v.setAttribute('controls', ''));
    } else {
      const img = document.createElement('img');
      img.src = trimmed;
      img.className = 'ad-media';
      img.alt = 'Advertisement';
      img.onerror = () => clearAd();
      adContainer.appendChild(img);
    }
  }

  // ==================== MAIN COMPUTATION ====================
  
  async function computePeopleAheadAndEstimate() {
    try {
      if (!currentQueueData) return;

      const myTicket = currentQueueData.queueId || currentQueueData.ticket;
      const myStatus = String(currentQueueData.status || '').toLowerCase();
      const myCounter = currentQueueData.counterId || currentQueueData.counter || null;

      // Get current nowServing from counter
      let nowServingNumber = null;
      if (myCounter) {
        const counterSnap = await get(ref(db, `counters/${myCounter}`));
        if (counterSnap.exists()) {
          const counterData = counterSnap.val();
          nowServingNumber = counterData.nowServing;
        }
      }

      // CRITICAL FIX: Calculate people ahead using numeric extraction
      const myNumber = extractNumericPart(myTicket);
      const servingNumber = extractNumericPart(nowServingNumber);

      let peopleAhead = 0;
      if (myNumber !== null && servingNumber !== null) {
        peopleAhead = Math.max(0, myNumber - servingNumber);
      } else {
        // Fallback: count from queue
        const allSnap = await get(ref(db, 'queue'));
        if (allSnap.exists()) {
          const all = allSnap.val();
          const myTime = Number(currentQueueData.timestamp) || 0;
          
          for (const k in all) {
            if (!all.hasOwnProperty(k)) continue;
            const t = all[k];
            if (!t) continue;
            const status = String(t.status || '').toLowerCase();
            if (status !== 'waiting') continue;
            if (myCounter && String(t.counterId || t.counter || '') !== String(myCounter)) continue;
            if (Number(t.timestamp) < myTime) peopleAhead++;
          }
        }
      }

      peopleAheadEl.textContent = String(peopleAhead);

      // CRITICAL FIX: Calculate estimated wait using analytics average
      const estMinutes = peopleAhead * avgServiceTimeMinutes;
      estimatedWaitEl.textContent = peopleAhead === 0 ? 'Now' : formatMinutes(estMinutes);

      // CRITICAL FIX: Calculate progress using linear formula
      // progressPercent = 100 - (peopleAhead / maxAhead) * 100
      const maxAhead = MAX_AHEAD_ESTIMATE;
      let progressPercent = 100 - (peopleAhead / maxAhead) * 100;
      progressPercent = Math.max(4, Math.min(100, progressPercent));

      updateProgress(progressPercent, peopleAhead, myStatus);

    } catch (e) {
      console.error('Failed to compute estimates:', e);
      showError('Failed to update queue status. Retrying...');
    }
  }

  function updateNowServingDisplay(counterData) {
    if (!currentQueueData) return;

    const prefix = counterData?.prefix ? String(counterData.prefix) : '';
    const nowServingNumber = counterData?.nowServing;
    
    if (prefix && nowServingNumber !== undefined && nowServingNumber !== null) {
      const digits = String(currentQueueData.queueId || '').match(/(\d+)$/) || ['', '001'];
      nowServingEl.textContent = `${prefix}${zeroPad(nowServingNumber, digits[1].length)}`;
    } else if (nowServingNumber !== undefined && nowServingNumber !== null) {
      nowServingEl.textContent = String(nowServingNumber);
    } else {
      nowServingEl.textContent = '‚Äî';
    }
  }

  function detectAndRedirectIfCalled(counterData) {
    if (!currentQueueData || redirecting) return;

    try {
      const status = String(currentQueueData.status || '').toLowerCase();
      if (status === 'serving' || status === 'called' || status === 'your_turn') {
        redirectToTurnPage();
        return;
      }

      // Check if nowServing matches your ticket
      const prefix = counterData?.prefix ? String(counterData.prefix) : '';
      const nowServingNum = counterData?.nowServing;
      
      if (prefix && Number.isFinite(nowServingNum)) {
        const myTicketNum = extractNumericPart(currentQueueData.queueId);
        if (myTicketNum !== null && myTicketNum === nowServingNum) {
          redirectToTurnPage();
        }
      }
    } catch (e) {
      console.warn('Redirect detection error:', e);
    }
  }

  function redirectToTurnPage() {
    if (redirecting) return;
    redirecting = true;
    connectionBannerText.innerHTML = 'üéâ It\'s your turn ‚Äî redirecting...';
    connectionBannerSub.textContent = 'Opening your turn page now.';
    updateProgress(100, 0, 'serving');
    
    setTimeout(() => {
      window.location.href = `your_turn.html?queueId=${encodeURIComponent(currentQueueKey || currentQueueData.queueId || '')}`;
    }, 800);
  }

  // ==================== INITIALIZATION ====================
  
  document.addEventListener('DOMContentLoaded', async () => {
    // Get queue ID from URL
    const params = new URLSearchParams(window.location.search);
    const queueKey = params.get('queueId');

    if (!queueKey) {
      showError('Queue ID missing. Redirecting to home...');
      setTimeout(() => window.location.href = 'index.html', 1500);
      return;
    }

    currentQueueKey = queueKey;

    // Show onboarding if not dismissed
    if (!onboardingDismissed) {
      obModal.style.display = 'flex';
      showSlide(0);
    }

    // Load logo
    await loadLogo();

    // Calculate average service time from analytics
    avgServiceTimeMinutes = await calculateAvgServiceTime();
    console.log('Average service time:', avgServiceTimeMinutes, 'minutes');

    // Watch settings for logo updates
    settingsRef = ref(db, 'settings/logoUrl');
    onValue(settingsRef, (snap) => {
      if (snap.exists() && snap.val()) {
        const logoUrl = String(snap.val()).trim();
        if (logoUrl) {
          logoImg.src = logoUrl;
          logoImg.onload = () => {
            logoText.style.display = 'none';
            logoImg.style.display = 'block';
          };
        }
      }
    });

    // Watch ad settings
    adRef = ref(db, 'settings/adImage');
    onValue(adRef, (snap) => {
      if (snap.exists()) showAdFromUrl(snap.val());
      else clearAd();
    });

    // Watch analytics for avg service time updates
    analyticsRef = ref(db, 'analytics/serviceEvents');
    onValue(analyticsRef, async () => {
      avgServiceTimeMinutes = await calculateAvgServiceTime();
      console.log('Updated average service time:', avgServiceTimeMinutes, 'minutes');
      computePeopleAheadAndEstimate();
    });

    // Watch your queue entry
    qRef = ref(db, `queue/${queueKey}`);
    onValue(qRef, async (snap) => {
      if (!snap.exists()) {
        showError('Queue entry not found. Redirecting...');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }

      currentQueueData = snap.val();
      yourNumberEl.textContent = currentQueueData.queueId || currentQueueData.ticket || '‚Äî';

      // Update Telegram connection status
      setTelegramConnectedUI(
        Boolean(currentQueueData.telegramConnected || currentQueueData.tgConnected)
      );

      // Watch assigned counter
      const counterId = currentQueueData.counterId || currentQueueData.counter || null;
      if (counterId && counterId !== currentCounterId) {
        if (counterRef) off(counterRef);
        currentCounterId = counterId;
        counterRef = ref(db, `counters/${counterId}`);
        onValue(counterRef, (cSnap) => {
          if (cSnap.exists()) {
            const cData = cSnap.val();
            updateNowServingDisplay(cData);
            detectAndRedirectIfCalled(cData);
            computePeopleAheadAndEstimate();
          }
        });
      } else if (!counterId) {
        nowServingEl.textContent = '‚Äî';
      }

      computePeopleAheadAndEstimate();
    });

    // Watch entire queue for updates
    allQueueRef = ref(db, 'queue');
    onValue(allQueueRef, () => computePeopleAheadAndEstimate());

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      try {
        if (qRef) off(qRef);
        if (allQueueRef) off(allQueueRef);
        if (adRef) off(adRef);
        if (counterRef) off(counterRef);
        if (settingsRef) off(settingsRef);
        if (analyticsRef) off(analyticsRef);
      } catch (e) {
        console.warn('Cleanup error:', e);
      }
    });
  });

</script>

</body>
</html>
