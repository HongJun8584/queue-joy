<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queue Joy - Your Queue Status</title>
  <meta name="description" content="Real-time queue status with Telegram notifications" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { 
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      display: inline-block;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease-in;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-cyan-50">

  <div class="min-h-screen flex items-center justify-center p-4 pb-32">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-gray-100 p-6 space-y-6 relative fade-in">
      
      <!-- Top Controls -->
      <div class="absolute top-4 right-4 flex gap-2 z-10">
        <button id="gameBtn" class="w-11 h-11 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl hover:scale-110 transition-transform" title="Play Game">
          üéÆ
        </button>
        <button id="connectTopBtn" class="w-11 h-11 rounded-full bg-white shadow-lg flex items-center justify-center text-2xl hover:scale-110 transition-transform" title="Connect Telegram">
          ‚úâÔ∏è
        </button>
      </div>

      <!-- Header -->
      <div class="space-y-3 text-center pt-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-blue-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900">Queue Status</h1>
        <p id="counterName" class="text-sm text-gray-600">--</p>
      </div>

      <!-- Connection Status Banner -->
      <div id="connectionBanner" class="rounded-2xl p-4 border-2">
        <p id="connectionBannerText" class="text-sm text-center"></p>
      </div>

      <!-- Your Number -->
      <div class="bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl p-6 border-2 border-purple-200">
        <p class="text-sm font-medium text-purple-700 mb-2">Your Number</p>
        <p id="yourNumber" class="text-5xl font-bold text-purple-800">--</p>
      </div>

      <!-- Status Grid -->
      <div class="space-y-4">
        <div class="bg-gray-50 rounded-2xl p-5">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Now Serving</span>
            <div id="statusIndicator" class="w-3 h-3 rounded-full bg-blue-500"></div>
          </div>
          <p id="nowServing" class="text-3xl font-bold text-gray-900">--</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
              <p class="text-sm text-gray-600">People Ahead</p>
            </div>
            <p id="peopleAhead" class="text-2xl font-bold text-gray-900">--</p>
          </div>
          <div class="bg-gray-50 rounded-2xl p-5">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-sm text-gray-600">Est. Wait</p>
            </div>
            <p id="estimatedWait" class="text-2xl font-bold text-gray-900">--</p>
          </div>
        </div>
      </div>

      <!-- Telegram Status (Desktop) -->
      <div class="hidden sm:block bg-gray-50 rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Notifications</p>
            <p id="telegramStatus" class="text-base font-semibold">Checking...</p>
          </div>
          <div id="telegramIcon" class="w-12 h-12 rounded-full flex items-center justify-center bg-gray-100">
            <span class="text-2xl">‚úâÔ∏è</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advertisement -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-md px-4 z-40">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-4">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement" class="w-full rounded-lg max-h-24 object-cover hidden">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>

  <!-- Connect Telegram Modal -->
  <div id="connectModal" class="modal">
    <div class="modal-content">
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
        <div class="flex items-center justify-center mb-4">
          <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
          </div>
        </div>
        <h2 class="text-2xl font-bold text-center">Get Notified on Telegram</h2>
        <p class="text-center text-blue-100 text-sm mt-2">Stay updated without keeping this page open</p>
      </div>
      
      <div class="p-6 space-y-4">
        <div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-gray-900 mb-2">üì± Important: Install Telegram App First</p>
              <p class="text-sm text-gray-700 mb-3">The Telegram <strong>app</strong> is required for background notifications. The web version won't work when your phone is locked.</p>
              
              <div class="bg-white rounded-lg p-3 space-y-2 text-sm text-gray-700">
                <p class="font-medium text-gray-900">How to connect:</p>
                <ol class="space-y-1.5 ml-4 list-decimal">
                  <li>Make sure <strong>Telegram app</strong> is installed on your phone</li>
                  <li>Click "<strong>Connect Telegram</strong>" button below</li>
                  <li>A new tab will open - tap "<strong>Open in Telegram</strong>"</li>
                  <li>Press "<strong>Start</strong>" in the Telegram app to complete connection</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <div id="loadingIndicator" class="hidden text-center py-2">
          <span class="spinner"></span>
          <span class="text-gray-600 text-sm">Preparing your secure link...</span>
        </div>

        <div class="space-y-3">
          <button id="connectBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
            Connect Telegram
          </button>
          <button id="closeModalBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors">
            Close
          </button>
        </div>

        <p class="text-xs text-gray-500 text-center">
          ‚ö†Ô∏è Only the Telegram app receives notifications in the background
        </p>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content max-w-sm">
      <div class="text-center py-6 px-4">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Connected Successfully!</h3>
        <p class="text-gray-600 mb-3">Hey üëã</p>
        <div class="text-sm bg-gray-50 rounded-lg p-4 mb-4 space-y-1">
          <p class="text-gray-700">üßæ Number: <strong id="confirmNumber">--</strong></p>
          <p class="text-gray-700">ü™ë Counter: <strong id="confirmCounter">--</strong></p>
        </div>
        <p class="text-sm text-gray-600">
          You can close this page now. We'll message you on Telegram when it's your turn.
        </p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const TELEGRAM_BOT_USERNAME = 'QueueJoyBot';
    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const SEND_TELEGRAM_ENDPOINT = '/.netlify/functions/sendTelegram';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const yourNumber = document.getElementById('yourNumber');
    const counterNameEl = document.getElementById('counterName');
    const nowServingEl = document.getElementById('nowServing');
    const peopleAheadEl = document.getElementById('peopleAhead');
    const estimatedWaitEl = document.getElementById('estimatedWait');
    const statusIndicator = document.getElementById('statusIndicator');
    const telegramStatus = document.getElementById('telegramStatus');
    const telegramIcon = document.getElementById('telegramIcon');
    const connectionBanner = document.getElementById('connectionBanner');
    const connectionBannerText = document.getElementById('connectionBannerText');
    const adPanel = document.getElementById('adPanel');
    const noAd = document.getElementById('noAd');

    const connectModal = document.getElementById('connectModal');
    const confirmModal = document.getElementById('confirmModal');
    const connectTopBtn = document.getElementById('connectTopBtn');
    const connectBtn = document.getElementById('connectBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const gameBtn = document.getElementById('gameBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const confirmNumber = document.getElementById('confirmNumber');
    const confirmCounter = document.getElementById('confirmCounter');

    let queueData = null;
    let avgServiceTime = 2;
    let isGeneratingLink = false;
    let connectLink = null;
    let prevTelegramConnected = false;

    const params = new URLSearchParams(window.location.search);
    const queueKey = params.get('queueId');

    if (!queueKey) {
      alert('Queue ID missing. Please scan the QR code again.');
      window.location.href = '/';
    }

    // Update connection UI
    function updateConnectionUI(connected) {
      if (connected) {
        telegramStatus.textContent = 'Connected to Telegram';
        telegramStatus.className = 'text-base font-semibold text-green-700';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-green-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-green-50 border-green-200';
        connectionBannerText.textContent = '‚úÖ Connected! You can leave this page. We\'ll notify you on Telegram when it\'s your turn.';
        connectionBannerText.className = 'text-sm text-center text-green-700';
      } else {
        telegramStatus.textContent = 'Not connected';
        telegramStatus.className = 'text-base font-semibold text-gray-800';
        telegramIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center bg-gray-100';
        connectionBanner.className = 'rounded-2xl p-4 border-2 bg-yellow-50 border-yellow-200';
        connectionBannerText.textContent = '‚ö†Ô∏è Not connected. Keep this page open for updates.';
        connectionBannerText.className = 'text-sm text-center text-yellow-700';
      }
    }

    // Generate Telegram link
    async function generateConnectLink() {
      if (!queueKey) throw new Error('Missing queueKey');
      
      let queueId = yourNumber.textContent;
      if (!queueId || queueId === '--') {
        await new Promise(resolve => setTimeout(resolve, 500));
        queueId = yourNumber.textContent;
      }

      const res = await fetch(CREATE_LINK_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          queueId: queueId || queueKey,
          counterId: queueData?.counterId || null
        })
      });

      const json = await res.json();
      return json.link;
    }

    // Handle connect click - OPENS IN NEW TAB
    async function handleConnect() {
      if (isGeneratingLink) return;
      
      isGeneratingLink = true;
      loadingIndicator.classList.remove('hidden');
      
      try {
        const link = await generateConnectLink();
        connectLink = link;
        // OPEN IN NEW TAB
        window.open(link || `https://t.me/${TELEGRAM_BOT_USERNAME}`, '_blank', 'noopener,noreferrer');
      } catch (e) {
        console.warn(e);
        // OPEN IN NEW TAB
        window.open(`https://t.me/${TELEGRAM_BOT_USERNAME}`, '_blank', 'noopener,noreferrer');
      } finally {
        isGeneratingLink = false;
        loadingIndicator.classList.add('hidden');
      }
    }

    // Event listeners
    connectTopBtn.addEventListener('click', () => {
      connectModal.classList.add('show');
    });

    connectBtn.addEventListener('click', handleConnect);

    closeModalBtn.addEventListener('click', () => {
      connectModal.classList.remove('show');
    });

    connectModal.addEventListener('click', (e) => {
      if (e.target === connectModal) {
        connectModal.classList.remove('show');
      }
    });

    gameBtn.addEventListener('click', () => {
      window.location.href = 'https://queuejoy.netlify.app/game.html';
    });

    // Show connect modal on load
    setTimeout(() => {
      connectModal.classList.add('show');
      handleConnect();
    }, 500);

    // Listen to queue data
    const queueRef = ref(db, `queue/${queueKey}`);
    onValue(queueRef, async (snap) => {
      if (!snap.exists()) {
        alert('Queue entry not found.');
        return;
      }

      const data = snap.val();
      const wasConnected = prevTelegramConnected;
      prevTelegramConnected = !!data.telegramConnected;
      
      queueData = data;
      yourNumber.textContent = data.queueId || '--';
      
      updateConnectionUI(!!data.telegramConnected);

      // Show confirmation when newly connected
      if (data.telegramConnected && !wasConnected) {
        const prefix = String(data.queueId || '').match(/^[A-Za-z]*/)?.[0] || '';
        const numberOnly = String(data.queueId || '').replace(prefix, '') || '';
        confirmNumber.textContent = `${prefix}${numberOnly}`;
        confirmCounter.textContent = data.counterId || 'TBD';
        connectModal.classList.remove('show');
        confirmModal.classList.add('show');
        setTimeout(() => confirmModal.classList.remove('show'), 3000);
      }

      // Listen to counter
      if (data.counterId) {
        const counterRef = ref(db, `counters/${data.counterId}`);
        onValue(counterRef, async (counterSnap) => {
          if (!counterSnap.exists()) return;
          
          const counterData = counterSnap.val();
          counterNameEl.textContent = counterData.name || data.counterId;

          // Get average service time
          let avgTime = Number(counterData.avgServiceTime) || null;
          if (!avgTime) {
            try {
              const settingsSnap = await get(ref(db, 'settings/avgServiceTime'));
              avgTime = settingsSnap.exists() ? Number(settingsSnap.val()) || 2 : 2;
            } catch (e) {
              avgTime = 2;
            }
          }
          avgServiceTime = avgTime;

          // Listen to now serving
          const servingRef = ref(db, `counters/${data.counterId}/nowServing`);
          onValue(servingRef, (nowSnap) => {
            const currentServing = Number(nowSnap.val() || 0);
            const prefix = counterData.prefix || String(data.queueId || '').match(/^[A-Za-z]+/)?.[0] || "";
            nowServingEl.textContent = `${prefix}${String(currentServing).padStart(3, '0')}`;

            const yourNumericValue = data.queueId ? parseInt(String(data.queueId).replace(prefix, ''), 10) : NaN;
            const ahead = Number.isFinite(yourNumericValue) ? Math.max(0, yourNumericValue - currentServing) : 0;
            peopleAheadEl.textContent = String(ahead);

            // Calculate estimated wait using average service time
            if (ahead === 0) {
              estimatedWaitEl.textContent = "Your turn!";
              statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse';

              // Notify via Telegram
              const notifyBody = data.chatId
                ? { chatId: data.chatId, message: `üéü It's now your turn!\nQueue: ${queueKey}` }
                : { message: `üéü It's now the customer's turn!\nQueue: ${queueKey}` };

              fetch(SEND_TELEGRAM_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notifyBody)
              }).catch(() => {});

              // Redirect to your turn page
              setTimeout(() => {
                try {
                  window.location.href = `/your_turn.html?queueId=${encodeURIComponent(queueKey)}`;
                } catch (e) {}
              }, 1200);
            } else {
              statusIndicator.className = 'w-3 h-3 bg-blue-500 rounded-full';
              const estimatedMinutes = Math.round(ahead * avgServiceTime);
              estimatedWaitEl.textContent = `~${estimatedMinutes} min`;
            }
          });
        });
      }
    });

    // Listen to ad
    const adRef = ref(db, "settings/adImage");
    onValue(adRef, (snap) => {
      const adUrl = snap.val();
      if (adUrl) {
        adPanel.src = adUrl;
        adPanel.classList.remove('hidden');
        noAd.classList.add('hidden');
      } else {
        adPanel.classList.add('hidden');
        noAd.classList.remove('hidden');
      }
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      off(queueRef);
      off(adRef);
    });
  </script>
</body>
</html>
