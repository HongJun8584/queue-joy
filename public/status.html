<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QueueJoy ‚Äî Your Queue Status</title>
  <meta name="theme-color" content="#8b5cf6">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #8b5cf6;
      --primary-light: #a78bfa;
      --primary-dark: #7c3aed;
      --bg: #faf8ff;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #f3e8ff 50%, #ede9fe 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      padding-bottom: 160px;
    }
    .main-card {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(139, 92, 246, 0.12), 0 4px 20px rgba(0,0,0,0.06);
      padding: 20px;
      position: relative;
    }
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    .logo-wrap {
      width: 64px; height: 64px; border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.25);
      overflow: hidden; flex-shrink: 0;
    }
    .logo-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .logo-wrap span { color: white; font-weight: 800; font-size: 20px; }
    .header-text { flex: 1; min-width: 0; }
    .header-text h1 { font-size: 18px; font-weight: 800; color: var(--text); line-height: 1.2; }
    .header-text p { font-size: 13px; color: var(--muted); margin-top: 2px; }
    .icon-btns { display: flex; gap: 6px; flex-shrink: 0; }
    .icon-btn {
      width: 38px; height: 38px; border-radius: 50%; background: #f9fafb;
      border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center;
      font-size: 16px; cursor: pointer; transition: all 0.2s;
    }
    .icon-btn:hover { background: #f3f4f6; transform: translateY(-1px); }
    .icon-btn.pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(139,92,246,0.4); } 50% { box-shadow: 0 0 0 8px rgba(139,92,246,0); } }

    .progress-section { margin-bottom: 14px; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .progress-label { font-size: 12px; color: var(--muted); font-weight: 500; }
    .progress-status { font-size: 12px; font-weight: 600; color: var(--primary); }
    .progress-track {
      height: 26px; background: #f3f4f6; border-radius: 13px; overflow: hidden;
      position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 13px; display: flex; align-items: center; justify-content: flex-end;
      padding-right: 10px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      position: relative; overflow: hidden; min-width: 45px;
    }
    .progress-fill::after {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer { 100% { left: 100%; } }
    .progress-text { color: white; font-size: 11px; font-weight: 700; position: relative; z-index: 1; }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .stat-card {
      background: #faf8ff; border-radius: 14px; padding: 14px;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); font-weight: 600; }
    .stat-value { font-size: 22px; font-weight: 800; margin-top: 4px; word-break: break-all; line-height: 1.1; }
    .stat-value.primary { color: var(--primary); }
    .stat-value.dark { color: var(--text); }

    .telegram-card {
      background: #faf8ff; border-radius: 14px; padding: 12px;
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    .telegram-icon {
      width: 44px; height: 44px; border-radius: 11px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .telegram-text { flex: 1; min-width: 0; }
    .telegram-text h3 { font-size: 13px; font-weight: 700; color: var(--text); }
    .telegram-text p { font-size: 11px; color: var(--muted); margin-top: 1px; }
    .connect-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white; border: none; padding: 10px 16px; border-radius: 10px;
      font-weight: 700; font-size: 12px; cursor: pointer; flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      transition: all 0.2s;
    }
    .connect-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4); }
    .connect-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .connect-btn.connected { background: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    .alert-banner {
      background: #fef3c7; border: 1px solid #fcd34d; border-radius: 10px;
      padding: 10px 12px; text-align: center; font-size: 12px; color: #92400e;
    }
    .alert-banner strong { font-weight: 700; }
    .alert-banner.hidden { display: none; }

    .error-box {
      background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px;
      padding: 10px; text-align: center; font-size: 12px; color: #dc2626;
      margin-top: 10px; display: none;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; z-index: 100; padding: 16px;
    }
    .modal-overlay.hidden { display: none; }
    .modal-card {
      background: white; border-radius: 22px; width: 100%; max-width: 360px;
      padding: 22px; box-shadow: 0 25px 80px rgba(0,0,0,0.3);
      animation: modalIn 0.3s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-icon {
      width: 72px; height: 72px; margin: 0 auto 14px; border-radius: 18px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      display: flex; align-items: center; justify-content: center; font-size: 32px;
      box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
    }
    .modal-title { text-align: center; font-size: 18px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
    .modal-desc { text-align: center; font-size: 13px; color: var(--muted); line-height: 1.4; margin-bottom: 14px; }
    .modal-desc strong { color: var(--text); }
    .modal-note {
      background: #fef3c7; border-radius: 8px; padding: 8px 10px;
      font-size: 11px; color: #92400e; text-align: center; margin-bottom: 14px;
    }
    .dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 14px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #e5e7eb; transition: all 0.3s; }
    .dot.active { width: 22px; border-radius: 4px; background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
    .modal-btn {
      width: 100%; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 14px;
      cursor: pointer; transition: all 0.2s; border: none;
    }
    .modal-btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white; box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .modal-btn.primary:hover:not(:disabled) { transform: translateY(-1px); }
    .modal-btn.primary:disabled { opacity: 0.7; cursor: not-allowed; }
    .modal-btn.secondary {
      background: #f3f4f6; color: var(--muted); margin-top: 8px;
    }
    .modal-btn.secondary:hover { background: #e5e7eb; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Ad Panel */
    .ad-panel {
      position: fixed; bottom: 0; left: 0; right: 0; background: white;
      padding: 10px 16px 16px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 50; display: none;
    }
    .ad-label { font-size: 9px; color: #9ca3af; text-align: center; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.1em; }
    .ad-media { width: 100%; max-height: 90px; object-fit: cover; border-radius: 8px; }

    @media (max-width: 360px) {
      .main-card { padding: 14px; }
      .header { gap: 8px; }
      .logo-wrap { width: 52px; height: 52px; }
      .header-text h1 { font-size: 16px; }
      .stat-value { font-size: 18px; }
      .stat-card { padding: 12px; }
    }
  </style>
</head>
<body>

  <!-- Onboarding Modal -->
  <div id="modal" class="modal-overlay">
    <div class="modal-card">
      <div id="slide0" class="slide">
        <div class="modal-icon">‚úâÔ∏è</div>
        <h2 class="modal-title">Get Notified via Telegram</h2>
        <p class="modal-desc">Receive push notifications when it's your turn ‚Äî even if you close this page.</p>
        <div class="modal-note">üì± <strong>Only the Telegram app</strong> supports background notifications. Web browser won't work!</div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
        <button class="modal-btn primary" onclick="showSlide(1)">Next</button>
        <button class="modal-btn secondary" onclick="closeModal()">Skip for now</button>
      </div>
      <div id="slide1" class="slide" style="display:none">
        <div class="modal-icon">‚ñ∂Ô∏è</div>
        <h2 class="modal-title">Tap "Start" in Telegram</h2>
        <p class="modal-desc">We'll open Telegram in a <strong>new tab</strong>. Tap <strong>Start</strong> to connect.</p>
        <div class="modal-note">‚ö†Ô∏è Make sure you have the <strong>Telegram app</strong> installed!</div>
        <div class="dots"><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
        <button class="modal-btn primary" onclick="showSlide(2)">Next</button>
        <button class="modal-btn secondary" onclick="showSlide(0)">Back</button>
      </div>
      <div id="slide2" class="slide" style="display:none">
        <div class="modal-icon">‚úÖ</div>
        <h2 class="modal-title">Ready to Connect</h2>
        <p id="slideStatus" class="modal-desc">Click below to open Telegram in a new tab.</p>
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot active"></div></div>
        <button id="connectBtn" class="modal-btn primary" onclick="openTelegram()">
          <span id="connectText">Connect to Telegram</span>
        </button>
        <button class="modal-btn secondary" onclick="showSlide(1)">Back</button>
      </div>
      <div id="slideConnected" class="slide" style="display:none">
        <div class="modal-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">‚úì</div>
        <h2 class="modal-title">You're Connected!</h2>
        <p class="modal-desc">You'll receive Telegram notifications when it's your turn. You can close this page.</p>
        <button class="modal-btn primary" onclick="closeModal()" style="background: linear-gradient(135deg, #10b981, #34d399);">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Main Card -->
  <main class="main-card">
    <div class="header">
      <div class="logo-wrap" id="logoWrap"><span>QJ</span></div>
      <div class="header-text">
        <h1>You're in the queue</h1>
        <p>Tracking your spot in real-time.</p>
      </div>
      <div class="icon-btns">
        <button class="icon-btn" onclick="location.href='game.html'" title="Play a game">üéÆ</button>
        <button class="icon-btn pulse" id="miniConnect" onclick="openModal()" title="Connect Telegram">‚úâÔ∏è</button>
      </div>
    </div>

    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Queue Progress</span>
        <span class="progress-status" id="progressCaption">Calculating...</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 10%">
          <span class="progress-text" id="progressText">10%</span>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Your Ticket</div>
        <div class="stat-value primary" id="yourTicket">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Now Serving</div>
        <div class="stat-value dark" id="nowServing">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">People Ahead</div>
        <div class="stat-value dark" id="peopleAhead">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Estimated Wait</div>
        <div class="stat-value primary" id="estimatedWait">‚Äî</div>
      </div>
    </div>

    <div class="telegram-card" id="telegramCard">
      <div class="telegram-icon">üîî</div>
      <div class="telegram-text">
        <h3 id="tgTitle">Get Telegram notifications</h3>
        <p id="tgSub">Alerts even when page is closed.</p>
      </div>
      <button class="connect-btn" id="mainConnect" onclick="openModal()">Connect</button>
    </div>

    <div class="alert-banner" id="stayAlert">
      ‚ö†Ô∏è <strong>Stay on this page & keep screen awake</strong> to not miss your turn.
    </div>

    <div class="error-box" id="errorBox"></div>
  </main>

  <!-- Ad Panel -->
  <div class="ad-panel" id="adPanel">
    <div class="ad-label">Advertisement</div>
    <div id="adContainer"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CREATE_LINK_ENDPOINT = '/.netlify/functions/createTelegramLink';
    const TELEGRAM_BOT_URL = 'https://t.me/QueueJoyBot';

    // State
    let queueKey = null;
    let queueData = null;
    let counterData = null;
    let avgServiceTime = 5;
    let isTelegramConnected = false;
    let linkGenerating = false;
    let telegramLink = null;

    // DOM Elements
    const modal = document.getElementById('modal');
    const logoWrap = document.getElementById('logoWrap');
    const yourTicket = document.getElementById('yourTicket');
    const nowServing = document.getElementById('nowServing');
    const peopleAhead = document.getElementById('peopleAhead');
    const estimatedWait = document.getElementById('estimatedWait');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressCaption = document.getElementById('progressCaption');
    const stayAlert = document.getElementById('stayAlert');
    const mainConnect = document.getElementById('mainConnect');
    const miniConnect = document.getElementById('miniConnect');
    const tgTitle = document.getElementById('tgTitle');
    const tgSub = document.getElementById('tgSub');
    const connectBtn = document.getElementById('connectBtn');
    const connectText = document.getElementById('connectText');
    const slideStatus = document.getElementById('slideStatus');
    const adPanel = document.getElementById('adPanel');
    const adContainer = document.getElementById('adContainer');
    const errorBox = document.getElementById('errorBox');

    // Modal functions
    window.showSlide = function(n) {
      document.querySelectorAll('.slide').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === n));
      const slide = document.getElementById('slide' + n);
      if (slide) slide.style.display = 'block';
      if (n === 2) generateLink();
    };

    window.openModal = function() {
      modal.classList.remove('hidden');
      if (isTelegramConnected) {
        document.querySelectorAll('.slide').forEach(s => s.style.display = 'none');
        document.getElementById('slideConnected').style.display = 'block';
      } else {
        showSlide(0);
      }
    };

    window.closeModal = function() {
      modal.classList.add('hidden');
    };

    async function generateLink() {
      if (linkGenerating || telegramLink) return;
      linkGenerating = true;
      connectBtn.disabled = true;
      connectText.innerHTML = '<span class="spinner"></span> Generating...';
      slideStatus.textContent = 'Generating secure link...';

      try {
        const res = await fetch(CREATE_LINK_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ queueKey })
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        if (data.link) {
          telegramLink = data.link;
        } else if (data.token) {
          telegramLink = `${TELEGRAM_BOT_URL}?start=${data.token}`;
        } else {
          telegramLink = TELEGRAM_BOT_URL;
        }
        slideStatus.textContent = 'Ready! Click below to open Telegram.';
        connectText.textContent = 'Open Telegram';
        connectBtn.disabled = false;
      } catch (e) {
        console.error(e);
        telegramLink = TELEGRAM_BOT_URL;
        slideStatus.textContent = 'Using default bot link.';
        connectText.textContent = 'Open Telegram';
        connectBtn.disabled = false;
      }
      linkGenerating = false;
    }

    window.openTelegram = function() {
      if (linkGenerating) return;
      const url = telegramLink || TELEGRAM_BOT_URL;
      // Open in NEW TAB - not replacing current page
      window.open(url, '_blank', 'noopener,noreferrer');
    };

    function showError(msg) {
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
      setTimeout(() => errorBox.style.display = 'none', 5000);
    }

    function updateTelegramUI(connected) {
      isTelegramConnected = connected;
      if (connected) {
        tgTitle.textContent = "‚úÖ Connected to Telegram";
        tgSub.textContent = "You'll be notified when it's your turn.";
        mainConnect.textContent = "Connected";
        mainConnect.classList.add('connected');
        mainConnect.disabled = true;
        miniConnect.classList.remove('pulse');
        stayAlert.classList.add('hidden');
      } else {
        tgTitle.textContent = "Get Telegram notifications";
        tgSub.textContent = "Alerts even when page is closed.";
        mainConnect.textContent = "Connect";
        mainConnect.classList.remove('connected');
        mainConnect.disabled = false;
        miniConnect.classList.add('pulse');
        stayAlert.classList.remove('hidden');
      }
    }

    function extractNumber(ticketId) {
      if (!ticketId) return null;
      const match = String(ticketId).match(/(\d+)$/);
      return match ? parseInt(match[1], 10) : null;
    }

    function formatTime(minutes) {
      if (minutes <= 0) return 'Now';
      if (minutes < 60) return `${Math.round(minutes)} min`;
      const hrs = Math.floor(minutes / 60);
      const mins = Math.round(minutes % 60);
      return mins > 0 ? `${hrs}h ${mins}m` : `${hrs}h`;
    }

    function updateDisplay() {
      if (!queueData) return;

      // Your ticket
      const myTicket = queueData.queueId || queueData.ticket || '‚Äî';
      yourTicket.textContent = myTicket;

      // Now serving
      let servingDisplay = '‚Äî';
      let servingNum = 0;
      if (counterData) {
        const prefix = counterData.prefix || '';
        const serving = counterData.nowServing;
        if (serving !== undefined && serving !== null) {
          servingNum = parseInt(serving, 10) || 0;
          const digits = String(extractNumber(myTicket) || '').length || 3;
          servingDisplay = prefix + String(servingNum).padStart(digits, '0');
        }
      }
      nowServing.textContent = servingDisplay;

      // Calculate people ahead - FIXED for nowServing = 0
      const myNum = extractNumber(myTicket);
      let ahead = 0;
      if (myNum !== null) {
        if (servingNum === 0) {
          // Queue hasn't started yet - you're ticket myNum, so myNum-1 people before you
          ahead = Math.max(0, myNum - 1);
        } else {
          ahead = Math.max(0, myNum - servingNum);
        }
      }
      peopleAhead.textContent = String(ahead);

      // Estimated wait
      const waitMins = ahead * avgServiceTime;
      estimatedWait.textContent = ahead === 0 ? 'Now' : formatTime(waitMins);

      // Progress bar - LINEAR: 1 ahead = 50%, 0 ahead = 100%
      // Formula: 100 / (ahead + 1)
      let pct;
      if (ahead === 0) {
        pct = 100;
      } else {
        pct = Math.round(100 / (ahead + 1));
      }
      pct = Math.max(5, Math.min(100, pct));
      
      progressFill.style.width = pct + '%';
      progressText.textContent = pct + '%';

      // Progress caption
      if (ahead === 0) {
        progressCaption.textContent = "üéØ You're next!";
      } else if (ahead === 1) {
        progressCaption.textContent = "1 ahead";
      } else {
        progressCaption.textContent = `${ahead} ahead`;
      }

      // Check if it's your turn - REDIRECT to your_turn.html
      const status = String(queueData.status || '').toLowerCase();
      if (status === 'serving' || status === 'called' || status === 'your_turn') {
        redirectToYourTurn();
        return;
      }
      // Also check if nowServing matches your ticket
      if (myNum !== null && servingNum > 0 && servingNum === myNum) {
        redirectToYourTurn();
        return;
      }
    }

    function redirectToYourTurn() {
      progressCaption.textContent = "üéâ It's your turn!";
      progressFill.style.width = '100%';
      progressText.textContent = '100%';
      setTimeout(() => {
        window.location.href = `your_turn.html?queueId=${encodeURIComponent(queueKey)}`;
      }, 500);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      queueKey = params.get('queueId');
      
      if (!queueKey) {
        showError('Missing queue ID');
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
      }

      // Load logo
      onValue(ref(db, 'settings/logoUrl'), (snap) => {
        if (snap.exists() && snap.val()) {
          logoWrap.innerHTML = `<img src="${snap.val()}" alt="Logo" onerror="this.parentElement.innerHTML='<span>QJ</span>'">`;
        }
      });

      // Load avg service time
      onValue(ref(db, 'settings/avgServiceTime'), (snap) => {
        if (snap.exists()) {
          const val = parseFloat(snap.val());
          if (val > 0) avgServiceTime = val;
        }
      });

      // Load ad
      onValue(ref(db, 'settings/adImage'), (snap) => {
        if (snap.exists() && snap.val()) {
          const url = snap.val();
          adPanel.style.display = 'block';
          if (/\.(mp4|webm|ogg)/i.test(url)) {
            adContainer.innerHTML = `<video class="ad-media" src="${url}" autoplay muted loop playsinline></video>`;
          } else {
            adContainer.innerHTML = `<img class="ad-media" src="${url}" alt="Ad">`;
          }
        } else {
          adPanel.style.display = 'none';
        }
      });

      // Load queue data
      onValue(ref(db, `queue/${queueKey}`), (snap) => {
        if (!snap.exists()) {
          showError('Queue not found');
          return;
        }
        queueData = snap.val();
        
        // Check telegram connection
        const connected = queueData.telegramConnected || queueData.tgConnected || false;
        updateTelegramUI(connected);

        // Load counter data if assigned
        const counterId = queueData.counterId || queueData.counter;
        if (counterId) {
          onValue(ref(db, `counters/${counterId}`), (cSnap) => {
            if (cSnap.exists()) {
              counterData = cSnap.val();
              updateDisplay();
            }
          });
        } else {
          updateDisplay();
        }
      });

      // Show modal on page load
      setTimeout(() => {
        openModal();
      }, 300);
    });
  </script>
</body>
</html>
