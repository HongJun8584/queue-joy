<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Joy - Counter Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease; }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .edit-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col items-center p-4">
    <div id="pinModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-6 slide-up">
            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-gray-800">Enter Counter PIN</h1>
                <p class="text-gray-600">Access required for counter management</p>
            </div>

            <form id="pinForm" class="space-y-4">
                <div class="relative">
                    <input
                        type="password"
                        id="pinInput"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent text-center text-lg tracking-wider"
                        placeholder="Enter PIN"
                        maxlength="4"
                    />
                    <button
                        type="button"
                        id="togglePin"
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                    >
                        <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </div>

                <div id="pinError" class="hidden">
                    <p class="text-sm text-red-500 text-center">Incorrect PIN</p>
                </div>

                <button
                    type="submit"
                    id="pinSubmit"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-400 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                >
                    <span id="pinBtnText">Access Counter Panel</span>
                    <div id="pinSpinner" class="hidden flex items-center justify-center">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                        Verifying...
                    </div>
                </button>
            </form>
        </div>
    </div>

    <div id="counterPanel" class="hidden w-full max-w-md">
        <div id="typeStep" class="relative bg-white rounded-2xl shadow-xl p-6 space-y-6 fade-in">
            <button id="typeMenuBtn" class="absolute top-4 right-4 p-2 text-xl text-gray-600 hover:text-gray-800 transition-colors z-10">‚ò∞</button>

            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-600 to-purple-500 rounded-full flex items-center justify-center mx-auto">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                <h2 class="text-lg font-medium text-indigo-600">Select Counter Type</h2>
                <p class="text-gray-600">Choose your counter configuration</p>
            </div>

            <div class="space-y-4">
                <button id="multipleCounters" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Multiple Counters</h3>
                            <p class="text-sm text-gray-600">Manage multiple service counters (up to 7)</p>
                        </div>
                    </div>
                </button>

                <button id="singleCounter" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-indigo-400 hover:bg-indigo-50 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Single Counter</h3>
                            <p class="text-sm text-gray-600">Manage one service counter</p>
                        </div>
                    </div>
                </button>
            </div>
        </div>

        <div id="setupMode" class="hidden relative bg-white rounded-2xl shadow-xl p-6 space-y-6 fade-in">
            <button id="setupMenuBtn" class="absolute top-4 right-4 p-2 text-xl text-gray-600 hover:text-gray-800 transition-colors z-10">‚ò∞</button>

            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-gradient-to-r from-green-600 to-blue-500 rounded-full flex items-center justify-center mx-auto">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <h2 id="setupTitle" class="text-lg font-medium text-green-600">Setup Counters</h2>
                <p id="setupDescription" class="text-gray-600">Configure your counters</p>
            </div>

            <div id="multipleSetup" class="hidden space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Available Counters</span>
                    <span id="counterCount" class="text-sm text-gray-500">0/7 selected</span>
                </div>
                <div id="counterList" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>

            <div id="singleSetup" class="hidden space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Counter Name</label>
                    <input
                        type="text"
                        id="singleCounterName"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent"
                        placeholder="e.g., Service Counter"
                        value="Service Counter"
                    />
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Counter Prefix</label>
                    <input
                        type="text"
                        id="singleCounterPrefix"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent text-center text-lg font-bold uppercase"
                        placeholder="A"
                        maxlength="5"
                    />
                    <p class="text-xs text-gray-500">Example: A, B, VIP, 1, etc. (A-Z, 0-9, max 5 chars)</p>
                </div>

                <div id="singleError" class="hidden">
                    <p class="text-sm text-red-500 text-center">Please fill in all fields correctly</p>
                </div>
            </div>

            <button
                id="setupBtn"
                class="w-full py-3 bg-gradient-to-r from-green-600 to-green-400 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                disabled
            >
                <span id="setupBtnText">Setup Counters</span>
                <div id="setupSpinner" class="hidden flex items-center justify-center">
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                    Setting up...
                </div>
            </button>
        </div>

        <div id="dashboardMode" class="hidden relative bg-white rounded-2xl shadow-xl p-6 space-y-6 fade-in">
            <button id="dashboardMenuBtn" class="absolute top-4 right-12 p-2 text-xl text-gray-600 hover:text-gray-800 transition-colors z-10">‚ò∞</button>
            <button id="helpBtn" class="absolute top-4 right-4 p-2 text-xl text-blue-600 hover:text-blue-800 transition-colors z-10">‚ùì</button>

            <div class="text-center space-y-2">
                <h2 class="text-lg font-medium text-indigo-600">Counter Dashboard</h2>
                <p id="activeCountersText" class="text-sm text-gray-600">0 active counters</p>
            </div>

            <div id="countersList" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>

            <button
                id="addMoreBtn"
                class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-500 text-white font-semibold rounded-xl shadow-lg hover:scale-105 transition-all duration-300"
            >
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add More Counters
                </span>
            </button>
        </div>
    </div>

    <div id="editModal" class="hidden edit-modal modal-backdrop">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-4 slide-up">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-indigo-600">Edit Counter</h3>
                <button id="closeEditModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Counter Name</label>
                    <input
                        type="text"
                        id="editCounterName"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                        placeholder="Counter Name"
                    />
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-700">Counter Prefix</label>
                    <input
                        type="text"
                        id="editCounterPrefix"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent text-center text-lg font-bold uppercase"
                        placeholder="A"
                        maxlength="5"
                    />
                    <p class="text-xs text-gray-500">A-Z, 0-9, max 5 characters</p>
                </div>

                <div id="editError" class="hidden">
                    <p class="text-sm text-red-500 text-center">Invalid input</p>
                </div>
            </div>

            <div class="flex gap-3">
                <button
                    id="cancelEditBtn"
                    class="flex-1 py-2 border border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all"
                >
                    Cancel
                </button>
                <button
                    id="saveEditBtn"
                    class="flex-1 py-2 bg-gradient-to-r from-indigo-600 to-purple-500 text-white font-medium rounded-xl hover:scale-105 transition-all disabled:opacity-50 disabled:hover:scale-100"
                    disabled
                >
                    <span id="saveEditText">Save</span>
                    <div id="saveEditSpinner" class="hidden flex items-center justify-center">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                        Saving...
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 space-y-4 slide-up max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-indigo-600">How It Works</h3>
                <button id="closeHelp" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-sm text-gray-700">
                <div>
                    <h4 class="font-medium text-gray-800">PIN Login</h4>
                    <p>Enter PIN (0108) to access the counter panel securely.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">Edit Counter</h4>
                    <p>Click Edit button to change counter name or prefix. Changes sync instantly across all devices.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">Call Next</h4>
                    <p>Issues a new number and updates "Now Serving". Server sends Telegram notification to the customer.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">Skip</h4>
                    <p>Moves to next number without issuing a new one.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">Reset</h4>
                    <p>Resets serving and issued numbers to 1.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">Server Notifications</h4>
                    <p>Telegram notifications are sent by the server when a number is called, even if customer closed their browser.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="menuDropdown" class="hidden fixed bg-white shadow-xl rounded-xl p-4 w-48 z-40 space-y-3 slide-up border border-gray-100" style="top: 70px; right: 20px;">
        <button id="logoutBtn" class="w-full text-left flex items-center gap-3 text-gray-700 font-medium hover:text-red-600 transition-colors p-2 rounded-lg hover:bg-red-50">
            <span class="text-xl">üö™</span>
            <span>Logout</span>
        </button>
        <a class='w-full text-left flex items-center gap-3 text-gray-700 font-medium hover:text-purple-600 transition-colors p-2 rounded-lg hover:bg-purple-50' href='/'>
            <span class="text-xl">üè†</span>
            <span>Customer Home</span>
        </a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            set,
            get,
            onValue,
            off,
            update,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
            authDomain: "queue-joy-aa21b.firebaseapp.com",
            databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "queue-joy-aa21b",
            storageBucket: "queue-joy-aa21b.appspot.com",
            messagingSenderId: "950240394209",
            appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        async function retryOperation(operation, maxRetries = 3, baseDelay = 700) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, i)));
                }
            }
        }

        function formatQueueId(prefix = '', num) {
            return `${prefix || ''}${String(Number(num) || 0).padStart(3,'0')}`;
        }

        async function notifyMatchingQueuesForServing(counterId, prefix, number) {
            const prefixed = formatQueueId(prefix, number);
            const padded = String(number).padStart(3, '0');
            const plain = String(number);

            await retryOperation(async () => {
                const qSnap = await get(ref(database, 'queue'));
                if (!qSnap.exists()) return;

                const updates = {};
                let any = false;

                qSnap.forEach(snap => {
                    const q = snap.val() || {};
                    const key = snap.key;
                    const qid = String(q.queueId || q.ticketNumber || q.id || q.number || '').trim();

                    const matches = qid === prefixed || qid === padded || qid === plain ||
                                    (q.counterId && q.counterId === counterId && qid === prefixed);

                    if (!matches) return;
                    if (q.called === true || q.serverNotified === true || q.serverNotifyRequested === true) return;

                    if (!q.chatId && !q.telegramChatId) {
                        updates[`queue/${key}/notificationError`] = 'no-chatId';
                        updates[`queue/${key}/notificationErrorAt`] = serverTimestamp();
                        any = true;
                        return;
                    }

                    updates[`queue/${key}/counterId`] = counterId;
                    updates[`queue/${key}/status`] = 'serving';
                    updates[`queue/${key}/serverNotifyRequested`] = true;
                    updates[`queue/${key}/serverNotifyRequestedAt`] = serverTimestamp();
                    updates[`queue/${key}/serverNotifyRequestedBy`] = 'counter-client';
                    any = true;
                });

                if (any) await update(ref(database), updates);
            }, 3, 700);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pinModal = document.getElementById('pinModal');
            const counterPanel = document.getElementById('counterPanel');
            const pinForm = document.getElementById('pinForm');
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            const pinSubmit = document.getElementById('pinSubmit');
            const pinBtnText = document.getElementById('pinBtnText');
            const pinSpinner = document.getElementById('pinSpinner');
            const togglePin = document.getElementById('togglePin');

            const typeStep = document.getElementById('typeStep');
            const setupMode = document.getElementById('setupMode');
            const dashboardMode = document.getElementById('dashboardMode');

            const multipleCounters = document.getElementById('multipleCounters');
            const singleCounter = document.getElementById('singleCounter');

            const setupTitle = document.getElementById('setupTitle');
            const setupDescription = document.getElementById('setupDescription');
            const multipleSetup = document.getElementById('multipleSetup');
            const singleSetup = document.getElementById('singleSetup');

            const counterList = document.getElementById('counterList');
            const counterCount = document.getElementById('counterCount');
            const singleCounterName = document.getElementById('singleCounterName');
            const singleCounterPrefix = document.getElementById('singleCounterPrefix');
            const singleError = document.getElementById('singleError');

            const setupBtn = document.getElementById('setupBtn');
            const setupBtnText = document.getElementById('setupBtnText');
            const setupSpinner = document.getElementById('setupSpinner');

            const countersList = document.getElementById('countersList');
            const activeCountersText = document.getElementById('activeCountersText');
            const addMoreBtn = document.getElementById('addMoreBtn');

            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeHelp = document.getElementById('closeHelp');

            const typeMenuBtn = document.getElementById('typeMenuBtn');
            const setupMenuBtn = document.getElementById('setupMenuBtn');
            const dashboardMenuBtn = document.getElementById('dashboardMenuBtn');
            const menuDropdown = document.getElementById('menuDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            const editModal = document.getElementById('editModal');
            const closeEditModal = document.getElementById('closeEditModal');
            const editCounterName = document.getElementById('editCounterName');
            const editCounterPrefix = document.getElementById('editCounterPrefix');
            const editError = document.getElementById('editError');
            const saveEditBtn = document.getElementById('saveEditBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditText = document.getElementById('saveEditText');
            const saveEditSpinner = document.getElementById('saveEditSpinner');

            let counterType = '';
            let selectedCounters = [];
            let prefixes = {};
            let activeCounters = {};
            let activeListeners = [];
            let currentEditCounterId = null;

            if (sessionStorage.getItem('counterAccess') === 'true') {
                pinModal.classList.add('hidden');
                counterPanel.classList.remove('hidden');
                loadCounters();
            }

            togglePin.addEventListener('click', () => {
                const isPassword = pinInput.type === 'password';
                pinInput.type = isPassword ? 'text' : 'password';
            });

            pinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pin = pinInput.value;

                if (pin.length !== 4) return;

                pinSubmit.disabled = true;
                pinBtnText.classList.add('hidden');
                pinSpinner.classList.remove('hidden');
                pinError.classList.add('hidden');

                await new Promise(resolve => setTimeout(resolve, 1000));

                if (pin === '0108') {
                    sessionStorage.setItem('counterAccess', 'true');
                    pinModal.classList.add('hidden');
                    counterPanel.classList.remove('hidden');
                    loadCounters();
                } else {
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                }

                pinSubmit.disabled = false;
                pinBtnText.classList.remove('hidden');
                pinSpinner.classList.add('hidden');
            });

            async function loadCounters() {
                try {
                    const countersRef = ref(database, 'settings/counters');
                    const snapshot = await get(countersRef);

                    if (snapshot.exists()) {
                        activeCounters = snapshot.val();
                        const hasActiveCounters = Object.keys(activeCounters).length > 0;

                        if (hasActiveCounters) {
                            showDashboard();
                        } else {
                            showTypeSelection();
                        }
                    } else {
                        showTypeSelection();
                    }
                } catch (error) {
                    console.error('Error loading counters:', error);
                    showTypeSelection();
                }
            }

            function showTypeSelection() {
                typeStep.classList.remove('hidden');
                setupMode.classList.add('hidden');
                dashboardMode.classList.add('hidden');
            }

            function showSetup() {
                typeStep.classList.add('hidden');
                setupMode.classList.remove('hidden');
                dashboardMode.classList.add('hidden');

                if (counterType === 'multiple') {
                    setupTitle.textContent = 'Setup Multiple Counters';
                    setupDescription.textContent = 'Select and configure up to 7 counters';
                    multipleSetup.classList.remove('hidden');
                    singleSetup.classList.add('hidden');
                    generateCounterList();
                } else {
                    setupTitle.textContent = 'Setup Single Counter';
                    setupDescription.textContent = 'Configure your service counter';
                    multipleSetup.classList.add('hidden');
                    singleSetup.classList.remove('hidden');
                    validateSingleSetup();
                }
            }

            function showDashboard() {
                typeStep.classList.add('hidden');
                setupMode.classList.add('hidden');
                dashboardMode.classList.remove('hidden');
                renderActiveCounters();
                setupRealtimeListeners();
            }

            multipleCounters.addEventListener('click', () => {
                counterType = 'multiple';
                showSetup();
            });

            singleCounter.addEventListener('click', () => {
                counterType = 'single';
                showSetup();
            });

            function generateCounterList() {
                counterList.innerHTML = '';

                for (let i = 1; i <= 7; i++) {
                    const counterId = `counter${i}`;
                    const counterDiv = document.createElement('div');
                    counterDiv.className = 'space-y-2';

                    counterDiv.innerHTML = `
                        <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                            <input type="checkbox" id="${counterId}" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" />
                            <span class="text-gray-700 font-medium">Counter ${i}</span>
                        </label>
                        <div id="${counterId}-config" class="hidden ml-8 space-y-2">
                            <input
                                type="text"
                                placeholder="Counter Name"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent"
                                data-field="name"
                                value="Counter ${i}"
                            />
                            <input
                                type="text"
                                placeholder="Prefix (A-Z, 0-9)"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent uppercase"
                                maxlength="5"
                                data-field="prefix"
                            />
                            <div class="error-msg hidden text-sm text-red-500"></div>
                        </div>
                    `;

                    const checkbox = counterDiv.querySelector(`#${counterId}`);
                    const configDiv = counterDiv.querySelector(`#${counterId}-config`);
                    const nameInput = configDiv.querySelector('[data-field="name"]');
                    const prefixInput = configDiv.querySelector('[data-field="prefix"]');

                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            if (selectedCounters.length >= 7) {
                                checkbox.checked = false;
                                return;
                            }
                            selectedCounters.push(counterId);
                            configDiv.classList.remove('hidden');
                            if (!prefixes[counterId]) {
                                prefixes[counterId] = { name: `Counter ${i}`, prefix: '' };
                            }
                        } else {
                            selectedCounters = selectedCounters.filter(id => id !== counterId);
                            configDiv.classList.add('hidden');
                            delete prefixes[counterId];
                        }
                        updateCounterCount();
                        validateMultipleSetup();
                    });

                    nameInput.addEventListener('input', (e) => {
                        if (!prefixes[counterId]) prefixes[counterId] = {};
                        prefixes[counterId].name = e.target.value;
                        validateMultipleSetup();
                    });

                    prefixInput.addEventListener('input', (e) => {
                        const value = e.target.value.toUpperCase();
                        e.target.value = value;
                        if (!prefixes[counterId]) prefixes[counterId] = {};
                        prefixes[counterId].prefix = value;
                        validateMultipleSetup();
                    });

                    counterList.appendChild(counterDiv);
                    validateMultipleSetup();
                }
            }

            function updateCounterCount() {
                counterCount.textContent = `${selectedCounters.length}/7 selected`;
            }

            function validateMultipleSetup() {
                const errors = {};
                const usedPrefixes = new Set();

                selectedCounters.forEach(counterId => {
                    const config = prefixes[counterId] || {};
                    const prefix = config.prefix || '';
                    const name = config.name || '';
                    const errorDiv = document.querySelector(`#${counterId}-config .error-msg`);

                    if (!name.trim()) {
                        errors[counterId] = 'Counter name required';
                    } else if (!prefix) {
                        errors[counterId] = 'Prefix required';
                    } else if (!/^[A-Z0-9]{1,5}$/.test(prefix)) {
                        errors[counterId] = 'Invalid format (A-Z, 0-9, max 5 chars)';
                    } else if (usedPrefixes.has(prefix)) {
                        errors[counterId] = 'Prefix already used';
                    } else {
                        usedPrefixes.add(prefix);
                    }

                    if (errors[counterId]) {
                        errorDiv.textContent = errors[counterId];
                        errorDiv.classList.remove('hidden');
                    } else {
                        errorDiv.classList.add('hidden');
                    }
                });

                const isValid = selectedCounters.length > 0 &&
                               selectedCounters.length <= 7 &&
                               Object.keys(errors).length === 0;

                setupBtn.disabled = !isValid;
            }

            function validateSingleSetup() {
                const name = singleCounterName.value.trim();
                const prefix = singleCounterPrefix.value.trim().toUpperCase();

                const isValid = name && prefix && /^[A-Z0-9]{1,5}$/.test(prefix);

                if (!isValid && (name || prefix)) {
                    singleError.classList.remove('hidden');
                } else {
                    singleError.classList.add('hidden');
                }

                setupBtn.disabled = !isValid;
            }

            singleCounterName.addEventListener('input', validateSingleSetup);
            singleCounterPrefix.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
                validateSingleSetup();
            });

            setupBtn.addEventListener('click', async () => {
                setupBtn.disabled = true;
                setupBtnText.classList.add('hidden');
                setupSpinner.classList.remove('hidden');

                try {
                    const countersToSetup = {};

                    if (counterType === 'multiple') {
                        selectedCounters.forEach(counterId => {
                            const config = prefixes[counterId];
                            countersToSetup[counterId] = {
                                name: config.name,
                                prefix: config.prefix,
                                nowServing: 1,
                                lastNumber: 0,
                                active: true
                            };
                        });
                    } else {
                        const name = singleCounterName.value.trim();
                        const prefix = singleCounterPrefix.value.trim().toUpperCase();
                        countersToSetup['counter1'] = {
                            name: name,
                            prefix: prefix,
                            nowServing: 1,
                            lastNumber: 0,
                            active: true
                        };
                    }

                    await retryOperation(async () => {
                        const updates = {};
                        Object.keys(countersToSetup).forEach(cid => {
                            const c = countersToSetup[cid];
                            updates[`settings/counters/${cid}/name`] = c.name;
                            updates[`settings/counters/${cid}/prefix`] = c.prefix;
                            updates[`settings/counters/${cid}/nowServing`] = c.nowServing;
                            updates[`settings/counters/${cid}/lastNumber`] = c.lastNumber;
                            updates[`settings/counters/${cid}/active`] = c.active;
                            updates[`settings/counters/${cid}/createdAt`] = serverTimestamp();
                            updates[`counters/${cid}/nowServing`] = c.nowServing;
                            updates[`counters/${cid}/name`] = c.name;
                            updates[`counters/${cid}/prefix`] = c.prefix;
                        });
                        await update(ref(database), updates);
                    });

                    activeCounters = countersToSetup;
                    showDashboard();
                } catch (error) {
                    console.error('Error setting up counters:', error);
                    alert('Failed to setup counters. Please try again.');
                }

                setupBtn.disabled = false;
                setupBtnText.classList.remove('hidden');
                setupSpinner.classList.add('hidden');
            });

            function renderActiveCounters() {
                countersList.innerHTML = '';
                const counterKeys = Object.keys(activeCounters);
                activeCountersText.textContent = `${counterKeys.length} active counter${counterKeys.length !== 1 ? 's' : ''}`;

                counterKeys.forEach(counterId => {
                    const counter = activeCounters[counterId];
                    const counterCard = document.createElement('div');
                    counterCard.className = 'bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 space-y-3 border border-indigo-100';

                    counterCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">${counter.name}</h3>
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">${counter.prefix}</span>
                                <button
                                    class="p-2 hover:bg-indigo-100 rounded-lg transition-colors"
                                    data-action="edit"
                                    data-counter="${counterId}"
                                    title="Edit counter"
                                >
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white rounded-lg p-3 text-center">
                                <p class="text-xs text-gray-600 mb-1">Now Serving</p>
                                <p class="text-2xl font-bold text-indigo-600" id="${counterId}-serving">${counter.prefix}${String(counter.nowServing).padStart(3, '0')}</p>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <p class="text-xs text-gray-600 mb-1">Last Issued</p>
                                <p class="text-2xl font-bold text-gray-800" id="${counterId}-issued">${counter.prefix}${String(counter.lastNumber).padStart(3, '0')}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                            <button
                                class="py-2 bg-gradient-to-r from-green-600 to-green-400 text-white font-medium rounded-lg hover:scale-105 transition-all text-sm"
                                data-action="call"
                                data-counter="${counterId}"
                            >
                                Call
                            </button>
                            <button
                                class="py-2 bg-gradient-to-r from-blue-600 to-blue-400 text-white font-medium rounded-lg hover:scale-105 transition-all text-sm"
                                data-action="skip"
                                data-counter="${counterId}"
                            >
                                Skip
                            </button>
                            <button
                                class="py-2 bg-gradient-to-r from-red-600 to-red-400 text-white font-medium rounded-lg hover:scale-105 transition-all text-sm"
                                data-action="reset"
                                data-counter="${counterId}"
                            >
                                Reset
                            </button>
                        </div>
                    `;

                    countersList.appendChild(counterCard);
                });

                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const action = e.currentTarget.getAttribute('data-action');
                        const counterId = e.currentTarget.getAttribute('data-counter');
                        if (action === 'edit') {
                            openEditModal(counterId);
                        } else {
                            await handleCounterAction(action, counterId);
                        }
                    });
                });
            }

            function openEditModal(counterId) {
                currentEditCounterId = counterId;
                const counter = activeCounters[counterId];
                if (!counter) return;

                editCounterName.value = counter.name || '';
                editCounterPrefix.value = counter.prefix || '';
                editError.classList.add('hidden');
                validateEditForm();
                editModal.classList.remove('hidden');
            }

            function closeEditModalFunc() {
                editModal.classList.add('hidden');
                currentEditCounterId = null;
                editCounterName.value = '';
                editCounterPrefix.value = '';
                editError.classList.add('hidden');
            }

            closeEditModal.addEventListener('click', closeEditModalFunc);
            cancelEditBtn.addEventListener('click', closeEditModalFunc);

            function validateEditForm() {
                const name = editCounterName.value.trim();
                const prefix = editCounterPrefix.value.trim().toUpperCase();
                const isValid = name && prefix && /^[A-Z0-9]{1,5}$/.test(prefix);

                saveEditBtn.disabled = !isValid;

                if (!isValid && (name || prefix)) {
                    editError.classList.remove('hidden');
                } else {
                    editError.classList.add('hidden');
                }
            }

            editCounterName.addEventListener('input', validateEditForm);
            editCounterPrefix.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
                validateEditForm();
            });

            saveEditBtn.addEventListener('click', async () => {
                if (!currentEditCounterId) return;

                const name = editCounterName.value.trim();
                const prefix = editCounterPrefix.value.trim().toUpperCase();

                if (!name || !prefix || !/^[A-Z0-9]{1,5}$/.test(prefix)) {
                    editError.classList.remove('hidden');
                    return;
                }

                saveEditBtn.disabled = true;
                saveEditText.classList.add('hidden');
                saveEditSpinner.classList.remove('hidden');

                try {
                    await retryOperation(async () => {
                        const updates = {};
                        updates[`settings/counters/${currentEditCounterId}/name`] = name;
                        updates[`settings/counters/${currentEditCounterId}/prefix`] = prefix;
                        updates[`settings/counters/${currentEditCounterId}/updatedAt`] = serverTimestamp();
                        updates[`settings/counters/${currentEditCounterId}/updatedBy`] = 'counter-client';
                        updates[`counters/${currentEditCounterId}/name`] = name;
                        updates[`counters/${currentEditCounterId}/prefix`] = prefix;
                        await update(ref(database), updates);
                    });

                    closeEditModalFunc();
                } catch (error) {
                    console.error('Edit error:', error);
                    editError.classList.remove('hidden');
                }

                saveEditBtn.disabled = false;
                saveEditText.classList.remove('hidden');
                saveEditSpinner.classList.add('hidden');
            });

            async function handleCounterAction(action, counterId) {
                try {
                    const counterRef = ref(database, `settings/counters/${counterId}`);
                    const snapshot = await get(counterRef);

                    if (!snapshot.exists()) return;

                    const counter = snapshot.val();
                    const prefix = counter.prefix || '';

                    if (action === 'call') {
                        const newNumber = counter.lastNumber + 1;
                        const newServing = newNumber;

                        await retryOperation(async () => {
                            const updates = {};
                            updates[`settings/counters/${counterId}/lastNumber`] = newNumber;
                            updates[`settings/counters/${counterId}/nowServing`] = newServing;
                            updates[`counters/${counterId}/nowServing`] = newServing;
                            updates[`counters/${counterId}/lastAdvanceAt`] = serverTimestamp();
                            await update(ref(database), updates);
                        });

                        await notifyMatchingQueuesForServing(counterId, prefix, newServing);

                    } else if (action === 'skip') {
                        const newServing = counter.nowServing + 1;

                        await retryOperation(async () => {
                            const updates = {};
                            updates[`settings/counters/${counterId}/nowServing`] = newServing;
                            updates[`counters/${counterId}/nowServing`] = newServing;
                            updates[`counters/${counterId}/lastAdvanceAt`] = serverTimestamp();
                            await update(ref(database), updates);
                        });

                        await notifyMatchingQueuesForServing(counterId, prefix, newServing);

                    } else if (action === 'reset') {
                        if (confirm('Reset this counter to 1?')) {
                            await retryOperation(async () => {
                                const updates = {};
                                updates[`settings/counters/${counterId}/nowServing`] = 1;
                                updates[`settings/counters/${counterId}/lastNumber`] = 0;
                                updates[`counters/${counterId}/nowServing`] = 1;
                                updates[`counters/${counterId}/lastAdvanceAt`] = serverTimestamp();
                                await update(ref(database), updates);
                            });

                            await notifyMatchingQueuesForServing(counterId, prefix, 1);
                        }
                    }
                } catch (error) {
                    console.error('Action error:', error);

                    try {
                        await update(ref(database), {
                            [`counters/${counterId}/lastNotifyClientError`]: error.message,
                            [`counters/${counterId}/lastNotifyClientErrorAt`]: serverTimestamp()
                        });
                    } catch (e) {}

                    alert('Operation failed. Please try again.');
                }
            }

            function setupRealtimeListeners() {
                activeListeners.forEach(({ ref: r }) => {
                    try { off(r); } catch (e) {}
                });
                activeListeners = [];

                const settingsCountersRef = ref(database, 'settings/counters');
                onValue(settingsCountersRef, (snapshot) => {
                    if (snapshot.exists()) {
                        activeCounters = snapshot.val();
                        updateDashboardDisplay();
                    }
                });
                activeListeners.push({ ref: settingsCountersRef });

                Object.keys(activeCounters).forEach(counterId => {
                    const counterRef = ref(database, `counters/${counterId}`);
                    onValue(counterRef, (snapshot) => {
                        if (snapshot.exists()) {
                            updateCounterDisplay(counterId, snapshot.val());
                        }
                    });
                    activeListeners.push({ ref: counterRef });
                });
            }

            function updateDashboardDisplay() {
                const counterKeys = Object.keys(activeCounters);
                activeCountersText.textContent = `${counterKeys.length} active counter${counterKeys.length !== 1 ? 's' : ''}`;

                counterKeys.forEach(counterId => {
                    const counter = activeCounters[counterId];
                    const card = document.querySelector(`[data-counter="${counterId}"]`)?.closest('.bg-gradient-to-r');
                    if (card) {
                        const nameEl = card.querySelector('h3');
                        const prefixBadge = card.querySelector('.px-3.py-1');
                        if (nameEl) nameEl.textContent = counter.name;
                        if (prefixBadge) prefixBadge.textContent = counter.prefix;

                        const servingEl = card.querySelector(`#${counterId}-serving`);
                        const issuedEl = card.querySelector(`#${counterId}-issued`);
                        if (servingEl) servingEl.textContent = formatQueueId(counter.prefix, counter.nowServing);
                        if (issuedEl) issuedEl.textContent = formatQueueId(counter.prefix, counter.lastNumber);
                    }
                });
            }

            function updateCounterDisplay(counterId, counterData) {
                const counter = activeCounters[counterId];
                if (!counter) return;

                const servingEl = document.getElementById(`${counterId}-serving`);
                const issuedEl = document.getElementById(`${counterId}-issued`);

                if (servingEl && counterData.nowServing !== undefined) {
                    servingEl.textContent = formatQueueId(counter.prefix, counterData.nowServing);
                }
                if (issuedEl && counter.lastNumber !== undefined) {
                    issuedEl.textContent = formatQueueId(counter.prefix, counter.lastNumber);
                }
            }

            addMoreBtn.addEventListener('click', () => {
                showTypeSelection();
            });

            helpBtn.addEventListener('click', () => {
                helpModal.classList.remove('hidden');
            });

            closeHelp.addEventListener('click', () => {
                helpModal.classList.add('hidden');
            });

            [typeMenuBtn, setupMenuBtn, dashboardMenuBtn].forEach(btn => {
                btn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menuDropdown.classList.toggle('hidden');
                });
            });

            document.addEventListener('click', (e) => {
                if (!menuDropdown.contains(e.target) &&
                    !typeMenuBtn?.contains(e.target) &&
                    !setupMenuBtn?.contains(e.target) &&
                    !dashboardMenuBtn?.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });

            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('counterAccess');
                window.location.reload();
            });

            window.addEventListener('beforeunload', () => {
                activeListeners.forEach(({ ref: r }) => {
                    try { off(r); } catch (e) {}
                });
            });
        });
    </script>
</body>
</html>
