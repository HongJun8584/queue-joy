<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Counter Management - Queue Joy</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- UMD QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background: linear-gradient(180deg,#eef2ff 0%, #fff0f6 100%); }
    .fade-in { animation: fadeIn .35s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }
    .pulse-ring { animation: pulseRing 1.2s cubic-bezier(.4,0,.6,1) infinite; }
    @keyframes pulseRing { 0%,100%{ transform:scale(1); opacity:1 } 50%{ transform:scale(1.04); opacity:0.65 } }
    .modal { display:none; position:fixed; inset:0; z-index:60; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); }
    .modal.show { display:flex; }
    .card { background: white; border-radius:14px; box-shadow: 0 20px 60px rgba(2,6,23,0.08); }
    .muted { color: #6b7280; }
    .qr-preview { width: 320px; height: auto; border-radius:12px; overflow:hidden; }
    .btn-primary { background: linear-gradient(135deg,#667eea,#764ba2); color:white; }
    .btn-success { background: linear-gradient(135deg,#10b981,#14b8a6); color:white; }
    canvas { max-width: 100%; height: auto; display: block; }
    .called-flash { animation: calledFlash .9s ease; }
    @keyframes calledFlash {
      0% { box-shadow: 0 10px 30px rgba(16,185,129,0.12); transform: translateY(-2px) }
      100% { box-shadow: none; transform: translateY(0) }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/></svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Counter Management</h1>
          <p class="text-sm muted">Queue Joy System â€” Admin</p>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="addCounterBtn" class="btn-primary px-5 py-3 rounded-xl font-semibold flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          Add Counter
        </button>
        <button id="generateTicketBtn" class="btn-success px-5 py-3 rounded-xl font-semibold flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          Generate Ticket
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="countersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div id="emptyState" class="text-center py-20 hidden">
      <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Counters Yet</h3>
      <p class="text-gray-600 mb-6">Create your first counter to start issuing tickets</p>
      <button id="addCounterBtnEmpty" class="btn-primary px-8 py-3 rounded-xl font-semibold">Add Your First Counter</button>
    </div>
  </main>

  <!-- Add/Edit Counter Modal -->
  <div id="counterModal" class="modal" aria-hidden="true">
    <div class="card max-w-lg w-full overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
        <h2 id="counterModalTitle" class="text-2xl font-bold">Add Counter</h2>
      </div>

      <form id="counterForm" class="p-6 space-y-4">
        <input type="hidden" id="counterIdInput">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Counter Name</label>
          <input id="counterNameInput" maxlength="50" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500" placeholder="e.g., COUNTER ICE CREAM">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Prefix (Max 7 characters)</label>
          <input id="counterPrefixInput" maxlength="7" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 uppercase" placeholder="e.g., ICE">
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 btn-primary text-white font-semibold py-3 rounded-xl">Save Counter</button>
          <button type="button" id="closeCounterModalBtn" class="flex-1 bg-gray-100 text-gray-700 font-semibold py-3 rounded-xl">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ticket modal (simplified: no counter selection) -->
  <div id="ticketModal" class="modal" aria-hidden="true">
    <div class="card w-full max-w-4xl overflow-hidden">
      <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6">
        <h2 class="text-2xl font-bold">Generate Ticket (QR)</h2>
      </div>

      <form id="ticketForm" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <p class="text-sm muted">This generates a QR that redirects to your app's <code>index.html</code>. It does <strong>not</strong> touch Firebase, does not create a queue entry, and does not update counters.</p>

          <div class="flex gap-3 pt-4">
            <button id="generateBtn" type="submit" class="flex-1 btn-success text-white font-semibold py-3 rounded-xl">Generate & Download QR</button>
            <button id="openStatusBtn" type="button" class="hidden flex-1 bg-indigo-600 text-white font-semibold py-3 rounded-xl">Open Index</button>
            <button id="downloadQRBtn" type="button" class="hidden flex-1 bg-indigo-600 text-white font-semibold py-3 rounded-xl">Download PNG</button>
            <button id="closeTicketModalBtn" type="button" class="flex-1 bg-gray-100 text-gray-700 font-semibold py-3 rounded-xl">Close</button>
          </div>
        </div>

        <div class="flex flex-col items-center justify-start gap-4">
          <div class="text-sm muted">QR Preview</div>
          <div id="ticketQRCode" class="qr-preview bg-white rounded-xl p-4 flex items-center justify-center"></div>
          <div id="ticketNote" class="text-xs muted text-center">QR points to <code>/index.html</code> of the app (no query params).</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="deleteModal" class="modal" aria-hidden="true">
    <div class="card max-w-sm p-6 text-center">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3" /></svg>
      </div>
      <h3 class="text-xl font-bold mb-2">Delete Counter?</h3>
      <p class="text-gray-600 mb-6">This action cannot be undone.</p>
      <div class="flex gap-3">
        <button id="confirmDeleteBtn" class="flex-1 bg-red-600 text-white font-semibold py-3 rounded-xl">Delete</button>
        <button id="cancelDeleteBtn" class="flex-1 bg-gray-100 text-gray-700 font-semibold py-3 rounded-xl">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, remove, push, get, runTransaction, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ===== CONFIG =====
    const SITE_URL = ''; // optional fixed base host (e.g. https://queuejoy.netlify.app)
    const NOTIFY_ENDPOINT = '/.netlify/functions/notifyCounter';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- TENANT RESOLUTION ----------
    function getTenantSlugFromUrl() {
      // 1) explicit ?slug= override
      try {
        const qp = new URLSearchParams(window.location.search);
        const s = qp.get('slug');
        if (s && /^[a-z0-9\-]+$/i.test(s)) return s.toLowerCase();
      } catch (e) {}

      // 2) path first segment (e.g. /demo-cafe/counter.html)
      try {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts.length === 0) return null;
        const p0 = parts[0];
        // avoid treating filenames (index.html) as slug
        if (p0.includes('.')) return null;
        if (/^[a-z0-9\-]+$/i.test(p0)) return p0.toLowerCase();
      } catch (e) {}

      return null;
    }

    const TENANT = getTenantSlugFromUrl(); // null => legacy/demo root
    const TENANT_PREFIX = TENANT ? `tenants/${TENANT}` : '';

    function tenantRef(dbInstance, relPath = '') {
      relPath = String(relPath || '').replace(/^\/+/, '');
      if (!TENANT) return ref(dbInstance, relPath || '/'); // legacy root mode
      if (!relPath) return ref(dbInstance, `tenants/${TENANT}`);
      return ref(dbInstance, `tenants/${TENANT}/${relPath}`);
    }
    // ---------- end tenant resolution ----------

    document.addEventListener('DOMContentLoaded', () => {
      // DOM refs
      const countersGrid = document.getElementById('countersGrid');
      const emptyState = document.getElementById('emptyState');

      const addCounterBtn = document.getElementById('addCounterBtn');
      const addCounterBtnEmpty = document.getElementById('addCounterBtnEmpty');

      const counterModal = document.getElementById('counterModal');
      const counterForm = document.getElementById('counterForm');
      const counterIdInput = document.getElementById('counterIdInput');
      const counterNameInput = document.getElementById('counterNameInput');
      const counterPrefixInput = document.getElementById('counterPrefixInput');
      const counterModalTitle = document.getElementById('counterModalTitle');
      const closeCounterModalBtn = document.getElementById('closeCounterModalBtn');

      const ticketModal = document.getElementById('ticketModal');
      const ticketForm = document.getElementById('ticketForm');
      const ticketQRCode = document.getElementById('ticketQRCode');
      const generateBtn = document.getElementById('generateBtn');
      const closeTicketModalBtn = document.getElementById('closeTicketModalBtn');
      const openStatusBtn = document.getElementById('openStatusBtn');
      const downloadQRBtn = document.getElementById('downloadQRBtn');

      const deleteModal = document.getElementById('deleteModal');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

      let countersData = {};
      let deleteTargetId = null;

      // --- WebAudio beep (small short tone) ---
      function playBeep() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = 880; // beep pitch
          g.gain.value = 0.12;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          setTimeout(() => {
            o.stop();
            try { ctx.close(); } catch(_) {}
          }, 160);
        } catch (e) {
          console.warn('beep failed', e);
        }
      }

      // ---------- LISTENERS (tenant-scoped) ----------
      const countersRef = tenantRef(db, 'counters');
      onValue(countersRef, snapshot => {
        countersData = snapshot.val() || {};
        renderCounters();
      }, (err) => {
        console.warn('counters read failed', err);
      });

      function renderCounters() {
        const ids = Object.keys(countersData || {});
        if (!ids.length) {
          countersGrid.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }
        emptyState.classList.add('hidden');
        countersGrid.classList.remove('hidden');
        countersGrid.innerHTML = '';

        ids.forEach(counterId => {
          const c = countersData[counterId] || {};
          const card = document.createElement('div');
          card.className = 'card p-6 fade-in';
          card.dataset.counterId = counterId;

          const nowServing = c.nowServing || 0;
          const lastIssued = c.lastIssued || 0;
          const prefix = c.prefix || '';
          const isActive = c.active !== false;
          const nowServingFormatted = `${prefix}${String(nowServing).padStart(3, '0')}`;
          const nextNumFormatted = `${prefix}${String((lastIssued || 0) + 1).padStart(3,'0')}`;

          card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="text-xl font-bold text-gray-900">${escapeHtml(c.name || counterId)}</h3>
                <p class="text-sm muted">${escapeHtml(prefix)} Series</p>
              </div>
              <div class="flex gap-2">
                <button class="editBtn w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center" title="Edit">âœŽ</button>
                <button class="deleteBtn w-8 h-8 rounded-lg bg-red-50 hover:bg-red-100 flex items-center justify-center" title="Delete">ðŸ—‘</button>
              </div>
            </div>

            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-4 mb-4">
              <p class="text-sm muted mb-1">Now Serving</p>
              <p class="text-4xl font-bold text-indigo-900">${escapeHtml(nowServingFormatted)}</p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-xs muted mb-1">Last Issued</p>
                <p class="text-xl font-bold text-gray-900">${escapeHtml(prefix)}${String(lastIssued).padStart(3,'0')}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-xs muted mb-1">Next Number</p>
                <p class="text-xl font-bold text-gray-900">${escapeHtml(nextNumFormatted)}</p>
              </div>
            </div>

            <div class="flex gap-2">
              <button class="callBtn flex-1 py-3 rounded-xl font-semibold text-white ${isActive ? '' : 'opacity-50 cursor-not-allowed'}" ${isActive ? '' : 'disabled'} style="background: linear-gradient(90deg,#10b981,#14b8a6);">Call Next</button>
              <button class="resetBtn px-4 py-3 bg-orange-500 text-white font-semibold rounded-xl">Reset</button>
            </div>
          `;

          // attach events
          card.querySelector('.editBtn').addEventListener('click', () => openEditCounter(counterId));
          card.querySelector('.deleteBtn').addEventListener('click', () => openDeleteCounter(counterId));
          card.querySelector('.callBtn').addEventListener('click', (ev) => {
            card.classList.add('called-flash');
            setTimeout(() => card.classList.remove('called-flash'), 900);
            callNext(counterId);
          });
          card.querySelector('.resetBtn').addEventListener('click', () => resetCounter(counterId));

          countersGrid.appendChild(card);
        });
      }

      function escapeHtml(s) {
        if (s === undefined || s === null) return '';
        return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }

      // modal handlers
      addCounterBtn.addEventListener('click', openAddCounter);
      addCounterBtnEmpty?.addEventListener('click', openAddCounter);
      closeCounterModalBtn.addEventListener('click', () => counterModal.classList.remove('show'));
      closeTicketModalBtn.addEventListener('click', () => ticketModal.classList.remove('show'));
      document.getElementById('addCounterBtnEmpty')?.addEventListener('click', openAddCounter);

      function openAddCounter() {
        counterModalTitle.textContent = 'Add Counter';
        counterForm.reset();
        counterIdInput.value = '';
        counterModal.classList.add('show');
      }

      function openEditCounter(counterId) {
        const c = countersData[counterId];
        if (!c) return;
        counterModalTitle.textContent = 'Edit Counter';
        counterIdInput.value = counterId;
        counterNameInput.value = c.name || '';
        counterPrefixInput.value = c.prefix || '';
        counterModal.classList.add('show');
      }

      // Save counter (tenant-scoped)
      counterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = counterNameInput.value.trim();
        const prefix = (counterPrefixInput.value || '').trim().toUpperCase();
        if (!name || !prefix || prefix.length > 7) return alert('Please provide valid counter name and prefix (max 7 chars)');

        const editingId = counterIdInput.value;
        try {
          if (editingId) {
            await update(tenantRef(db, `counters/${editingId}`), { name, prefix });
          } else {
            const lastAssignedRef = tenantRef(db, 'lastAssignedCounter');
            const tx = await runTransaction(lastAssignedRef, (curr) => (curr || 0) + 1);
            const newNum = tx.snapshot.val();
            const newId = `counter${newNum}`;
            await set(tenantRef(db, `counters/${newId}`), {
              name, prefix, active: true, busy: false, nowServing: 0, lastIssued: 0, lastAdvanceAt: Date.now()
            });
          }
          counterModal.classList.remove('show');
        } catch (err) {
          console.error('Save counter error', err);
          alert('Failed to save counter (check console).');
        }
      });

      // delete flow
      function openDeleteCounter(counterId) {
        deleteTargetId = counterId;
        deleteModal.classList.add('show');
      }
      confirmDeleteBtn.addEventListener('click', async () => {
        if (!deleteTargetId) return;
        try {
          await remove(tenantRef(db, `counters/${deleteTargetId}`));
          deleteModal.classList.remove('show');
          deleteTargetId = null;
        } catch (err) {
          console.error('Delete counter error', err);
          alert('Failed to delete counter');
        }
      });
      cancelDeleteBtn.addEventListener('click', () => { deleteModal.classList.remove('show'); deleteTargetId = null; });

      // reset: clears counter fields and FULL /queue (tenant-scoped)
      async function resetCounter(counterId) {
        const ok = confirm('Reset this counter to 0 AND clear the entire /queue data for this tenant? This will remove all waiting tickets. Proceed?');
        if (!ok) return;
        try {
          await update(tenantRef(db, `counters/${counterId}`), { nowServing: 0, lastIssued: 0, busy: false, lastAdvanceAt: Date.now() });
          await remove(tenantRef(db, 'queue'));
          alert('Counter reset and tenant /queue cleared.');
        } catch (err) {
          console.error('Reset error', err);
          alert('Failed to reset / clear queue (see console).');
        }
      }

      /**
       * CALL NEXT (tenant-scoped)
       */
      async function callNext(counterId) {
        try {
          const counterNodeRef = tenantRef(db, `counters/${counterId}`);

          const tx = await runTransaction(counterNodeRef, (curr) => {
            if (!curr) {
              return { nowServing: 1, lastIssued: 1, lastAdvanceAt: Date.now(), name: counterId, prefix: '' };
            }
            const prevNow = curr.nowServing || 0;
            const prevLast = curr.lastIssued || 0;
            const nextNow = prevNow + 1;
            const nextLast = Math.max(prevLast, nextNow);
            return Object.assign({}, curr, { nowServing: nextNow, lastIssued: nextLast, lastAdvanceAt: Date.now() });
          });

          if (!tx || !tx.snapshot) {
            console.warn('Transaction did not return snapshot for', counterId);
            return;
          }

          const updated = tx.snapshot.val();
          const nowServing = updated.nowServing || 0;
          const prefix = updated.prefix || '';
          const calledFull = `${prefix}${String(nowServing).padStart(3, '0')}`;

          // Play beep for admin
          playBeep();

          // Collect recipients from tenant's /queue who are waiting for this counter and have chatId
          const qSnap = await get(tenantRef(db, 'queue'));
          const recipients = [];
          if (qSnap.exists()) {
            const allQ = qSnap.val();
            Object.keys(allQ).forEach(k => {
              const e = allQ[k];
              if (e && e.counterId === counterId && e.chatId) {
                recipients.push({ chatId: e.chatId, theirNumber: e.queueId, ticketId: k });
              }
            });
          }

          // Notify to server function if recipients exist
          if (recipients.length) {
            try {
              let site = (SITE_URL && SITE_URL.trim()) ? SITE_URL.trim() : window.location.origin;
              site = site.replace(/\/$/, '');
              // if tenant present, ensure site includes tenant path (for server logic if it needs it)
              const siteWithTenant = TENANT ? `${site}/${TENANT}` : site;
              const payload = {
                calledFull,
                counterName: updated.name || counterId,
                recipients
              };

              const res = await fetch(`${siteWithTenant}${NOTIFY_ENDPOINT}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!res.ok) {
                const t = await res.text().catch(() => '');
                console.warn('notifyCounter non-ok', res.status, t);
              }
            } catch (notifyErr) {
              console.error('Notify error', notifyErr);
            }
          }

        } catch (err) {
          console.error('callNext error', err);
          alert('Failed to call next (see console).');
        }
      }

      // Open ticket modal
      document.getElementById('generateTicketBtn').addEventListener('click', () => {
        ticketForm.reset();
        ticketQRCode.innerHTML = '';
        openStatusBtn.classList.add('hidden');
        downloadQRBtn.classList.add('hidden');
        ticketModal.classList.add('show');
      });
      closeTicketModalBtn.addEventListener('click', () => ticketModal.classList.remove('show'));

      // Generate QR ONLY (tenant-scoped link)
      ticketForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          let base = (SITE_URL && SITE_URL.trim()) ? SITE_URL.trim() : window.location.origin;
          base = base.replace(/\/$/, '');
          const statusUrl = TENANT ? `${base}/${TENANT}/index.html` : `${base}/index.html`;

          ticketQRCode.innerHTML = '';
          const qrCanvas = document.createElement('canvas');
          await new Promise((resolve, reject) => {
            try {
              QRCode.toCanvas(qrCanvas, statusUrl, {
                width: 420,
                margin: 2,
                color: { dark: '#111827', light: '#ffffff' }
              }, (err) => err ? reject(err) : resolve());
            } catch (ex) {
              reject(ex);
            }
          });

          ticketQRCode.appendChild(qrCanvas);
          const ts = Date.now();
          downloadCanvasPNG(qrCanvas, `ticket-${ts}.png`);

          openStatusBtn.classList.remove('hidden');
          downloadQRBtn.classList.remove('hidden');
          openStatusBtn.onclick = () => window.open(statusUrl, '_blank', 'noopener');
          downloadQRBtn.onclick = () => downloadCanvasPNG(qrCanvas, `ticket-${ts}.png`);

        } catch (err) {
          console.error('Generate QR failed', err);
          alert('Failed to generate QR (see console).');
        }
      });

      function downloadCanvasPNG(canvas, filename = 'ticket.png') {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = filename;
        link.click();
      }

      // helper: close modal when backdrop clicked
      [counterModal, ticketModal, deleteModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.remove('show');
        });
      });

      // initial render safety
      (function tryInitial() {
        const keys = Object.keys(countersData || {});
        if (!keys.length) {
          countersGrid.classList.add('hidden');
          emptyState.classList.remove('hidden');
        }
      })();

      // cleanup: detach any open listeners when leaving
      window.addEventListener('beforeunload', () => {
        try { off(countersRef); } catch(_) {}
      });

    }); // DOMContentLoaded end
  </script>
</body>
</html>
