<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Queue Joy - It's Your Turn!</title>
  <!-- Tailwind CDN (fine for dev; the console warning is just advice for production builds) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn .6s ease-out; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(8px)} to {opacity:1;transform:translateY(0)} }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 flex items-center justify-center p-4">

  <main class="w-full max-w-xl bg-white rounded-2xl shadow-xl p-8 text-center space-y-6 fade-in">
    <header class="space-y-2">
      <div class="w-16 h-16 mx-auto rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 grid place-items-center text-white shadow-md">
        <svg viewBox="0 0 24 24" class="w-8 h-8" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-extrabold text-indigo-900">It’s Your Turn!</h1>
      <p class="text-gray-600">Please proceed to the counter below</p>
    </header>

    <section class="space-y-3">
      <div class="rounded-xl border-2 border-indigo-200 bg-indigo-50/70 p-4">
        <p class="text-sm text-indigo-600 font-medium">Your Queue Number</p>
        <p id="yourNumber" class="mt-1 text-5xl font-black text-indigo-900 tracking-wide">--</p>
      </div>

      <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
        <p class="text-sm text-gray-600">Proceed To</p>
        <p id="counterName" class="mt-1 text-2xl font-bold text-purple-700">--</p>
      </div>

      <p id="hint" class="text-xs text-gray-500 italic">
        (You’ll still be notified even if this tab is in the background.)
      </p>
    </section>

    <div id="errorBox" class="hidden rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 text-sm"></div>
  </main>

  <!-- Sound -->
  <audio id="ding" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg">
  </audio>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ===== CONFIG (your instance; explicitly pass URL to avoid attaching to any default/demo DB) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    // Force the exact RTDB instance (prevents the “queue-joy-demo…” warning/attach)
    const db = getDatabase(app, firebaseConfig.databaseURL);

    // ===== DOM =====
    const yourNumberEl = document.getElementById("yourNumber");
    const counterNameEl = document.getElementById("counterName");
    const errorBox = document.getElementById("errorBox");
    const ding = document.getElementById("ding");

    // ===== Helpers =====
    const showError = (msg) => {
      errorBox.textContent = msg;
      errorBox.classList.remove("hidden");
    };

    const getParam = (keys) => {
      const usp = new URLSearchParams(window.location.search);
      for (const k of keys) {
        const v = usp.get(k);
        if (v) return v;
      }
      return null;
    };

    // Ask for notification permission (non-blocking)
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission().catch(() => {});
    }

    // ===== Main =====
    let queueRef = null;
    let counterRef = null;
    let counterFallbackRef = null;
    let playedOnce = false;

    const queueKey = getParam(["queueId", "queueid", "qid", "id"]);
    if (!queueKey) {
      showError("Missing queueId in URL.");
    } else {
      // Your DB export shows the collection is "queue" (singular)
      queueRef = ref(db, `queue/${queueKey}`);

      onValue(queueRef, (snap) => {
        if (!snap.exists()) {
          showError("Your queue entry was not found.");
          return;
        }

        const q = snap.val() || {};
        const { queueId, counterId } = q;

        // Show user's ticket number
        yourNumberEl.textContent = queueId || "—";

        // Attach counter name listener (root: counters/{counterId})
        if (counterId && !counterRef && !counterFallbackRef) {
          counterRef = ref(db, `counters/${counterId}`);
          onValue(counterRef, (cSnap) => {
            if (cSnap.exists()) {
              const c = cSnap.val() || {};
              counterNameEl.textContent = c.name || "Counter";
              maybeNotify(queueId, c.name);
            } else {
              // Fallback if you ever nest under settings/counters
              counterFallbackRef = ref(db, `settings/counters/${counterId}`);
              onValue(counterFallbackRef, (c2Snap) => {
                if (c2Snap.exists()) {
                  const c2 = c2Snap.val() || {};
                  counterNameEl.textContent = c2.name || "Counter";
                  maybeNotify(queueId, c2.name);
                } else {
                  counterNameEl.textContent = "Counter";
                }
              });
            }
          });
        }
      }, (err) => {
        showError("Failed to read your queue entry. Please refresh.");
        console.error(err);
      });
    }

    function maybeNotify(ticket, counterName) {
      if (playedOnce) return;
      playedOnce = true;

      // Sound
      ding.play().catch(() => { /* autoplay may be blocked */ });

      // Notification
      if ("Notification" in window && Notification.permission === "granted") {
        const n = new Notification("Queue Joy • It's Your Turn!", {
          body: `Ticket ${ticket || ""} → ${counterName || "Counter"}`,
          icon: "https://img.icons8.com/color/96/appointment-reminders.png",
          tag: "queue-joy-your-turn"
        });
        n.onclick = () => window.focus();
      }
    }

    // Clean-up listeners
    window.addEventListener("beforeunload", () => {
      try {
        if (queueRef) off(queueRef);
        if (counterRef) off(counterRef);
        if (counterFallbackRef) off(counterFallbackRef);
      } catch (_) {}
    });
  </script>
</body>
</html>
