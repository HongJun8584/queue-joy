<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queue Joy - Memory Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card {
      perspective: 1000px;
      cursor: pointer;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .card-back {
      transform: rotateY(180deg);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col items-center justify-center p-4 pb-32">
  <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-4 fade-in">
    <!-- Header -->
    <div class="text-center space-y-2">
      <div class="w-12 h-12 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M15 14h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h1 class="text-xl font-bold text-indigo-800">Memory Game</h1>
      <p id="queueInfo" class="text-sm text-gray-600">Your number: (loading...)</p>
    </div>
    <!-- Game Stats -->
    <div class="grid grid-cols-3 gap-2 text-center">
      <div class="bg-gray-50 rounded-lg p-2">
        <p class="text-xs text-gray-600">Moves</p>
        <p id="moves" class="text-sm font-bold text-gray-800">0</p>
      </div>
      <div class="bg-gray-50 rounded-lg p-2">
        <p class="text-xs text-gray-600">Matches</p>
        <p id="matches" class="text-sm font-bold text-gray-800">0/6</p>
      </div>
      <div class="bg-gray-50 rounded-lg p-2">
        <p class="text-xs text-gray-600">Time</p>
        <p id="timer" class="text-sm font-bold text-gray-800">0:00</p>
      </div>
    </div>
    <!-- Game Board -->
    <div id="gameBoard" class="grid grid-cols-4 gap-2 aspect-square"></div>
    <!-- Game Complete -->
    <div id="gameComplete" class="hidden bg-green-50 border-2 border-green-200 rounded-xl p-3 text-center">
      <div class="text-2xl mb-1">üéâ</div>
      <p class="text-green-800 font-bold">Great job!</p>
      <div id="finalStats" class="text-green-700 text-xs"></div>
    </div>
    <!-- Actions -->
    <div class="space-y-2">
      <button id="newGameBtn" class="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-500 text-white font-semibold rounded-xl shadow hover:scale-105 transition-all duration-300">
        üéÆ New Game
      </button>
      <button id="backBtn" class="w-full py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
        ‚Üê Back to Status
      </button>
      <div id="inlineError" class="hidden text-red-600 text-sm text-center bg-red-50 border border-red-200 rounded-lg p-2"></div>
    </div>
  </div>
  <!-- Ad Panel -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-sm px-4">
    <div class="bg-white rounded-xl shadow-lg p-3">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement" class="w-full rounded-lg shadow-md hidden max-h-24 object-cover">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
      authDomain: "queue-joy-aa21b.firebaseapp.com",
      databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "queue-joy-aa21b",
      storageBucket: "queue-joy-aa21b.firebasestorage.app",
      messagingSenderId: "950240394209",
      appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // --- UI refs ---
    const queueInfoEl = document.getElementById('queueInfo');
    const gameBoardEl = document.getElementById('gameBoard');
    const movesEl = document.getElementById('moves');
    const matchesEl = document.getElementById('matches');
    const timerEl = document.getElementById('timer');
    const gameCompleteEl = document.getElementById('gameComplete');
    const finalStatsEl = document.getElementById('finalStats');
    const newGameBtn = document.getElementById('newGameBtn');
    const backBtn = document.getElementById('backBtn');
    const adPanel = document.getElementById('adPanel');
    const noAd = document.getElementById('noAd');
    const inlineError = document.getElementById('inlineError');

    // --- Game state ---
    const symbols = ['üéØ', 'üé®', 'üé™', 'üé≠', 'üé∏', 'üé≤'];
    let flippedCards = [];
    let matchedPairs = 0;
    let moves = 0;
    let gameStartTime = null;
    let gameTimer = null;

    // --- Firebase refs ---
    let adRef = null;
    let queueRef = null;
    let counterRef = null;
    let hasNavigated = false;

    function showError(msg) {
      inlineError.textContent = msg;
      inlineError.classList.remove('hidden');
    }

    function shuffleArray(array) {
      const a = [...array];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function initializeGame() {
      flippedCards = [];
      matchedPairs = 0;
      moves = 0;
      gameStartTime = null;
      if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
      }
      const cards = shuffleArray([...symbols, ...symbols]);
      gameBoardEl.innerHTML = '';
      gameCompleteEl.classList.add('hidden');
      cards.forEach((symbol, index) => {
        const card = document.createElement('div');
        card.className = 'card aspect-square';
        card.dataset.index = String(index);
        card.dataset.symbol = symbol;
        card.innerHTML = `
          <div class="card-inner">
            <div class="card-front bg-gradient-to-br from-purple-400 to-indigo-500 text-white">
              <span class="text-lg">?</span>
            </div>
            <div class="card-back bg-white border-2 border-gray-200">
              <span>${symbol}</span>
            </div>
          </div>
        `;
        card.addEventListener('click', () => flipCard(card));
        gameBoardEl.appendChild(card);
      });
      updateStats();
    }

    function flipCard(cardEl) {
      if (cardEl.classList.contains('flipped')) return;
      if (flippedCards.length >= 2) return;
      if (!gameStartTime) {
        gameStartTime = Date.now();
        startTimer();
      }
      cardEl.classList.add('flipped');
      flippedCards.push({ element: cardEl, symbol: cardEl.dataset.symbol });
      if (flippedCards.length === 2) {
        moves++;
        updateStats();
        setTimeout(checkMatch, 450);
      }
    }

    function checkMatch() {
      const [c1, c2] = flippedCards;
      if (!c1 || !c2) {
        flippedCards = [];
        return;
      }
      if (c1.symbol === c2.symbol) {
        matchedPairs++;
        c1.element.style.opacity = '0.7';
        c2.element.style.opacity = '0.7';
        if (matchedPairs === symbols.length) {
          setTimeout(completeGame, 300);
        }
      } else {
        setTimeout(() => {
          c1.element.classList.remove('flipped');
          c2.element.classList.remove('flipped');
        }, 250);
      }
      flippedCards = [];
      updateStats();
    }

    function startTimer() {
      gameTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function updateStats() {
      movesEl.textContent = String(moves);
      matchesEl.textContent = `${matchedPairs}/${symbols.length}`;
    }

    function completeGame() {
      if (gameTimer) clearInterval(gameTimer);
      const total = Math.floor((Date.now() - gameStartTime) / 1000);
      const minutes = Math.floor(total / 60);
      const seconds = total % 60;
      finalStatsEl.innerHTML = `Time: ${minutes}:${seconds.toString().padStart(2, '0')} | Moves: ${moves}`;
      gameCompleteEl.classList.remove('hidden');
    }

    function initAdListener() {
      adRef = ref(database, 'settings/adImage');
      onValue(adRef, (snap) => {
        const val = snap.exists() ? snap.val() : '';
        if (val) {
          adPanel.src = val;
          adPanel.classList.remove('hidden');
          noAd.classList.add('hidden');
        } else {
          adPanel.classList.add('hidden');
          noAd.classList.remove('hidden');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeGame();
      initAdListener();
      const params = new URLSearchParams(window.location.search);
      const queueId = params.get('queueId');
      if (!queueId) {
        showError('Missing queueId in URL.');
        backBtn.onclick = () => { window.location.href = 'index.html'; };
        return;
      }
      backBtn.onclick = () => {
        window.location.href = `status.html?queueId=${encodeURIComponent(queueId)}`;
      };
      queueRef = ref(database, `queues/${queueId}`);
      onValue(queueRef, (snapshot) => {
        if (!snapshot.exists()) {
          showError('Queue not found.');
          return;
        }
        const q = snapshot.val() || {};
        const prefix = (q.prefix ?? '').toString();
        const number = Number(q.number ?? NaN);
        const counterId = (q.counterId ?? '').toString();
        queueInfoEl.textContent = (prefix && Number.isFinite(number))
          ? `Your number: ${prefix}${number}`
          : 'Your number: (loading...)';
        if (counterId && Number.isFinite(number) && !counterRef) {
          counterRef = ref(database, `settings/counters/${counterId}`);
          onValue(counterRef, (counterSnap) => {
            console.log('Counter Snapshot:', counterSnap.val(), 'Number:', number);
            if (hasNavigated) return;
            if (counterSnap.exists()) {
              const c = counterSnap.val() || {};
              const nowServing = Number(c.nowServing ?? NaN);
              console.log('Now Serving:', nowServing, 'User Number:', number);
              if (Number.isFinite(nowServing) && nowServing === number) {
                hasNavigated = true;
                window.location.href = `your_turn.html?queueId=${encodeURIComponent(queueId)}`;
              }
            } else {
              showError('Counter not found.');
            }
          });
        } else if (!counterId || !Number.isFinite(number)) {
          showError('Invalid queue data.');
        }
      });
    });

    window.addEventListener('beforeunload', () => {
      try {
        if (adRef) off(adRef);
        if (queueRef) off(queueRef);
        if (counterRef) off(counterRef);
        if (gameTimer) clearInterval(gameTimer);
      } catch (_) {}
    });

    newGameBtn.addEventListener('click', initializeGame);
  </script>
</body>
</html>
