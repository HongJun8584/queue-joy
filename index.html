<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================
       Queue Joy - Index Page
       ========================= -->

  <!-- Firebase SDK -->
  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getDatabase, ref, set, get, child, update, push, onValue 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiRGvkQbnLlpnJT3fEEQrY1A3nwLVIFY0",
    authDomain: "queue-joy-aa21b.firebaseapp.com",
    databaseURL: "https://queue-joy-aa21b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "queue-joy-aa21b",
    storageBucket: "queue-joy-aa21b.firebasestorage.app",
    messagingSenderId: "950240394209",
    appId: "1:950240394209:web:78d4f2471d2d89ac91f0a0"
  };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Expose globally (debugging in console)
    window.db = db;
    window.ref = ref;
    window.child = child;
    window.get = get;
    window.set = set;
    window.update = update;
    window.push = push;
    window.onValue = onValue;

    console.log("‚úÖ Firebase initialized successfully.");
  </script>

  <!-- Meta and Styles -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queue Joy - Digital Queue System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #menuDropdown { top: 70px; right: 20px; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col items-center justify-center p-4 pb-32">
  <!-- =========================
       Main Card
       ========================= -->
  <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-6 text-center fade-in relative">

    <!-- Hamburger Menu -->
    <button id="menuBtn" 
      class="absolute top-4 right-4 p-2 text-xl text-gray-600 hover:text-gray-800 transition-colors z-10">
      ‚ò∞
    </button>

    <!-- Logo Circle -->
    <div class="w-16 h-16 bg-gradient-to-r from-purple-600 to-indigo-500 rounded-full flex items-center justify-center mx-auto">
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
        </path>
      </svg>
    </div>

    <!-- Title and Intro -->
    <div class="space-y-2">
      <h1 class="text-2xl font-bold text-gray-800">Queue Joy</h1>
      <p id="introText" class="text-gray-600">
        Real-time queueing system. Mobile-friendly. No app needed.
      </p>
    </div>

    <!-- Get Number Button -->
    <button id="getNumberBtn"
      class="w-full py-4 bg-gradient-to-r from-purple-600 to-purple-400 text-white font-semibold rounded-2xl shadow-lg hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
      <span id="btnText">üé´ Get My Number</span>
      <div id="btnSpinner" class="hidden flex items-center justify-center">
        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
        Getting your number...
      </div>
    </button>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-red-600 text-sm"></p>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
      <p class="text-green-600 text-sm"></p>
    </div>

    <!-- Menu Dropdown -->
    <div id="menuDropdown"
      class="hidden fixed bg-white shadow-xl rounded-xl p-4 w-48 z-40 space-y-3 fade-in border border-gray-100">
      <button id="counterPanelBtn"
        class="w-full text-left flex items-center gap-3 text-gray-700 font-medium hover:text-purple-600 transition-colors p-2 rounded-lg hover:bg-purple-50">
        <span class="text-xl">‚öôÔ∏è</span>
        <span>Counter Panel</span>
      </button>
    </div>
  </div>

  <!-- =========================
       Advertisement Panel
       ========================= -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-sm px-4">
    <div class="bg-white rounded-xl shadow-lg p-3">
      <p class="text-xs text-gray-500 text-center mb-2">Advertisement</p>
      <img id="adPanel" src="" alt="Advertisement"
        class="w-full rounded-lg shadow-md hidden max-h-24 object-cover">
      <div id="noAd" class="text-center text-gray-400 text-sm py-4">No advertisement available</div>
    </div>
  </div>

  <!-- =========================
       Script
       ========================= -->
  <script>
    console.log("üöÄ Queue Joy index.html script loaded.");

    document.addEventListener("DOMContentLoaded", function () {
      console.log("‚úÖ DOMContentLoaded fired.");

      // Elements
      const menuBtn = document.getElementById("menuBtn");
      const menuDropdown = document.getElementById("menuDropdown");
      const counterPanelBtn = document.getElementById("counterPanelBtn");
      const getNumberBtn = document.getElementById("getNumberBtn");
      const btnText = document.getElementById("btnText");
      const btnSpinner = document.getElementById("btnSpinner");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const adPanel = document.getElementById("adPanel");
      const noAd = document.getElementById("noAd");
      const introText = document.getElementById("introText");

      // Bounce detection
      const now = Date.now();
      const lastVisit = sessionStorage.getItem("lastVisitIndex");
      sessionStorage.setItem("lastVisitIndex", now);
      if (lastVisit && now - parseInt(lastVisit, 10) < 2000) {
        console.warn("‚ö†Ô∏è Bounce detected. Returned to index within", now - lastVisit, "ms");
      }

      // Menu dropdown toggle
      if (menuBtn) {
        menuBtn.addEventListener("click", e => {
          e.stopPropagation();
          menuDropdown.classList.toggle("hidden");
        });
        document.addEventListener("click", e => {
          if (!menuDropdown.contains(e.target) && !menuBtn.contains(e.target)) {
            menuDropdown.classList.add("hidden");
          }
        });
      }

      // Navigate to counter panel
      if (counterPanelBtn) {
        counterPanelBtn.addEventListener("click", () => {
          window.location.href = "counter.html";
        });
      }

      // Helper: Show error
      function showError(msg) {
        console.error("‚ùå Error:", msg);
        errorMessage.querySelector("p").textContent = msg;
        errorMessage.classList.remove("hidden");
        successMessage.classList.add("hidden");
        setTimeout(() => errorMessage.classList.add("hidden"), 4000);
      }

      // Helper: Show success
      function showSuccess(msg) {
        console.log("‚úÖ Success:", msg);
        successMessage.querySelector("p").textContent = msg;
        successMessage.classList.remove("hidden");
        errorMessage.classList.add("hidden");
      }

      // Helper: Button loading state
      function setLoading(flag) {
        getNumberBtn.disabled = flag;
        btnText.classList.toggle("hidden", flag);
        btnSpinner.classList.toggle("hidden", !flag);
      }

      // Ad panel listener
      function setupAdListener() {
        const adRef = ref(db, "settings/adImage");
        onValue(adRef, snap => {
          if (snap.exists()) {
            adPanel.src = snap.val();
            adPanel.classList.remove("hidden");
            noAd.classList.add("hidden");
          } else {
            adPanel.classList.add("hidden");
            noAd.classList.remove("hidden");
          }
        });
      }

      // Intro text listener
      function setupIntroTextListener() {
        const introRef = ref(db, "settings/introText");
        onValue(introRef, snap => {
          if (snap.exists()) {
            introText.textContent = snap.val();
          }
        });
      }

      // Auto redirect if user already has waiting queue
      async function autoRedirectIfActiveQueue() {
        try {
          const lastQueueId = sessionStorage.getItem("lastQueueId");
          if (!lastQueueId) return;
          const snap = await get(child(ref(db), `queue/${lastQueueId}`));
          if (snap.exists() && snap.val().status === "waiting") {
            console.log("üîÑ Redirecting to status.html with queueId:", lastQueueId);
            const lastRedirect = sessionStorage.getItem("lastRedirectTime");
            const now = Date.now();
            if (!lastRedirect || now - parseInt(lastRedirect, 10) > 2000) {
              sessionStorage.setItem("lastRedirectTime", now);
              window.location.href = `status.html?queueId=${lastQueueId}`;
            }
          }
        } catch (err) {
          showError("Auto-redirect failed.");
          console.error("‚ùå autoRedirectIfActiveQueue error:", err);
        }
      }

      // Get new queue number
      async function getQueueNumber() {
        try {
          setLoading(true);
          errorMessage.classList.add("hidden");
          successMessage.classList.add("hidden");

          const snapshot = await get(child(ref(db), "counters"));
          if (!snapshot.exists()) return showError("No counters available.");

          const counters = snapshot.val();
          const counterIds = Object.keys(counters);
          if (counterIds.length === 0) return showError("No counters available.");

          let counterId, counter, found = false;
          for (const id of counterIds) {
            if (counters[id].active === true) {
              counterId = id;
              counter = counters[id];
              found = true;
              break;
            }
          }
          if (!found) return showError("No active counters.");
          if (!counter.prefix) return showError("Counter misconfigured.");

          const nextNumber = (counter.lastIssued || 0) + 1;
          const queueId = `${counter.prefix}${String(nextNumber).padStart(3, "0")}`;

          // Update counter
          await update(ref(db, `counters/${counterId}`), { lastIssued: nextNumber });

          // Create queue entry
          const entry = { counterId, queueId, timestamp: Date.now(), status: "waiting" };
          const newKey = push(child(ref(db), "queue")).key;
          await set(ref(db, `queue/${newKey}`), entry);

          sessionStorage.setItem("lastQueueId", newKey);
          showSuccess(`‚úÖ Your number is ${queueId}! Redirecting...`);
          await new Promise(r => setTimeout(r, 1500));
          window.location.href = `status.html?queueId=${newKey}`;
        } catch (err) {
          showError("Failed to get queue number.");
          console.error("‚ùå getQueueNumber error:", err);
        } finally {
          setLoading(false);
        }
      }

      // Add listeners
      getNumberBtn.addEventListener("click", e => {
        e.preventDefault();
        getQueueNumber();
      });

      // Init
      setupAdListener();
      setupIntroTextListener();
      autoRedirectIfActiveQueue();
    });
  </script>
</body>
</html>
